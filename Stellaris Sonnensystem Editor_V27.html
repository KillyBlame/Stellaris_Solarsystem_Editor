<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stellaris Solar System Editor V27 - Full Editor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800;900&family=Exo+2:wght@300;400;500;600&display=swap');
        
        :root {
            --stellaris-blue: #00d4ff;
            --stellaris-gold: #ffd700;
            --stellaris-purple: #9966ff;
            --stellaris-dark: #0a0e1a;
            --stellaris-darker: #050811;
            --stellaris-panel: #1a2332;
            --stellaris-border: #2a3847;
            --stellaris-accent: #00a8cc;
            --stellaris-green: #48bb78;
        }

        body {
            font-family: 'Exo 2', 'Inter', sans-serif;
            background: linear-gradient(135deg, var(--stellaris-darker) 0%, var(--stellaris-dark) 50%, #0f1419 100%);
            color: #e2e8f0;
            min-height: 100vh;
            background-attachment: fixed;
        }

        .stellaris-header {
            background: linear-gradient(90deg, var(--stellaris-blue) 0%, var(--stellaris-purple) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-family: 'Orbitron', monospace;
            font-weight: 700;
            text-align: center;
            font-size: 2.5rem;
            margin-bottom: 2rem;
            text-shadow: 0 0 20px rgba(0, 212, 255, 0.3);
        }

        .stellaris-panel {
            background: linear-gradient(145deg, var(--stellaris-panel) 0%, rgba(26, 35, 50, 0.8) 100%);
            border: 1px solid var(--stellaris-border);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            position: relative;
            overflow: hidden;
        }

        .stellaris-panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, var(--stellaris-blue), var(--stellaris-purple), var(--stellaris-gold));
        }

        .system-selector-item {
            background: linear-gradient(145deg, rgba(74, 85, 104, 0.4) 0%, rgba(45, 55, 72, 0.6) 100%);
            border: 1px solid var(--stellaris-border);
            border-radius: 6px;
            padding: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
            border-left: 4px solid transparent;
            margin-bottom: 0.5rem;
        }

        .system-selector-item:hover {
            border-color: var(--stellaris-accent);
            transform: translateX(2px);
        }

        .system-selector-item.active {
            background: linear-gradient(145deg, rgba(0, 212, 255, 0.15) 0%, rgba(153, 102, 255, 0.15) 100%);
            border-left-color: var(--stellaris-blue);
            box-shadow: 0 0 10px rgba(0, 212, 255, 0.2);
        }

        .stellaris-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-primary {
            background: linear-gradient(135deg, var(--stellaris-blue), var(--stellaris-purple));
            color: white;
        }

        .badge-secondary {
            background: rgba(74, 85, 104, 0.6);
            color: var(--stellaris-gold);
        }

        .stellaris-input {
            background: linear-gradient(145deg, #2a3847 0%, #1e2936 100%);
            border: 1px solid var(--stellaris-border);
            color: #e2e8f0;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            width: 100%;
            font-family: 'Exo 2', sans-serif;
            transition: all 0.3s ease;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .stellaris-input:focus {
            outline: none;
            border-color: var(--stellaris-blue);
            box-shadow: 
                inset 0 2px 4px rgba(0, 0, 0, 0.2),
                0 0 0 3px rgba(0, 212, 255, 0.2);
        }

        /* Z-Index Fix f√ºr Dropdowns */
        .stellaris-input select {
            position: relative;
            z-index: 100;
        }

        .modal-content {
            position: relative;
            z-index: 2001;
        }

        .modal-content select {
            position: relative;
            z-index: 2002;
        }

        /* Dropdown-Optionen verbessern */
        .stellaris-input option,
        .stellaris-input optgroup {
            background-color: #2a3847 !important;
            color: #e2e8f0 !important;
            padding: 8px 12px;
        }

        .stellaris-input optgroup {
            font-weight: bold;
            background-color: #1e2936 !important;
        }

        /* Modal √ºber allem */
        .modal {
            z-index: 2000;
        }

        .stellaris-btn {
            background: linear-gradient(135deg, var(--stellaris-blue) 0%, var(--stellaris-accent) 100%);
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 212, 255, 0.3);
            font-family: 'Exo 2', sans-serif;
        }

        .stellaris-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 212, 255, 0.5);
        }

        .stellaris-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .stellaris-btn-secondary {
            background: linear-gradient(135deg, #4a5568 0%, #2d3748 100%);
            box-shadow: 0 4px 15px rgba(74, 85, 104, 0.3);
        }

        .stellaris-btn-secondary:hover {
            box-shadow: 0 6px 20px rgba(74, 85, 104, 0.5);
        }

        .stellaris-btn-danger {
            background: linear-gradient(135deg, #f56565 0%, #c53030 100%);
            box-shadow: 0 4px 15px rgba(245, 101, 101, 0.3);
        }

        .stellaris-btn-danger:hover {
            box-shadow: 0 6px 20px rgba(245, 101, 101, 0.5);
        }

        .stellaris-btn-success {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            box-shadow: 0 4px 15px rgba(72, 187, 120, 0.3);
        }

        .stellaris-btn-success:hover {
            box-shadow: 0 6px 20px rgba(72, 187, 120, 0.5);
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, var(--stellaris-blue), var(--stellaris-purple));
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--stellaris-gold);
            font-size: 0.9rem;
        }

        .multi-system-layout {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 1.5rem;
            min-height: 600px;
        }

        .system-list-panel {
            border-right: 2px solid var(--stellaris-border);
            padding-right: 1.5rem;
        }

        .planet-item {
            background: linear-gradient(145deg, rgba(74, 85, 104, 0.4) 0%, rgba(45, 55, 72, 0.6) 100%);
            border: 1px solid var(--stellaris-border);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            transition: all 0.2s ease;
        }

        .planet-item:hover {
            border-color: var(--stellaris-blue);
            box-shadow: 0 0 15px rgba(0, 212, 255, 0.2);
        }

        .moon-item {
            background: rgba(45, 55, 72, 0.6);
            border-left: 3px solid var(--stellaris-purple);
            padding: 0.5rem;
            margin-left: 2rem;
            margin-top: 0.5rem;
            border-radius: 4px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 3000;  /* GE√ÑNDERT: von 2000 auf 3000 */
            justify-content: center;
            align-items: center;
            overflow-y: auto;
            padding: 2rem;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--stellaris-panel);
            border: 2px solid var(--stellaris-border);
            border-radius: 12px;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            padding: 2rem;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6);
            position: relative;           /* NEU */
            z-index: 3001;                /* NEU */
        }
        
        /* NEU: Dropdown-Verbesserungen */
        .modal-content select {
            position: relative;
            z-index: 3002;
        }
        
        .stellaris-input option,
        .stellaris-input optgroup {
            background-color: #2a3847 !important;
            color: #e2e8f0 !important;
            padding: 8px 12px;
        }
        
        .stellaris-input optgroup {
            font-weight: bold;
            background-color: #1e2936 !important;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .hidden {
            display: none !important;
        }

        /* ===== VISUALIZATION CANVAS ===== */
        .visualization-container {
            position: relative;
            background: linear-gradient(135deg, #0a0e1a 0%, #1a1f2e 100%);
            border: 2px solid var(--stellaris-border);
            border-radius: 12px;
            overflow: hidden;
            height: 600px;
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.4),
                inset 0 0 100px rgba(0, 212, 255, 0.05);
        }
        
        #systemCanvas {
            display: block;
            width: 100%;
            height: 100%;
            cursor: grab;
        }
        
        #systemCanvas:active {
            cursor: grabbing;
        }
        
        .canvas-controls {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(26, 35, 50, 0.95);
            border: 1px solid var(--stellaris-border);
            border-radius: 8px;
            padding: 10px;
            z-index: 10;
            backdrop-filter: blur(10px);
        }
        
        .canvas-info {
            position: absolute;
            bottom: 15px;
            left: 15px;
            background: rgba(26, 35, 50, 0.95);
            border: 1px solid var(--stellaris-border);
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 0.75rem;
            z-index: 10;
            color: var(--stellaris-blue);
            font-family: 'Orbitron', monospace;
        }
    </style>
</head>
<body>
    <div class="container mx-auto py-8 px-4">
        <h1 class="stellaris-header">üåå Stellaris Solar System Editor V27</h1>
        <div class="text-center mb-6">
            <span class="text-yellow-400 font-semibold">‚≠ê Full Editor - Edit systems, planets, and neighbors</span>
        </div>

        <!-- Import Section -->
        <div class="stellaris-panel mb-6">
            <h2 class="text-xl font-bold mb-4 text-blue-300">üìÇ Import/Export System</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="label">Load System-File (.txt)</label>
                    <input type="file" id="importFile" class="stellaris-input" accept=".txt" style="padding: 0.5rem;">
                </div>
                <div class="flex items-end gap-2">
                    <button id="importBtn" class="stellaris-btn">Import System(s)</button>
                    <button id="clearAllBtn" class="stellaris-btn stellaris-btn-secondary">Remove all</button>
                </div>
                <div class="flex items-end">
                    <button id="exportAllBtn" class="stellaris-btn stellaris-btn-secondary">Export all</button>
                </div>
            </div>
            
            <div class="mt-4 p-3 bg-purple-900/20 rounded-lg border border-purple-500/30">
                <label class="flex items-center gap-2 cursor-pointer">
                    <input type="checkbox" id="skipLocalizationCheckbox" class="w-4 h-4 rounded border-purple-500 bg-gray-700 text-purple-600 focus:ring-purple-500">
                    <span class="text-purple-300">
                        <span class="font-semibold">üìù Skip localization file</span> 
                        <span class="text-gray-400 text-sm">(Use if localization already exists in your mod)</span>
                    </span>
                </label>
            </div>
            
            <div id="importInfo" class="mt-4 p-3 bg-blue-900/30 rounded-lg border border-blue-500/30 hidden">
                <p class="text-blue-300 font-semibold">‚úÖ Imported: <span id="systemCount">0</span> System(s)</p>
            </div>
        </div>

        <!-- Multi-System Layout -->
        <div class="multi-system-layout">
            <!-- Left Panel: System List -->
            <div class="system-list-panel">
                <div class="stellaris-panel">
                    <h2 class="text-lg font-bold mb-4 text-purple-300">üåü Loaded Systems</h2>
                    <div id="systemList" class="space-y-2">
                        <p class="text-gray-400 text-sm">No systems loaded.</p>
                    </div>
                    <button id="addNewSystemBtn" class="stellaris-btn stellaris-btn-secondary mt-4 w-full text-sm py-2">
                        ‚ûï Create New System
                    </button>
                </div>
            </div>

            <!-- Right Panel: System Editor -->
            <div class="system-editor-panel">
                <div id="systemEditorContent">
                    <div class="stellaris-panel text-center py-12">
                        <p class="text-gray-400 text-lg">üëà Select a system from the list or import a file</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Export Preview Modal -->
        <div id="exportPreview" class="modal">
            <div class="modal-content">
                <h2 class="text-2xl font-bold mb-4 text-green-300">üìã Export Preview</h2>
                <textarea id="exportTextarea" class="stellaris-input font-mono text-sm" rows="20" readonly></textarea>
                <div class="mt-4 flex gap-2">
                    <button id="downloadExportBtn" class="stellaris-btn">üíæ Download Files</button>
                    <button id="copyExportBtn" class="stellaris-btn stellaris-btn-secondary">üìã Copy to Clipboard</button>
                    <button id="closePreviewBtn" class="stellaris-btn stellaris-btn-secondary">‚úï Close</button>
                </div>
            </div>
        </div>

        <!-- Add/Edit Planet Modal -->
        <div id="planetModal" class="modal">
            <div class="modal-content">
                <h2 class="text-2xl font-bold mb-4 text-blue-300" id="planetModalTitle">üåç Add Planet</h2>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label class="label">Planet-Name</label>
                        <input type="text" id="planetName" class="stellaris-input" placeholder="z.B. Earth">
                    </div>
                    <div class="form-group">
                        <label class="label">Planet class</label>
                        <select id="planetClass" class="stellaris-input" onchange="window.toggleCustomPlanetClass()">
                            <optgroup label="‚≠ê Stars">
                                <option value="pc_g_star">G-Star (Yellow)</option>
                                <option value="pc_k_star">K-Star (Orange)</option>
                                <option value="pc_m_star">M-Star (Red)</option>
                                <option value="pc_f_star">F-Star (Yellowish-White)</option>
                                <option value="pc_a_star">A-Star (White)</option>
                                <option value="pc_b_star">B-Star (Blue)</option>
                                <option value="pc_o_star">O-Star (Blue)</option>
                                <option value="pc_black_hole">Black Hole</option>
                                <option value="pc_neutron_star">Neutron Star</option>
                                <option value="pc_pulsar">Pulsar</option>
                            </optgroup>
                            <optgroup label="Habitable Planets">
                                <option value="pc_continental">Continental</option>
                                <option value="pc_ocean">Ocean</option>
                                <option value="pc_desert">Desert</option>
                                <option value="pc_tropical">Tropical</option>
                                <option value="pc_arid">Arid</option>
                                <option value="pc_tundra">Tundra</option>
                                <option value="pc_arctic">Arctic</option>
                                <option value="pc_alpine">Alpine</option>
                                <option value="pc_savannah">Savannah</option>
                            </optgroup>
                            <optgroup label="Unique Planets">
                                <option value="pc_gaia">Gaia</option>
                                <option value="pc_machine">Machine World</option>
                                <option value="pc_hive">Hive World</option>
                            </optgroup>
                            <optgroup label="Uninhabitable Planets">
                                <option value="pc_gas_giant">Gas Giant</option>
                                <option value="pc_molten">Molten</option>
                                <option value="pc_barren">Barren</option>
                                <option value="pc_barren_cold">Barren (Cold)</option>
                                <option value="pc_toxic">Toxic</option>
                                <option value="pc_frozen">Frozen</option>
                            </optgroup>
                            <optgroup label="Destroyed/Special Worlds">
                                <option value="pc_nuked">Nuked (Tomb World)</option>
                                <option value="pc_shattered">Shattered</option>
                                <option value="pc_shattered_2">Shattered 2</option>
                                <option value="pc_broken">Broken</option>
                                <option value="pc_shrouded">Shrouded</option>
                                <option value="pc_shielded">Shielded</option>
                                <option value="pc_relic">Relic World</option>
                                <option value="pc_city">Ecumenopolis</option>
                                <option value="pc_habitat">Habitat</option>
                            </optgroup>
                            <optgroup label="Exotic">
                                <option value="pc_volcanic">Volcanic</option>
                                <option value="pc_gray_goo">Gray Goo</option>
                                <option value="pc_ai">AI World</option>
                                <option value="pc_cybrex">Cybrex World</option>
                            </optgroup>
                            <optgroup label="Asteroiden">
                                <option value="pc_asteroid">Asteroid</option>
                                <option value="pc_ice_asteroid">Ice Asteroid</option>
                                <option value="pc_rare_crystal_asteroid">Rare Crystal Asteroid</option>
                                <option value="pc_crystal_asteroid">Crystal Asteroid</option>
                            </optgroup>
                            <optgroup label="Custome">
                                <option value="CUSTOM">üîß Custom Class...</option>
                                </select>
                                <!-- ‚úÖ NEW: Custom class input -->
                                <input type="text" id="planetClassCustom" class="stellaris-input mt-2 hidden" placeholder="Enter custom class (e.g. pc_my_planet)">
                            </optgroup>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="label">Size (5-50)</label>
                        <input type="number" id="planetSize" class="stellaris-input" value="16" min="5" max="50">
                    </div>
                    <div class="form-group">
                        <label class="label">Orbit Distance</label>
                        <input type="number" id="planetOrbit" class="stellaris-input" value="25" min="0" max="200">
                    </div>
                    <div class="form-group" style="grid-column: span 2;">
                        <label class="label">Orbit Angle Mode</label>
                        <select id="orbitAngleMode" class="stellaris-input" onchange="window.toggleOrbitAngleFields()">
                            <option value="preset">Preset (Fixed Angle)</option>
                            <option value="range">Range (Min/Max)</option>
                        </select>
                    </div>

                    <div id="orbitAnglePreset" class="form-group" style="grid-column: span 2;">
                        <label class="label">Orbit Angle</label>
                        <select id="planetAnglePreset" class="stellaris-input">
                            <option value="0">0¬∞ (Top)</option>
                            <option value="60">60¬∞</option>
                            <option value="90" selected>90¬∞ (Right)</option>
                            <option value="120">120¬∞</option>
                            <option value="180">180¬∞ (Bottom)</option>
                            <option value="240">240¬∞</option>
                            <option value="270">270¬∞ (Left)</option>
                            <option value="300">300¬∞</option>
                        </select>
                    </div>

                    <div id="orbitAngleRange" class="hidden" style="grid-column: span 2;">
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="label">Min (¬∞)</label>
                                <input type="number" id="planetAngleMin" class="stellaris-input" value="90" min="0" max="360">
                            </div>
                            <div>
                                <label class="label">Max (¬∞)</label>
                                <input type="number" id="planetAngleMax" class="stellaris-input" value="270" min="0" max="360">
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="label">Change Orbit</label>
                        <input type="number" id="planetChangeOrbit" class="stellaris-input" value="0" min="0" max="20">
                    </div>
                    <div class="form-group flex items-center">
                        <label class="flex items-center cursor-pointer">
                            <input type="checkbox" id="planetHasRing" class="mr-2">
                            <span class="text-gray-300">Planet has Ring</span>
                        </label>
                    </div>
                    <div class="form-group flex items-center">
                        <label class="flex items-center cursor-pointer">
                            <input type="checkbox" id="planetIsStarting" class="mr-2">
                            <span class="text-gray-300">üè† Starting Planet</span>
                        </label>
                    </div>
                    <div class="form-group flex items-center">
                        <label class="flex items-center cursor-pointer">
                            <input type="checkbox" id="planetIsHomePlanet" class="mr-2">
                            <span class="text-gray-300">üåç Home Planet (Random Empire)</span>
                        </label>
                    </div>
                    <div class="form-group flex items-center">
                        <label class="flex items-center cursor-pointer">
                            <input type="checkbox" id="planetIsGuaranteedHabitable" class="mr-2">
                            <span class="text-gray-300">üåø Garantierter bewohnbarer Planet</span>
                        </label>
                    </div>
                </div>

                <!-- Modifier System -->
                <div class="mt-6 p-4 bg-gradient-to-br from-green-900/30 to-emerald-900/20 rounded-lg border border-green-700/50">
                    <h3 class="text-lg font-semibold text-green-300 mb-3 flex items-center">
                        üåø Smart Planet Modifier System
                    </h3>
                    
                    <div class="bg-blue-900/20 border border-blue-700/30 rounded p-3 mb-4 text-sm">
                        <p class="text-blue-300 mb-1"><strong>Planetary Diversity:</strong> Shows only compatible modifiers for selected base planet class</p>
                        <p class="text-blue-200"><strong>Others:</strong> Standard modifiers work with all classes</p>
                    </div>

                    <div class="mb-4">
                        <p id="modifierStatusText" class="text-gray-400 text-sm mb-3">No modifiers selected</p>
                        <div id="selectedModifiersList" class="space-y-2">
                            <!-- Selected modifiers will be displayed here -->
                        </div>
                    </div>

                    <div class="bg-slate-800/50 p-3 rounded border border-slate-700">
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
                            <div>
                                <label class="label text-xs">MODIFIER CATEGORY</label>
                                <select id="modifierCategory" class="stellaris-input text-sm" onchange="window.updateModifierOptions()">
                                    <option value="">-- Select Category --</option>
                                    <option value="resources">Resource Modifiers</option>
                                    <option value="planetary">Planetary Features</option>
                                    <option value="deposits">Deposits</option>
                                    <option value="anomalies">Anomalies</option>
                                    <option value="special">Special Modifiers</option>
                                    <option value="pd_terraforming">PD: Terraforming</option>
                                    <option value="pd_climate">PD: Climate</option>
                                    <option value="pd_unique">PD: Unique</option>
                                </select>
                            </div>
                            <div>
                                <label class="label text-xs">MODIFIER</label>
                                <select id="modifierSelection" class="stellaris-input text-sm" disabled>
                                    <option value="">-- Select Modifier --</option>
                                </select>
                            </div>
                        </div>
                        
                        <button id="addModifierBtn" class="stellaris-btn stellaris-btn-success w-full" onclick="window.addModifierToPlanet()" disabled>
                            ADD MODIFIER
                        </button>
                        
                        <!-- ‚úÖ NEW: Custom Modifier Input -->
                        <div class="mt-3 p-3 bg-purple-900/20 rounded border border-purple-500/30">
                            <label class="label text-xs">OR ENTER CUSTOM MODIFIER</label>
                            <input type="text" id="customModifierInput" class="stellaris-input text-sm" placeholder="e.g. pm_custom_modifier">
                            <button class="stellaris-btn stellaris-btn-secondary w-full mt-2 text-sm" onclick="window.addCustomModifierToPlanet()">
                                ‚ûï Add Custom Modifier
                            </button>
                        </div>
                    </div>
                </div>

                <!-- ‚úÖ NEW: Deposit Management -->
                <div class="mt-4">
                    <h3 class="text-lg font-bold mb-2 text-yellow-300">üíé Deposits</h3>
                    <div class="p-3 bg-gray-800/50 rounded-lg border border-gray-700">
                        <div id="selectedDepositsList" class="mb-3 min-h-[40px]">
                            <!-- Deposits will be listed here -->
                        </div>
                        <p id="depositStatusText" class="text-xs text-gray-400 mb-3">No deposits added</p>
                        
                        <div class="mb-2">
                            <label class="label text-xs">SELECT DEPOSIT</label>
                            <select id="depositSelection" class="stellaris-input text-sm">
                                <option value="">-- Select Deposit --</option>
                                <optgroup label="Resources">
                                    <option value="d_minerals_1">Minerals +1</option>
                                    <option value="d_minerals_2">Minerals +2</option>
                                    <option value="d_minerals_3">Minerals +3</option>
                                    <option value="d_minerals_4">Minerals +4</option>
                                    <option value="d_energy_1">Energy +1</option>
                                    <option value="d_energy_2">Energy +2</option>
                                    <option value="d_energy_3">Energy +3</option>
                                    <option value="d_alloys_1">Alloys +1</option>
                                    <option value="d_alloys_2">Alloys +2</option>
                                </optgroup>
                                <optgroup label="Strategic">
                                    <option value="d_exotic_gases_1">Exotic Gases +1</option>
                                    <option value="d_rare_crystals_1">Rare Crystals +1</option>
                                    <option value="d_volatile_motes_1">Volatile Motes +1</option>
                                    <option value="d_zro_deposit_1">Zro +1</option>
                                    <option value="d_dark_matter_deposit_1">Dark Matter +1</option>
                                </optgroup>
                            </select>
                        </div>
                        
                        <button class="stellaris-btn stellaris-btn-success w-full text-sm mb-2" onclick="window.addDepositToPlanet()">
                            ADD DEPOSIT
                        </button>
                        
                        <div class="p-2 bg-purple-900/20 rounded border border-purple-500/30">
                            <label class="label text-xs">OR CUSTOM DEPOSIT</label>
                            <input type="text" id="customDepositInput" class="stellaris-input text-sm" placeholder="e.g. d_custom_deposit">
                            <button class="stellaris-btn stellaris-btn-secondary w-full mt-2 text-sm" onclick="window.addCustomDepositToPlanet()">
                                ‚ûï Add Custom Deposit
                            </button>
                        </div>
                    </div>
                </div>

                <div class="mt-6 flex gap-2">
                    <button id="savePlanetBtn" class="stellaris-btn stellaris-btn-success">üíæ Save</button>
                    <button id="cancelPlanetBtn" class="stellaris-btn stellaris-btn-secondary">‚úï Cancel</button>
                </div>
            </div>
        </div>

        <!-- Add/Edit Moon Modal -->
        <div id="moonModal" class="modal">
            <div class="modal-content">
                <h2 class="text-2xl font-bold mb-4 text-purple-300" id="moonModalTitle">üåô Add Moon</h2>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label class="label">Moon-Name</label>
                        <input type="text" id="moonName" class="stellaris-input" placeholder="z.B. Luna">
                    </div>
                    <div class="form-group">
                        <label class="label">Moon Class</label>
                        <select id="moonClass" class="stellaris-input">
                            <optgroup label="Habitable Moons">
                                <option value="pc_continental">Continental</option>
                                <option value="pc_ocean">Ocean</option>
                                <option value="pc_desert">Desert</option>
                                <option value="pc_tropical">Tropical</option>
                                <option value="pc_arid">Arid</option>
                                <option value="pc_tundra">Tundra</option>
                                <option value="pc_arctic">Arctic</option>
                                <option value="pc_alpine">Alpine</option>
                                <option value="pc_savannah">Savannah</option>
                            </optgroup>
                            <optgroup label="Unique Moons">
                                <option value="pc_gaia">Gaia</option>
                                <option value="pc_machine">Machine World</option>
                                <option value="pc_hive">Hive World</option>
                            </optgroup>
                            <optgroup label="Uninhabitable Moons">
                                <option value="pc_gas_giant">Gas Giant</option>
                                <option value="pc_molten">Molten</option>
                                <option value="pc_barren">Barren</option>
                                <option value="pc_barren_cold">Barren (Cold)</option>
                                <option value="pc_toxic">Toxic</option>
                                <option value="pc_frozen">Frozen</option>
                            </optgroup>
                            <optgroup label="Destroyed/Special Worlds">
                                <option value="pc_nuked">Nuked (Tomb World)</option>
                                <option value="pc_shattered">Shattered</option>
                                <option value="pc_shattered_2">Shattered 2</option>
                                <option value="pc_broken">Broken</option>
                                <option value="pc_shrouded">Shrouded</option>
                                <option value="pc_shielded">Shielded</option>
                                <option value="pc_relic">Relic World</option>
                            </optgroup>
                            <optgroup label="Asteroids">
                                <option value="pc_asteroid">Asteroid</option>
                                <option value="pc_ice_asteroid">Ice Asteroid</option>
                                <option value="pc_rare_crystal_asteroid">Rare Crystal Asteroid</option>
                                <option value="pc_crystal_asteroid">Crystal Asteroid</option>
                            </optgroup>
                            <optgroup label="Custome">
                                <option value="CUSTOM">üîß Custom Class...</option>
                                </select>
                                <!-- ‚úÖ NEW: Custom class input -->
                                <input type="text" id="moonClassCustom" class="stellaris-input mt-2 hidden" placeholder="Enter custom class (e.g. pc_my_moon)">
                            </optgroup>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="label">Size (3-50)</label>
                        <input type="number" id="moonSize" class="stellaris-input" value="8" min="3" max="50">
                    </div>
                    <div class="form-group">
                        <label class="label">Orbit Distance from Planet</label>
                        <input type="number" id="moonOrbit" class="stellaris-input" value="10" min="5" max="30">
                    </div>

                    <div class="form-group" style="grid-column: span 2;">
                        <label class="label">Orbit Angle Mode</label>
                        <select id="moonOrbitAngleMode" class="stellaris-input" onchange="window.toggleMoonOrbitAngleFields()">
                            <option value="preset">Preset (Fixed Angle)</option>
                            <option value="range">Range (Min/Max)</option>
                        </select>
                    </div>

                    <div id="moonOrbitAnglePreset" class="form-group" style="grid-column: span 2;">
                        <label class="label">Orbit Angle</label>
                        <select id="moonAnglePreset" class="stellaris-input">
                            <option value="0">0¬∞ (Top)</option>
                            <option value="60">60¬∞</option>
                            <option value="90" selected>90¬∞ (Right)</option>
                            <option value="120">120¬∞</option>
                            <option value="180">180¬∞ (Bottom)</option>
                            <option value="240">240¬∞</option>
                            <option value="270">270¬∞ (Left)</option>
                            <option value="300">300¬∞</option>
                        </select>
                    </div>

                    <div id="moonOrbitAngleRange" class="hidden" style="grid-column: span 2;">
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="label">Min (¬∞)</label>
                                <input type="number" id="moonAngleMin" class="stellaris-input" value="90" min="0" max="360">
                            </div>
                            <div>
                                <label class="label">Max (¬∞)</label>
                                <input type="number" id="moonAngleMax" class="stellaris-input" value="270" min="0" max="360">
                            </div>
                        </div>
                    </div>
                    
                    <!-- NEW: Starting Planet Checkbox for Moons -->
                    <div class="form-group" style="grid-column: span 2;">
                        <label class="flex items-center cursor-pointer">
                            <input type="checkbox" id="moonIsStarting" class="mr-2" style="width: auto;">
                            <span class="text-gray-300">üè† Mark moon as starting planet</span>
                        </label>
                        <p class="text-xs text-gray-400 mt-1">
                            For habitable moons like Sleipnir (Asgard system)
                        </p>
                    </div>
                    <div class="form-group" style="grid-column: span 2;">
                        <label class="flex items-center cursor-pointer">
                            <input type="checkbox" id="moonIsGuaranteedHabitable" class="mr-2" style="width: auto;">
                            <span class="text-gray-300">üåç Mark moon as guaranteed habitable world</span>
                        </label>
                        <p class="text-xs text-gray-400 mt-1">
                            For habitable moons, which are considered ideal colony targets
                        </p>
                    </div>
                </div>

                <!-- Modifier System f√ºr Monde -->
                <div class="mt-6 p-4 bg-gradient-to-br from-purple-900/30 to-pink-900/20 rounded-lg border border-purple-700/50">
                    <h3 class="text-lg font-semibold text-purple-300 mb-3 flex items-center">
                        üåô Moon Modifier System
                    </h3>
                    
                    <div class="bg-blue-900/20 border border-blue-700/30 rounded p-3 mb-4 text-sm">
                        <p class="text-blue-300">Moons can have the same modifiers as planets.</p>
                    </div>

                    <div class="mb-4">
                        <p id="moonModifierStatusText" class="text-gray-400 text-sm mb-3">No modifiers selected</p>
                        <div id="selectedMoonModifiersList" class="space-y-2">
                            <!-- Selected modifiers will be displayed here -->
                        </div>
                    </div>

                    <div class="bg-slate-800/50 p-3 rounded border border-slate-700">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
                            <div>
                                <label class="label text-xs">MODIFIER CATEGORY</label>
                                <select id="moonModifierCategory" class="stellaris-input text-sm" onchange="window.updateMoonModifierOptions()">
                                    <option value="">-- Select Category --</option>
                                    <option value="resources">Resource Modifiers</option>
                                    <option value="planetary">Planetary Features</option>
                                    <option value="deposits">Deposits</option>
                                    <option value="anomalies">Anomalies</option>
                                    <option value="special">Special Modifiers</option>
                                    <option value="pd_terraforming">PD: Terraforming</option>
                                    <option value="pd_climate">PD: Climate</option>
                                    <option value="pd_unique">PD: Unique</option>
                                </select>
                            </div>
                            <div>
                                <label class="label text-xs">MODIFIER</label>
                                <select id="moonModifierSelection" class="stellaris-input text-sm" disabled>
                                    <option value="">-- Select Modifier --</option>
                                </select>
                            </div>
                        </div>
                        
                        <button id="addMoonModifierBtn" class="stellaris-btn stellaris-btn-success w-full" onclick="window.addModifierToMoon()" disabled>
                            ADD MODIFIER
                        </button>
                        
                        <!-- ‚úÖ NEW: Custom Modifier Input for Moons -->
                        <div class="mt-3 p-3 bg-purple-900/20 rounded border border-purple-500/30">
                            <label class="label text-xs">OR ENTER CUSTOM MODIFIER</label>
                            <input type="text" id="customMoonModifierInput" class="stellaris-input text-sm" placeholder="e.g. pm_custom_modifier">
                            <button class="stellaris-btn stellaris-btn-secondary w-full mt-2 text-sm" onclick="window.addCustomModifierToMoon()">
                                ‚ûï Add Custom Modifier
                            </button>
                        </div>
                    </div>
                </div>

                <div class="mt-6 flex gap-2">
                    <button id="saveMoonBtn" class="stellaris-btn stellaris-btn-success">üíæ Save</button>
                    <button id="cancelMoonBtn" class="stellaris-btn stellaris-btn-secondary">‚úï Cancel</button>
                </div>
            </div>
        </div>

        <!-- Add Neighbor System Modal -->
        <div id="neighborModal" class="modal">
            <div class="modal-content">
                <h2 class="text-2xl font-bold mb-4 text-yellow-300">üîó Add Neighbor System</h2>
                
                <div class="mb-4 p-3 bg-blue-900/30 rounded-lg border border-blue-500/30">
                    <p class="text-sm text-gray-300">
                        <strong>üí° Note:</strong> The system identifier will be automatically generated from the main system name and display name.
                    </p>
                </div>

                <div class="form-group">
                    <label class="label">Display Name of Neighbor System</label>
                    <div class="mb-4">
                        <label class="label">Select Neighbor System</label>
                        <select id="neighborSystemSelect" class="stellaris-input mb-2">
                            <option value="">-- Select from List --</option>
                        </select>
                        <p class="text-xs text-gray-400">Or enter manually:</p>
                    </div>
                    
                    <input type="text" id="neighborDisplayName" class="stellaris-input" placeholder="z.B. Apsu">
                    <p class="text-xs text-gray-400 mt-1">Will be converted to: <span id="neighborPreviewIdentifier" class="text-blue-300">-</span></p>
                </div>

               <div class="form-grid mt-4">
                    <div class="form-group">
                        <label class="label">Hyperlane Jumps (Min)</label>
                        <input type="number" id="neighborJumpsMin" class="stellaris-input" value="1" min="1" max="10">
                    </div>
                    <div class="form-group">
                        <label class="label">Hyperlane Jumps (Max)</label>
                        <input type="number" id="neighborJumpsMax" class="stellaris-input" value="3" min="1" max="10">
                    </div>
                </div>

                <!-- ‚úÖ NEW: Advanced Neighbor Parameters -->
                <div class="mt-4 p-4 bg-blue-900/20 rounded-lg border border-blue-500/30">
                    <h3 class="text-lg font-bold mb-3 text-blue-300">‚öôÔ∏è Advanced Parameters</h3>
                    
                    <!-- Distance -->
                    <div class="mb-3">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="neighborUseDistance" class="stellaris-checkbox">
                            <span class="text-sm font-semibold">Euclidean Distance</span>
                        </label>
                        <input type="number" id="neighborDistance" class="stellaris-input text-sm mt-1" value="50" min="1" max="500" disabled>
                        <p class="text-xs text-gray-400 mt-1">Straight-line distance between systems</p>
                    </div>
                    
                    <!-- Orientation Angles -->
                    <div class="mb-3">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="neighborUseOrientation" class="stellaris-checkbox">
                            <span class="text-sm font-semibold">Orientation Angles</span>
                        </label>
                        <div class="grid grid-cols-2 gap-2 mt-1">
                            <div>
                                <label class="text-xs text-gray-400">Min Angle</label>
                                <input type="number" id="neighborMinOrientation" class="stellaris-input text-sm" value="0" min="0" max="360" disabled>
                            </div>
                            <div>
                                <label class="text-xs text-gray-400">Max Angle</label>
                                <input type="number" id="neighborMaxOrientation" class="stellaris-input text-sm" value="360" min="0" max="360" disabled>
                            </div>
                        </div>
                        <p class="text-xs text-gray-400 mt-1">Precise location control (0-360¬∞)</p>
                    </div>
                    
                    <!-- Hyperlane Distance -->
                    <div class="mb-3">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="neighborUseHyperlaneDistance" class="stellaris-checkbox">
                            <span class="text-sm font-semibold">Hyperlane Distance</span>
                        </label>
                        <input type="number" id="neighborHyperlaneDistance" class="stellaris-input text-sm mt-1" value="3" min="1" max="20" disabled>
                        <p class="text-xs text-gray-400 mt-1">Total distance via hyperlanes</p>
                    </div>
                    
                    <!-- Spawn Chance -->
                    <div class="mb-3">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="neighborUseSpawnChance" class="stellaris-checkbox">
                            <span class="text-sm font-semibold">Spawn Chance</span>
                        </label>
                        <input type="number" id="neighborSpawnChance" class="stellaris-input text-sm mt-1" value="100" min="0" max="100" disabled>
                        <p class="text-xs text-gray-400 mt-1">Probability of neighbor spawning (0-100%)</p>
                    </div>
                </div>

                <div class="mt-6 flex gap-2">
                    <button id="saveNeighborBtn" class="stellaris-btn stellaris-btn-success">üíæ Save</button>
                    <button id="cancelNeighborBtn" class="stellaris-btn stellaris-btn-secondary">‚úï Cancel</button>
                </div>
            </div>
        </div>

            <!-- Star Configuration Wizard Modal -->
            <div id="starConfigModal" class="modal">
                <div class="modal-content" style="max-width: 700px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="margin: 0; color: var(--stellaris-accent);">üåü Star Configuration Wizard</h2>
                        <button onclick="closeStarConfigWizard()" class="modal-close" style="background: none; border: none; font-size: 28px; cursor: pointer; color: #94a3b8;">&times;</button>
                    </div>

                    <div style="background: rgba(0, 212, 255, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid var(--stellaris-accent);">
                        <p style="margin: 0; color: #94a3b8;">
                            <strong>Selected Star Class:</strong> <span id="wizardStarClassName" style="color: var(--stellaris-accent);">-</span><br>
                            <strong>Number of Stars:</strong> <span id="wizardStarCount" style="color: var(--stellaris-accent);">-</span>
                        </p>
                    </div>

                    <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
                        <button onclick="resetStarAngles()" class="stellaris-btn stellaris-btn-secondary" style="flex: 1; min-width: 150px;">
                            üîÑ Reset to Smart Distribution
                        </button>
                        <button onclick="randomizeStarAngles()" class="stellaris-btn stellaris-btn-secondary" style="flex: 1; min-width: 150px;">
                            üé≤ Randomize Angles
                        </button>
                    </div>

                    <div id="starConfigList" style="max-height: 400px; overflow-y: auto; margin-bottom: 20px;">
                        <!-- Stars will be dynamically added here -->
                    </div>

                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button onclick="closeStarConfigWizard()" class="stellaris-btn stellaris-btn-secondary">‚ùå Cancel</button>
                        <button onclick="applyStarConfiguration()" class="stellaris-btn stellaris-btn-success">‚úÖ Apply Configuration</button>
                    </div>
                </div>
            </div>
            
            <!-- System Properties Modal -->
            <div id="systemPropertiesModal" class="modal">
                <div class="modal-content">
                    <h2 class="text-2xl font-bold mb-4 text-purple-300">‚öôÔ∏è Edit System Properties</h2>

                    <!-- ‚úÖ NEW: System Identifier field -->
                    <div class="form-group mb-4">
                        <label class="label">System Identifier (Internal Name)</label>
                        <input type="text" id="systemIdentifier" class="stellaris-input" placeholder="e.g. my_custom_system_initializer">
                        <p class="text-xs text-gray-400 mt-1">üí° Must end with "_system_initializer" for proper export/import</p>
                    </div>
                    
                    <div class="form-group mb-4">
                        <label class="label">System Display Name</label>
                        <input type="text" id="systemDisplayName" class="stellaris-input" placeholder="e.g. Sol System">
                    </div>

                    <div class="form-group mb-4">
                        <label class="label">Star Class</label>
                        <select id="systemStarClass" class="stellaris-input" onchange="window.toggleCustomStarClass()">
                            <optgroup label="‚≠ê Main Sequence Stars">
                                <option value="sc_o">O-Star (Hot Blue)</option>
                                <option value="sc_b">B-Star (Blue)</option>
                                <option value="sc_a">A-Star (White)</option>
                                <option value="sc_f">F-Star (Yellow-White)</option>
                                <option value="sc_g" selected>G-Star (Yellow - Sun-like)</option>
                                <option value="sc_k">K-Star (Orange)</option>
                                <option value="sc_m">M-Star (Red)</option>
                            </optgroup>
                            <optgroup label="üåë Special Objects">
                                <option value="sc_t">T-Star (Brown Dwarf)</option>
                                <option value="sc_black_hole">Black Hole</option>
                                <option value="sc_neutron_star">Neutron Star</option>
                                <option value="sc_pulsar">Pulsar</option>
                            </optgroup>
                            <optgroup label="üåü Binary Systems">
                                <option value="sc_binary_1">Binary 1 (Both Main Sequence)</option>
                                <option value="sc_binary_2">Binary 2 (Main Sequence + Compact)</option>
                                <option value="sc_binary_3">Binary 3 (Main Sequence + Neutron)</option>
                                <option value="sc_binary_4">Binary 4 (Both Compact)</option>
                                <option value="sc_binary_5">Binary 5 (Main Sequence + Black Hole)</option>
                                <option value="sc_binary_6">Binary 6 (Neutron + Black Hole)</option>
                                <option value="sc_binary_7">Binary 7 (Both Black Holes)</option>
                                <option value="sc_binary_8">Binary 8 (Both Neutron Stars)</option>
                                <option value="sc_binary_9">Binary 9 (Both Pulsars)</option>
                                <option value="sc_binary_10">Binary 10 (Pulsar + Black Hole)</option>
                            </optgroup>
                            <optgroup label="‚ú® Trinary Systems">
                                <option value="sc_trinary_1">Trinary 1 (Three Main Sequence)</option>
                                <option value="sc_trinary_2">Trinary 2 (Two Main Sequence + Compact)</option>
                                <option value="sc_trinary_3">Trinary 3 (Two Main Sequence + Neutron)</option>
                                <option value="sc_trinary_4">Trinary 4 (Main Sequence + Two Compact)</option>
                            </optgroup>
                            <optgroup label="üîß Custom">
                                <option value="CUSTOM">üîß Custom Star Class...</option>
                            </optgroup>
                        </select>
                    </div>

                    <div id="customStarClassField" class="form-group mb-4 hidden">
                        <label class="label">Custom Star Class</label>
                        <input type="text" id="customStarClassInput" class="stellaris-input" placeholder="e.g. sc_custom_star">
                        <p class="text-xs text-gray-400 mt-1">Enter a custom star class ID (e.g. for mods)</p>
                    </div>

                    <div class="form-group mb-4" id="starConfigWizardButton" style="display: none;">
                        <button onclick="openStarConfigWizard()" class="stellaris-btn stellaris-btn-secondary" style="width: 100%;">
                            üåü Configure Stars (Multi-Star System)
                        </button>
                    </div>

                    <div class="form-group mb-4">
                        <label class="label">Usage</label>
                        <select id="systemUsage" class="stellaris-input">
                            <option value="custom_empire">Custom Empire (Player Start)</option>
                            <option value="empire_init">Empire Init (AI Start)</option>
                            <option value="fallen_empire_init">Fallen Empire Init</option>
                            <option value="misc_system_init">Misc System Init (Random Galaxy)</option>
                            <option value="origin">Origin (Specific Origins)</option>
                            <option value="none">None (Neighbor-only, not selectable)</option>
                        </select>
                        <p class="text-xs text-gray-400 mt-1">üí° Tip: "Custom Empire" for player starts, "None" for neighbor-only systems</p>
                    </div>

                    <div class="form-group mb-4">
                        <label class="flex items-center cursor-pointer">
                            <input type="checkbox" id="systemMandatoryNeighbors" class="mr-2">
                            <span class="label mb-0">Enable Mandatory Neighbors</span>
                        </label>
                        <p class="text-xs text-gray-400 mt-1">If enabled: Game engine creates new systems if no matching ones are found</p>
                    </div>

                    <div class="form-group mb-4">
                        <label class="flex items-center cursor-pointer">
                            <input type="checkbox" id="systemGenerateHomeResources" class="mr-2" checked>
                            <span class="label mb-0">Generate Home System Resources</span>
                        </label>
                        <p class="text-xs text-gray-400 mt-1">If enabled: Automatically generates strategic resources near homeworld (recommended for player empires)</p>
                    </div>

                    <div class="mt-6 flex gap-2">
                        <button id="saveSystemPropertiesBtn" class="stellaris-btn stellaris-btn-success">üíæ Save</button>
                        <button id="cancelSystemPropertiesBtn" class="stellaris-btn stellaris-btn-secondary">‚úï Cancel</button>
                    </div>
                </div>
            </div>

        <!-- Add Asteroid Belt Modal -->
        <div id="asteroidBeltModal" class="modal">
            <div class="modal-content">
                <h2 class="text-2xl font-bold mb-4 text-yellow-300">‚òÑÔ∏è Add Asteroid Belt</h2>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label class="label">Belt Typ</label>
                        <select id="beltType" class="stellaris-input">
                            <option value="rocky_asteroid_belt">Rocky Asteroid Belt</option>
                            <option value="icy_asteroid_belt">Icy Asteroid Belt</option>
                            <option value="crystal_asteroid_belt">Crystal Asteroid Belt</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="label">Radius (30-1500)</label>
                        <input type="number" id="beltRadius" class="stellaris-input" value="90" min="30" max="1500">
                    </div>
                </div>

                <div class="mt-6 flex gap-2">
                    <button id="saveBeltBtn" class="stellaris-btn stellaris-btn-success">üíæ Save</button>
                    <button id="cancelBeltBtn" class="stellaris-btn stellaris-btn-secondary">‚úï Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // =====================================================
        // DATA MODEL & STATE
        // =====================================================

        // ==================== STAR CONFIGURATION DATABASE ====================
        
        const STAR_CLASS_CONFIG = {
            // Single Stars
            'sc_a': { count: 1, types: ['pc_a_star'] },
            'sc_b': { count: 1, types: ['pc_b_star'] },
            'sc_f': { count: 1, types: ['pc_f_star'] },
            'sc_g': { count: 1, types: ['pc_g_star'] },
            'sc_k': { count: 1, types: ['pc_k_star'] },
            'sc_m': { count: 1, types: ['pc_m_star'] },
            'sc_t': { count: 1, types: ['pc_t_star'] },
            'sc_black_hole': { count: 1, types: ['pc_black_hole'] },
            'sc_neutron_star': { count: 1, types: ['pc_neutron_star'] },
            'sc_pulsar': { count: 1, types: ['pc_pulsar'] },
            
            // Binary Systems
            'sc_binary_1': { count: 2, types: ['pc_g_star', 'pc_k_star'] },
            'sc_binary_2': { count: 2, types: ['pc_g_star', 'pc_m_star'] },
            'sc_binary_3': { count: 2, types: ['pc_g_star', 'pc_neutron_star'] },
            'sc_binary_4': { count: 2, types: ['pc_m_star', 'pc_m_star'] },
            'sc_binary_5': { count: 2, types: ['pc_g_star', 'pc_black_hole'] },
            'sc_binary_6': { count: 2, types: ['pc_neutron_star', 'pc_black_hole'] },
            'sc_binary_7': { count: 2, types: ['pc_black_hole', 'pc_black_hole'] },
            'sc_binary_8': { count: 2, types: ['pc_neutron_star', 'pc_neutron_star'] },
            'sc_binary_9': { count: 2, types: ['pc_pulsar', 'pc_pulsar'] },
            'sc_binary_10': { count: 2, types: ['pc_pulsar', 'pc_black_hole'] },
            
            // Trinary Systems
            'sc_trinary_1': { count: 3, types: ['pc_g_star', 'pc_k_star', 'pc_m_star'] },
            'sc_trinary_2': { count: 3, types: ['pc_g_star', 'pc_k_star', 'pc_m_star'] },
            'sc_trinary_3': { count: 3, types: ['pc_g_star', 'pc_k_star', 'pc_neutron_star'] },
            'sc_trinary_4': { count: 3, types: ['pc_g_star', 'pc_neutron_star', 'pc_black_hole'] }
        };
        
        // Calculate star orbits for multi-star systems
        function calculateStarOrbits(starCount) {
            if (starCount === 1) return [0];
            if (starCount === 2) return [0, 25];
            if (starCount === 3) return [0, 25, -50];
            return [0]; // Fallback
        }
        
        let allSystems = [];
        let currentSystemIndex = null;
        let editingPlanetId = null;
        let editingPlanetIndex = null;
        let editingMoonParentId = null;
        let editingMoonIndex = null;
        let editingMoonPlanetIndex = null;
        let nextPlanetId = 1;

        // ‚úÖ FIX: Default name now ends with _system_initializer for proper import/export compatibility
        function createEmptySystem(name = 'custom_system_initializer') {
            return {
                name: name,
                displayName: name.replace(/_/g, ' ').replace(/system initializer$/i, '').trim(),
                class: 'sc_g',
                usage: 'custom_empire',
                asteroidBelts: [],
                neighborSystems: [],
                planets: [],
                flags: [],
                isMain: false,
                mandatoryNeighbors: false,  // ‚úÖ NEU: Mandatory Neighbors Option
                generateHomeResources: true  // ‚úÖ FIX 9: Generate Home System Resources
            };
        }

        // Modifier Definitions
        const MODIFIER_DATABASE = {
            resources: {
                name: 'Ressourcen-Modifier',
                modifiers: [
                    { id: 'pm_planet_strong_magnetic_field', name: 'Starkes Magnetfeld', desc: '+2 Physik' },
                    { id: 'pm_natural_beauty', name: 'Nat√ºrliche Sch√∂nheit', desc: '+5% Annehmlichkeiten' },
                    { id: 'pm_atmospheric_hallucinogen', name: 'Atmosph√§risches Halluzinogen', desc: '+10% Gl√ºck' },
                    { id: 'pm_titanic_life', name: 'Titanisches Leben', desc: '+4 Gesellschaft' },
                    { id: 'pm_asteroid_belt', name: 'Asteroideng√ºrtel', desc: '+2 Mineralien' },
                    { id: 'pm_extensive_moon_system', name: 'Ausgedehntes Mondsystem', desc: '+2 Physik' }
                ]
            },
            planetary: {
                name: 'Planetare Features',
                modifiers: [
                    { id: 'pm_dangerous_wildlife', name: 'Gef√§hrliche Tierwelt', desc: 'Armeen -15%' },
                    { id: 'pm_lush', name: '√úppig', desc: '+25% Landwirtschaft' },
                    { id: 'pm_bleak', name: 'Trist', desc: '-10% Annehmlichkeiten' },
                    { id: 'pm_unstable_tectonics', name: 'Instabile Tektonik', desc: 'H√§user -20%' },
                    { id: 'pm_chthonian_planet', name: 'Chthonischer Planet', desc: 'Ehemaliger Gasriese' }
                ]
            },
            deposits: {
                name: 'Ablagerungen',
                modifiers: [
                    { id: 'd_mineral_rich', name: 'Reich an Mineralien', desc: '+3 Mineralien' },
                    { id: 'd_mineral_poor', name: 'Arm an Mineralien', desc: '-1 Mineralien' },
                    { id: 'd_rich_mountain', name: 'Reiche Berge', desc: '+4 Mineralien' },
                    { id: 'd_vast_sinkhole', name: 'Riesiges Erdloch', desc: '+6 Ingenieurwesen' },
                    { id: 'd_energy_rich', name: 'Reich an Energie', desc: '+3 Energie' },
                    { id: 'd_rare_crystals', name: 'Seltene Kristalle', desc: 'Kristalle' }
                ]
            },
            anomalies: {
                name: 'Anomalien',
                modifiers: [
                    { id: 'pm_ancient_reactor_pits', name: 'Alte Reaktorgruben', desc: 'Physik/Ingenieurwesen' },
                    { id: 'pm_asteroid_impacts', name: 'Asteroideneinschl√§ge', desc: 'Mineralien +2' },
                    { id: 'pm_buried_lithoids', name: 'Begrabene Lithoiden', desc: 'Mineralien +3' },
                    { id: 'pm_crashed_starship', name: 'Abgest√ºrztes Raumschiff', desc: 'Ingenieurwesen +3' }
                ]
            },
            special: {
                name: 'Spezielle Modifier',
                modifiers: [
                    { id: 'pm_carbon_world', name: 'Kohlenstoffwelt', desc: 'Diamant-Planet' },
                    { id: 'pm_class_star', name: 'Klasse-Stern', desc: 'Besondere Sternklasse' },
                    { id: 'pm_floating_landmass', name: 'Schwebende Landmasse', desc: 'Gravitationsanomalie' },
                    { id: 'pm_irradiated', name: 'Verstrahlt', desc: 'Radioaktiv' }
                ]
            },
            pd_terraforming: {
                name: 'PD: Terraforming',
                modifiers: [
                    { id: 'pm_pd_terraformed', name: 'Terraformiert', desc: 'PD Terraforming-Status' },
                    { id: 'pm_pd_terraform_candidate', name: 'Terraform-Kandidat', desc: 'F√ºr Terraforming geeignet' }
                ]
            },
            pd_climate: {
                name: 'PD: Klima',
                modifiers: [
                    { id: 'pm_pd_extreme_heat', name: 'Extreme Hitze', desc: 'PD Klimaeffekt' },
                    { id: 'pm_pd_extreme_cold', name: 'Extreme K√§lte', desc: 'PD Klimaeffekt' },
                    { id: 'pm_pd_high_gravity', name: 'Hohe Schwerkraft', desc: 'PD Schwerkraft' },
                    { id: 'pm_pd_low_gravity', name: 'Niedrige Schwerkraft', desc: 'PD Schwerkraft' }
                ]
            },
            pd_unique: {
                name: 'PD: Einzigartige',
                modifiers: [
                    { id: 'pm_pd_crystal_caverns', name: 'Kristallkavernen', desc: 'PD Einzigartig' },
                    { id: 'pm_pd_megaflora', name: 'Megaflora', desc: 'PD Riesenvegetation' },
                    { id: 'pm_pd_magnetic_storms', name: 'Magnetst√ºrme', desc: 'PD Magnetfeld' }
                ]
            }
        };

        // =====================================================
        // MULTI-SYSTEM PARSER (from V16)
        // =====================================================
        
        class MultiSystemParser {
            constructor() {
                this.starClasses = [
                    'pc_b_star', 'pc_a_star', 'pc_f_star', 'pc_g_star', 
                    'pc_k_star', 'pc_m_star', 
                    'pc_black_hole', 'pc_neutron_star', 'pc_pulsar',
                    'pc_t_star', 'pc_o_star', 'pc_toxoid_star', 'pc_rift_star'
                ];
            }

            parseMultipleSystems(fileContent) {
                const systems = [];
                // ‚úÖ FIX: Accept any top-level block that looks like a system initializer
                // Must start at beginning of line (no indentation) to avoid matching nested blocks
                const systemRegex = /^(\w+)\s*=\s*\{/gm;
                const matches = [];
                let match;
                
                while ((match = systemRegex.exec(fileContent)) !== null) {
                    matches.push({
                        name: match[1],
                        startIndex: match.index
                    });
                }
                
                for (let i = 0; i < matches.length; i++) {
                    const systemMatch = matches[i];
                    const startPos = fileContent.indexOf('{', systemMatch.startIndex);
                    
                    let endPos;
                    if (i < matches.length - 1) {
                        endPos = matches[i + 1].startIndex;
                    } else {
                        endPos = fileContent.length;
                    }
                    
                    const systemBlock = this.extractBlock(fileContent, startPos, endPos);
                    
                    try {
                        const system = this.parseSystemBlock(systemMatch.name, systemBlock);
                        systems.push(system);
                    } catch (error) {
                        console.error(`Error parsing system ${systemMatch.name}:`, error);
                    }
                }
                
                return systems;
            }

            extractBlock(content, startPos, maxPos) {
                let braceCount = 0;
                let i = startPos;
                
                while (i < content.length && i < maxPos) {
                    if (content[i] === '{') braceCount++;
                    if (content[i] === '}') {
                        braceCount--;
                        if (braceCount === 0) {
                            return content.substring(startPos + 1, i);
                        }
                    }
                    i++;
                }
                
                return content.substring(startPos + 1, maxPos);
            }

            parseSystemBlock(systemName, blockContent) {
                const system = createEmptySystem(systemName);
                
                const nameMatch = blockContent.match(/name\s*=\s*"([^"]+)"/);
                if (nameMatch) {
                    system.displayName = nameMatch[1];
                }
                
                const classMatch = blockContent.match(/class\s*=\s*"([^"]+)"/);
                if (classMatch) {
                    system.class = classMatch[1];
                }
                
                const usageMatch = blockContent.match(/usage\s*=\s*(\w+)/);
                if (usageMatch) {
                    system.usage = usageMatch[1];
                }
                
                const asteroidBeltRegex = /asteroid_belt\s*=\s*\{[^}]*type\s*=\s*(\w+)[^}]*radius\s*=\s*(\d+)[^}]*\}/g;
                let beltMatch;
                while ((beltMatch = asteroidBeltRegex.exec(blockContent)) !== null) {
                    system.asteroidBelts.push({
                        id: Date.now() + Math.random(),
                        type: beltMatch[1],
                        radius: parseInt(beltMatch[2])
                    });
                }
                
                // Parse neighbor_systems mit Bracket-Counting
                let i = 0;
                while (i < blockContent.length) {
                    const neighborKeyword = blockContent.indexOf('neighbor_system', i);
                    if (neighborKeyword === -1) break;
                    
                    const equalsSign = blockContent.indexOf('=', neighborKeyword);
                    if (equalsSign === -1 || equalsSign - neighborKeyword > 20) {
                        i = neighborKeyword + 15;
                        continue;
                    }
                    
                    const braceStart = blockContent.indexOf('{', equalsSign);
                    if (braceStart === -1) break;
                    
                    let braceCount = 0;
                    let blockEnd = -1;
                    
                    for (let j = braceStart; j < blockContent.length; j++) {
                        if (blockContent[j] === '{') braceCount++;
                        if (blockContent[j] === '}') {
                            braceCount--;
                            if (braceCount === 0) {
                                blockEnd = j;
                                break;
                            }
                        }
                    }
                    
                    if (blockEnd === -1) break;
                    
                    const neighborBlock = blockContent.substring(braceStart + 1, blockEnd);
                    
                    // Parse Neighbor-Block
                    const initializerMatch = neighborBlock.match(/initializer\s*=\s*"?([^"\s}]+)"?/);
                    const hyperlaneMatch = neighborBlock.match(/hyperlane_jumps\s*=\s*\{\s*min\s*=\s*(\d+)\s*max\s*=\s*(\d+)\s*\}/);
                    
                    if (initializerMatch) {
                        system.neighborSystems.push({
                            id: Date.now() + Math.random(),
                            mode: 'reference',
                            initializer: initializerMatch[1],
                            hyperlaneJumps: hyperlaneMatch ? {
                                min: parseInt(hyperlaneMatch[1]),
                                max: parseInt(hyperlaneMatch[2])
                            } : { min: 1, max: 3 }
                        });
                    }
                    
                    i = blockEnd + 1;
                }
                
                system.planets = this.extractPlanets(blockContent);
                
                return system;
            }

            extractPlanets(code) {
                const planets = [];
                let planetId = 1;
                
                let i = 0;
                while (i < code.length) {
                    const planetKeyword = code.indexOf('planet', i);
                    if (planetKeyword === -1) break;
                    
                    const equalsSign = code.indexOf('=', planetKeyword);
                    if (equalsSign === -1 || equalsSign - planetKeyword > 10) {
                        i = planetKeyword + 6;
                        continue;
                    }
                    
                    const braceStart = code.indexOf('{', equalsSign);
                    if (braceStart === -1) break;
                    
                    let braceCount = 0;
                    let blockEnd = -1;
                    
                    for (let j = braceStart; j < code.length; j++) {
                        if (code[j] === '{') braceCount++;
                        if (code[j] === '}') {
                            braceCount--;
                            if (braceCount === 0) {
                                blockEnd = j;
                                break;
                            }
                        }
                    }
                    
                    if (blockEnd === -1) break;
                    
                    const planetBlock = code.substring(braceStart + 1, blockEnd);
                    
                    try {
                        const planet = this.parsePlanetBlock(planetBlock, planetId);
                        
                        // ‚úÖ FIX: Skip dummy star entries (syntax-only, not real planets)
                        if (planet.class === 'star' && planet.orbitDistance === 0 && (!planet.size || planet.size <= 16)) {
                            // This is just a Stellaris syntax requirement, not an actual planet
                            i = blockEnd + 1;
                            continue;
                        }
                        
                        if (this.isStarClass(planet.class)) {
                            if (planet.size > 30 || (planet.orbitDistance === 0 && planetId === 1)) {
                                planet.isStar = true;
                                planet.type = 'star';
                            } else {
                                planet.class = 'pc_asteroid';
                            }
                        }
                        
                        planets.push(planet);
                        nextPlanetId = Math.max(nextPlanetId, planetId + 1);
                        planetId++;
                    } catch (error) {
                        console.error('Error parsing planet:', error);
                    }
                    
                    i = blockEnd + 1;
                }
                
                return planets;
            }

            parsePlanetBlock(blockContent, id) {
                const planet = {
                    id: id,
                    type: 'planet',
                    name: this.extractValue(blockContent, 'name') || `planet_${id}`,
                    displayName: this.extractValue(blockContent, 'name') || `Planet ${id}`,
                    class: this.extractValue(blockContent, 'class') || 'pc_continental',
                    size: parseInt(this.extractValue(blockContent, 'size')) || 16,
                    orbitDistance: (() => {
                        const val = this.extractValue(blockContent, 'orbit_distance');
                        return val !== null ? parseInt(val) : 25;
                    })(),
                    orbitAngleType: 'range',
                    orbitAngle: 0,
                    orbitAngleMin: 90,
                    orbitAngleMax: 270,
                    changeOrbit: parseInt(this.extractValue(blockContent, 'change_orbit') || '0'),
                    hasRing: this.extractValue(blockContent, 'has_ring') === 'yes',
                    isStartingPlanet: this.checkStartingPlanetAtTopLevel(blockContent),
                    isGuaranteedHabitable: blockContent.includes('prescripted_ideal') || blockContent.includes('ideal_design_class'),
                    modifiers: this.extractModifiers(blockContent),
                    moons: [],
                    flags: []
                };

                const angleRangeMatch = blockContent.match(/orbit_angle\s*=\s*\{\s*min\s*=\s*(\d+)\s*max\s*=\s*(\d+)\s*\}/);
                if (angleRangeMatch) {
                    planet.orbitAngleType = 'range';
                    planet.orbitAngleMin = parseInt(angleRangeMatch[1]);
                    planet.orbitAngleMax = parseInt(angleRangeMatch[2]);
                } else {
                    const angleFixedMatch = blockContent.match(/orbit_angle\s*=\s*(\d+)/);
                    if (angleFixedMatch) {
                        planet.orbitAngleType = 'fixed';
                        planet.orbitAngle = parseInt(angleFixedMatch[1]);
                    }
                }

                planet.moons = this.extractMoons(blockContent, id);

                return planet;
            }

            extractMoons(planetBlock, parentId) {
                const moons = [];
                let moonId = 1;
                
                let i = 0;
                while (i < planetBlock.length) {
                    const moonStart = planetBlock.indexOf('moon', i);
                    if (moonStart === -1) break;
                    
                    const braceStart = planetBlock.indexOf('{', moonStart);
                    if (braceStart === -1) break;
                    
                    let braceCount = 0;
                    let blockEnd = -1;
                    
                    for (let j = braceStart; j < planetBlock.length; j++) {
                        if (planetBlock[j] === '{') braceCount++;
                        if (planetBlock[j] === '}') {
                            braceCount--;
                            if (braceCount === 0) {
                                blockEnd = j;
                                break;
                            }
                        }
                    }
                    
                    if (blockEnd === -1) break;
                    
                    const moonBlock = planetBlock.substring(braceStart + 1, blockEnd);
                    
                    const moon = {
                        id: parentId * 1000 + moonId,
                        type: 'moon',
                        name: this.extractValue(moonBlock, 'name') || `moon_${moonId}`,
                        displayName: this.extractValue(moonBlock, 'name') || `Mond ${moonId}`,
                        class: this.extractValue(moonBlock, 'class') || 'pc_barren_cold',
                        size: parseInt(this.extractValue(moonBlock, 'size')) || 8,
                        orbitDistance: (() => {
                            const val = this.extractValue(moonBlock, 'orbit_distance');
                            return val !== null ? parseInt(val) : 10;
                        })(),
                        orbitAngleType: 'range',
                        orbitAngle: 0,
                        orbitAngleMin: 90,
                        orbitAngleMax: 270,
                        changeOrbit: 0,
                        hasRing: false,
                        isStartingPlanet: moonBlock.includes('starting_planet') || moonBlock.includes('generate_start_buildings'),
                        isGuaranteedHabitable: false,
                        modifiers: this.extractModifiers(moonBlock),
                        moons: [],
                        flags: []
                    };

                    moons.push(moon);
                    moonId++;
                    i = blockEnd + 1;
                }
                
                return moons;
            }

            extractModifiers(block) {
                const modifiers = [];
                const modifierMatch = block.match(/modifiers\s*=\s*\{\s*([^}]+)\s*\}/);
                
                if (modifierMatch) {
                    const modifierString = modifierMatch[1].trim();
                    if (modifierString && modifierString !== 'none') {
                        // Split by whitespace and filter out empty strings
                        const modifierList = modifierString.split(/\s+/).filter(m => m.length > 0);
                        modifiers.push(...modifierList);
                    }
                }
                
                return modifiers;
            }

            checkStartingPlanetAtTopLevel(block) {
                // Only check for starting_planet at the top level (braceDepth = 0)
                // to avoid false positives from nested moon blocks
                let braceDepth = 0;
                let i = 0;
                
                while (i < block.length) {
                    const char = block[i];
                    
                    if (char === '{') {
                        braceDepth++;
                        i++;
                        continue;
                    }
                    if (char === '}') {
                        braceDepth--;
                        i++;
                        continue;
                    }
                    
                    // Only check at top level (braceDepth = 0)
                    if (braceDepth === 0) {
                        const remaining = block.substring(i);
                        
                        // Check for starting_planet = yes
                        if (/^\s*starting_planet\s*=\s*yes/.test(remaining)) {
                            return true;
                        }
                        
                        // Check for generate_start_buildings in init_effect
                        if (/^\s*init_effect\s*=\s*\{[^}]*generate_start_buildings/.test(remaining)) {
                            return true;
                        }
                    }
                    
                    i++;
                }
                
                return false;
            }

            extractValue(block, key) {
                let braceDepth = 0;
                let i = 0;
                
                while (i < block.length) {
                    const char = block[i];
                    
                    if (char === '{') {
                        braceDepth++;
                        i++;
                        continue;
                    }
                    if (char === '}') {
                        braceDepth--;
                        i++;
                        continue;
                    }
                    
                    if (braceDepth === 0) {
                        const remaining = block.substring(i);
                        const keyPattern = new RegExp(`^\\s*${key}\\s*=\\s*`);
                        
                        if (keyPattern.test(remaining)) {
                            const afterKey = remaining.replace(keyPattern, '');
                            
                            const quotedMatch = afterKey.match(/^"([^"]+)"/);
                            if (quotedMatch) return quotedMatch[1];
                            
                            const unquotedMatch = afterKey.match(/^(\w+)/);
                            if (unquotedMatch) return unquotedMatch[1];
                        }
                    }
                    
                    i++;
                }
                
                return null;
            }

            isStarClass(className) {
                return this.starClasses.includes(className);
            }
        }

        // =====================================================
        // AUTOMATIC IDENTIFIER GENERATION
        // =====================================================
        
        function linkNeighborSystemsAfterImport() {
            // Erstelle Mapping von Initializer-Namen zu System-Indizes
            const systemMap = new Map();
            allSystems.forEach((system, index) => {
                systemMap.set(system.name, index);
            });
            
            // Durchlaufe alle Systeme und verkn√ºpfe Nachbarn
            allSystems.forEach((system, systemIndex) => {
                system.neighborSystems.forEach(neighbor => {
                    // Pr√ºfe ob das referenzierte System existiert
                    if (systemMap.has(neighbor.initializer)) {
                        neighbor.linkedSystemIndex = systemMap.get(neighbor.initializer);
                        neighbor.exists = true;
                    } else {
                        neighbor.exists = false;
                    }
                });
            });
            
            showNotification(`‚úÖ ${allSystems.length} systems imported and neighbors linked!`);
        }

        function generateNeighborIdentifier(displayName) {
            if (!allSystems.length || currentSystemIndex === null) {
                return 'unknown_system_initializer';
            }
            
            const mainSystem = allSystems.find(s => s.isMain) || allSystems[0];
            const mainBaseName = mainSystem.name.replace(/_system_initializer$/, '');
            
            const cleanedDisplayName = displayName
                .toLowerCase()
                .replace(/\s+/g, '_')
                .replace(/[^a-z0-9_]/g, '');
            
            return `${mainBaseName}_${cleanedDisplayName}_system_initializer`;
        }

        // =====================================================
        // EVENT HANDLERS
        // =====================================================
        
        document.getElementById('importBtn').addEventListener('click', () => {
            const file = document.getElementById('importFile').files[0];
            if (!file) {
                showNotification('‚ö†Ô∏è Please select a file!');
                return;
            }
            
            const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const parser = new MultiSystemParser();
                            const systems = parser.parseMultipleSystems(e.target.result);
                            
                            if (systems.length === 0) {
                                showNotification('‚ùå No system initializers found!');
                                return;
                            }
                            
                            allSystems = systems;
                            
                            if (allSystems.length > 0) {
                                allSystems[0].isMain = true;
                            }
                            
                            // Auto-Verkn√ºpfung von Nachbarsystemen
                            linkNeighborSystemsAfterImport();
                            
                            updateSystemList();
                            selectSystem(0);
                            
                            document.getElementById('importInfo').classList.remove('hidden');
                            document.getElementById('systemCount').textContent = systems.length;
                            
                            showNotification(`‚úÖ ${systems.length} system(s) successfully imported!`);
                        } catch (error) {
                            showNotification('‚ùå Import error: ' + error.message);
                            console.error(error);
                        }
                    };
            reader.readAsText(file);
        });

        document.getElementById('addNewSystemBtn').addEventListener('click', () => {
            // ‚úÖ FIX: Add _system_initializer suffix for proper import/export compatibility
            const newSystem = createEmptySystem('custom_system_' + (allSystems.length + 1) + '_system_initializer');
            if (allSystems.length === 0) {
                newSystem.isMain = true;
            }
            allSystems.push(newSystem);
            updateSystemList();
            selectSystem(allSystems.length - 1);
            showNotification('‚úÖ New system created!');
        });

        document.getElementById('clearAllBtn').addEventListener('click', () => {
            if (confirm('Do you really want to delete all systems?')) {
                allSystems = [];
                currentSystemIndex = null;
                updateSystemList();
                clearEditor();
                document.getElementById('importInfo').classList.add('hidden');
                showNotification('üóëÔ∏è All systems deleted!');
            }
        });

        document.getElementById('exportAllBtn').addEventListener('click', () => {
            if (allSystems.length === 0) {
                showNotification('‚ö†Ô∏è No systems to export!');
                return;
            }
            
            const exportCode = allSystems.map(sys => generateSystemCode(sys)).join('\n\n');
            document.getElementById('exportTextarea').value = exportCode;
            document.getElementById('exportPreview').classList.add('active');
        });

        document.getElementById('downloadExportBtn').addEventListener('click', () => {
            // Get main system for filename
            const mainSystem = allSystems.find(s => s.isMain) || allSystems[0];
            const baseName = mainSystem.name.replace(/_system_initializer$/, '');
            
            // Generate .txt file (system initializer)
            const code = document.getElementById('exportTextarea').value;
            const txtBlob = new Blob([code], { type: 'text/plain; charset=utf-8' });
            const txtUrl = URL.createObjectURL(txtBlob);
            const txtLink = document.createElement('a');
            txtLink.href = txtUrl;
            txtLink.download = `${baseName}_system_initializer.txt`;
            txtLink.click();
            URL.revokeObjectURL(txtUrl);
            
            // Generate .yml file (localization) - only if not skipped
            const skipLocalization = document.getElementById('skipLocalizationCheckbox').checked;
            if (!skipLocalization) {
                const ymlContent = generateLocalizationYML(allSystems);
                // ‚úÖ UTF-8 with BOM (required by Stellaris)
                const ymlBlob = new Blob(['\ufeff' + ymlContent], { type: 'text/plain; charset=utf-8' });
                const ymlUrl = URL.createObjectURL(ymlBlob);
                const ymlLink = document.createElement('a');
                ymlLink.href = ymlUrl;
                ymlLink.download = `initializers_names_l_english.yml`;
                ymlLink.click();
                URL.revokeObjectURL(ymlUrl);
            }
            
            const fileCount = skipLocalization ? 1 : 2;
            showNotification(`üíæ ${fileCount} file${fileCount > 1 ? 's' : ''} downloaded!`);
        });

        document.getElementById('copyExportBtn').addEventListener('click', () => {
            const textarea = document.getElementById('exportTextarea');
            textarea.select();
            document.execCommand('copy');
            showNotification('üìã Copied to clipboard!');
        });

        document.getElementById('closePreviewBtn').addEventListener('click', () => {
            document.getElementById('exportPreview').classList.remove('active');
        });

        // Planet Modal Events
        document.getElementById('cancelPlanetBtn').addEventListener('click', () => {
            document.getElementById('planetModal').classList.remove('active');
        });

        document.getElementById('savePlanetBtn').addEventListener('click', () => {
            savePlanet();
        });

        // Moon Modal Events
        document.getElementById('cancelMoonBtn').addEventListener('click', () => {
            document.getElementById('moonModal').classList.remove('active');
        });

        document.getElementById('saveMoonBtn').addEventListener('click', () => {
            saveMoon();
        });

        // Neighbor Modal Events
        document.getElementById('neighborDisplayName').addEventListener('input', (e) => {
            const preview = generateNeighborIdentifier(e.target.value);
            document.getElementById('neighborPreviewIdentifier').textContent = preview;
        });

        document.getElementById('cancelNeighborBtn').addEventListener('click', () => {
            document.getElementById('neighborModal').classList.remove('active');
        });

        // ‚úÖ NEW: Neighbor advanced parameters toggle
        document.getElementById('neighborUseDistance')?.addEventListener('change', (e) => {
            document.getElementById('neighborDistance').disabled = !e.target.checked;
        });
        
        document.getElementById('neighborUseOrientation')?.addEventListener('change', (e) => {
            const disabled = !e.target.checked;
            document.getElementById('neighborMinOrientation').disabled = disabled;
            document.getElementById('neighborMaxOrientation').disabled = disabled;
        });
        
        document.getElementById('neighborUseHyperlaneDistance')?.addEventListener('change', (e) => {
            document.getElementById('neighborHyperlaneDistance').disabled = !e.target.checked;
        });
        
        document.getElementById('neighborUseSpawnChance')?.addEventListener('change', (e) => {
            document.getElementById('neighborSpawnChance').disabled = !e.target.checked;
        });
        
        document.getElementById('saveNeighborBtn').addEventListener('click', () => {
            saveNeighborSystem();
        });

        // System Properties Modal Event Listeners
        document.getElementById('saveSystemPropertiesBtn').addEventListener('click', saveSystemProperties);
        document.getElementById('cancelSystemPropertiesBtn').addEventListener('click', () => {
            document.getElementById('systemPropertiesModal').classList.remove('active');
        });

        // Asteroid Belt Modal Events
        document.getElementById('cancelBeltBtn').addEventListener('click', () => {
            document.getElementById('asteroidBeltModal').classList.remove('active');
        });

        document.getElementById('saveBeltBtn').addEventListener('click', () => {
            saveAsteroidBelt();
        });

        // Modifier Management Functions
        window.updateModifierOptions = function() {
            const category = document.getElementById('modifierCategory').value;
            const modifierSelect = document.getElementById('modifierSelection');
            const addBtn = document.getElementById('addModifierBtn');
            
            modifierSelect.innerHTML = '<option value="">-- Modifier w√§hlen --</option>';
            
            if (category && MODIFIER_DATABASE[category]) {
                modifierSelect.disabled = false;
                MODIFIER_DATABASE[category].modifiers.forEach(mod => {
                    const option = document.createElement('option');
                    option.value = mod.id;
                    option.textContent = `${mod.name} (${mod.desc})`;
                    modifierSelect.appendChild(option);
                });
                addBtn.disabled = false;
            } else {
                modifierSelect.disabled = true;
                addBtn.disabled = true;
            }
        };

        window.addModifierToPlanet = function() {
            const category = document.getElementById('modifierCategory').value;
            const modifierId = document.getElementById('modifierSelection').value;
            
            if (!modifierId) {
                alert('Bitte w√§hlen Sie einen Modifier aus.');
                return;
            }
            const currentPlanet = getCurrentPlanet();
            if (!currentPlanet) {
                alert('‚ö†Ô∏è Please select a planet first!\n\nYou need to select a planet from the "Celestial Bodies" list before adding modifiers.');
                return;
            }
            // Avoid duplicates
            if (!currentPlanet.modifiers.includes(modifierId)) {
                currentPlanet.modifiers.push(modifierId);
                updateSelectedModifiersList();
                
                // Visual feedback
                const addBtn = document.getElementById('addModifierBtn');
                addBtn.textContent = '‚úÖ Add';
                addBtn.style.backgroundColor = '#48bb78';
                
                setTimeout(() => {
                    addBtn.textContent = 'Add MODIFIER';
                    addBtn.style.backgroundColor = '';
                }, 1000);
                
                // Reset selections
                document.getElementById('modifierCategory').value = '';
                document.getElementById('modifierSelection').innerHTML = '<option value="">-- Modifier w√§hlen --</option>';
                document.getElementById('modifierSelection').disabled = true;
                document.getElementById('addModifierBtn').disabled = true;
            } else {
                alert('Dieser Modifier wurde bereits hinzugef√ºgt.');
            }
            // Scroll to modifiers list
            const modifiersList = document.getElementById('selectedModifiersList');
            if (modifiersList && modifiersList.lastElementChild) {
                modifiersList.lastElementChild.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        };

        // ‚úÖ NEW: Add custom modifier function
        window.addCustomModifierToPlanet = function() {
            const customModifier = document.getElementById('customModifierInput').value.trim();
            
            if (!customModifier) {
                alert('Please enter a modifier ID.');
                return;
            }
            
            const currentPlanet = getCurrentPlanet();
            if (!currentPlanet) {
                alert('‚ö†Ô∏è Please select a planet first!\n\nYou need to select a planet from the "Celestial Bodies" list before adding modifiers.');
                return;
            }
            
            if (!currentPlanet.modifiers.includes(customModifier)) {
                currentPlanet.modifiers.push(customModifier);
                updateSelectedModifiersList();
                document.getElementById('customModifierInput').value = '';
                showNotification(`‚úÖ Custom modifier "${customModifier}" added!`);
                
                // Scroll to modifiers list
                const modifiersList = document.getElementById('selectedModifiersList');
                if (modifiersList && modifiersList.lastElementChild) {
                    modifiersList.lastElementChild.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }
            } else {
                alert('This modifier is already added.');
            }
        };

        window.removeModifierFromPlanet = function(modifierId) {
            const currentPlanet = getCurrentPlanet();
            if (!currentPlanet) return;

            const index = currentPlanet.modifiers.indexOf(modifierId);
            if (index > -1) {
                currentPlanet.modifiers.splice(index, 1);
                updateSelectedModifiersList();
            }
        };

        // ‚úÖ NEW: Deposit management functions
        window.addDepositToPlanet = function() {
            const depositId = document.getElementById('depositSelection').value;
            
            if (!depositId) {
                alert('Please select a deposit.');
                return;
            }
            
            const currentPlanet = getCurrentPlanet();
            if (!currentPlanet) {
                alert('‚ö†Ô∏è Please select a planet first!\n\nYou need to select a planet from the "Celestial Bodies" list before adding deposits.');
                return;
            }
            
            if (!currentPlanet.deposits) currentPlanet.deposits = [];
            
            if (!currentPlanet.deposits.includes(depositId)) {
                currentPlanet.deposits.push(depositId);
                updateSelectedDepositsList();
                document.getElementById('depositSelection').value = '';
                showNotification(`‚úÖ Deposit "${depositId}" added!`);
            } else {
                alert('This deposit is already added.');
            }
        };
        
        window.addCustomDepositToPlanet = function() {
            const customDeposit = document.getElementById('customDepositInput').value.trim();
            
            if (!customDeposit) {
                alert('Please enter a deposit ID.');
                return;
            }
            
            const currentPlanet = getCurrentPlanet();
            if (!currentPlanet) {
                alert('‚ö†Ô∏è Please select a planet first!\n\nYou need to select a planet from the "Celestial Bodies" list before adding deposits.');
                return;
            }
            
            if (!currentPlanet.deposits) currentPlanet.deposits = [];
            
            if (!currentPlanet.deposits.includes(customDeposit)) {
                currentPlanet.deposits.push(customDeposit);
                updateSelectedDepositsList();
                document.getElementById('customDepositInput').value = '';
                showNotification(`‚úÖ Custom deposit "${customDeposit}" added!`);
            } else {
                alert('This deposit is already added.');
            }
        };
        
        window.removeDepositFromPlanet = function(depositId) {
            const currentPlanet = getCurrentPlanet();
            if (!currentPlanet) return;
            
            currentPlanet.deposits = currentPlanet.deposits.filter(d => d !== depositId);
            updateSelectedDepositsList();
        };
        
        function updateSelectedDepositsList() {
            const currentPlanet = getCurrentPlanet();
            if (!currentPlanet) return;
            
            const container = document.getElementById('selectedDepositsList');
            const statusText = document.getElementById('depositStatusText');
            
            if (!currentPlanet.deposits || currentPlanet.deposits.length === 0) {
                container.innerHTML = '';
                statusText.textContent = 'No deposits added';
                return;
            }
            
            statusText.textContent = `${currentPlanet.deposits.length} deposit(s) added`;
            container.innerHTML = currentPlanet.deposits.map(dep => `
                <div class="flex items-center justify-between bg-gray-900/50 p-2 rounded mb-1">
                    <span class="text-sm">üíé ${dep}</span>
                    <button onclick="window.removeDepositFromPlanet('${dep}')" class="stellaris-btn stellaris-btn-danger text-xs px-2 py-1">‚úï</button>
                </div>
            `).join('');
        }

        // Moon Modifier Management Functions
        window.updateMoonModifierOptions = function() {
            const category = document.getElementById('moonModifierCategory').value;
            const modifierSelect = document.getElementById('moonModifierSelection');
            const addBtn = document.getElementById('addMoonModifierBtn');
            
            modifierSelect.innerHTML = '<option value="">-- Modifier w√§hlen --</option>';
            
            if (category && MODIFIER_DATABASE[category]) {
                modifierSelect.disabled = false;
                MODIFIER_DATABASE[category].modifiers.forEach(mod => {
                    const option = document.createElement('option');
                    option.value = mod.id;
                    option.textContent = `${mod.name} (${mod.desc})`;
                    modifierSelect.appendChild(option);
                });
                addBtn.disabled = false;
            } else {
                modifierSelect.disabled = true;
                addBtn.disabled = true;
            }
        };

        window.addModifierToMoon = function() {
            const category = document.getElementById('moonModifierCategory').value;
            const modifierId = document.getElementById('moonModifierSelection').value;
            
            if (!modifierId) {
                alert('Bitte w√§hlen Sie einen Modifier aus.');
                return;
            }
            const currentMoon = getCurrentMoon();
            if (!currentMoon) {
                alert('‚ö†Ô∏è Please select a moon first!\n\nYou need to select a moon from a planet before adding modifiers.');
                return;
            }
            // Avoid duplicates
            if (!currentMoon.modifiers.includes(modifierId)) {
                currentMoon.modifiers.push(modifierId);
                updateSelectedMoonModifiersList();
                
                // Visual feedback
                const addBtn = document.getElementById('addMoonModifierBtn');
                addBtn.textContent = '‚úÖ ADD!';
                addBtn.style.backgroundColor = '#48bb78';
                
                setTimeout(() => {
                    addBtn.textContent = 'ADD MODIFIER';
                    addBtn.style.backgroundColor = '';
                }, 1000);
                
                // Reset selections
                document.getElementById('moonModifierCategory').value = '';
                document.getElementById('moonModifierSelection').innerHTML = '<option value="">-- Select Modifier --</option>';
                document.getElementById('moonModifierSelection').disabled = true;
                document.getElementById('addMoonModifierBtn').disabled = true;
            } else {
                alert('Dieser Modifier wurde bereits hinzugef√ºgt.');
            }
        };

        // ‚úÖ NEW: Add custom modifier to moon
        window.addCustomModifierToMoon = function() {
            const customModifier = document.getElementById('customMoonModifierInput').value.trim();
            
            if (!customModifier) {
                alert('Please enter a modifier ID.');
                return;
            }
            
            const currentMoon = getCurrentMoon();
            if (!currentMoon) {
                alert('‚ö†Ô∏è Please select a moon first!\n\nYou need to select a moon from a planet before adding modifiers.');
                return;
            }
            
            if (!currentMoon.modifiers.includes(customModifier)) {
                currentMoon.modifiers.push(customModifier);
                updateSelectedMoonModifiersList();
                document.getElementById('customMoonModifierInput').value = '';
                showNotification(`‚úÖ Custom modifier "${customModifier}" added to moon!`);
            } else {
                alert('This modifier is already added.');
            }
        };

        window.removeModifierFromMoon = function(modifierId) {
            const currentMoon = getCurrentMoon();
            if (!currentMoon) return;

            const index = currentMoon.modifiers.indexOf(modifierId);
            if (index > -1) {
                currentMoon.modifiers.splice(index, 1);
                updateSelectedMoonModifiersList();
            }
        };

        function updateSelectedMoonModifiersList() {
            const currentMoon = getCurrentMoon();
            if (!currentMoon) return;

            const listContainer = document.getElementById('selectedMoonModifiersList');
            const statusText = document.getElementById('moonModifierStatusText');
            
            if (currentMoon.modifiers.length === 0) {
                listContainer.innerHTML = '';
                statusText.textContent = 'No modifiers selected';
                statusText.className = 'text-gray-400 text-sm mb-3';
                return;
            }

            statusText.textContent = `‚úÖ ${currentMoon.modifiers.length} modifier(s) selected:`;
            statusText.className = 'text-purple-400 text-sm mb-3 font-semibold';

            listContainer.innerHTML = currentMoon.modifiers.map(modId => {
                // Find modifier details
                let modDetails = null;
                for (const cat in MODIFIER_DATABASE) {
                    const found = MODIFIER_DATABASE[cat].modifiers.find(m => m.id === modId);
                    if (found) {
                        modDetails = found;
                        break;
                    }
                }

                const displayName = modDetails ? modDetails.name : modId;
                const desc = modDetails ? modDetails.desc : '';

                return `
                    <div class="flex items-center justify-between bg-slate-700/50 p-2 rounded border border-slate-600">
                        <div class="flex-1">
                            <span class="text-purple-300 font-medium">${displayName}</span>
                            <span class="text-gray-400 text-xs ml-2">${desc}</span>
                        </div>
                        <button onclick="window.removeModifierFromMoon('${modId}')" 
                                class="ml-2 px-2 py-1 bg-red-600 hover:bg-red-700 rounded text-xs">
                            ‚úï
                        </button>
                    </div>
                `;
            }).join('');
        }

        function getCurrentMoon() {
            if (editingMoonPlanetIndex === null || editingMoonPlanetIndex === undefined) return null;
            if (editingMoonIndex === null || editingMoonIndex === undefined) return null;
            if (!allSystems[currentSystemIndex]) return null;
            
            const planet = allSystems[currentSystemIndex].planets[editingMoonPlanetIndex];
            if (!planet || !planet.moons) return null;
            
            return planet.moons[editingMoonIndex];
        }

        function updateSelectedModifiersList() {
            const currentPlanet = getCurrentPlanet();
            console.log('Current Planet:', currentPlanet);
            console.log('Modifiers:', currentPlanet ? currentPlanet.modifiers : 'No planet');
            if (!currentPlanet) return;

            const listContainer = document.getElementById('selectedModifiersList');
            const statusText = document.getElementById('modifierStatusText');
            
            if (currentPlanet.modifiers.length === 0) {
                listContainer.innerHTML = '';
                statusText.textContent = 'No modifiers selected';
                statusText.className = 'text-gray-400 text-sm mb-3';
                return;
            }

            statusText.textContent = `‚úÖ ${currentPlanet.modifiers.length} modifier(s) selected:`;
            statusText.className = 'text-green-400 text-sm mb-3 font-semibold';

            listContainer.innerHTML = currentPlanet.modifiers.map(modId => {
                // Find modifier details
                let modDetails = null;
                for (const cat in MODIFIER_DATABASE) {
                    const found = MODIFIER_DATABASE[cat].modifiers.find(m => m.id === modId);
                    if (found) {
                        modDetails = found;
                        break;
                    }
                }

                const displayName = modDetails ? modDetails.name : modId;
                const desc = modDetails ? modDetails.desc : '';

                return `
                    <div class="flex items-center justify-between bg-slate-700/50 p-2 rounded border border-slate-600">
                        <div class="flex-1">
                            <span class="text-green-300 font-medium">${displayName}</span>
                            <span class="text-gray-400 text-xs ml-2">${desc}</span>
                        </div>
                        <button onclick="window.removeModifierFromPlanet('${modId}')" 
                                class="ml-2 px-2 py-1 bg-red-600 hover:bg-red-700 rounded text-xs">
                            ‚úï
                        </button>
                    </div>
                `;
            }).join('');
        }

        function getCurrentPlanet() {
            if (editingPlanetIndex === null || editingPlanetIndex === undefined) return null;
            if (!allSystems[currentSystemIndex]) return null;
            
            return allSystems[currentSystemIndex].planets[editingPlanetIndex];
        }

        // =====================================================
        // UI FUNCTIONS
        // =====================================================
        
        function updateSystemList() {
            const listContainer = document.getElementById('systemList');
            
            if (allSystems.length === 0) {
                listContainer.innerHTML = '<p class="text-gray-400 text-sm">No systems loaded.</p>';
                return;
            }
            
            listContainer.innerHTML = '';
            
            allSystems.forEach((system, index) => {
                const item = document.createElement('div');
                item.className = 'system-selector-item' + (index === currentSystemIndex ? ' active' : '');
                item.onclick = () => selectSystem(index);
                
                const badge = system.isMain ? 
                    '<span class="stellaris-badge badge-primary ml-2">Main</span>' : 
                    '<span class="stellaris-badge badge-secondary ml-2">Neighbor</span>';
                
                item.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <div class="font-semibold text-blue-300">${system.displayName}</div>
                            <div class="text-xs text-gray-400 mt-1">${system.name}</div>
                            <div class="text-xs text-gray-500 mt-1">
                                ${system.planets.length} Planets ‚Ä¢ ${system.neighborSystems.length} Neighbors
                            </div>
                        </div>
                        ${badge}
                    </div>
                `;
                
                listContainer.appendChild(item);
            });
        }

        function selectSystem(index) {
            if (index < 0 || index >= allSystems.length) return;
            
            currentSystemIndex = index;
            updateSystemList();
            loadSystemIntoEditor(allSystems[index]);
        }

        function loadSystemIntoEditor(system) {
            const editorContainer = document.getElementById('systemEditorContent');
            
            editorContainer.innerHTML = `
                <div class="stellaris-panel">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-blue-300">üåü ${system.displayName}</h2>
                        <div class="flex gap-2">
                            <button onclick="editSystemProperties()" class="stellaris-btn text-sm">
                                ‚úèÔ∏è Edit System
                            </button>
                            <button onclick="deleteCurrentSystem()" class="stellaris-btn stellaris-btn-danger text-sm">
                                üóëÔ∏è Delete
                            </button>
                        </div>
                    </div>
                    
                    <!-- System Properties -->
                    <div class="bg-gray-800/50 p-4 rounded-lg mb-6">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <span class="text-gray-400 text-sm">Identifier:</span>
                                <div class="font-mono text-blue-300">${system.name}</div>
                            </div>
                            <div>
                                <span class="text-gray-400 text-sm">Star Class:</span>
                                <div class="text-yellow-300">${system.class}</div>
                            </div>
                            <div>
                                <span class="text-gray-400 text-sm">Usage:</span>
                                <div class="text-green-300">${system.usage}</div>
                            </div>
                            <div>
                                <span class="text-gray-400 text-sm">Typ:</span>
                                <div class="text-purple-300">${system.isMain ? 'Main System' : 'Neighbor System'}</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Combined Celestial Bodies Section -->
                    <div class="mb-6">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="text-lg font-semibold text-yellow-400">ü™ê Celestial Bodies (${system.planets.length + system.asteroidBelts.length})</h3>
                            <div class="flex gap-2">
                                <button onclick="openAddStarModal()" class="stellaris-btn stellaris-btn-secondary text-sm" style="background: linear-gradient(135deg, #FFD700, #FFA500);">
                                    ‚≠ê Star
                                </button>
                                <button onclick="openAddPlanetModal()" class="stellaris-btn stellaris-btn-secondary text-sm">
                                    ‚ûï Planet
                                </button>
                                <button onclick="openAddAsteroidBeltModal()" class="stellaris-btn stellaris-btn-secondary text-sm">
                                    ‚ûï Belt
                                </button>
                            </div>
                        </div>
                        <div id="celestialBodiesList">
                            ${renderCombinedCelestialBodies(system.planets, system.asteroidBelts)}
                        </div>
                    </div>
                    
                    <!-- Neighbor Systems Section -->
                    <div class="mb-6">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="text-lg font-semibold text-yellow-400">üîó Neighbor Systems (${system.neighborSystems.length})</h3>
                            <button onclick="openAddNeighborModal()" class="stellaris-btn stellaris-btn-secondary text-sm">
                                ‚ûï Add Neighbor
                            </button>
                        </div>
                        <div id="neighborsList">
                            ${renderNeighborSystems(system.neighborSystems)}
                        </div>
                    </div>
                    
                    <!-- System Visualization Canvas -->
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold text-yellow-400 mb-3">üî≠ System Visualization</h3>
                        <div class="visualization-container">
                            <canvas id="systemCanvas"></canvas>
                            <div class="canvas-controls">
                                <button onclick="resetCanvasView()" class="stellaris-btn text-xs px-2 py-1">
                                    üîÑ Reset View
                                </button>
                            </div>
                            <div class="canvas-info">
                                üñ±Ô∏è Drag to Pan | üñ≤Ô∏è Scroll to Zoom
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Render visualization after DOM is ready
            setTimeout(() => renderSystemVisualization(), 50);
        }

        function renderPlanetList(planets) {
            if (planets.length === 0) {
                return '<p class="text-gray-400 text-sm">No planets. Click on ‚ÄúAdd planet.‚Äù</p>';
            }
            
            return planets.map((planet, index) => {
                const icon = getPlanetIcon(planet.class);
                const moonCount = planet.moons.length;
                
                let html = `
                    <div class="planet-item">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center gap-3 flex-1">
                                <span class="text-2xl">${icon}</span>
                                <div>
                                    <div class="font-semibold text-blue-300">${index + 1}. ${planet.displayName}</div>
                                    <div class="text-sm text-gray-400">
                                        ${getClassDisplayName(planet.class)} ‚Ä¢ Gr√∂√üe ${planet.size} ‚Ä¢ Orbit ${planet.orbitDistance}
                                        ${planet.isStartingPlanet ? ' ‚Ä¢ <span class="text-green-400">üè† Startplanet</span>' : ''}
                                        ${planet.isGuaranteedHabitable ? ' ‚Ä¢ <span class="text-blue-400">üåç Garantiert</span>' : ''}
                                    </div>
                                </div>
                            </div>
                            <div class="flex gap-2">
                                ${index > 0 ? `<button onclick="movePlanetUp(${index})" class="stellaris-btn stellaris-btn-secondary text-xs px-2 py-1">‚Üë</button>` : ''}
                                ${index < planets.length - 1 ? `<button onclick="movePlanetDown(${index})" class="stellaris-btn stellaris-btn-secondary text-xs px-2 py-1">‚Üì</button>` : ''}
                                <button onclick="openEditPlanetModal(${planet.id}, ${index})" class="stellaris-btn stellaris-btn-secondary text-xs px-2 py-1">‚úèÔ∏è</button>
                                <button onclick="openAddMoonModal(${planet.id})" class="stellaris-btn stellaris-btn-secondary text-xs px-2 py-1">üåô+</button>
                                <button onclick="deletePlanet(${index})" class="stellaris-btn stellaris-btn-danger text-xs px-2 py-1">üóëÔ∏è</button>
                            </div>
                        </div>
                `;
                
                if (moonCount > 0) {
                    html += '<div class="space-y-2">';
                    planet.moons.forEach((moon, moonIndex) => {
                        const startingIcon = moon.isStartingPlanet ? ' <span class="text-green-400">üè† </span>' : ''; 
                        const guaranteedIcon = moon.isGuaranteedHabitable ? ' <span class="text-blue-400">üåç</span>' : '';
                        html += `
                            <div class="moon-item flex items-center justify-between">
                                <div class="flex items-center gap-2">
                                    <span class="text-lg">${getPlanetIcon(moon.class)}</span>
                                    <span class="text-sm">${moon.displayName} (${getClassDisplayName(moon.class)}, Gr√∂√üe ${moon.size})${startingIcon}${guaranteedIcon}</span>
                                </div>
                                <div class="flex gap-1">
                                    <button onclick="editMoon(${planet.id}, ${moonIndex})" class="stellaris-btn stellaris-btn-secondary text-xs px-2 py-1">‚úèÔ∏è</button>
                                    <button onclick="deleteMoon(${planet.id}, ${moonIndex})" class="stellaris-btn stellaris-btn-danger text-xs px-2 py-1">üóëÔ∏è</button>
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';
                }
                
                html += '</div>';
                return html;
            }).join('');
        }

        function renderAsteroidBelts(belts) {
            if (belts.length === 0) {
                return '<p class="text-gray-400 text-sm">No Asteroid Belt.</p>';
            }
            
            return belts.map((belt, index) => {
                return `
                    <div class="bg-gray-800/50 p-3 rounded-lg border border-gray-700 flex justify-between items-center mb-2">
                        <div>
                            <span class="text-yellow-500">‚òÑÔ∏è</span> ${belt.type} (Radius: ${belt.radius})
                        </div>
                        <button onclick="deleteAsteroidBelt(${index})" class="stellaris-btn stellaris-btn-danger text-xs px-2 py-1">üóëÔ∏è</button>
                    </div>
                `;
            }).join('');
        }

        function renderCombinedCelestialBodies(planets, asteroidBelts) {
            // Kombiniere Planeten und Asteroideng√ºrtel mit korrekter Orbit-Berechnung
            const combined = [];
            
            // Berechne kumulative Positionen f√ºr Planeten
            let cumulativeOrbit = 0;
            planets.forEach((planet, index) => {
                cumulativeOrbit += planet.orbitDistance;
                combined.push({
                    type: 'planet',
                    data: planet,
                    index: index,
                    orbit: cumulativeOrbit,  // Kumulative Position
                    displayOrbit: planet.orbitDistance  // Original f√ºr Anzeige
                });
            });
            
            // F√ºge Asteroideng√ºrtel mit absoluter Position hinzu
            asteroidBelts.forEach((belt, index) => {
                combined.push({
                    type: 'asteroid',
                    data: belt,
                    index: index,
                    orbit: belt.radius,  // Absolute Position
                    displayOrbit: belt.radius
                });
            });
            
            // Sortiere nach tats√§chlicher Orbit-Position
            combined.sort((a, b) => a.orbit - b.orbit);
                
                if (combined.length === 0) {
                    return '<p class="text-gray-400 text-sm">No celestial bodies. Click on "Planet" or "Belt" to add.</p>';
                }
                
                return combined.map(item => {
                    if (item.type === 'planet') {
                        const planet = item.data;
                        const index = item.index;
                        const icon = getPlanetIcon(planet.class);
                        const moonCount = planet.moons.length;
                        
                        let html = `
                            <div class="bg-gray-800/50 p-3 rounded-lg border border-gray-700 mb-3">
                                <div class="flex justify-between items-start">
                                    <div class="flex-1">
                                        <div class="flex items-center gap-2 mb-2">
                                            <span class="text-2xl">${icon}</span>
                                            <div>
                                                <div class="font-semibold text-blue-300">${planet.class === 'star' ? '‚≠ê ' : ''}${planet.name}</div>
                                                <div class="text-xs text-gray-400">${getClassDisplayName(planet.class)} ‚Ä¢ Size ${planet.size} ‚Ä¢ Orbit +${item.displayOrbit} (Position: ${item.orbit})</div>
                                            </div>
                                        </div>
                                        ${moonCount > 0 ? `<div class="text-xs text-yellow-400 ml-8">üåô ${moonCount} Moon(s)</div>` : ''}
                                    </div>
                                    <div class="flex gap-1">
                                        <button onclick="movePlanetUp(${index})" class="stellaris-btn stellaris-btn-secondary text-xs px-2 py-1" ${index === 0 ? 'disabled' : ''}>‚¨ÜÔ∏è</button>
                                        <button onclick="movePlanetDown(${index})" class="stellaris-btn stellaris-btn-secondary text-xs px-2 py-1">‚¨áÔ∏è</button>
                                        <button onclick="openEditPlanetModal(${planet.id}, ${index})" class="stellaris-btn text-xs px-2 py-1">‚úèÔ∏è</button>
                                        <button onclick="openAddMoonModal(${planet.id})" class="stellaris-btn stellaris-btn-secondary text-xs px-2 py-1">üåô+</button>
                                        <button onclick="deletePlanet(${index})" class="stellaris-btn stellaris-btn-danger text-xs px-2 py-1">üóëÔ∏è</button>
                                    </div>
                                </div>
                                ${planet.moons.length > 0 ? renderMoonsList(planet.moons, planet.id) : ''}
                            </div>
                        `;
                        return html;
                    } else {
                        // Asteroideng√ºrtel
                        const belt = item.data;
                        const index = item.index;
                        return `
                            <div class="bg-gray-800/50 p-3 rounded-lg border border-yellow-600/50 mb-3">
                                <div class="flex justify-between items-center">
                                    <div class="flex items-center gap-2">
                                        <span class="text-yellow-500 text-2xl">‚òÑÔ∏è</span>
                                        <div>
                                            <div class="font-semibold text-yellow-300">Asteroid Belt</div>
                                            <div class="text-xs text-gray-400">${belt.type} ‚Ä¢ Radius: ${item.displayOrbit} (Position: ${item.orbit})</div>
                                        </div>
                                    </div>
                                    <button onclick="deleteAsteroidBelt(${index})" class="stellaris-btn stellaris-btn-danger text-xs px-2 py-1">üóëÔ∏è</button>
                                </div>
                            </div>
                        `;
                    }
                }).join('');
             }

            function renderMoonsList(moons, parentPlanetId) {
                if (moons.length === 0) {
                    return '';
                }
                
                return '<div class="ml-8 mt-2 space-y-2 border-l-2 border-gray-700 pl-4">' + 
                    moons.map((moon, moonIndex) => {
                        const startingIcon = moon.isStartingPlanet ? ' <span class="text-green-400">üè†</span>' : '';
                        return `
                            <div class="bg-gray-900/50 p-2 rounded border border-gray-700 flex items-center justify-between">
                                <div class="flex items-center gap-2">
                                    <span class="text-lg">${getPlanetIcon(moon.class)}</span>
                                    <span class="text-sm">${moon.displayName} (${getClassDisplayName(moon.class)}, Size ${moon.size}, Orbit ${moon.orbitDistance})${startingIcon}</span>
                                </div>
                                <div class="flex gap-1">
                                    <button onclick="editMoon(${parentPlanetId}, ${moonIndex})" class="stellaris-btn stellaris-btn-secondary text-xs px-2 py-1">‚úèÔ∏è</button>
                                    <button onclick="deleteMoon(${parentPlanetId}, ${moonIndex})" class="stellaris-btn stellaris-btn-danger text-xs px-2 py-1">üóëÔ∏è</button>
                                </div>
                            </div>
                        `;
                    }).join('') + 
                '</div>';
            }

        function renderNeighborSystems(neighbors) {
            if (neighbors.length === 0) {
                return '<p class="text-gray-400 text-sm">No neighbor systems.</p>';
            }
            
            return neighbors.map((neighbor, index) => {
                const jumps = `${neighbor.hyperlaneJumps.min}-${neighbor.hyperlaneJumps.max} Hyperlane Jumps`;
                
                // Status-Icon und Info
                let statusIcon = 'üîó';
                let statusColor = 'text-purple-400';
                let displayName = neighbor.initializer;
                
                if (neighbor.linkedSystemIndex !== undefined) {
                    const linkedSystem = allSystems[neighbor.linkedSystemIndex];
                    if (linkedSystem) {
                        statusIcon = '‚úì';
                        statusColor = 'text-green-400';
                        displayName = `${linkedSystem.displayName} ‚Üí ${neighbor.initializer}`;
                    }
                } else if (neighbor.exists === false) {
                    statusIcon = '‚ö†';
                    statusColor = 'text-yellow-400';
                }
                
                return `
                    <div class="bg-gray-800/50 p-3 rounded-lg border border-gray-700 flex justify-between items-center mb-2">
                        <div>
                            <span class="${statusColor}">${statusIcon}</span> ${displayName}
                            <div class="text-xs text-gray-400 mt-1">${jumps}</div>
                        </div>
                        <button onclick="deleteNeighborSystem(${index})" class="stellaris-btn stellaris-btn-danger text-xs px-2 py-1">üóëÔ∏è</button>
                    </div>
                `;
            }).join('');
        }

        function clearEditor() {
            document.getElementById('systemEditorContent').innerHTML = `
                <div class="stellaris-panel text-center py-12">
                    <p class="text-gray-400 text-lg">üëà Select a system from the list or import a file</p>
                </div>
            `;
        }

        // =====================================================
        // PLANET MANAGEMENT
        // =====================================================
        
        function openAddPlanetModal() {
            editingPlanetId = null;
            editingPlanetIndex = null;
            document.getElementById('planetModalTitle').textContent = 'üåç Add Planet';
            
            // ‚úÖ FEATURE 8: Warn if no stars exist
            const system = allSystems[currentSystemIndex];
            if (system && !system.planets.some(p => p.class === 'star')) {
                if (!confirm('‚ö†Ô∏è WARNING: No stars in system!\n\nStars must be added before planets. Stars are the first objects in Stellaris systems.\n\nDo you want to add a planet anyway?\n\n(Recommended: Cancel and add a star first)')) {
                    return;
                }
            }
            
            // Reset form
            document.getElementById('planetName').value = '';
            document.getElementById('planetClass').value = 'pc_continental';
            document.getElementById('planetSize').value = '16';
            document.getElementById('planetOrbit').value = '25';
            
            // NEU: Orbit Angle Preset Setup
            document.getElementById('orbitAngleMode').value = 'preset';
            document.getElementById('planetAnglePreset').value = '90';
            document.getElementById('planetAngleMin').value = '90';
            document.getElementById('planetAngleMax').value = '270';
            toggleOrbitAngleFields();
            
            document.getElementById('planetChangeOrbit').value = '0';
            document.getElementById('planetHasRing').checked = false;
            document.getElementById('planetIsStarting').checked = false;
            
            document.getElementById('planetModal').classList.add('active');
        }

        // ‚úÖ FEATURE 8: Add Star as Planet with class = star
        function openAddStarModal() {
            editingPlanetId = null;
            editingPlanetIndex = null;
            document.getElementById('planetModalTitle').textContent = '‚≠ê Add Star';
            
            // Pre-fill star parameters
            document.getElementById('planetName').value = 'Star';
            document.getElementById('planetClass').value = 'star';
            document.getElementById('planetSize').value = '30';  // Default star size
            document.getElementById('planetOrbit').value = '0';   // Primary star at center
            
            // Orbit angle
            document.getElementById('orbitAngleMode').value = 'preset';
            document.getElementById('planetAnglePreset').value = '0';
            document.getElementById('planetAngleMin').value = '0';
            document.getElementById('planetAngleMax').value = '360';
            toggleOrbitAngleFields();
            
            document.getElementById('planetChangeOrbit').value = '0';
            document.getElementById('planetHasRing').checked = false;
            document.getElementById('planetIsStarting').checked = false;
            document.getElementById('planetIsGuaranteedHabitable').checked = false;
            
            // Show info banner
            showStarInfoBanner();
            
            document.getElementById('planetModal').classList.add('active');
        }
        
        function showStarInfoBanner() {
            const modalContent = document.querySelector('#planetModal .modal-content');
            
            // Remove existing banner if present
            const existingBanner = document.getElementById('starInfoBanner');
            if (existingBanner) existingBanner.remove();
            
            // Create info banner
            const banner = document.createElement('div');
            banner.id = 'starInfoBanner';
            banner.className = 'mb-4 p-3 bg-yellow-900/30 rounded-lg border border-yellow-500/30';
            banner.innerHTML = `
                <p class="text-sm text-gray-300">
                    <strong>‚≠ê Star Parameters:</strong>
                </p>
                <ul class="text-xs text-gray-400 mt-2 space-y-1">
                    <li>‚Ä¢ <strong>Primary Star:</strong> orbit_distance = 0</li>
                    <li>‚Ä¢ <strong>Companion Stars:</strong> orbit_distance = 25, 50, -50 (can be negative!)</li>
                    <li>‚Ä¢ <strong>Size:</strong> 15-35 (larger than planets)</li>
                    <li>‚Ä¢ <strong>Class:</strong> Set to "star" (will be exported as <code>class = star</code>)</li>
                </ul>
            `;
            
            modalContent.insertBefore(banner, modalContent.firstChild.nextSibling);
        }

        function openEditPlanetModal(planetId, planetIndex) {
            const planet = allSystems[currentSystemIndex].planets[planetIndex];
            
            editingPlanetId = planetId;
            editingPlanetIndex = planetIndex;
            document.getElementById('planetModalTitle').textContent = '‚úèÔ∏è Edit Planet';
            
            document.getElementById('planetName').value = planet.name;
            document.getElementById('planetClass').value = planet.class;
            document.getElementById('planetSize').value = planet.size;
            document.getElementById('planetOrbit').value = planet.orbitDistance;
            
            // NEU: Orbit Angle Setup basierend auf Planet-Daten
            if (planet.orbitAngleType === 'fixed') {
                document.getElementById('orbitAngleMode').value = 'preset';
                document.getElementById('planetAnglePreset').value = planet.orbitAngle.toString();
            } else {
                document.getElementById('orbitAngleMode').value = 'range';
                document.getElementById('planetAngleMin').value = planet.orbitAngleMin;
                document.getElementById('planetAngleMax').value = planet.orbitAngleMax;
            }
            toggleOrbitAngleFields();
            
            document.getElementById('planetChangeOrbit').value = planet.changeOrbit;
            document.getElementById('planetHasRing').checked = planet.hasRing;
            document.getElementById('planetIsStarting').checked = planet.isStartingPlanet;
            document.getElementById('planetIsGuaranteedHabitable').checked = planet.isGuaranteedHabitable || false;
            
            // Load modifiers
            if (!planet.modifiers) {
                planet.modifiers = [];
            }
            updateSelectedModifiersList();
            
            // ‚úÖ NEW: Load deposits
            if (!planet.deposits) {
                planet.deposits = [];
            }
            updateSelectedDepositsList();
            
            document.getElementById('planetModal').classList.add('active');
        }

        function savePlanet() {
            const name = document.getElementById('planetName').value.trim() || `planet_${nextPlanetId}`;
            let planetClass = document.getElementById('planetClass').value;
            
            // ‚úÖ NEW: Handle custom planet class
            if (planetClass === 'CUSTOM') {
                const customClass = document.getElementById('planetClassCustom').value.trim();
                if (!customClass) {
                    showNotification('‚ö†Ô∏è Please enter a custom planet class!');
                    return;
                }
                planetClass = customClass;
            }
            
            const size = parseInt(document.getElementById('planetSize').value);
            const orbit = parseInt(document.getElementById('planetOrbit').value);
            const changeOrbit = parseInt(document.getElementById('planetChangeOrbit').value);
            const hasRing = document.getElementById('planetHasRing').checked;
            const isStarting = document.getElementById('planetIsStarting').checked;
            const isHomePlanet = document.getElementById('planetIsHomePlanet').checked;
            const isGuaranteedHabitable = document.getElementById('planetIsGuaranteedHabitable').checked;
            
            // NEU: Orbit Angle basierend auf Modus
            const angleMode = document.getElementById('orbitAngleMode').value;
            let orbitAngleType, orbitAngle, orbitAngleMin, orbitAngleMax;
            
            if (angleMode === 'preset') {
                const preset = document.getElementById('planetAnglePreset').value;
                orbitAngleType = 'fixed';
                orbitAngle = parseInt(preset);
                orbitAngleMin = 90;  // Fallback f√ºr Export
                orbitAngleMax = 270;
            } else {
                orbitAngleType = 'range';
                orbitAngle = 0;
                orbitAngleMin = parseInt(document.getElementById('planetAngleMin').value);
                orbitAngleMax = parseInt(document.getElementById('planetAngleMax').value);
            }
            
            const planetData = {
                id: editingPlanetId || nextPlanetId++,
                type: 'planet',
                name: name,
                displayName: name,
                class: planetClass,
                size: size,
                orbitDistance: orbit,
                orbitAngleType: orbitAngleType,
                orbitAngle: orbitAngle,
                orbitAngleMin: orbitAngleMin,
                orbitAngleMax: orbitAngleMax,
                changeOrbit: changeOrbit,
                hasRing: hasRing,
                isStartingPlanet: isStarting,
                isHomePlanet: isHomePlanet,
                isGuaranteedHabitable: isGuaranteedHabitable,
                modifiers: editingPlanetIndex !== null ? allSystems[currentSystemIndex].planets[editingPlanetIndex].modifiers || [] : [],
                deposits: editingPlanetIndex !== null ? (allSystems[currentSystemIndex].planets[editingPlanetIndex].deposits || []) : [], // ‚úÖ NEW
                moons: [],
                flags: []
            };
            
            if (editingPlanetIndex !== null) {
                // Keep existing moons and modifiers
                const existingPlanet = allSystems[currentSystemIndex].planets[editingPlanetIndex];
                planetData.moons = existingPlanet.moons || [];
                planetData.modifiers = existingPlanet.modifiers || [];
                allSystems[currentSystemIndex].planets[editingPlanetIndex] = planetData;
                showNotification('‚úÖ Planet updated!');
            } else {
                allSystems[currentSystemIndex].planets.push(planetData);
                showNotification('‚úÖ Planet added!');
            }
            
            document.getElementById('planetModal').classList.remove('active');
            loadSystemIntoEditor(allSystems[currentSystemIndex]);
        }

        function deletePlanet(index) {
            if (confirm('Really delete planet?')) {
                allSystems[currentSystemIndex].planets.splice(index, 1);
                showNotification('üóëÔ∏è Planet deleted!');
                loadSystemIntoEditor(allSystems[currentSystemIndex]);
            }
        }

        function movePlanetUp(index) {
            if (index > 0) {
                const planets = allSystems[currentSystemIndex].planets;
                [planets[index], planets[index - 1]] = [planets[index - 1], planets[index]];
                loadSystemIntoEditor(allSystems[currentSystemIndex]);
            }
        }

        function movePlanetDown(index) {
            const planets = allSystems[currentSystemIndex].planets;
            if (index < planets.length - 1) {
                [planets[index], planets[index + 1]] = [planets[index + 1], planets[index]];
                loadSystemIntoEditor(allSystems[currentSystemIndex]);
            }
        }

        // =====================================================
        // MOON MANAGEMENT
        // =====================================================
        
        function openAddMoonModal(parentPlanetId) {
            editingMoonParentId = parentPlanetId;
            editingMoonIndex = null;
            document.getElementById('moonModalTitle').textContent = 'üåô Add Moon';
            
            document.getElementById('moonName').value = '';
            document.getElementById('moonClass').value = 'pc_barren_cold';
            document.getElementById('moonSize').value = '8';
            document.getElementById('moonOrbit').value = '10';
            document.getElementById('moonIsStarting').checked = false;
            document.getElementById('moonIsGuaranteedHabitable').checked = false;
            
            // NEU: Orbit Angle Standardwerte
            document.getElementById('moonOrbitAngleMode').value = 'range';
            document.getElementById('moonAngleMin').value = '90';
            document.getElementById('moonAngleMax').value = '270';
            toggleMoonOrbitAngleFields();
            
            // Reset moon modifiers for new moon
            editingMoonPlanetIndex = allSystems[currentSystemIndex].planets.findIndex(p => p.id === parentPlanetId);
            document.getElementById('selectedMoonModifiersList').innerHTML = '';
            document.getElementById('moonModifierStatusText').textContent = 'No modifiers selected';
            document.getElementById('moonModifierStatusText').className = 'text-gray-400 text-sm mb-3';
            document.getElementById('moonModifierCategory').value = '';
            document.getElementById('moonModifierSelection').innerHTML = '<option value="">-- Select Modifier --</option>';
            document.getElementById('moonModifierSelection').disabled = true;
            document.getElementById('addMoonModifierBtn').disabled = true;
            
            document.getElementById('moonModal').classList.add('active');
        }

        function editMoon(parentPlanetId, moonIndex) {
            const planet = allSystems[currentSystemIndex].planets.find(p => p.id === parentPlanetId);
            const moon = planet.moons[moonIndex];
            
            editingMoonParentId = parentPlanetId;
            editingMoonIndex = moonIndex;
            document.getElementById('moonModalTitle').textContent = '‚úèÔ∏è Edit Moon';
            
            document.getElementById('moonName').value = moon.name;
            document.getElementById('moonClass').value = moon.class;
            document.getElementById('moonSize').value = moon.size;
            document.getElementById('moonOrbit').value = moon.orbitDistance;
            document.getElementById('moonIsStarting').checked = moon.isStartingPlanet || false;
            document.getElementById('moonIsGuaranteedHabitable').checked = false;
            
            // NEU: Orbit Angle Setup f√ºr Monde
            if (moon.orbitAngleType === 'fixed') {
                document.getElementById('moonOrbitAngleMode').value = 'preset';
                document.getElementById('moonAnglePreset').value = moon.orbitAngle.toString();
            } else {
                document.getElementById('moonOrbitAngleMode').value = 'range';
                document.getElementById('moonAngleMin').value = moon.orbitAngleMin;
                document.getElementById('moonAngleMax').value = moon.orbitAngleMax;
            }
            toggleMoonOrbitAngleFields();
            
            // Load moon modifiers
            if (!moon.modifiers) {
                moon.modifiers = [];
            }
            // Store the planet index for getCurrentMoon
            editingMoonPlanetIndex = allSystems[currentSystemIndex].planets.findIndex(p => p.id === parentPlanetId);
            updateSelectedMoonModifiersList();
            
            document.getElementById('moonModal').classList.add('active');
        }

        function saveMoon() {
            const name = document.getElementById('moonName').value.trim() || 'moon';
            let moonClass = document.getElementById('moonClass').value;
            
            // ‚úÖ NEW: Handle custom moon class
            if (moonClass === 'CUSTOM') {
                const customClass = document.getElementById('moonClassCustom').value.trim();
                if (!customClass) {
                    showNotification('‚ö†Ô∏è Please enter a custom moon class!');
                    return;
                }
                moonClass = customClass;
            }
            
            const size = parseInt(document.getElementById('moonSize').value);
            const orbit = parseInt(document.getElementById('moonOrbit').value);
            const isStarting = document.getElementById('moonIsStarting').checked;
            const isGuaranteedHabitable = document.getElementById('moonIsGuaranteedHabitable').checked;
            
            // NEU: Orbit Angle basierend auf Modus
            const angleMode = document.getElementById('moonOrbitAngleMode').value;
            let orbitAngleType, orbitAngle, orbitAngleMin, orbitAngleMax;
            
            if (angleMode === 'preset') {
                const preset = document.getElementById('moonAnglePreset').value;
                orbitAngleType = 'fixed';
                orbitAngle = parseInt(preset);
                orbitAngleMin = 90;
                orbitAngleMax = 270;
            } else {
                orbitAngleType = 'range';
                orbitAngle = 0;
                orbitAngleMin = parseInt(document.getElementById('moonAngleMin').value);
                orbitAngleMax = parseInt(document.getElementById('moonAngleMax').value);
            }
            
            const planet = allSystems[currentSystemIndex].planets.find(p => p.id === editingMoonParentId);
            
            const moonData = {
                id: editingMoonParentId * 1000 + (planet.moons.length + 1),
                type: 'moon',
                name: name,
                displayName: name,
                class: moonClass,
                size: size,
                orbitDistance: orbit,
                orbitAngleType: orbitAngleType,
                orbitAngle: orbitAngle,
                orbitAngleMin: orbitAngleMin,
                orbitAngleMax: orbitAngleMax,
                changeOrbit: 0,
                hasRing: false,
                isStartingPlanet: isStarting,  // GE√ÑNDERT: von false zu isStarting
                isGuaranteedHabitable: isGuaranteedHabitable,
                modifiers: editingMoonIndex !== null ? planet.moons[editingMoonIndex].modifiers || [] : [],
                deposits: editingPlanetIndex !== null ? (allSystems[currentSystemIndex].planets[editingPlanetIndex].deposits || []) : [], // ‚úÖ NEW
                moons: [],
                flags: []
            };
            
            if (editingMoonIndex !== null) {
                planet.moons[editingMoonIndex] = moonData;
                showNotification('‚úÖ Moon updated!');
            } else {
                planet.moons.push(moonData);
                showNotification('‚úÖ Moon added!');
            }
            
            document.getElementById('moonModal').classList.remove('active');
            loadSystemIntoEditor(allSystems[currentSystemIndex]);
        }

        function deleteMoon(parentPlanetId, moonIndex) {
            if (confirm('Really delete moon?')) {
                const planet = allSystems[currentSystemIndex].planets.find(p => p.id === parentPlanetId);
                planet.moons.splice(moonIndex, 1);
                showNotification('üóëÔ∏è Moon deleted!');
                loadSystemIntoEditor(allSystems[currentSystemIndex]);
            }
        }

        // =====================================================
        // ORBIT ANGLE PRESET FUNCTIONS
        // =====================================================
        
        window.toggleOrbitAngleFields = function() {
            const mode = document.getElementById('orbitAngleMode').value;
            const presetDiv = document.getElementById('orbitAnglePreset');
            const rangeDiv = document.getElementById('orbitAngleRange');
            
            if (mode === 'preset') {
                presetDiv.classList.remove('hidden');
                rangeDiv.classList.add('hidden');
            } else {
                presetDiv.classList.add('hidden');
                rangeDiv.classList.remove('hidden');
            }
        };

        window.toggleMoonOrbitAngleFields = function() {
            const mode = document.getElementById('moonOrbitAngleMode').value;
            const presetDiv = document.getElementById('moonOrbitAnglePreset');
            const rangeDiv = document.getElementById('moonOrbitAngleRange');
            
            if (mode === 'preset') {
                presetDiv.classList.remove('hidden');
                rangeDiv.classList.add('hidden');
            } else {
                presetDiv.classList.add('hidden');
                rangeDiv.classList.remove('hidden');
            }
        };
        
        window.toggleOrbitAngleFields = toggleOrbitAngleFields;

        // =====================================================
        // NEIGHBOR SYSTEM MANAGEMENT
        // =====================================================
        
        function openAddNeighborModal() {
            document.getElementById('neighborDisplayName').value = '';
            document.getElementById('neighborJumpsMin').value = '1';
            document.getElementById('neighborJumpsMax').value = '3';
            document.getElementById('neighborPreviewIdentifier').textContent = '-';
            
            // ‚úÖ NEW: Reset advanced parameters
            document.getElementById('neighborUseDistance').checked = false;
            document.getElementById('neighborDistance').disabled = true;
            document.getElementById('neighborDistance').value = '50';
            
            document.getElementById('neighborUseOrientation').checked = false;
            document.getElementById('neighborMinOrientation').disabled = true;
            document.getElementById('neighborMaxOrientation').disabled = true;
            document.getElementById('neighborMinOrientation').value = '0';
            document.getElementById('neighborMaxOrientation').value = '360';
            
            document.getElementById('neighborUseHyperlaneDistance').checked = false;
            document.getElementById('neighborHyperlaneDistance').disabled = true;
            document.getElementById('neighborHyperlaneDistance').value = '3';
            
            document.getElementById('neighborUseSpawnChance').checked = false;
            document.getElementById('neighborSpawnChance').disabled = true;
            document.getElementById('neighborSpawnChance').value = '100';
            
            // F√ºlle System-Auswahl
            const select = document.getElementById('neighborSystemSelect');
            select.innerHTML = '<option value="">-- Select from list or enter manually --</option>';
            
            allSystems.forEach((system, index) => {
                if (index !== currentSystemIndex) {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = `${system.displayName} (${system.name})`;
                    select.appendChild(option);
                }
            });
            
            document.getElementById('neighborModal').classList.add('active');
        }

                document.getElementById('neighborSystemSelect').addEventListener('change', (e) => {
                const selectedIndex = e.target.value;
                if (selectedIndex !== '') {
                    const selectedSystem = allSystems[selectedIndex];
                    document.getElementById('neighborDisplayName').value = selectedSystem.displayName;
                    document.getElementById('neighborPreviewIdentifier').textContent = selectedSystem.name;
                } else {
                    document.getElementById('neighborDisplayName').value = '';
                    document.getElementById('neighborPreviewIdentifier').textContent = '-';
                }
            });
            
        function saveNeighborSystem() {
            const displayName = document.getElementById('neighborDisplayName').value.trim();
            const jumpsMin = parseInt(document.getElementById('neighborJumpsMin').value);
            const jumpsMax = parseInt(document.getElementById('neighborJumpsMax').value);
            const selectedSystemIndex = document.getElementById('neighborSystemSelect').value;
            
            // ‚úÖ NEW: Advanced neighbor parameters
            const useDistance = document.getElementById('neighborUseDistance')?.checked || false;
            const distance = useDistance ? parseInt(document.getElementById('neighborDistance')?.value || 0) : null;
            
            const useOrientation = document.getElementById('neighborUseOrientation')?.checked || false;
            const minOrientation = useOrientation ? parseInt(document.getElementById('neighborMinOrientation')?.value || 0) : null;
            const maxOrientation = useOrientation ? parseInt(document.getElementById('neighborMaxOrientation')?.value || 360) : null;
            
            const useHyperlaneDistance = document.getElementById('neighborUseHyperlaneDistance')?.checked || false;
            const hyperlaneDistance = useHyperlaneDistance ? parseInt(document.getElementById('neighborHyperlaneDistance')?.value || 0) : null;
            
            const useSpawnChance = document.getElementById('neighborUseSpawnChance')?.checked || false;
            const spawnChance = useSpawnChance ? parseInt(document.getElementById('neighborSpawnChance')?.value || 100) : null;
            
            if (!displayName) {
                showNotification('‚ö†Ô∏è Please enter a display name!');
                return;
            }
            
            // ‚úÖ FIX: Verwende echten System-Identifier wenn aus Liste gew√§hlt, sonst generiere neu
            let identifier;
            if (selectedSystemIndex !== '') {
                // Benutzer hat existierendes System aus Dropdown gew√§hlt
                identifier = allSystems[selectedSystemIndex].name;
            } else {
                // Benutzer hat manuell einen Namen eingegeben
                identifier = generateNeighborIdentifier(displayName);
            }
            
            const neighborData = {
                id: Date.now() + Math.random(),
                mode: 'reference',
                initializer: identifier,
                linkedSystemIndex: selectedSystemIndex !== '' ? parseInt(selectedSystemIndex) : undefined,
                hyperlaneJumps: {
                    min: jumpsMin,
                    max: jumpsMax
                },
                // ‚úÖ NEW: Advanced parameters
                distance: distance,
                minOrientationAngle: minOrientation,
                maxOrientationAngle: maxOrientation,
                hyperlaneDistance: hyperlaneDistance,
                spawnChance: spawnChance
            };
            
            allSystems[currentSystemIndex].neighborSystems.push(neighborData);
            
            document.getElementById('neighborModal').classList.remove('active');
            showNotification(`‚úÖ Neighbor system "${identifier}" added!`);
            loadSystemIntoEditor(allSystems[currentSystemIndex]);
        }

        function deleteNeighborSystem(index) {
            if (confirm('Really remove neighbor system?')) {
                allSystems[currentSystemIndex].neighborSystems.splice(index, 1);
                showNotification('üóëÔ∏è Neighbor system removed!');
                loadSystemIntoEditor(allSystems[currentSystemIndex]);
            }
        }

        // =====================================================
        // ASTEROID BELT MANAGEMENT
        // =====================================================
        
        function openAddAsteroidBeltModal() {
            document.getElementById('beltType').value = 'rocky_asteroid_belt';
            document.getElementById('beltRadius').value = '90';
            
            document.getElementById('asteroidBeltModal').classList.add('active');
        }

        function saveAsteroidBelt() {
            const type = document.getElementById('beltType').value;
            const radius = parseInt(document.getElementById('beltRadius').value);
            
            const beltData = {
                id: Date.now() + Math.random(),
                type: type,
                radius: radius
            };
            
            allSystems[currentSystemIndex].asteroidBelts.push(beltData);
            
            document.getElementById('asteroidBeltModal').classList.remove('active');
            showNotification('‚úÖ Asteroid belt added!');
            loadSystemIntoEditor(allSystems[currentSystemIndex]);
        }

        function deleteAsteroidBelt(index) {
            if (confirm('Really delete asteroid belt?')) {
                allSystems[currentSystemIndex].asteroidBelts.splice(index, 1);
                showNotification('üóëÔ∏è Asteroid belt deleted!');
                loadSystemIntoEditor(allSystems[currentSystemIndex]);
            }
        }

        // =====================================================
        // SYSTEM MANAGEMENT
        // =====================================================
        
        function editSystemProperties() {
            if (currentSystemIndex === null) return;
            
            const system = allSystems[currentSystemIndex];
            
            // ‚úÖ NEW: Populate system identifier field
            document.getElementById('systemIdentifier').value = system.name || '';
            
            // Populate modal with current system data
            document.getElementById('systemDisplayName').value = system.displayName || '';
            document.getElementById('systemUsage').value = system.usage || 'custom_empire';
            document.getElementById('systemMandatoryNeighbors').checked = system.mandatoryNeighbors || false;
            document.getElementById('systemGenerateHomeResources').checked = system.generateHomeResources !== false;
            
            // Handle star class (check if custom or vanilla)
            const starClassDropdown = document.getElementById('systemStarClass');
            const vanillaClasses = Array.from(starClassDropdown.options)
                .filter(opt => opt.value !== 'CUSTOM')
                .map(opt => opt.value);
            
            if (vanillaClasses.includes(system.class)) {
                starClassDropdown.value = system.class;
                document.getElementById('customStarClassField').classList.add('hidden');
            } else {
                starClassDropdown.value = 'CUSTOM';
                document.getElementById('customStarClassField').classList.remove('hidden');
                document.getElementById('customStarClassInput').value = system.class;
            }
            
            // Show modal
            document.getElementById('systemPropertiesModal').classList.add('active');
        }

        function saveSystemProperties() {
            if (currentSystemIndex === null) return;
            
            const system = allSystems[currentSystemIndex];
            
            // ‚úÖ NEW: Get and validate system identifier
            let newIdentifier = document.getElementById('systemIdentifier').value.trim();
            if (newIdentifier) {
                // Sanitize: remove spaces, convert to lowercase, replace invalid chars
                newIdentifier = newIdentifier.toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_]/g, '');
                
                // Auto-add _system_initializer suffix if missing
                if (!newIdentifier.endsWith('_system_initializer')) {
                    // Remove common endings that might be partial
                    newIdentifier = newIdentifier.replace(/_system$/, '').replace(/_initializer$/, '').replace(/_init$/, '');
                    newIdentifier = newIdentifier + '_system_initializer';
                }
                system.name = newIdentifier;
            }
            
            // Get display name
            const newDisplayName = document.getElementById('systemDisplayName').value.trim();
            if (newDisplayName) {
                system.displayName = newDisplayName;
            }
            
            // Get star class
            const starClassDropdown = document.getElementById('systemStarClass');
            if (starClassDropdown.value === 'CUSTOM') {
                const customClass = document.getElementById('customStarClassInput').value.trim();
                if (customClass) {
                    system.class = customClass;
                } else {
                    showNotification('‚ö†Ô∏è Please enter a custom star class!', 'error');
                    return;
                }
            } else {
                system.class = starClassDropdown.value;
                
                // Auto-trigger Star Config Wizard for multi-star systems
                const config = STAR_CLASS_CONFIG[starClassDropdown.value];
                if (config && config.count > 1) {
                    // Close system properties modal first
                    document.getElementById('systemPropertiesModal').classList.remove('active');
                    
                    // Open wizard after short delay
                    setTimeout(() => {
                        openStarConfigWizard();
                    }, 300);
                }
            }
            
            // Get usage
            system.usage = document.getElementById('systemUsage').value;
            
            // Get mandatory neighbors
            system.mandatoryNeighbors = document.getElementById('systemMandatoryNeighbors').checked;
            // Get generate home resources flag
            system.generateHomeResources = document.getElementById('systemGenerateHomeResources').checked;
            
            // Close modal and update UI
            document.getElementById('systemPropertiesModal').classList.remove('active');
            updateSystemList();
            loadSystemIntoEditor(system);
            showNotification('‚úÖ System properties updated!');
        }

        // ==================== STAR CONFIGURATION WIZARD ====================
        
        let wizardStarConfig = null;
        
        function openStarConfigWizard() {
            const starClassDropdown = document.getElementById('systemStarClass');
            const selectedClass = starClassDropdown.value;
            
            // Check if this is a multi-star system
            const config = STAR_CLASS_CONFIG[selectedClass];
            
            if (!config || config.count === 1) {
                showNotification('‚ö†Ô∏è Single star systems don\'t need configuration', 'warning');
                return;
            }
            
            wizardStarConfig = {
                starClass: selectedClass,
                starCount: config.count,
                stars: []
            };
            
            // Initialize stars with suggested types
            const orbits = calculateStarOrbits(config.count);
            const angles = calculateSmartAngles(config.count); // ‚úÖ Smart default angles
            
            for (let i = 0; i < config.count; i++) {
                wizardStarConfig.stars.push({
                    index: i,
                    name: `Star ${i + 1}`,
                    class: config.types[i] || 'pc_g_star',
                    orbitDistance: orbits[i],
                    orbitAngle: angles[i],
                    size: 25
                });
            }

            // Calculate smart default angles for multi-star systems
            function calculateSmartAngles(starCount) {
                if (starCount === 1) return [0];
                if (starCount === 2) return [0, 180];      // Opposite sides
                if (starCount === 3) return [0, 120, 240]; // Evenly distributed
                return [0]; // Fallback
            }
            
            // Update modal info
            document.getElementById('wizardStarClassName').textContent = selectedClass;
            document.getElementById('wizardStarCount').textContent = config.count;
            
            // Render star configuration list
            renderStarConfigList();
            
            // Show modal
            document.getElementById('starConfigModal').classList.add('active');
        }
        
        function renderStarConfigList() {
            const container = document.getElementById('starConfigList');
            container.innerHTML = '';
            
            wizardStarConfig.stars.forEach((star, index) => {
                const starDiv = document.createElement('div');
                starDiv.style.cssText = 'background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px; margin-bottom: 10px; border: 2px solid rgba(0,212,255,0.2);';
                
                starDiv.innerHTML = `
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <label class="label">Star Name</label>
                            <input type="text" value="${star.name}" 
                                   onchange="updateStarConfig(${index}, 'name', this.value)"
                                   class="stellaris-input" placeholder="Star ${index + 1}">
                        </div>
                        
                        <div>
                            <label class="label">Star Type</label>
                            <select onchange="updateStarConfig(${index}, 'class', this.value)" 
                                    class="stellaris-input">
                                <option value="pc_a_star" ${star.class === 'pc_a_star' ? 'selected' : ''}>A-Star (White)</option>
                                <option value="pc_b_star" ${star.class === 'pc_b_star' ? 'selected' : ''}>B-Star (Blue)</option>
                                <option value="pc_f_star" ${star.class === 'pc_f_star' ? 'selected' : ''}>F-Star (Yellowish-White)</option>
                                <option value="pc_g_star" ${star.class === 'pc_g_star' ? 'selected' : ''}>G-Star (Yellow)</option>
                                <option value="pc_k_star" ${star.class === 'pc_k_star' ? 'selected' : ''}>K-Star (Orange)</option>
                                <option value="pc_m_star" ${star.class === 'pc_m_star' ? 'selected' : ''}>M-Star (Red)</option>
                                <option value="pc_black_hole" ${star.class === 'pc_black_hole' ? 'selected' : ''}>Black Hole</option>
                                <option value="pc_neutron_star" ${star.class === 'pc_neutron_star' ? 'selected' : ''}>Neutron Star</option>
                                <option value="pc_pulsar" ${star.class === 'pc_pulsar' ? 'selected' : ''}>Pulsar</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="label">Orbit Distance</label>
                            <input type="number" value="${star.orbitDistance}" 
                                   onchange="updateStarConfig(${index}, 'orbitDistance', parseFloat(this.value))"
                                   class="stellaris-input" step="5">
                        </div>
                        
                        <div>
                            <label class="label">Orbit Angle (¬∞)</label>
                            <input type="number" value="${star.orbitAngle}" 
                                   onchange="updateStarConfig(${index}, 'orbitAngle', parseFloat(this.value))"
                                   class="stellaris-input" min="0" max="360">
                        </div>
                        
                        <div>
                            <label class="label">Star Size</label>
                            <input type="number" value="${star.size}" 
                                   onchange="updateStarConfig(${index}, 'size', parseInt(this.value))"
                                   class="stellaris-input" min="10" max="50">
                        </div>
                    </div>
                `;
                
                container.appendChild(starDiv);
            });
        }
        
        function updateStarConfig(index, property, value) {
            if (wizardStarConfig && wizardStarConfig.stars[index]) {
                wizardStarConfig.stars[index][property] = value;
            }
        }

        function resetStarAngles() {
            if (!wizardStarConfig) return;
            
            const smartAngles = calculateSmartAngles(wizardStarConfig.starCount);
            wizardStarConfig.stars.forEach((star, index) => {
                star.orbitAngle = smartAngles[index];
            });
            
            renderStarConfigList();
            showNotification('üîÑ Angles reset to smart distribution', 'success');
        }
        
        function randomizeStarAngles() {
            if (!wizardStarConfig) return;
            
            wizardStarConfig.stars.forEach(star => {
                star.orbitAngle = Math.floor(Math.random() * 360);
            });
            
            renderStarConfigList();
            showNotification('üé≤ Angles randomized!', 'success');
        }
        
        function applyStarConfiguration() {
            if (!wizardStarConfig || currentSystemIndex === null) return;
            
            const system = allSystems[currentSystemIndex];
            
            // Clear existing stars
            system.planets = system.planets.filter(p => !p.class.includes('star') && !p.class.includes('black_hole'));
            
            // Add configured stars
            wizardStarConfig.stars.forEach(star => {
                system.planets.unshift({
                    name: star.name,
                    displayName: star.name, // ‚úÖ FIX: Add displayName for visualizer
                    class: star.class,
                    size: star.size,
                    orbitDistance: star.orbitDistance,
                    // ‚úÖ FIX: Set orbitAngleType for proper export
                    orbitAngleType: 'fixed',
                    orbitAngle: star.orbitAngle,
                    orbitAngleMin: 90,
                    orbitAngleMax: 270,
                    hasRing: false,
                    changeOrbit: 0,
                    moons: [],
                    modifiers: [],
                    flags: [],
                    deposits: [],
                    surveyTime: 1,
                    colonizable: false,
                    isStartingPlanet: false,
                    isGuaranteedHabitable: false,
                    isHomePlanet: false
                });
            });
            
            // Close modal and update
            closeStarConfigWizard();
            loadSystemIntoEditor(system);
            drawSystem();
            showNotification(`‚úÖ ${wizardStarConfig.starCount} stars configured successfully!`, 'success');
        }
        
        function closeStarConfigWizard() {
            document.getElementById('starConfigModal').classList.remove('active');
            wizardStarConfig = null;
        }

        function toggleCustomStarClass() {
            const dropdown = document.getElementById('systemStarClass');
            const customField = document.getElementById('customStarClassField');
            const wizardButton = document.getElementById('starConfigWizardButton');
            
            if (dropdown.value === 'CUSTOM') {
                customField.classList.remove('hidden');
                document.getElementById('customStarClassInput').focus();
                wizardButton.style.display = 'none';
            } else {
                customField.classList.add('hidden');
                
                // Show wizard button for multi-star systems
                const config = STAR_CLASS_CONFIG[dropdown.value];
                if (config && config.count > 1) {
                    wizardButton.style.display = 'block';
                } else {
                    wizardButton.style.display = 'none';
                }
            }
        }

        function deleteCurrentSystem() {
            if (currentSystemIndex === null) return;
            
            if (confirm(`Really delete system "${allSystems[currentSystemIndex].displayName}"?`)) {
                allSystems.splice(currentSystemIndex, 1);
                
                if (allSystems.length > 0) {
                    selectSystem(Math.min(currentSystemIndex, allSystems.length - 1));
                } else {
                    currentSystemIndex = null;
                    clearEditor();
                    document.getElementById('importInfo').classList.add('hidden');
                }
                
                updateSystemList();
                showNotification('üóëÔ∏è System deleted!');
            }
        }

        // ‚úÖ NEW: Toggle custom planet class input
        window.toggleCustomPlanetClass = function() {
            const select = document.getElementById('planetClass');
            const customInput = document.getElementById('planetClassCustom');
            
            if (select.value === 'CUSTOM') {
                customInput.classList.remove('hidden');
                customInput.focus();
            } else {
                customInput.classList.add('hidden');
            }
        };

        // ‚úÖ NEW: Toggle custom moon class input
        window.toggleCustomMoonClass = function() {
            const select = document.getElementById('moonClass');
            const customInput = document.getElementById('moonClassCustom');
            
            if (select.value === 'CUSTOM') {
                customInput.classList.remove('hidden');
                customInput.focus();
            } else {
                customInput.classList.add('hidden');
            }
        };

        // Make functions globally accessible
        window.deleteCurrentSystem = deleteCurrentSystem;
        window.editSystemProperties = editSystemProperties;
        window.saveSystemProperties = saveSystemProperties;
        window.toggleCustomStarClass = toggleCustomStarClass;
        window.openAddPlanetModal = openAddPlanetModal;
        window.openEditPlanetModal = openEditPlanetModal;
        window.deletePlanet = deletePlanet;
        window.movePlanetUp = movePlanetUp;
        window.movePlanetDown = movePlanetDown;
        window.openAddMoonModal = openAddMoonModal;
        window.editMoon = editMoon;
        window.deleteMoon = deleteMoon;
        window.openAddNeighborModal = openAddNeighborModal;
        window.deleteNeighborSystem = deleteNeighborSystem;
        window.openAddAsteroidBeltModal = openAddAsteroidBeltModal;
        window.deleteAsteroidBelt = deleteAsteroidBelt;

        // =====================================================
        // CODE GENERATION
        // =====================================================
        
        function generateSystemCode(system) {
            let code = `${system.name} = {\n`;
            code += `\tname = "${system.displayName}"\n`;
            code += `\tclass = "${system.class}"\n`;
            
            system.asteroidBelts.forEach(belt => {
                code += `\tasteroid_belt = {\n`;
                code += `\t\ttype = ${belt.type}\n`;
                code += `\t\tradius = ${belt.radius}\n`;
                code += `\t}\n`;
            });
            
            // ‚úÖ FEATURE 8: Export stars (planets with class = star or pc_*_star) FIRST
            const starClasses = ['star', 'pc_g_star', 'pc_k_star', 'pc_m_star', 'pc_f_star', 
                                 'pc_a_star', 'pc_b_star', 'pc_o_star', 'pc_black_hole', 
                                 'pc_neutron_star', 'pc_pulsar'];
            const starPlanets = system.planets.filter(p => starClasses.includes(p.class));
            const regularPlanets = system.planets.filter(p => !starClasses.includes(p.class));
            
            // If no star planets exist, generate default primary star
            if (starPlanets.length === 0) {
                code += `\n\tplanet = {\n`;
                code += `\t\tclass = star\n`;
                code += `\t\torbit_distance = 0\n`;
                code += `\t}\n`;
            } else {
                // Export all star planets first
                starPlanets.forEach(starPlanet => {
                    code += generatePlanetCode(starPlanet, 1);
                });
            }
            
            // ‚úÖ NEW: Skip usage line if set to 'none'
            if (system.usage !== 'none') {
                code += `\tusage = ${system.usage}\n`;
            }
            
            // ‚úÖ NEU: Mandatory Neighbors Export
            if (system.mandatoryNeighbors && system.neighborSystems.length > 0) {
                code += `\tmandatory_neighbors = yes\n`;
            }
            
            if (system.isMain) {
                code += `\tinit_effect = {\n`;
                code += `\t\tevery_neighbor_system = {\n`;
                code += `\t\t\tset_star_flag = empire_cluster\n`;
                code += `\t\t\tevery_neighbor_system = {\n`;
                code += `\t\t\t\tset_star_flag = empire_cluster\n`;
                code += `\t\t\t}\n`;
                code += `\t\t}\n`;
                // ‚úÖ FIX 9: Only export if checkbox is enabled
                if (system.generateHomeResources !== false) {
                    code += `\t\tgenerate_home_system_resources = yes\n`;
                }
                code += `\t}\n`;
            }
            
            // Export regular planets (non-stars)
            regularPlanets.forEach(planet => {
                code += generatePlanetCode(planet, 1);
            });
            
            system.neighborSystems.forEach(neighbor => {
                code += `\n\tneighbor_system = {\n`;
                code += `\t\thyperlane_jumps = { min = ${neighbor.hyperlaneJumps.min} max = ${neighbor.hyperlaneJumps.max} }\n`;
                
                // ‚úÖ NEW: Export advanced parameters if set
                if (neighbor.distance !== null && neighbor.distance !== undefined) {
                    code += `\t\tdistance = ${neighbor.distance}\n`;
                }
                
                if (neighbor.minOrientationAngle !== null && neighbor.maxOrientationAngle !== null) {
                    code += `\t\tmin_orientation_angle = ${neighbor.minOrientationAngle}\n`;
                    code += `\t\tmax_orientation_angle = ${neighbor.maxOrientationAngle}\n`;
                }
                
                if (neighbor.hyperlaneDistance !== null && neighbor.hyperlaneDistance !== undefined) {
                    code += `\t\thyperlane_distance = ${neighbor.hyperlaneDistance}\n`;
                }
                
                if (neighbor.spawnChance !== null && neighbor.spawnChance !== undefined && neighbor.spawnChance < 100) {
                    code += `\t\tspawn_chance = ${neighbor.spawnChance}\n`;
                }
                
                code += `\t\tinitializer = "${neighbor.initializer}"\n`;
                code += `\t}\n`;
            });
            
            code += `}\n`;
            
            return code;
        }

        function generatePlanetCode(planet, indentLevel) {
            const tab = '\t'.repeat(indentLevel);
            let code = `\n${tab}planet = {\n`;
            
            code += `${tab}\tname = "${planet.name}"\n`;
            // Verwende ideal_design_class f√ºr garantierte bewohnbare Planeten
            if (planet.isGuaranteedHabitable) {
                code += `${tab}\tclass = ideal_design_class\n`;
            } else {
                code += `${tab}\tclass = "${planet.class}"\n`;
            }
            code += `${tab}\torbit_distance = ${planet.orbitDistance}\n`;
            
            // Export orbit_angle based on type
            if (planet.orbitAngleType === 'fixed') {
                code += `${tab}\torbit_angle = ${planet.orbitAngle}\n`;
            } else {
                code += `${tab}\torbit_angle = { min = ${planet.orbitAngleMin} max = ${planet.orbitAngleMax} }\n`;
            }
            
            code += `${tab}\tsize = ${planet.size}\n`;
            
            if (planet.changeOrbit > 0) {
                code += `${tab}\tchange_orbit = ${planet.changeOrbit}\n`;
            }
            
            code += `${tab}\thas_ring = ${planet.hasRing ? 'yes' : 'no'}\n`;
            
            // Export modifiers for ALL planets
            if (planet.modifiers && planet.modifiers.length > 0) {
                code += `${tab}\tmodifiers = { ${planet.modifiers.join(' ')} }\n`;
            }
            
            // ‚úÖ NEW: Home planet for random empires
            if (planet.isHomePlanet) {
                code += `${tab}\thome_planet = yes\n`;
            }
            
            if (planet.isStartingPlanet) {
                code += `${tab}\tstarting_planet = yes\n`;
                code += `${tab}\tdeposit_blockers = none\n`;
                // Only add "modifiers = none" if no modifiers exist
                if (!planet.modifiers || planet.modifiers.length === 0) {
                    code += `${tab}\tmodifiers = none\n`;
                }
                code += `${tab}\tinit_effect = {\n`;
                code += `${tab}\t\tprevent_anomaly = yes\n`;
                
                // ‚úÖ NEW: Export deposits in init_effect
                if (planet.deposits && planet.deposits.length > 0) {
                    planet.deposits.forEach(deposit => {
                        code += `${tab}\t\tadd_deposit = ${deposit}\n`;
                    });
                }
                
                code += `${tab}\t}\n`;
                code += `${tab}\tinit_effect = {\n`;
                code += `${tab}\t\tgenerate_empire_home_planet = yes\n`;
                code += `${tab}\t}\n`;
            } else {
                // ‚úÖ NEW: For non-starting planets, deposits go in separate init_effect
                if (planet.deposits && planet.deposits.length > 0) {
                    code += `${tab}\tinit_effect = {\n`;
                    planet.deposits.forEach(deposit => {
                        code += `${tab}\t\tadd_deposit = ${deposit}\n`;
                    });
                    code += `${tab}\t}\n`;
                }
            }

            if (planet.isGuaranteedHabitable) {
                code += `${tab}\tmodifiers = none\n`;
                code += `${tab}\tanomaly = none\n`;
                code += `${tab}\tinit_effect = {\n`;
                code += `${tab}\t\tprevent_anomaly = yes\n`;
                code += `${tab}\t\tset_planet_flag = prescripted_ideal\n`;
                code += `${tab}\t}\n`;
            }
    //
    //
    // This change does the following:

    // 1. ‚úÖ **For normal planets with modifiers**: Exports `modifiers = { pm_xyz pm_abc }`
    // 2. ‚úÖ **For normal planets without modifiers**: No modifier line (as is usual in Stellaris)
    // 3. ‚úÖ **For starting planets with modifiers**: Exports the modifiers and NOT `modifiers = none`
    // 4. ‚úÖ **For starting planets without modifiers**: Exports `modifiers = none` (as expected by Stellaris)

    // Now the export should work correctly! Please test it again and check the export preview. The modifiers should now appear as:
    
    //  planet = {
    //      name = "Balder"
    //      class = "pc_molten"
    //      orbit_distance = 25
    //      orbit_angle = { min = 90 max = 270 }
    //      size = 20
    //      has_ring = no
    //      modifiers = { pm_carbon_world }
    //  }
            
            planet.moons.forEach(moon => {
                const moonCode = generatePlanetCode(moon, indentLevel + 1);
                code += moonCode.replace(/\n\s*planet\s*=\s*\{/, '\n' + tab + '\tmoon = {');
            });
            
            code += `${tab}}\n`;
            
            return code;
        }

        function generateLocalizationYML(systems) {
            let yml = 'l_english:\n';
            
            systems.forEach(system => {
                const baseName = system.name.replace(/_system_initializer$/, '');
                const identifier = `${baseName}_system_initializer`;
                
                // NAME entry
                yml += ` ${identifier}_NAME:0 "${system.displayName}"\n`;
                
                // DESC entry - create a default description
                const description = `${system.displayName} Description: A custom star system created with the Stellaris Solar System Editor.`;
                yml += ` ${identifier}_DESC:0 "${description}"\n`;
            });
            
            return yml;
        }

        // =====================================================
        // HELPER FUNCTIONS
        // =====================================================
        
        function getPlanetIcon(planetClass) {
            const icons = {
                'pc_g_star': '‚òÄÔ∏è', 'pc_k_star': 'üåü', 'pc_m_star': 'üî¥',
                'pc_f_star': '‚≠ê', 'pc_a_star': 'üí´', 'pc_b_star': 'üå†',
                'pc_black_hole': '‚ö´', 'pc_neutron_star': 'üí†', 'pc_pulsar': 'üì°',
                'pc_continental': 'üåç', 'pc_ocean': 'üåä', 'pc_desert': 'üèúÔ∏è',
                'pc_tropical': 'üå¥', 'pc_arid': 'üåµ', 'pc_tundra': '‚ùÑÔ∏è',
                'pc_arctic': 'üßä', 'pc_alpine': 'üèîÔ∏è', 'pc_savannah': 'üåæ',
                'pc_gas_giant': 'ü™ê', 'pc_molten': 'üåã', 'pc_barren': 'ü™®',
                'pc_barren_cold': '‚òÑÔ∏è', 'pc_toxic': '‚ò¢Ô∏è', 'pc_frozen': 'üßä',
                'pc_asteroid': '‚òÑÔ∏è', 'pc_ice_asteroid': '‚ùÑÔ∏è', 'pc_rare_crystal_asteroid': 'üíé',
                'pc_crystal_asteroid': 'üí†',
                'pc_nuked': '‚ò¢Ô∏è', 'pc_shattered': 'üí•', 'pc_shattered_2': 'üí•',
                'pc_broken': 'üî•', 'pc_shrouded': 'üëÅÔ∏è', 'pc_shielded': 'üõ°Ô∏è',
                'pc_relic': 'üèõÔ∏è', 'pc_city': 'üåÉ', 'pc_habitat': 'üõ∏',
                'pc_volcanic': 'üåã', 'pc_gray_goo': 'ü¶†', 'pc_ai': 'ü§ñ', 'pc_cybrex': '‚öôÔ∏è'
            };
            return icons[planetClass] || 'üåë';
        }

        function getClassDisplayName(planetClass) {
            const names = {
                'star': '‚≠ê Star',
                'pc_g_star': 'G-Star', 'pc_k_star': 'K-Star', 'pc_m_star': 'M-Star',
                'pc_f_star': 'F-Star', 'pc_a_star': 'A-Star', 'pc_b_star': 'B-Star',
                'pc_black_hole': 'Black Hole', 'pc_neutron_star': 'Neutron Star', 
                'pc_pulsar': 'Pulsar',
                'pc_continental': 'Continental', 'pc_ocean': 'Ocean', 'pc_desert': 'Desert',
                'pc_tropical': 'Tropical', 'pc_arid': 'Arid', 'pc_tundra': 'Tundra',
                'pc_arctic': 'Arctic', 'pc_alpine': 'Alpine', 'pc_savannah': 'Savannah',
                'pc_gas_giant': 'Gas Giant', 'pc_molten': 'Molten', 'pc_barren': 'Barren',
                'pc_barren_cold': 'Barren (Cold)', 'pc_toxic': 'Toxic', 'pc_frozen': 'Frozen',
                'pc_asteroid': 'Asteroid', 'pc_ice_asteroid': 'Ice Asteroid', 
                'pc_rare_crystal_asteroid': 'Rare Crystal Asteroid', 'pc_crystal_asteroid': 'Crystal Asteroid',
                'pc_nuked': 'Nuked (Tomb)', 'pc_shattered': 'Shattered', 'pc_shattered_2': 'Shattered 2',
                'pc_broken': 'Broken', 'pc_shrouded': 'Shrouded', 'pc_shielded': 'Shielded',
                'pc_relic': 'Relic World', 'pc_city': 'Ecumenopolis', 'pc_habitat': 'Habitat',
                'pc_volcanic': 'Volcanic', 'pc_gray_goo': 'Gray Goo', 'pc_ai': 'AI World', 'pc_cybrex': 'Cybrex'
            };
            return names[planetClass] || planetClass;
        }

        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // ===== SYSTEM VISUALIZATION =====
        let canvas, ctx;
        let canvasScale = 1;
        let canvasOffsetX = 0;
        let canvasOffsetY = 0;
        let isDragging = false;
        let lastMouseX = 0;
        let lastMouseY = 0;
        
        function renderSystemVisualization() {
            canvas = document.getElementById('systemCanvas');
            if (!canvas) return;
            
            ctx = canvas.getContext('2d');
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            
            // Reset view
            canvasScale = 1;
            canvasOffsetX = canvas.width / 2;
            canvasOffsetY = canvas.height / 2;
            
            // Setup event listeners
            setupCanvasControls();
            
            // Draw system
            drawSystem();
        }
        
        function setupCanvasControls() {
            // Mouse wheel zoom
            canvas.addEventListener('wheel', (e) => {
                e.preventDefault();
                const delta = e.deltaY > 0 ? 0.9 : 1.1;
                canvasScale *= delta;
                canvasScale = Math.max(0.1, Math.min(5, canvasScale));
                drawSystem();
            });
            
            // Mouse drag pan
            canvas.addEventListener('mousedown', (e) => {
                isDragging = true;
                lastMouseX = e.clientX;
                lastMouseY = e.clientY;
            });
            
            canvas.addEventListener('mousemove', (e) => {
                if (isDragging) {
                    const dx = e.clientX - lastMouseX;
                    const dy = e.clientY - lastMouseY;
                    canvasOffsetX += dx;
                    canvasOffsetY += dy;
                    lastMouseX = e.clientX;
                    lastMouseY = e.clientY;
                    drawSystem();
                }
            });
            
            canvas.addEventListener('mouseup', () => {
                isDragging = false;
            });
            
            canvas.addEventListener('mouseleave', () => {
                isDragging = false;
            });
        }
        
        function resetCanvasView() {
            canvasScale = 1;
            canvasOffsetX = canvas.width / 2;
            canvasOffsetY = canvas.height / 2;
            drawSystem();
        }
        
        function drawSystem() {
            if (!canvas || !ctx || !allSystems[currentSystemIndex]) return;
            
            const system = allSystems[currentSystemIndex];
            
            // Clear canvas
            ctx.fillStyle = '#0a0e1a';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Draw background grid
            drawGrid();
            
            // ‚úÖ STERN-KLASSEN: Diese Planet-Classes sind eigentlich Sterne
            const starClasses = [
                'pc_g_star', 'pc_k_star', 'pc_m_star', 'pc_f_star', 
                'pc_a_star', 'pc_b_star', 'pc_black_hole', 
                'pc_neutron_star', 'pc_pulsar'
            ];
            
            // ‚úÖ Filter: Trenne Sterne von echten Planeten
            const actualPlanets = system.planets.filter(p => !starClasses.includes(p.class));
            const starPlanets = system.planets.filter(p => starClasses.includes(p.class));
            
            // Draw main system star (from system.class) - ONLY if no stars in planets list
            if (starPlanets.length === 0) {
                drawStar(system.class);
            }
            
            // ‚úÖ Draw additional stars as "planets" (binary/trinary systems)
            starPlanets.forEach(starPlanet => {
                // Stars in planet list get drawn with special handling
                let cumulativeStarOrbit = 0;
                // Calculate cumulative orbit for this star
                const starIndex = system.planets.indexOf(starPlanet);
                for (let i = 0; i <= starIndex; i++) {
                    if (system.planets[i].orbitDistance > 0) {
                        cumulativeStarOrbit += system.planets[i].orbitDistance;
                    }
                }
                
                const distance = cumulativeStarOrbit * canvasScale;
                const angle = (starPlanet.orbitAngleType === 'fixed' ? starPlanet.orbitAngle : 90) * Math.PI / 180;
                const x = canvasOffsetX + Math.cos(angle) * distance;
                const y = canvasOffsetY + Math.sin(angle) * distance;
                
                // Draw companion star
                const colors = {
                    'pc_g_star': '#FFD700',
                    'pc_k_star': '#FFA500',
                    'pc_m_star': '#FF4500',
                    'pc_f_star': '#F0E68C',
                    'pc_a_star': '#FFFFFF',
                    'pc_b_star': '#87CEEB',
                    'pc_black_hole': '#000000',
                    'pc_neutron_star': '#9370DB',
                    'pc_pulsar': '#FF1493'
                };
                
                const color = colors[starPlanet.class] || '#FFD700';
                const radius = 12 * canvasScale;
                
                // Draw glow
                const gradient = ctx.createRadialGradient(x, y, 0, x, y, radius * 2);
                gradient.addColorStop(0, color + '80');
                gradient.addColorStop(1, color + '00');
                ctx.fillStyle = gradient;
                ctx.fillRect(x - radius * 2, y - radius * 2, radius * 4, radius * 4);
                
                // Draw star
                ctx.fillStyle = color;
                ctx.beginPath();
                ctx.arc(x, y, radius, 0, Math.PI * 2);
                ctx.fill();
                
                // Label
                if (canvasScale > 0.8) {
                    ctx.fillStyle = '#e2e8f0';
                    ctx.font = `${10 * canvasScale}px 'Exo 2', sans-serif`;
                    ctx.textAlign = 'center';
                    ctx.fillText(starPlanet.displayName, x, y - radius - 8);
                }
            });
            
            // ‚úÖ KUMULATIVE Orbit-Berechnung f√ºr ECHTE Planeten mit orbit_distance = 0 Support
            let cumulativePlanetOrbit = 0;
            let sharedOrbitGroup = []; // Gruppe von Planeten auf derselben Bahn
            let globalPlanetAngleIndex = 0; // ‚úÖ Globaler Winkel-Counter f√ºr visuelle Verteilung
            
            actualPlanets.forEach((planet, index) => {
                // Berechne kumulative Orbit-Position
                if (planet.orbitDistance > 0) {
                    // Zeichne vorherige Gruppe mit orbit_distance = 0
                    if (sharedOrbitGroup.length > 0) {
                        drawPlanetsAndMoons(sharedOrbitGroup, cumulativePlanetOrbit, globalPlanetAngleIndex);
                        globalPlanetAngleIndex += sharedOrbitGroup.length; // Erh√∂he Counter
                        sharedOrbitGroup = [];
                    }
                    
                    cumulativePlanetOrbit += planet.orbitDistance;
                    drawOrbit(cumulativePlanetOrbit);
                }
                
                // Erster Planet mit orbit_distance = 0
                if (index === 0 && planet.orbitDistance === 0) {
                    cumulativePlanetOrbit = 30;
                    drawOrbit(cumulativePlanetOrbit);
                }
                
                // F√ºge Planet zur aktuellen Orbit-Gruppe hinzu
                sharedOrbitGroup.push({
                    planet: planet,
                    orbitDistance: cumulativePlanetOrbit
                });
            });
            
            // Zeichne letzte Gruppe
            if (sharedOrbitGroup.length > 0) {
                drawPlanetsAndMoons(sharedOrbitGroup, cumulativePlanetOrbit, globalPlanetAngleIndex);
            }
            
            // ‚úÖ ABSOLUTE Position f√ºr Asteroid-G√ºrtel
            system.asteroidBelts.forEach(belt => {
                drawAsteroidBelt(belt.radius);
            });
        }
        
        // ‚úÖ NEW: Zeichne Planeten-Gruppe und ihre Monde
        function drawPlanetsAndMoons(planetGroup, orbitDistance, startAngleIndex) {
            // ‚úÖ Wenn Gruppe nur 1 Planet hat: Verwende globale Verteilung (0¬∞, 90¬∞, 180¬∞, 270¬∞)
            // ‚úÖ Wenn Gruppe mehrere Planeten hat: Verteile sie gleichm√§√üig auf dieser Bahn
            const useGlobalDistribution = planetGroup.length === 1;
            const angleStep = useGlobalDistribution ? 90 : (360 / planetGroup.length);
            
            planetGroup.forEach((item, index) => {
                const planet = item.planet;
                const angleIndex = useGlobalDistribution ? startAngleIndex : index;
                const planetAngle = (angleIndex * angleStep) * Math.PI / 180;
                //```
                //
                //---

                //## ‚úÖ **Was wurde gefixt:**

                //### **Neue Winkelverteilung:**
                //1. ‚úÖ **Einzelne Planeten auf verschiedenen Orbits**: 0¬∞, 90¬∞, 180¬∞, 270¬∞, 0¬∞, 90¬∞, ...
                //2. ‚úÖ **Mehrere Planeten auf demselben Orbit**: Gleichm√§√üig verteilt auf 360¬∞ / Anzahl
                //3. ‚úÖ **Globaler Counter** z√§hlt alle Planeten f√ºr bessere visuelle Verteilung

                //### **Beispiele:**
                //```
                //System mit 8 Planeten auf verschiedenen Orbits:
                //- Planet 1 (Orbit 10): 0¬∞
                //- Planet 2 (Orbit 25): 90¬∞
                //- Planet 3 (Orbit 40): 180¬∞
                //- Planet 4 (Orbit 60): 270¬∞
                //- Planet 5 (Orbit 80): 0¬∞
                //- Planet 6 (Orbit 100): 90¬∞
                //- Planet 7 (Orbit 120): 180¬∞
                //- Planet 8 (Orbit 150): 270¬∞

                //System mit 3 Planeten auf EINEM Orbit (orbit_distance = 0):
                //- Planet 1: 0¬∞
                //- Planet 2: 120¬∞
                //- Planet 3: 240¬∞//
                
                // ‚úÖ Zeichne Planeten an seiner Position
                drawPlanet(planet, orbitDistance, planetAngle);
                
                // ‚úÖ Zeichne Monde um diesen Planeten
                if (planet.moons && planet.moons.length > 0) {
                    const planetDistance = orbitDistance * canvasScale;
                    const planetX = canvasOffsetX + Math.cos(planetAngle) * planetDistance;
                    const planetY = canvasOffsetY + Math.sin(planetAngle) * planetDistance;
                    
                    let cumulativeMoonOrbit = 0;
                    let sharedMoonGroup = [];
                    
                    planet.moons.forEach((moon, moonIndex) => {
                        if (moon.orbitDistance > 0) {
                            // Zeichne vorherige Mond-Gruppe
                            if (sharedMoonGroup.length > 0) {
                                drawMoonGroup(sharedMoonGroup, planetX, planetY, cumulativeMoonOrbit);
                                sharedMoonGroup = [];
                            }
                            
                            cumulativeMoonOrbit += moon.orbitDistance;
                            drawMoonOrbit(orbitDistance, planetAngle, cumulativeMoonOrbit);
                        }
                        
                        if (moonIndex === 0 && moon.orbitDistance === 0) {
                            cumulativeMoonOrbit = 10;
                            drawMoonOrbit(orbitDistance, planetAngle, cumulativeMoonOrbit);
                        }
                        
                        sharedMoonGroup.push(moon);
                    });
                    
                    // Zeichne letzte Mond-Gruppe
                    if (sharedMoonGroup.length > 0) {
                        drawMoonGroup(sharedMoonGroup, planetX, planetY, cumulativeMoonOrbit);
                    }
                }
            });
        }
        
        // ‚úÖ NEW: Zeichne Mond-Gruppe um Planeten
        function drawMoonGroup(moons, planetX, planetY, moonOrbitRadius) {
            const angleStep = 360 / moons.length;
            
            moons.forEach((moon, index) => {
                const moonAngle = (index * angleStep) * Math.PI / 180;
                drawMoonAroundPlanet(moon, planetX, planetY, moonOrbitRadius, moonAngle);
            });
        }

        // ‚úÖ NEW: Zeichne Mond-Umlaufbahn um Planeten (nicht um Stern!)
        function drawMoonOrbit(planetOrbit, planetAngle, moonOrbitRadius) {
            // Calculate planet position
            const planetDistance = planetOrbit * canvasScale;
            const planetX = canvasOffsetX + Math.cos(planetAngle) * planetDistance;
            const planetY = canvasOffsetY + Math.sin(planetAngle) * planetDistance;
            
            const moonOrbitSize = moonOrbitRadius * canvasScale;
            
            // Draw moon orbit around planet
            ctx.strokeStyle = 'rgba(153, 102, 255, 0.3)';
            ctx.lineWidth = 1;
            ctx.setLineDash([5, 5]);
            
            ctx.beginPath();
            ctx.arc(planetX, planetY, moonOrbitSize, 0, Math.PI * 2);
            ctx.stroke();
            
            ctx.setLineDash([]);
        }
        
        // ‚úÖ NEW: Zeichne Mond relativ zum Planeten
        function drawMoonAroundPlanet(moon, planetX, planetY, moonOrbitRadius, moonAngle) {
            const moonDistance = moonOrbitRadius * canvasScale;
            
            // Moon position relative to planet
            const x = planetX + Math.cos(moonAngle) * moonDistance;
            const y = planetY + Math.sin(moonAngle) * moonDistance;
            
            const radius = Math.max(2, Math.log(moon.size + 1) * canvasScale);
            
            // Moon color
            ctx.fillStyle = '#9ca3af';
            ctx.beginPath();
            ctx.arc(x, y, radius, 0, Math.PI * 2);
            ctx.fill();
            
            // Draw starting planet indicator for moons
            if (moon.isStartingPlanet) {
                ctx.strokeStyle = '#48bb78';
                ctx.lineWidth = 1.5;
                ctx.beginPath();
                ctx.arc(x, y, radius + 2, 0, Math.PI * 2);
                ctx.stroke();
            }
            
            // Draw moon label for larger zoom levels
            if (canvasScale > 1.2) {
                ctx.fillStyle = '#cbd5e0';
                ctx.font = `${8 * canvasScale}px 'Exo 2', sans-serif`;
                ctx.textAlign = 'center';
                ctx.fillText(moon.displayName, x, y - radius - 6);
            }
        }
        
        function drawGrid() {
            ctx.strokeStyle = 'rgba(0, 212, 255, 0.1)';
            ctx.lineWidth = 1;
            
            const gridSize = 50 * canvasScale;
            const startX = (canvasOffsetX % gridSize) - gridSize;
            const startY = (canvasOffsetY % gridSize) - gridSize;
            
            // Vertical lines
            for (let x = startX; x < canvas.width + gridSize; x += gridSize) {
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, canvas.height);
                ctx.stroke();
            }
            
            // Horizontal lines
            for (let y = startY; y < canvas.height + gridSize; y += gridSize) {
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(canvas.width, y);
                ctx.stroke();
            }
        }
        
        function drawStar(starClass) {
            const colors = {
                'pc_g_star': '#FFD700',
                'pc_k_star': '#FFA500',
                'pc_m_star': '#FF4500',
                'pc_f_star': '#F0E68C',
                'pc_a_star': '#FFFFFF',
                'pc_b_star': '#87CEEB',
                'pc_black_hole': '#000000',
                'pc_neutron_star': '#9370DB',
                'pc_pulsar': '#FF1493'
            };
            
            const color = colors[starClass] || '#FFD700';
            const radius = 15 * canvasScale;
            
            // Draw glow
            const gradient = ctx.createRadialGradient(
                canvasOffsetX, canvasOffsetY, 0,
                canvasOffsetX, canvasOffsetY, radius * 2
            );
            gradient.addColorStop(0, color + '80');
            gradient.addColorStop(1, color + '00');
            
            ctx.fillStyle = gradient;
            ctx.fillRect(
                canvasOffsetX - radius * 2,
                canvasOffsetY - radius * 2,
                radius * 4,
                radius * 4
            );
            
            // Draw star
            ctx.fillStyle = color;
            ctx.beginPath();
            ctx.arc(canvasOffsetX, canvasOffsetY, radius, 0, Math.PI * 2);
            ctx.fill();
            
            // Black hole border
            if (starClass === 'pc_black_hole') {
                ctx.strokeStyle = '#9966ff';
                ctx.lineWidth = 2;
                ctx.stroke();
            }
        }
        
        function drawOrbit(distance, isMoon = false) {
            const radius = distance * canvasScale;
            
            ctx.strokeStyle = isMoon ? 'rgba(153, 102, 255, 0.3)' : 'rgba(0, 212, 255, 0.3)';
            ctx.lineWidth = isMoon ? 1 : 1.5;
            ctx.setLineDash(isMoon ? [5, 5] : []);
            
            ctx.beginPath();
            ctx.arc(canvasOffsetX, canvasOffsetY, radius, 0, Math.PI * 2);
            ctx.stroke();
            
            ctx.setLineDash([]);
        }
        
        function drawPlanet(planet, absoluteOrbit, forceAngle = null) {
            const angle = forceAngle !== null 
                ? forceAngle 
                : (planet.orbitAngleType === 'fixed' ? planet.orbitAngle : 90) * Math.PI / 180;
            const distance = absoluteOrbit * canvasScale;
            
            const x = canvasOffsetX + Math.cos(angle) * distance;
            const y = canvasOffsetY + Math.sin(angle) * distance;
            
            // Calculate size (logarithmic scale for better visualization)
            const baseSize = Math.max(3, Math.log(planet.size + 1) * 2) * canvasScale;
            const radius = Math.max(3, baseSize);
            
            // Planet color based on class
            const colors = {
                'pc_continental': '#48bb78',
                'pc_ocean': '#4299e1',
                'pc_desert': '#ecc94b',
                'pc_tropical': '#38b2ac',
                'pc_arid': '#d69e2e',
                'pc_tundra': '#90cdf4',
                'pc_arctic': '#bee3f8',
                'pc_alpine': '#e6fffa',
                'pc_savannah': '#faf089',
                'pc_gas_giant': '#ed8936',
                'pc_molten': '#fc8181',
                'pc_barren': '#a0aec0',
                'pc_barren_cold': '#718096',
                'pc_toxic': '#9ae6b4',
                'pc_frozen': '#e2e8f0',
                'pc_nuked': '#6b7280',
                'pc_shattered': '#4a5568',
                'pc_shattered_2': '#4a5568',
                'pc_broken': '#b45309',
                'pc_shrouded': '#7c3aed',
                'pc_shielded': '#3b82f6',
                'pc_relic': '#f59e0b',
                'pc_city': '#fbbf24',
                'pc_habitat': '#8b5cf6',
                'pc_volcanic': '#ef4444',
                'pc_gray_goo': '#6ee7b7',
                'pc_ai': '#60a5fa',
                'pc_cybrex': '#a78bfa',
                'pc_crystal_asteroid': '#c084fc'
            };
            
            const color = colors[planet.class] || '#cbd5e0';
            
            // Draw planet
            ctx.fillStyle = color;
            ctx.beginPath();
            ctx.arc(x, y, radius, 0, Math.PI * 2);
            ctx.fill();
            
            // Draw ring if has ring
            if (planet.hasRing) {
                ctx.strokeStyle = color + '80';
                ctx.lineWidth = 2 * canvasScale;
                ctx.beginPath();
                ctx.ellipse(x, y, radius * 1.8, radius * 0.6, 0, 0, Math.PI * 2);
                ctx.stroke();
            }
            
            // Draw starting planet indicator
            if (planet.isStartingPlanet) {
                ctx.strokeStyle = '#48bb78';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.arc(x, y, radius + 3, 0, Math.PI * 2);
                ctx.stroke();
            }
            
            // Draw label for larger zoom levels
            if (canvasScale > 0.8) {
                ctx.fillStyle = '#e2e8f0';
                ctx.font = `${10 * canvasScale}px 'Exo 2', sans-serif`;
                ctx.textAlign = 'center';
                ctx.fillText(planet.displayName, x, y - radius - 8);
            }
        }
        
        function drawMoon(moon, parentPlanetAbsoluteOrbit, moonAbsoluteOrbit, forceAngle = null) {
            const baseAngle = forceAngle !== null 
                ? forceAngle 
                : 90 * Math.PI / 180;
            
            const distance = moonAbsoluteOrbit * canvasScale;
            
            const x = canvasOffsetX + Math.cos(baseAngle) * distance;
            const y = canvasOffsetY + Math.sin(baseAngle) * distance;
            
            const radius = Math.max(2, Math.log(moon.size + 1) * canvasScale);
            
            // Moon color (slightly darker than planets)
            ctx.fillStyle = '#9ca3af';
            ctx.beginPath();
            ctx.arc(x, y, radius, 0, Math.PI * 2);
            ctx.fill();
            
            // Draw starting planet indicator for moons
            if (moon.isStartingPlanet) {
                ctx.strokeStyle = '#48bb78';
                ctx.lineWidth = 1.5;
                ctx.beginPath();
                ctx.arc(x, y, radius + 2, 0, Math.PI * 2);
                ctx.stroke();
            }
            
            // Draw moon label for larger zoom levels
            if (canvasScale > 1.2) {
                ctx.fillStyle = '#cbd5e0';
                ctx.font = `${8 * canvasScale}px 'Exo 2', sans-serif`;
                ctx.textAlign = 'center';
                ctx.fillText(moon.displayName, x, y - radius - 6);
            }
        }
        
        function drawAsteroidBelt(radius) {
            const distance = radius * canvasScale;
            
            // Draw dashed circle
            ctx.strokeStyle = 'rgba(255, 215, 0, 0.4)';
            ctx.lineWidth = 2;
            ctx.setLineDash([10, 5]);
            
            ctx.beginPath();
            ctx.arc(canvasOffsetX, canvasOffsetY, distance, 0, Math.PI * 2);
            ctx.stroke();
            
            ctx.setLineDash([]);
            
            // Draw asteroid particles
            const particleCount = Math.min(30, Math.floor(distance / 5));
            for (let i = 0; i < particleCount; i++) {
                const angle = (i / particleCount) * Math.PI * 2;
                const variance = (Math.random() - 0.5) * 10 * canvasScale;
                const x = canvasOffsetX + Math.cos(angle) * (distance + variance);
                const y = canvasOffsetY + Math.sin(angle) * (distance + variance);
                
                ctx.fillStyle = 'rgba(255, 215, 0, 0.6)';
                ctx.beginPath();
                ctx.arc(x, y, 1.5 * canvasScale, 0, Math.PI * 2);
                ctx.fill();
            }
        }
    </script>
</body>
</html>
