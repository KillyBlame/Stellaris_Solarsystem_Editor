<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stellaris Solar System Editor V21 - Full Editor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800;900&family=Exo+2:wght@300;400;500;600&display=swap');
        
        :root {
            --stellaris-blue: #00d4ff;
            --stellaris-gold: #ffd700;
            --stellaris-purple: #9966ff;
            --stellaris-dark: #0a0e1a;
            --stellaris-darker: #050811;
            --stellaris-panel: #1a2332;
            --stellaris-border: #2a3847;
            --stellaris-accent: #00a8cc;
            --stellaris-green: #48bb78;
        }

        body {
            font-family: 'Exo 2', 'Inter', sans-serif;
            background: linear-gradient(135deg, var(--stellaris-darker) 0%, var(--stellaris-dark) 50%, #0f1419 100%);
            color: #e2e8f0;
            min-height: 100vh;
            background-attachment: fixed;
        }

        .stellaris-header {
            background: linear-gradient(90deg, var(--stellaris-blue) 0%, var(--stellaris-purple) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-family: 'Orbitron', monospace;
            font-weight: 700;
            text-align: center;
            font-size: 2.5rem;
            margin-bottom: 2rem;
            text-shadow: 0 0 20px rgba(0, 212, 255, 0.3);
        }

        .stellaris-panel {
            background: linear-gradient(145deg, var(--stellaris-panel) 0%, rgba(26, 35, 50, 0.8) 100%);
            border: 1px solid var(--stellaris-border);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            position: relative;
            overflow: hidden;
        }

        .stellaris-panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, var(--stellaris-blue), var(--stellaris-purple), var(--stellaris-gold));
        }

        .system-selector-item {
            background: linear-gradient(145deg, rgba(74, 85, 104, 0.4) 0%, rgba(45, 55, 72, 0.6) 100%);
            border: 1px solid var(--stellaris-border);
            border-radius: 6px;
            padding: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
            border-left: 4px solid transparent;
            margin-bottom: 0.5rem;
        }

        .system-selector-item:hover {
            border-color: var(--stellaris-accent);
            transform: translateX(2px);
        }

        .system-selector-item.active {
            background: linear-gradient(145deg, rgba(0, 212, 255, 0.15) 0%, rgba(153, 102, 255, 0.15) 100%);
            border-left-color: var(--stellaris-blue);
            box-shadow: 0 0 10px rgba(0, 212, 255, 0.2);
        }

        .stellaris-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-primary {
            background: linear-gradient(135deg, var(--stellaris-blue), var(--stellaris-purple));
            color: white;
        }

        .badge-secondary {
            background: rgba(74, 85, 104, 0.6);
            color: var(--stellaris-gold);
        }

        .stellaris-input {
            background: linear-gradient(145deg, #2a3847 0%, #1e2936 100%);
            border: 1px solid var(--stellaris-border);
            color: #e2e8f0;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            width: 100%;
            font-family: 'Exo 2', sans-serif;
            transition: all 0.3s ease;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .stellaris-input:focus {
            outline: none;
            border-color: var(--stellaris-blue);
            box-shadow: 
                inset 0 2px 4px rgba(0, 0, 0, 0.2),
                0 0 0 3px rgba(0, 212, 255, 0.2);
        }

        /* Z-Index Fix f√ºr Dropdowns */
        .stellaris-input select {
            position: relative;
            z-index: 100;
        }

        .modal-content {
            position: relative;
            z-index: 2001;
        }

        .modal-content select {
            position: relative;
            z-index: 2002;
        }

        /* Dropdown-Optionen verbessern */
        .stellaris-input option,
        .stellaris-input optgroup {
            background-color: #2a3847 !important;
            color: #e2e8f0 !important;
            padding: 8px 12px;
        }

        .stellaris-input optgroup {
            font-weight: bold;
            background-color: #1e2936 !important;
        }

        /* Modal √ºber allem */
        .modal {
            z-index: 2000;
        }

        .stellaris-btn {
            background: linear-gradient(135deg, var(--stellaris-blue) 0%, var(--stellaris-accent) 100%);
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 212, 255, 0.3);
            font-family: 'Exo 2', sans-serif;
        }

        .stellaris-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 212, 255, 0.5);
        }

        .stellaris-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .stellaris-btn-secondary {
            background: linear-gradient(135deg, #4a5568 0%, #2d3748 100%);
            box-shadow: 0 4px 15px rgba(74, 85, 104, 0.3);
        }

        .stellaris-btn-secondary:hover {
            box-shadow: 0 6px 20px rgba(74, 85, 104, 0.5);
        }

        .stellaris-btn-danger {
            background: linear-gradient(135deg, #f56565 0%, #c53030 100%);
            box-shadow: 0 4px 15px rgba(245, 101, 101, 0.3);
        }

        .stellaris-btn-danger:hover {
            box-shadow: 0 6px 20px rgba(245, 101, 101, 0.5);
        }

        .stellaris-btn-success {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            box-shadow: 0 4px 15px rgba(72, 187, 120, 0.3);
        }

        .stellaris-btn-success:hover {
            box-shadow: 0 6px 20px rgba(72, 187, 120, 0.5);
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, var(--stellaris-blue), var(--stellaris-purple));
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--stellaris-gold);
            font-size: 0.9rem;
        }

        .multi-system-layout {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 1.5rem;
            min-height: 600px;
        }

        .system-list-panel {
            border-right: 2px solid var(--stellaris-border);
            padding-right: 1.5rem;
        }

        .planet-item {
            background: linear-gradient(145deg, rgba(74, 85, 104, 0.4) 0%, rgba(45, 55, 72, 0.6) 100%);
            border: 1px solid var(--stellaris-border);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            transition: all 0.2s ease;
        }

        .planet-item:hover {
            border-color: var(--stellaris-blue);
            box-shadow: 0 0 15px rgba(0, 212, 255, 0.2);
        }

        .moon-item {
            background: rgba(45, 55, 72, 0.6);
            border-left: 3px solid var(--stellaris-purple);
            padding: 0.5rem;
            margin-left: 2rem;
            margin-top: 0.5rem;
            border-radius: 4px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 3000;  /* GE√ÑNDERT: von 2000 auf 3000 */
            justify-content: center;
            align-items: center;
            overflow-y: auto;
            padding: 2rem;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--stellaris-panel);
            border: 2px solid var(--stellaris-border);
            border-radius: 12px;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            padding: 2rem;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6);
            position: relative;           /* NEU */
            z-index: 3001;                /* NEU */
        }
        
        /* NEU: Dropdown-Verbesserungen */
        .modal-content select {
            position: relative;
            z-index: 3002;
        }
        
        .stellaris-input option,
        .stellaris-input optgroup {
            background-color: #2a3847 !important;
            color: #e2e8f0 !important;
            padding: 8px 12px;
        }
        
        .stellaris-input optgroup {
            font-weight: bold;
            background-color: #1e2936 !important;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="container mx-auto py-8 px-4">
        <h1 class="stellaris-header">üåå Stellaris Solar System Editor V21</h1>
        <div class="text-center mb-6">
            <span class="text-yellow-400 font-semibold">‚≠ê Full Editor - Edit systems, planets, and neighbors</span>
        </div>

        <!-- Import Section -->
        <div class="stellaris-panel mb-6">
            <h2 class="text-xl font-bold mb-4 text-blue-300">üìÇ Import/Export System</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="label">Load System-File (.txt)</label>
                    <input type="file" id="importFile" class="stellaris-input" accept=".txt" style="padding: 0.5rem;">
                </div>
                <div class="flex items-end gap-2">
                    <button id="importBtn" class="stellaris-btn">Import System(s)</button>
                    <button id="clearAllBtn" class="stellaris-btn stellaris-btn-secondary">Remove all</button>
                </div>
                <div class="flex items-end">
                    <button id="exportAllBtn" class="stellaris-btn stellaris-btn-secondary">Export all</button>
                </div>
            </div>
            
            <div id="importInfo" class="mt-4 p-3 bg-blue-900/30 rounded-lg border border-blue-500/30 hidden">
                <p class="text-blue-300 font-semibold">‚úÖ Imported: <span id="systemCount">0</span> System(s)</p>
            </div>
        </div>

        <!-- Multi-System Layout -->
        <div class="multi-system-layout">
            <!-- Left Panel: System List -->
            <div class="system-list-panel">
                <div class="stellaris-panel">
                    <h2 class="text-lg font-bold mb-4 text-purple-300">üåü Loaded Systems</h2>
                    <div id="systemList" class="space-y-2">
                        <p class="text-gray-400 text-sm">No systems loaded.</p>
                    </div>
                    <button id="addNewSystemBtn" class="stellaris-btn stellaris-btn-secondary mt-4 w-full text-sm py-2">
                        ‚ûï Create New System
                    </button>
                </div>
            </div>

            <!-- Right Panel: System Editor -->
            <div class="system-editor-panel">
                <div id="systemEditorContent">
                    <div class="stellaris-panel text-center py-12">
                        <p class="text-gray-400 text-lg">üëà Select a system from the list or import a file</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Export Preview Modal -->
        <div id="exportPreview" class="modal">
            <div class="modal-content">
                <h2 class="text-2xl font-bold mb-4 text-green-300">üìã Export Preview</h2>
                <textarea id="exportTextarea" class="stellaris-input font-mono text-sm" rows="20" readonly></textarea>
                <div class="mt-4 flex gap-2">
                    <button id="downloadExportBtn" class="stellaris-btn">üíæ Download Files</button>
                    <button id="copyExportBtn" class="stellaris-btn stellaris-btn-secondary">üìã Copy to Clipboard</button>
                    <button id="closePreviewBtn" class="stellaris-btn stellaris-btn-secondary">‚úï Close</button>
                </div>
            </div>
        </div>

        <!-- Add/Edit Planet Modal -->
        <div id="planetModal" class="modal">
            <div class="modal-content">
                <h2 class="text-2xl font-bold mb-4 text-blue-300" id="planetModalTitle">üåç Add Planet</h2>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label class="label">Planet-Name</label>
                        <input type="text" id="planetName" class="stellaris-input" placeholder="z.B. Earth">
                    </div>
                    <div class="form-group">
                        <label class="label">Planet class</label>
                        <select id="planetClass" class="stellaris-input">
                            <optgroup label="‚≠ê Stars">
                                <option value="pc_g_star">G-Star (Yellow)</option>
                                <option value="pc_k_star">K-Star (Orange)</option>
                                <option value="pc_m_star">M-Star (Red)</option>
                                <option value="pc_f_star">F-Star (Yellowish-White)</option>
                                <option value="pc_a_star">A-Star (White)</option>
                                <option value="pc_b_star">B-Star (Blue)</option>
                                <option value="pc_o_star">O-Star (Blue)</option>
                                <option value="pc_black_hole">Black Hole</option>
                                <option value="pc_neutron_star">Neutron Star</option>
                                <option value="pc_pulsar">Pulsar</option>
                            </optgroup>
                            <optgroup label="Habitable Planets">
                                <option value="pc_continental">Continental</option>
                                <option value="pc_ocean">Ocean</option>
                                <option value="pc_desert">Desert</option>
                                <option value="pc_tropical">Tropical</option>
                                <option value="pc_arid">Arid</option>
                                <option value="pc_tundra">Tundra</option>
                                <option value="pc_arctic">Arctic</option>
                                <option value="pc_alpine">Alpine</option>
                                <option value="pc_savannah">Savannah</option>
                            </optgroup>
                            <optgroup label="Uninhabitable Planets">
                                <option value="pc_gas_giant">Gas Giant</option>
                                <option value="pc_molten">Molten</option>
                                <option value="pc_barren">Barren</option>
                                <option value="pc_barren_cold">Barren (Cold)</option>
                                <option value="pc_toxic">Toxic</option>
                                <option value="pc_frozen">Frozen</option>
                            </optgroup>
                            <optgroup label="Asteroiden">
                                <option value="pc_asteroid">Asteroid</option>
                                <option value="pc_ice_asteroid">Ice Asteroid</option>
                                <option value="pc_rare_crystal_asteroid">Rare Crystal Asteroid</option>
                            </optgroup>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="label">Size (5-40)</label>
                        <input type="number" id="planetSize" class="stellaris-input" value="16" min="5" max="40">
                    </div>
                    <div class="form-group">
                        <label class="label">Orbit Distance</label>
                        <input type="number" id="planetOrbit" class="stellaris-input" value="25" min="0" max="200">
                    </div>
                    <div class="form-group" style="grid-column: span 2;">
                        <label class="label">Orbit Angle Mode</label>
                        <select id="orbitAngleMode" class="stellaris-input" onchange="window.toggleOrbitAngleFields()">
                            <option value="preset">Preset (Fixed Angle)</option>
                            <option value="range">Range (Min/Max)</option>
                        </select>
                    </div>

                    <div id="orbitAnglePreset" class="form-group" style="grid-column: span 2;">
                        <label class="label">Orbit Angle</label>
                        <select id="planetAnglePreset" class="stellaris-input">
                            <option value="0">0¬∞ (Top)</option>
                            <option value="60">60¬∞</option>
                            <option value="90" selected>90¬∞ (Right)</option>
                            <option value="120">120¬∞</option>
                            <option value="180">180¬∞ (Bottom)</option>
                            <option value="240">240¬∞</option>
                            <option value="270">270¬∞ (Left)</option>
                            <option value="300">300¬∞</option>
                        </select>
                    </div>

                    <div id="orbitAngleRange" class="hidden" style="grid-column: span 2;">
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="label">Min (¬∞)</label>
                                <input type="number" id="planetAngleMin" class="stellaris-input" value="90" min="0" max="360">
                            </div>
                            <div>
                                <label class="label">Max (¬∞)</label>
                                <input type="number" id="planetAngleMax" class="stellaris-input" value="270" min="0" max="360">
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="label">Change Orbit</label>
                        <input type="number" id="planetChangeOrbit" class="stellaris-input" value="0" min="0" max="20">
                    </div>
                    <div class="form-group flex items-center">
                        <label class="flex items-center cursor-pointer">
                            <input type="checkbox" id="planetHasRing" class="mr-2">
                            <span class="text-gray-300">Planet has Ring</span>
                        </label>
                    </div>
                    <div class="form-group flex items-center">
                        <label class="flex items-center cursor-pointer">
                            <input type="checkbox" id="planetIsStarting" class="mr-2">
                            <span class="text-gray-300">üè† Starting Planet</span>
                        </label>
                    </div>
                    <div class="form-group flex items-center">
                        <label class="flex items-center cursor-pointer">
                            <input type="checkbox" id="planetIsGuaranteedHabitable" class="mr-2">
                            <span class="text-gray-300">üåç Garantierter bewohnbarer Planet</span>
                        </label>
                    </div>
                </div>

                <!-- Modifier System -->
                <div class="mt-6 p-4 bg-gradient-to-br from-green-900/30 to-emerald-900/20 rounded-lg border border-green-700/50">
                    <h3 class="text-lg font-semibold text-green-300 mb-3 flex items-center">
                        üåø Smart Planet Modifier System
                    </h3>
                    
                    <div class="bg-blue-900/20 border border-blue-700/30 rounded p-3 mb-4 text-sm">
                        <p class="text-blue-300 mb-1"><strong>Planetary Diversity:</strong> Shows only compatible modifiers for selected base planet class</p>
                        <p class="text-blue-200"><strong>Others:</strong> Standard modifiers work with all classes</p>
                    </div>

                    <div class="mb-4">
                        <p id="modifierStatusText" class="text-gray-400 text-sm mb-3">No modifiers selected</p>
                        <div id="selectedModifiersList" class="space-y-2">
                            <!-- Selected modifiers will be displayed here -->
                        </div>
                    </div>

                    <div class="bg-slate-800/50 p-3 rounded border border-slate-700">
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
                            <div>
                                <label class="label text-xs">MODIFIER CATEGORY</label>
                                <select id="modifierCategory" class="stellaris-input text-sm" onchange="window.updateModifierOptions()">
                                    <option value="">-- Select Category --</option>
                                    <option value="resources">Resource Modifiers</option>
                                    <option value="planetary">Planetary Features</option>
                                    <option value="deposits">Deposits</option>
                                    <option value="anomalies">Anomalies</option>
                                    <option value="special">Special Modifiers</option>
                                    <option value="pd_terraforming">PD: Terraforming</option>
                                    <option value="pd_climate">PD: Climate</option>
                                    <option value="pd_unique">PD: Unique</option>
                                </select>
                            </div>
                            <div>
                                <label class="label text-xs">MODIFIER</label>
                                <select id="modifierSelection" class="stellaris-input text-sm" disabled>
                                    <option value="">-- Select Modifier --</option>
                                </select>
                            </div>
                        </div>
                        
                        <button id="addModifierBtn" class="stellaris-btn stellaris-btn-success w-full" onclick="window.addModifierToPlanet()" disabled>
                            ADD MODIFIER
                        </button>
                    </div>
                </div>

                <div class="mt-6 flex gap-2">
                    <button id="savePlanetBtn" class="stellaris-btn stellaris-btn-success">üíæ Save</button>
                    <button id="cancelPlanetBtn" class="stellaris-btn stellaris-btn-secondary">‚úï Cancel</button>
                </div>
            </div>
        </div>

        <!-- Add/Edit Moon Modal -->
        <div id="moonModal" class="modal">
            <div class="modal-content">
                <h2 class="text-2xl font-bold mb-4 text-purple-300" id="moonModalTitle">üåô Add Moon</h2>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label class="label">Moon-Name</label>
                        <input type="text" id="moonName" class="stellaris-input" placeholder="z.B. Luna">
                    </div>
                    <div class="form-group">
                        <label class="label">Mondklasse</label>
                        <select id="moonClass" class="stellaris-input">
                            <optgroup label="Habitable Moons">
                                <option value="pc_continental">Continental</option>
                                <option value="pc_ocean">Ocean</option>
                                <option value="pc_desert">Desert</option>
                                <option value="pc_tropical">Tropical</option>
                                <option value="pc_arid">Arid</option>
                                <option value="pc_tundra">Tundra</option>
                                <option value="pc_arctic">Arctic</option>
                                <option value="pc_alpine">Alpine</option>
                                <option value="pc_savannah">Savannah</option>
                            </optgroup>
                            <optgroup label="Uninhabitable Moons">
                                <option value="pc_gas_giant">Gas Giant</option>
                                <option value="pc_molten">Molten</option>
                                <option value="pc_barren">Barren</option>
                                <option value="pc_barren_cold">Barren (Cold)</option>
                                <option value="pc_toxic">Toxic</option>
                                <option value="pc_frozen">Frozen</option>
                            </optgroup>
                            <optgroup label="Asteroids">
                                <option value="pc_asteroid">Asteroid</option>
                                <option value="pc_ice_asteroid">Ice Asteroid</option>
                                <option value="pc_rare_crystal_asteroid">Rare Crystal Asteroid</option>
                            </optgroup>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="label">Size (3-20)</label>
                        <input type="number" id="moonSize" class="stellaris-input" value="8" min="3" max="20">
                    </div>
                    <div class="form-group">
                        <label class="label">Orbit Distance from Planet</label>
                        <input type="number" id="moonOrbit" class="stellaris-input" value="10" min="5" max="30">
                    </div>

                    <div class="form-group" style="grid-column: span 2;">
                        <label class="label">Orbit Angle Mode</label>
                        <select id="moonOrbitAngleMode" class="stellaris-input" onchange="window.toggleMoonOrbitAngleFields()">
                            <option value="preset">Preset (Fixed Angle)</option>
                            <option value="range">Range (Min/Max)</option>
                        </select>
                    </div>

                    <div id="moonOrbitAnglePreset" class="form-group" style="grid-column: span 2;">
                        <label class="label">Orbit Angle</label>
                        <select id="moonAnglePreset" class="stellaris-input">
                            <option value="0">0¬∞ (Top)</option>
                            <option value="60">60¬∞</option>
                            <option value="90" selected>90¬∞ (Right)</option>
                            <option value="120">120¬∞</option>
                            <option value="180">180¬∞ (Bottom)</option>
                            <option value="240">240¬∞</option>
                            <option value="270">270¬∞ (Left)</option>
                            <option value="300">300¬∞</option>
                        </select>
                    </div>

                    <div id="moonOrbitAngleRange" class="hidden" style="grid-column: span 2;">
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="label">Min (¬∞)</label>
                                <input type="number" id="moonAngleMin" class="stellaris-input" value="90" min="0" max="360">
                            </div>
                            <div>
                                <label class="label">Max (¬∞)</label>
                                <input type="number" id="moonAngleMax" class="stellaris-input" value="270" min="0" max="360">
                            </div>
                        </div>
                    </div>
                    
                    <!-- NEW: Starting Planet Checkbox for Moons -->
                    <div class="form-group" style="grid-column: span 2;">
                        <label class="flex items-center cursor-pointer">
                            <input type="checkbox" id="moonIsStarting" class="mr-2" style="width: auto;">
                            <span class="text-gray-300">üè† Mark moon as starting planet</span>
                        </label>
                        <p class="text-xs text-gray-400 mt-1">
                            For habitable moons like Sleipnir (Asgard system)
                        </p>
                    </div>
                    <div class="form-group" style="grid-column: span 2;">
                        <label class="flex items-center cursor-pointer">
                            <input type="checkbox" id="moonIsGuaranteedHabitable" class="mr-2" style="width: auto;">
                            <span class="text-gray-300">üåç Mark moon as guaranteed habitable world</span>
                        </label>
                        <p class="text-xs text-gray-400 mt-1">
                            For habitable moons, which are considered ideal colony targets
                        </p>
                    </div>
                </div>

                <!-- Modifier System f√ºr Monde -->
                <div class="mt-6 p-4 bg-gradient-to-br from-purple-900/30 to-pink-900/20 rounded-lg border border-purple-700/50">
                    <h3 class="text-lg font-semibold text-purple-300 mb-3 flex items-center">
                        üåô Moon Modifier System
                    </h3>
                    
                    <div class="bg-blue-900/20 border border-blue-700/30 rounded p-3 mb-4 text-sm">
                        <p class="text-blue-300">Moons can have the same modifiers as planets.</p>
                    </div>

                    <div class="mb-4">
                        <p id="moonModifierStatusText" class="text-gray-400 text-sm mb-3">No modifiers selected</p>
                        <div id="selectedMoonModifiersList" class="space-y-2">
                            <!-- Selected modifiers will be displayed here -->
                        </div>
                    </div>

                    <div class="bg-slate-800/50 p-3 rounded border border-slate-700">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
                            <div>
                                <label class="label text-xs">MODIFIER CATEGORY</label>
                                <select id="moonModifierCategory" class="stellaris-input text-sm" onchange="window.updateMoonModifierOptions()">
                                    <option value="">-- Select Category --</option>
                                    <option value="resources">Resource Modifiers</option>
                                    <option value="planetary">Planetary Features</option>
                                    <option value="deposits">Deposits</option>
                                    <option value="anomalies">Anomalies</option>
                                    <option value="special">Special Modifiers</option>
                                    <option value="pd_terraforming">PD: Terraforming</option>
                                    <option value="pd_climate">PD: Climate</option>
                                    <option value="pd_unique">PD: Unique</option>
                                </select>
                            </div>
                            <div>
                                <label class="label text-xs">MODIFIER</label>
                                <select id="moonModifierSelection" class="stellaris-input text-sm" disabled>
                                    <option value="">-- Select Modifier --</option>
                                </select>
                            </div>
                        </div>
                        
                        <button id="addMoonModifierBtn" class="stellaris-btn stellaris-btn-success w-full" onclick="window.addModifierToMoon()" disabled>
                            ADD MODIFIER
                        </button>
                    </div>
                </div>

                <div class="mt-6 flex gap-2">
                    <button id="saveMoonBtn" class="stellaris-btn stellaris-btn-success">üíæ Save</button>
                    <button id="cancelMoonBtn" class="stellaris-btn stellaris-btn-secondary">‚úï Cancel</button>
                </div>
            </div>
        </div>

        <!-- Add Neighbor System Modal -->
        <div id="neighborModal" class="modal">
            <div class="modal-content">
                <h2 class="text-2xl font-bold mb-4 text-yellow-300">üîó Add Neighbor System</h2>
                
                <div class="mb-4 p-3 bg-blue-900/30 rounded-lg border border-blue-500/30">
                    <p class="text-sm text-gray-300">
                        <strong>üí° Note:</strong> The system identifier will be automatically generated from the main system name and display name.
                    </p>
                </div>

                <div class="form-group">
                    <label class="label">Display Name of Neighbor System</label>
                    <div class="mb-4">
                        <label class="label">Select Neighbor System</label>
                        <select id="neighborSystemSelect" class="stellaris-input mb-2">
                            <option value="">-- Select from List --</option>
                        </select>
                        <p class="text-xs text-gray-400">Or enter manually:</p>
                    </div>
                    
                    <input type="text" id="neighborDisplayName" class="stellaris-input" placeholder="z.B. Apsu">
                    <p class="text-xs text-gray-400 mt-1">Will be converted to: <span id="neighborPreviewIdentifier" class="text-blue-300">-</span></p>
                </div>

                <div class="form-grid mt-4">
                    <div class="form-group">
                        <label class="label">Hyperlane Jumps (Min)</label>
                        <input type="number" id="neighborJumpsMin" class="stellaris-input" value="1" min="1" max="10">
                    </div>
                    <div class="form-group">
                        <label class="label">Hyperlane Jumps (Max)</label>
                        <input type="number" id="neighborJumpsMax" class="stellaris-input" value="3" min="1" max="10">
                    </div>
                </div>

                <div class="mt-6 flex gap-2">
                    <button id="saveNeighborBtn" class="stellaris-btn stellaris-btn-success">üíæ Save</button>
                    <button id="cancelNeighborBtn" class="stellaris-btn stellaris-btn-secondary">‚úï Cancel</button>
                </div>
            </div>
        </div>

        <!-- Add Asteroid Belt Modal -->
        <div id="asteroidBeltModal" class="modal">
            <div class="modal-content">
                <h2 class="text-2xl font-bold mb-4 text-yellow-300">‚òÑÔ∏è Add Asteroid Belt</h2>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label class="label">Belt Typ</label>
                        <select id="beltType" class="stellaris-input">
                            <option value="rocky_asteroid_belt">Rocky Asteroid Belt</option>
                            <option value="icy_asteroid_belt">Icy Asteroid Belt</option>
                            <option value="crystal_asteroid_belt">Crystal Asteroid Belt</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="label">Radius (30-1500)</label>
                        <input type="number" id="beltRadius" class="stellaris-input" value="90" min="30" max="1500">
                    </div>
                </div>

                <div class="mt-6 flex gap-2">
                    <button id="saveBeltBtn" class="stellaris-btn stellaris-btn-success">üíæ Save</button>
                    <button id="cancelBeltBtn" class="stellaris-btn stellaris-btn-secondary">‚úï Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // =====================================================
        // DATA MODEL & STATE
        // =====================================================
        
        let allSystems = [];
        let currentSystemIndex = null;
        let editingPlanetId = null;
        let editingPlanetIndex = null;
        let editingMoonParentId = null;
        let editingMoonIndex = null;
        let editingMoonPlanetIndex = null;
        let nextPlanetId = 1;

        function createEmptySystem(name = 'custom_system') {
            return {
                name: name,
                displayName: name.replace(/_/g, ' ').replace(/system initializer$/i, '').trim(),
                class: 'sc_g',
                usage: 'custom_empire',
                asteroidBelts: [],
                neighborSystems: [],
                planets: [],
                flags: [],
                isMain: false
            };
        }

        // Modifier Definitions
        const MODIFIER_DATABASE = {
            resources: {
                name: 'Ressourcen-Modifier',
                modifiers: [
                    { id: 'pm_planet_strong_magnetic_field', name: 'Starkes Magnetfeld', desc: '+2 Physik' },
                    { id: 'pm_natural_beauty', name: 'Nat√ºrliche Sch√∂nheit', desc: '+5% Annehmlichkeiten' },
                    { id: 'pm_atmospheric_hallucinogen', name: 'Atmosph√§risches Halluzinogen', desc: '+10% Gl√ºck' },
                    { id: 'pm_titanic_life', name: 'Titanisches Leben', desc: '+4 Gesellschaft' },
                    { id: 'pm_asteroid_belt', name: 'Asteroideng√ºrtel', desc: '+2 Mineralien' },
                    { id: 'pm_extensive_moon_system', name: 'Ausgedehntes Mondsystem', desc: '+2 Physik' }
                ]
            },
            planetary: {
                name: 'Planetare Features',
                modifiers: [
                    { id: 'pm_dangerous_wildlife', name: 'Gef√§hrliche Tierwelt', desc: 'Armeen -15%' },
                    { id: 'pm_lush', name: '√úppig', desc: '+25% Landwirtschaft' },
                    { id: 'pm_bleak', name: 'Trist', desc: '-10% Annehmlichkeiten' },
                    { id: 'pm_unstable_tectonics', name: 'Instabile Tektonik', desc: 'H√§user -20%' },
                    { id: 'pm_chthonian_planet', name: 'Chthonischer Planet', desc: 'Ehemaliger Gasriese' }
                ]
            },
            deposits: {
                name: 'Ablagerungen',
                modifiers: [
                    { id: 'd_mineral_rich', name: 'Reich an Mineralien', desc: '+3 Mineralien' },
                    { id: 'd_mineral_poor', name: 'Arm an Mineralien', desc: '-1 Mineralien' },
                    { id: 'd_rich_mountain', name: 'Reiche Berge', desc: '+4 Mineralien' },
                    { id: 'd_vast_sinkhole', name: 'Riesiges Erdloch', desc: '+6 Ingenieurwesen' },
                    { id: 'd_energy_rich', name: 'Reich an Energie', desc: '+3 Energie' },
                    { id: 'd_rare_crystals', name: 'Seltene Kristalle', desc: 'Kristalle' }
                ]
            },
            anomalies: {
                name: 'Anomalien',
                modifiers: [
                    { id: 'pm_ancient_reactor_pits', name: 'Alte Reaktorgruben', desc: 'Physik/Ingenieurwesen' },
                    { id: 'pm_asteroid_impacts', name: 'Asteroideneinschl√§ge', desc: 'Mineralien +2' },
                    { id: 'pm_buried_lithoids', name: 'Begrabene Lithoiden', desc: 'Mineralien +3' },
                    { id: 'pm_crashed_starship', name: 'Abgest√ºrztes Raumschiff', desc: 'Ingenieurwesen +3' }
                ]
            },
            special: {
                name: 'Spezielle Modifier',
                modifiers: [
                    { id: 'pm_carbon_world', name: 'Kohlenstoffwelt', desc: 'Diamant-Planet' },
                    { id: 'pm_class_star', name: 'Klasse-Stern', desc: 'Besondere Sternklasse' },
                    { id: 'pm_floating_landmass', name: 'Schwebende Landmasse', desc: 'Gravitationsanomalie' },
                    { id: 'pm_irradiated', name: 'Verstrahlt', desc: 'Radioaktiv' }
                ]
            },
            pd_terraforming: {
                name: 'PD: Terraforming',
                modifiers: [
                    { id: 'pm_pd_terraformed', name: 'Terraformiert', desc: 'PD Terraforming-Status' },
                    { id: 'pm_pd_terraform_candidate', name: 'Terraform-Kandidat', desc: 'F√ºr Terraforming geeignet' }
                ]
            },
            pd_climate: {
                name: 'PD: Klima',
                modifiers: [
                    { id: 'pm_pd_extreme_heat', name: 'Extreme Hitze', desc: 'PD Klimaeffekt' },
                    { id: 'pm_pd_extreme_cold', name: 'Extreme K√§lte', desc: 'PD Klimaeffekt' },
                    { id: 'pm_pd_high_gravity', name: 'Hohe Schwerkraft', desc: 'PD Schwerkraft' },
                    { id: 'pm_pd_low_gravity', name: 'Niedrige Schwerkraft', desc: 'PD Schwerkraft' }
                ]
            },
            pd_unique: {
                name: 'PD: Einzigartige',
                modifiers: [
                    { id: 'pm_pd_crystal_caverns', name: 'Kristallkavernen', desc: 'PD Einzigartig' },
                    { id: 'pm_pd_megaflora', name: 'Megaflora', desc: 'PD Riesenvegetation' },
                    { id: 'pm_pd_magnetic_storms', name: 'Magnetst√ºrme', desc: 'PD Magnetfeld' }
                ]
            }
        };

        // =====================================================
        // MULTI-SYSTEM PARSER (from V16)
        // =====================================================
        
        class MultiSystemParser {
            constructor() {
                this.starClasses = [
                    'pc_b_star', 'pc_a_star', 'pc_f_star', 'pc_g_star', 
                    'pc_k_star', 'pc_m_star', 
                    'pc_black_hole', 'pc_neutron_star', 'pc_pulsar',
                    'pc_t_star', 'pc_o_star', 'pc_toxoid_star', 'pc_rift_star'
                ];
            }

            parseMultipleSystems(fileContent) {
                const systems = [];
                const systemRegex = /(\w+_system_initializer)\s*=\s*\{/g;
                const matches = [];
                let match;
                
                while ((match = systemRegex.exec(fileContent)) !== null) {
                    matches.push({
                        name: match[1],
                        startIndex: match.index
                    });
                }
                
                for (let i = 0; i < matches.length; i++) {
                    const systemMatch = matches[i];
                    const startPos = fileContent.indexOf('{', systemMatch.startIndex);
                    
                    let endPos;
                    if (i < matches.length - 1) {
                        endPos = matches[i + 1].startIndex;
                    } else {
                        endPos = fileContent.length;
                    }
                    
                    const systemBlock = this.extractBlock(fileContent, startPos, endPos);
                    
                    try {
                        const system = this.parseSystemBlock(systemMatch.name, systemBlock);
                        systems.push(system);
                    } catch (error) {
                        console.error(`Error parsing system ${systemMatch.name}:`, error);
                    }
                }
                
                return systems;
            }

            extractBlock(content, startPos, maxPos) {
                let braceCount = 0;
                let i = startPos;
                
                while (i < content.length && i < maxPos) {
                    if (content[i] === '{') braceCount++;
                    if (content[i] === '}') {
                        braceCount--;
                        if (braceCount === 0) {
                            return content.substring(startPos + 1, i);
                        }
                    }
                    i++;
                }
                
                return content.substring(startPos + 1, maxPos);
            }

            parseSystemBlock(systemName, blockContent) {
                const system = createEmptySystem(systemName);
                
                const nameMatch = blockContent.match(/name\s*=\s*"([^"]+)"/);
                if (nameMatch) {
                    system.displayName = nameMatch[1];
                }
                
                const classMatch = blockContent.match(/class\s*=\s*"([^"]+)"/);
                if (classMatch) {
                    system.class = classMatch[1];
                }
                
                const usageMatch = blockContent.match(/usage\s*=\s*(\w+)/);
                if (usageMatch) {
                    system.usage = usageMatch[1];
                }
                
                const asteroidBeltRegex = /asteroid_belt\s*=\s*\{[^}]*type\s*=\s*(\w+)[^}]*radius\s*=\s*(\d+)[^}]*\}/g;
                let beltMatch;
                while ((beltMatch = asteroidBeltRegex.exec(blockContent)) !== null) {
                    system.asteroidBelts.push({
                        id: Date.now() + Math.random(),
                        type: beltMatch[1],
                        radius: parseInt(beltMatch[2])
                    });
                }
                
                // Parse neighbor_systems mit Bracket-Counting
                let i = 0;
                while (i < blockContent.length) {
                    const neighborKeyword = blockContent.indexOf('neighbor_system', i);
                    if (neighborKeyword === -1) break;
                    
                    const equalsSign = blockContent.indexOf('=', neighborKeyword);
                    if (equalsSign === -1 || equalsSign - neighborKeyword > 20) {
                        i = neighborKeyword + 15;
                        continue;
                    }
                    
                    const braceStart = blockContent.indexOf('{', equalsSign);
                    if (braceStart === -1) break;
                    
                    let braceCount = 0;
                    let blockEnd = -1;
                    
                    for (let j = braceStart; j < blockContent.length; j++) {
                        if (blockContent[j] === '{') braceCount++;
                        if (blockContent[j] === '}') {
                            braceCount--;
                            if (braceCount === 0) {
                                blockEnd = j;
                                break;
                            }
                        }
                    }
                    
                    if (blockEnd === -1) break;
                    
                    const neighborBlock = blockContent.substring(braceStart + 1, blockEnd);
                    
                    // Parse Neighbor-Block
                    const initializerMatch = neighborBlock.match(/initializer\s*=\s*"?([^"\s}]+)"?/);
                    const hyperlaneMatch = neighborBlock.match(/hyperlane_jumps\s*=\s*\{\s*min\s*=\s*(\d+)\s*max\s*=\s*(\d+)\s*\}/);
                    
                    if (initializerMatch) {
                        system.neighborSystems.push({
                            id: Date.now() + Math.random(),
                            mode: 'reference',
                            initializer: initializerMatch[1],
                            hyperlaneJumps: hyperlaneMatch ? {
                                min: parseInt(hyperlaneMatch[1]),
                                max: parseInt(hyperlaneMatch[2])
                            } : { min: 1, max: 3 }
                        });
                    }
                    
                    i = blockEnd + 1;
                }
                
                system.planets = this.extractPlanets(blockContent);
                
                return system;
            }

            extractPlanets(code) {
                const planets = [];
                let planetId = 1;
                
                let i = 0;
                while (i < code.length) {
                    const planetKeyword = code.indexOf('planet', i);
                    if (planetKeyword === -1) break;
                    
                    const equalsSign = code.indexOf('=', planetKeyword);
                    if (equalsSign === -1 || equalsSign - planetKeyword > 10) {
                        i = planetKeyword + 6;
                        continue;
                    }
                    
                    const braceStart = code.indexOf('{', equalsSign);
                    if (braceStart === -1) break;
                    
                    let braceCount = 0;
                    let blockEnd = -1;
                    
                    for (let j = braceStart; j < code.length; j++) {
                        if (code[j] === '{') braceCount++;
                        if (code[j] === '}') {
                            braceCount--;
                            if (braceCount === 0) {
                                blockEnd = j;
                                break;
                            }
                        }
                    }
                    
                    if (blockEnd === -1) break;
                    
                    const planetBlock = code.substring(braceStart + 1, blockEnd);
                    
                    try {
                        const planet = this.parsePlanetBlock(planetBlock, planetId);
                        
                        if (this.isStarClass(planet.class)) {
                            if (planet.size > 30 || (planet.orbitDistance === 0 && planetId === 1)) {
                                planet.isStar = true;
                                planet.type = 'star';
                            } else {
                                planet.class = 'pc_asteroid';
                            }
                        }
                        
                        planets.push(planet);
                        nextPlanetId = Math.max(nextPlanetId, planetId + 1);
                        planetId++;
                    } catch (error) {
                        console.error('Error parsing planet:', error);
                    }
                    
                    i = blockEnd + 1;
                }
                
                return planets;
            }

            parsePlanetBlock(blockContent, id) {
                const planet = {
                    id: id,
                    type: 'planet',
                    name: this.extractValue(blockContent, 'name') || `planet_${id}`,
                    displayName: this.extractValue(blockContent, 'name') || `Planet ${id}`,
                    class: this.extractValue(blockContent, 'class') || 'pc_continental',
                    size: parseInt(this.extractValue(blockContent, 'size')) || 16,
                    orbitDistance: (() => {
                        const val = this.extractValue(blockContent, 'orbit_distance');
                        return val !== null ? parseInt(val) : 25;
                    })(),
                    orbitAngleType: 'range',
                    orbitAngle: 0,
                    orbitAngleMin: 90,
                    orbitAngleMax: 270,
                    changeOrbit: parseInt(this.extractValue(blockContent, 'change_orbit') || '0'),
                    hasRing: this.extractValue(blockContent, 'has_ring') === 'yes',
                    isStartingPlanet: this.checkStartingPlanetAtTopLevel(blockContent),
                    isGuaranteedHabitable: blockContent.includes('prescripted_ideal') || blockContent.includes('ideal_design_class'),
                    modifiers: this.extractModifiers(blockContent),
                    moons: [],
                    flags: []
                };

                const angleRangeMatch = blockContent.match(/orbit_angle\s*=\s*\{\s*min\s*=\s*(\d+)\s*max\s*=\s*(\d+)\s*\}/);
                if (angleRangeMatch) {
                    planet.orbitAngleType = 'range';
                    planet.orbitAngleMin = parseInt(angleRangeMatch[1]);
                    planet.orbitAngleMax = parseInt(angleRangeMatch[2]);
                } else {
                    const angleFixedMatch = blockContent.match(/orbit_angle\s*=\s*(\d+)/);
                    if (angleFixedMatch) {
                        planet.orbitAngleType = 'fixed';
                        planet.orbitAngle = parseInt(angleFixedMatch[1]);
                    }
                }

                planet.moons = this.extractMoons(blockContent, id);

                return planet;
            }

            extractMoons(planetBlock, parentId) {
                const moons = [];
                let moonId = 1;
                
                let i = 0;
                while (i < planetBlock.length) {
                    const moonStart = planetBlock.indexOf('moon', i);
                    if (moonStart === -1) break;
                    
                    const braceStart = planetBlock.indexOf('{', moonStart);
                    if (braceStart === -1) break;
                    
                    let braceCount = 0;
                    let blockEnd = -1;
                    
                    for (let j = braceStart; j < planetBlock.length; j++) {
                        if (planetBlock[j] === '{') braceCount++;
                        if (planetBlock[j] === '}') {
                            braceCount--;
                            if (braceCount === 0) {
                                blockEnd = j;
                                break;
                            }
                        }
                    }
                    
                    if (blockEnd === -1) break;
                    
                    const moonBlock = planetBlock.substring(braceStart + 1, blockEnd);
                    
                    const moon = {
                        id: parentId * 1000 + moonId,
                        type: 'moon',
                        name: this.extractValue(moonBlock, 'name') || `moon_${moonId}`,
                        displayName: this.extractValue(moonBlock, 'name') || `Mond ${moonId}`,
                        class: this.extractValue(moonBlock, 'class') || 'pc_barren_cold',
                        size: parseInt(this.extractValue(moonBlock, 'size')) || 8,
                        orbitDistance: (() => {
                            const val = this.extractValue(moonBlock, 'orbit_distance');
                            return val !== null ? parseInt(val) : 10;
                        })(),
                        orbitAngleType: 'range',
                        orbitAngle: 0,
                        orbitAngleMin: 90,
                        orbitAngleMax: 270,
                        changeOrbit: 0,
                        hasRing: false,
                        isStartingPlanet: moonBlock.includes('starting_planet') || moonBlock.includes('generate_start_buildings'),
                        isGuaranteedHabitable: false,
                        modifiers: this.extractModifiers(moonBlock),
                        moons: [],
                        flags: []
                    };

                    moons.push(moon);
                    moonId++;
                    i = blockEnd + 1;
                }
                
                return moons;
            }

            extractModifiers(block) {
                const modifiers = [];
                const modifierMatch = block.match(/modifiers\s*=\s*\{\s*([^}]+)\s*\}/);
                
                if (modifierMatch) {
                    const modifierString = modifierMatch[1].trim();
                    if (modifierString && modifierString !== 'none') {
                        // Split by whitespace and filter out empty strings
                        const modifierList = modifierString.split(/\s+/).filter(m => m.length > 0);
                        modifiers.push(...modifierList);
                    }
                }
                
                return modifiers;
            }

            checkStartingPlanetAtTopLevel(block) {
                // Only check for starting_planet at the top level (braceDepth = 0)
                // to avoid false positives from nested moon blocks
                let braceDepth = 0;
                let i = 0;
                
                while (i < block.length) {
                    const char = block[i];
                    
                    if (char === '{') {
                        braceDepth++;
                        i++;
                        continue;
                    }
                    if (char === '}') {
                        braceDepth--;
                        i++;
                        continue;
                    }
                    
                    // Only check at top level (braceDepth = 0)
                    if (braceDepth === 0) {
                        const remaining = block.substring(i);
                        
                        // Check for starting_planet = yes
                        if (/^\s*starting_planet\s*=\s*yes/.test(remaining)) {
                            return true;
                        }
                        
                        // Check for generate_start_buildings in init_effect
                        if (/^\s*init_effect\s*=\s*\{[^}]*generate_start_buildings/.test(remaining)) {
                            return true;
                        }
                    }
                    
                    i++;
                }
                
                return false;
            }

            extractValue(block, key) {
                let braceDepth = 0;
                let i = 0;
                
                while (i < block.length) {
                    const char = block[i];
                    
                    if (char === '{') {
                        braceDepth++;
                        i++;
                        continue;
                    }
                    if (char === '}') {
                        braceDepth--;
                        i++;
                        continue;
                    }
                    
                    if (braceDepth === 0) {
                        const remaining = block.substring(i);
                        const keyPattern = new RegExp(`^\\s*${key}\\s*=\\s*`);
                        
                        if (keyPattern.test(remaining)) {
                            const afterKey = remaining.replace(keyPattern, '');
                            
                            const quotedMatch = afterKey.match(/^"([^"]+)"/);
                            if (quotedMatch) return quotedMatch[1];
                            
                            const unquotedMatch = afterKey.match(/^(\w+)/);
                            if (unquotedMatch) return unquotedMatch[1];
                        }
                    }
                    
                    i++;
                }
                
                return null;
            }

            isStarClass(className) {
                return this.starClasses.includes(className);
            }
        }

        // =====================================================
        // AUTOMATIC IDENTIFIER GENERATION
        // =====================================================
        
        function linkNeighborSystemsAfterImport() {
            // Erstelle Mapping von Initializer-Namen zu System-Indizes
            const systemMap = new Map();
            allSystems.forEach((system, index) => {
                systemMap.set(system.name, index);
            });
            
            // Durchlaufe alle Systeme und verkn√ºpfe Nachbarn
            allSystems.forEach((system, systemIndex) => {
                system.neighborSystems.forEach(neighbor => {
                    // Pr√ºfe ob das referenzierte System existiert
                    if (systemMap.has(neighbor.initializer)) {
                        neighbor.linkedSystemIndex = systemMap.get(neighbor.initializer);
                        neighbor.exists = true;
                    } else {
                        neighbor.exists = false;
                    }
                });
            });
            
            showNotification(`‚úÖ ${allSystems.length} systems imported and neighbors linked!`);
        }

        function generateNeighborIdentifier(displayName) {
            if (!allSystems.length || currentSystemIndex === null) {
                return 'unknown_system_initializer';
            }
            
            const mainSystem = allSystems.find(s => s.isMain) || allSystems[0];
            const mainBaseName = mainSystem.name.replace(/_system_initializer$/, '');
            
            const cleanedDisplayName = displayName
                .toLowerCase()
                .replace(/\s+/g, '_')
                .replace(/[^a-z0-9_]/g, '');
            
            return `${mainBaseName}_${cleanedDisplayName}_system_initializer`;
        }

        // =====================================================
        // EVENT HANDLERS
        // =====================================================
        
        document.getElementById('importBtn').addEventListener('click', () => {
            const file = document.getElementById('importFile').files[0];
            if (!file) {
                showNotification('‚ö†Ô∏è Please select a file!');
                return;
            }
            
            const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const parser = new MultiSystemParser();
                            const systems = parser.parseMultipleSystems(e.target.result);
                            
                            if (systems.length === 0) {
                                showNotification('‚ùå No system initializers found!');
                                return;
                            }
                            
                            allSystems = systems;
                            
                            if (allSystems.length > 0) {
                                allSystems[0].isMain = true;
                            }
                            
                            // Auto-Verkn√ºpfung von Nachbarsystemen
                            linkNeighborSystemsAfterImport();
                            
                            updateSystemList();
                            selectSystem(0);
                            
                            document.getElementById('importInfo').classList.remove('hidden');
                            document.getElementById('systemCount').textContent = systems.length;
                            
                            showNotification(`‚úÖ ${systems.length} system(s) successfully imported!`);
                        } catch (error) {
                            showNotification('‚ùå Import error: ' + error.message);
                            console.error(error);
                        }
                    };
            reader.readAsText(file);
        });

        document.getElementById('addNewSystemBtn').addEventListener('click', () => {
            const newSystem = createEmptySystem('new_custom_system_' + (allSystems.length + 1));
            if (allSystems.length === 0) {
                newSystem.isMain = true;
            }
            allSystems.push(newSystem);
            updateSystemList();
            selectSystem(allSystems.length - 1);
            showNotification('‚úÖ New system created!');
        });

        document.getElementById('clearAllBtn').addEventListener('click', () => {
            if (confirm('Do you really want to delete all systems?')) {
                allSystems = [];
                currentSystemIndex = null;
                updateSystemList();
                clearEditor();
                document.getElementById('importInfo').classList.add('hidden');
                showNotification('üóëÔ∏è All systems deleted!');
            }
        });

        document.getElementById('exportAllBtn').addEventListener('click', () => {
            if (allSystems.length === 0) {
                showNotification('‚ö†Ô∏è No systems to export!');
                return;
            }
            
            const exportCode = allSystems.map(sys => generateSystemCode(sys)).join('\n\n');
            document.getElementById('exportTextarea').value = exportCode;
            document.getElementById('exportPreview').classList.add('active');
        });

        document.getElementById('downloadExportBtn').addEventListener('click', () => {
            // Get main system for filename
            const mainSystem = allSystems.find(s => s.isMain) || allSystems[0];
            const baseName = mainSystem.name.replace(/_system_initializer$/, '');
            
            // Generate .txt file (system initializer)
            const code = document.getElementById('exportTextarea').value;
            const txtBlob = new Blob([code], { type: 'text/plain; charset=utf-8' });
            const txtUrl = URL.createObjectURL(txtBlob);
            const txtLink = document.createElement('a');
            txtLink.href = txtUrl;
            txtLink.download = `${baseName}_system_initializer.txt`;
            txtLink.click();
            URL.revokeObjectURL(txtUrl);
            
            // Generate .yml file (localization)
            const ymlContent = generateLocalizationYML(allSystems);
            const ymlBlob = new Blob([ymlContent], { type: 'text/plain; charset=utf-8' });
            const ymlUrl = URL.createObjectURL(ymlBlob);
            const ymlLink = document.createElement('a');
            ymlLink.href = ymlUrl;
            ymlLink.download = `l_english_${baseName}_systems.yml`;
            ymlLink.click();
            URL.revokeObjectURL(ymlUrl);
            
            showNotification('üíæ Files downloaded!');
        });

        document.getElementById('copyExportBtn').addEventListener('click', () => {
            const textarea = document.getElementById('exportTextarea');
            textarea.select();
            document.execCommand('copy');
            showNotification('üìã Copied to clipboard!');
        });

        document.getElementById('closePreviewBtn').addEventListener('click', () => {
            document.getElementById('exportPreview').classList.remove('active');
        });

        // Planet Modal Events
        document.getElementById('cancelPlanetBtn').addEventListener('click', () => {
            document.getElementById('planetModal').classList.remove('active');
        });

        document.getElementById('savePlanetBtn').addEventListener('click', () => {
            savePlanet();
        });

        // Moon Modal Events
        document.getElementById('cancelMoonBtn').addEventListener('click', () => {
            document.getElementById('moonModal').classList.remove('active');
        });

        document.getElementById('saveMoonBtn').addEventListener('click', () => {
            saveMoon();
        });

        // Neighbor Modal Events
        document.getElementById('neighborDisplayName').addEventListener('input', (e) => {
            const preview = generateNeighborIdentifier(e.target.value);
            document.getElementById('neighborPreviewIdentifier').textContent = preview;
        });

        document.getElementById('cancelNeighborBtn').addEventListener('click', () => {
            document.getElementById('neighborModal').classList.remove('active');
        });

        document.getElementById('saveNeighborBtn').addEventListener('click', () => {
            saveNeighborSystem();
        });

        // Asteroid Belt Modal Events
        document.getElementById('cancelBeltBtn').addEventListener('click', () => {
            document.getElementById('asteroidBeltModal').classList.remove('active');
        });

        document.getElementById('saveBeltBtn').addEventListener('click', () => {
            saveAsteroidBelt();
        });

        // Modifier Management Functions
        window.updateModifierOptions = function() {
            const category = document.getElementById('modifierCategory').value;
            const modifierSelect = document.getElementById('modifierSelection');
            const addBtn = document.getElementById('addModifierBtn');
            
            modifierSelect.innerHTML = '<option value="">-- Modifier w√§hlen --</option>';
            
            if (category && MODIFIER_DATABASE[category]) {
                modifierSelect.disabled = false;
                MODIFIER_DATABASE[category].modifiers.forEach(mod => {
                    const option = document.createElement('option');
                    option.value = mod.id;
                    option.textContent = `${mod.name} (${mod.desc})`;
                    modifierSelect.appendChild(option);
                });
                addBtn.disabled = false;
            } else {
                modifierSelect.disabled = true;
                addBtn.disabled = true;
            }
        };

        window.addModifierToPlanet = function() {
            const category = document.getElementById('modifierCategory').value;
            const modifierId = document.getElementById('modifierSelection').value;
            
            if (!modifierId) {
                alert('Bitte w√§hlen Sie einen Modifier aus.');
                return;
            }

            const currentPlanet = getCurrentPlanet();
            if (!currentPlanet) return;

            // Avoid duplicates
            if (!currentPlanet.modifiers.includes(modifierId)) {
                currentPlanet.modifiers.push(modifierId);
                updateSelectedModifiersList();
                
                // Visual feedback
                const addBtn = document.getElementById('addModifierBtn');
                addBtn.textContent = '‚úÖ HINZUGEF√úGT!';
                addBtn.style.backgroundColor = '#48bb78';
                
                setTimeout(() => {
                    addBtn.textContent = 'MODIFIER HINZUF√úGEN';
                    addBtn.style.backgroundColor = '';
                }, 1000);
                
                // Reset selections
                document.getElementById('modifierCategory').value = '';
                document.getElementById('modifierSelection').innerHTML = '<option value="">-- Modifier w√§hlen --</option>';
                document.getElementById('modifierSelection').disabled = true;
                document.getElementById('addModifierBtn').disabled = true;
            } else {
                alert('Dieser Modifier wurde bereits hinzugef√ºgt.');
            }

            // Scroll to modifiers list
            const modifiersList = document.getElementById('selectedModifiersList');
            if (modifiersList && modifiersList.lastElementChild) {
                modifiersList.lastElementChild.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        };

        window.removeModifierFromPlanet = function(modifierId) {
            const currentPlanet = getCurrentPlanet();
            if (!currentPlanet) return;

            const index = currentPlanet.modifiers.indexOf(modifierId);
            if (index > -1) {
                currentPlanet.modifiers.splice(index, 1);
                updateSelectedModifiersList();
            }
        };

        // Moon Modifier Management Functions
        window.updateMoonModifierOptions = function() {
            const category = document.getElementById('moonModifierCategory').value;
            const modifierSelect = document.getElementById('moonModifierSelection');
            const addBtn = document.getElementById('addMoonModifierBtn');
            
            modifierSelect.innerHTML = '<option value="">-- Modifier w√§hlen --</option>';
            
            if (category && MODIFIER_DATABASE[category]) {
                modifierSelect.disabled = false;
                MODIFIER_DATABASE[category].modifiers.forEach(mod => {
                    const option = document.createElement('option');
                    option.value = mod.id;
                    option.textContent = `${mod.name} (${mod.desc})`;
                    modifierSelect.appendChild(option);
                });
                addBtn.disabled = false;
            } else {
                modifierSelect.disabled = true;
                addBtn.disabled = true;
            }
        };

        window.addModifierToMoon = function() {
            const category = document.getElementById('moonModifierCategory').value;
            const modifierId = document.getElementById('moonModifierSelection').value;
            
            if (!modifierId) {
                alert('Bitte w√§hlen Sie einen Modifier aus.');
                return;
            }

            const currentMoon = getCurrentMoon();
            if (!currentMoon) return;

            // Avoid duplicates
            if (!currentMoon.modifiers.includes(modifierId)) {
                currentMoon.modifiers.push(modifierId);
                updateSelectedMoonModifiersList();
                
                // Visual feedback
                const addBtn = document.getElementById('addMoonModifierBtn');
                addBtn.textContent = '‚úÖ ADD!';
                addBtn.style.backgroundColor = '#48bb78';
                
                setTimeout(() => {
                    addBtn.textContent = 'ADD MODIFIER';
                    addBtn.style.backgroundColor = '';
                }, 1000);
                
                // Reset selections
                document.getElementById('moonModifierCategory').value = '';
                document.getElementById('moonModifierSelection').innerHTML = '<option value="">-- Select Modifier --</option>';
                document.getElementById('moonModifierSelection').disabled = true;
                document.getElementById('addMoonModifierBtn').disabled = true;
            } else {
                alert('Dieser Modifier wurde bereits hinzugef√ºgt.');
            }
        };

        window.removeModifierFromMoon = function(modifierId) {
            const currentMoon = getCurrentMoon();
            if (!currentMoon) return;

            const index = currentMoon.modifiers.indexOf(modifierId);
            if (index > -1) {
                currentMoon.modifiers.splice(index, 1);
                updateSelectedMoonModifiersList();
            }
        };

        function updateSelectedMoonModifiersList() {
            const currentMoon = getCurrentMoon();
            if (!currentMoon) return;

            const listContainer = document.getElementById('selectedMoonModifiersList');
            const statusText = document.getElementById('moonModifierStatusText');
            
            if (currentMoon.modifiers.length === 0) {
                listContainer.innerHTML = '';
                statusText.textContent = 'No modifiers selected';
                statusText.className = 'text-gray-400 text-sm mb-3';
                return;
            }

            statusText.textContent = `‚úÖ ${currentMoon.modifiers.length} modifier(s) selected:`;
            statusText.className = 'text-purple-400 text-sm mb-3 font-semibold';

            listContainer.innerHTML = currentMoon.modifiers.map(modId => {
                // Find modifier details
                let modDetails = null;
                for (const cat in MODIFIER_DATABASE) {
                    const found = MODIFIER_DATABASE[cat].modifiers.find(m => m.id === modId);
                    if (found) {
                        modDetails = found;
                        break;
                    }
                }

                const displayName = modDetails ? modDetails.name : modId;
                const desc = modDetails ? modDetails.desc : '';

                return `
                    <div class="flex items-center justify-between bg-slate-700/50 p-2 rounded border border-slate-600">
                        <div class="flex-1">
                            <span class="text-purple-300 font-medium">${displayName}</span>
                            <span class="text-gray-400 text-xs ml-2">${desc}</span>
                        </div>
                        <button onclick="window.removeModifierFromMoon('${modId}')" 
                                class="ml-2 px-2 py-1 bg-red-600 hover:bg-red-700 rounded text-xs">
                            ‚úï
                        </button>
                    </div>
                `;
            }).join('');
        }

        function getCurrentMoon() {
            if (editingMoonPlanetIndex === null || editingMoonPlanetIndex === undefined) return null;
            if (editingMoonIndex === null || editingMoonIndex === undefined) return null;
            if (!allSystems[currentSystemIndex]) return null;
            
            const planet = allSystems[currentSystemIndex].planets[editingMoonPlanetIndex];
            if (!planet || !planet.moons) return null;
            
            return planet.moons[editingMoonIndex];
        }

        function updateSelectedModifiersList() {
            const currentPlanet = getCurrentPlanet();
            console.log('Current Planet:', currentPlanet);
            console.log('Modifiers:', currentPlanet ? currentPlanet.modifiers : 'No planet');
            if (!currentPlanet) return;

            const listContainer = document.getElementById('selectedModifiersList');
            const statusText = document.getElementById('modifierStatusText');
            
            if (currentPlanet.modifiers.length === 0) {
                listContainer.innerHTML = '';
                statusText.textContent = 'No modifiers selected';
                statusText.className = 'text-gray-400 text-sm mb-3';
                return;
            }

            statusText.textContent = `‚úÖ ${currentPlanet.modifiers.length} modifier(s) selected:`;
            statusText.className = 'text-green-400 text-sm mb-3 font-semibold';

            listContainer.innerHTML = currentPlanet.modifiers.map(modId => {
                // Find modifier details
                let modDetails = null;
                for (const cat in MODIFIER_DATABASE) {
                    const found = MODIFIER_DATABASE[cat].modifiers.find(m => m.id === modId);
                    if (found) {
                        modDetails = found;
                        break;
                    }
                }

                const displayName = modDetails ? modDetails.name : modId;
                const desc = modDetails ? modDetails.desc : '';

                return `
                    <div class="flex items-center justify-between bg-slate-700/50 p-2 rounded border border-slate-600">
                        <div class="flex-1">
                            <span class="text-green-300 font-medium">${displayName}</span>
                            <span class="text-gray-400 text-xs ml-2">${desc}</span>
                        </div>
                        <button onclick="window.removeModifierFromPlanet('${modId}')" 
                                class="ml-2 px-2 py-1 bg-red-600 hover:bg-red-700 rounded text-xs">
                            ‚úï
                        </button>
                    </div>
                `;
            }).join('');
        }

        function getCurrentPlanet() {
            if (editingPlanetIndex === null || editingPlanetIndex === undefined) return null;
            if (!allSystems[currentSystemIndex]) return null;
            
            return allSystems[currentSystemIndex].planets[editingPlanetIndex];
        }

        // =====================================================
        // UI FUNCTIONS
        // =====================================================
        
        function updateSystemList() {
            const listContainer = document.getElementById('systemList');
            
            if (allSystems.length === 0) {
                listContainer.innerHTML = '<p class="text-gray-400 text-sm">No systems loaded.</p>';
                return;
            }
            
            listContainer.innerHTML = '';
            
            allSystems.forEach((system, index) => {
                const item = document.createElement('div');
                item.className = 'system-selector-item' + (index === currentSystemIndex ? ' active' : '');
                item.onclick = () => selectSystem(index);
                
                const badge = system.isMain ? 
                    '<span class="stellaris-badge badge-primary ml-2">Main</span>' : 
                    '<span class="stellaris-badge badge-secondary ml-2">Neighbor</span>';
                
                item.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <div class="font-semibold text-blue-300">${system.displayName}</div>
                            <div class="text-xs text-gray-400 mt-1">${system.name}</div>
                            <div class="text-xs text-gray-500 mt-1">
                                ${system.planets.length} Planets ‚Ä¢ ${system.neighborSystems.length} Neighbors
                            </div>
                        </div>
                        ${badge}
                    </div>
                `;
                
                listContainer.appendChild(item);
            });
        }

        function selectSystem(index) {
            if (index < 0 || index >= allSystems.length) return;
            
            currentSystemIndex = index;
            updateSystemList();
            loadSystemIntoEditor(allSystems[index]);
        }

        function loadSystemIntoEditor(system) {
            const editorContainer = document.getElementById('systemEditorContent');
            
            editorContainer.innerHTML = `
                <div class="stellaris-panel">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-blue-300">üåü ${system.displayName}</h2>
                        <div class="flex gap-2">
                            <button onclick="editSystemProperties()" class="stellaris-btn text-sm">
                                ‚úèÔ∏è Edit System
                            </button>
                            <button onclick="deleteCurrentSystem()" class="stellaris-btn stellaris-btn-danger text-sm">
                                üóëÔ∏è Delete
                            </button>
                        </div>
                    </div>
                    
                    <!-- System Properties -->
                    <div class="bg-gray-800/50 p-4 rounded-lg mb-6">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <span class="text-gray-400 text-sm">Identifier:</span>
                                <div class="font-mono text-blue-300">${system.name}</div>
                            </div>
                            <div>
                                <span class="text-gray-400 text-sm">Star Class:</span>
                                <div class="text-yellow-300">${system.class}</div>
                            </div>
                            <div>
                                <span class="text-gray-400 text-sm">Usage:</span>
                                <div class="text-green-300">${system.usage}</div>
                            </div>
                            <div>
                                <span class="text-gray-400 text-sm">Typ:</span>
                                <div class="text-purple-300">${system.isMain ? 'Main System' : 'Neighbor System'}</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Combined Celestial Bodies Section -->
                    <div class="mb-6">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="text-lg font-semibold text-yellow-400">ü™ê Celestial Bodies (${system.planets.length + system.asteroidBelts.length})</h3>
                            <div class="flex gap-2">
                                <button onclick="openAddPlanetModal()" class="stellaris-btn stellaris-btn-secondary text-sm">
                                    ‚ûï Planet
                                </button>
                                <button onclick="openAddAsteroidBeltModal()" class="stellaris-btn stellaris-btn-secondary text-sm">
                                    ‚ûï Belt
                                </button>
                            </div>
                        </div>
                        <div id="celestialBodiesList">
                            ${renderCombinedCelestialBodies(system.planets, system.asteroidBelts)}
                        </div>
                    </div>
                    
                    <!-- Neighbor Systems Section -->
                    <div class="mb-6">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="text-lg font-semibold text-yellow-400">üîó Neighbor Systems (${system.neighborSystems.length})</h3>
                            <button onclick="openAddNeighborModal()" class="stellaris-btn stellaris-btn-secondary text-sm">
                                ‚ûï Add Neighbor
                            </button>
                        </div>
                        <div id="neighborsList">
                            ${renderNeighborSystems(system.neighborSystems)}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderPlanetList(planets) {
            if (planets.length === 0) {
                return '<p class="text-gray-400 text-sm">No planets. Click on ‚ÄúAdd planet.‚Äù</p>';
            }
            
            return planets.map((planet, index) => {
                const icon = getPlanetIcon(planet.class);
                const moonCount = planet.moons.length;
                
                let html = `
                    <div class="planet-item">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center gap-3 flex-1">
                                <span class="text-2xl">${icon}</span>
                                <div>
                                    <div class="font-semibold text-blue-300">${index + 1}. ${planet.displayName}</div>
                                    <div class="text-sm text-gray-400">
                                        ${getClassDisplayName(planet.class)} ‚Ä¢ Gr√∂√üe ${planet.size} ‚Ä¢ Orbit ${planet.orbitDistance}
                                        ${planet.isStartingPlanet ? ' ‚Ä¢ <span class="text-green-400">üè† Startplanet</span>' : ''}
                                        ${planet.isGuaranteedHabitable ? ' ‚Ä¢ <span class="text-blue-400">üåç Garantiert</span>' : ''}
                                    </div>
                                </div>
                            </div>
                            <div class="flex gap-2">
                                ${index > 0 ? `<button onclick="movePlanetUp(${index})" class="stellaris-btn stellaris-btn-secondary text-xs px-2 py-1">‚Üë</button>` : ''}
                                ${index < planets.length - 1 ? `<button onclick="movePlanetDown(${index})" class="stellaris-btn stellaris-btn-secondary text-xs px-2 py-1">‚Üì</button>` : ''}
                                <button onclick="openEditPlanetModal(${planet.id}, ${index})" class="stellaris-btn stellaris-btn-secondary text-xs px-2 py-1">‚úèÔ∏è</button>
                                <button onclick="openAddMoonModal(${planet.id})" class="stellaris-btn stellaris-btn-secondary text-xs px-2 py-1">üåô+</button>
                                <button onclick="deletePlanet(${index})" class="stellaris-btn stellaris-btn-danger text-xs px-2 py-1">üóëÔ∏è</button>
                            </div>
                        </div>
                `;
                
                if (moonCount > 0) {
                    html += '<div class="space-y-2">';
                    planet.moons.forEach((moon, moonIndex) => {
                        const startingIcon = moon.isStartingPlanet ? ' <span class="text-green-400">üè† </span>' : ''; 
                        const guaranteedIcon = moon.isGuaranteedHabitable ? ' <span class="text-blue-400">üåç</span>' : '';
                        html += `
                            <div class="moon-item flex items-center justify-between">
                                <div class="flex items-center gap-2">
                                    <span class="text-lg">${getPlanetIcon(moon.class)}</span>
                                    <span class="text-sm">${moon.displayName} (${getClassDisplayName(moon.class)}, Gr√∂√üe ${moon.size})${startingIcon}${guaranteedIcon}</span>
                                </div>
                                <div class="flex gap-1">
                                    <button onclick="editMoon(${planet.id}, ${moonIndex})" class="stellaris-btn stellaris-btn-secondary text-xs px-2 py-1">‚úèÔ∏è</button>
                                    <button onclick="deleteMoon(${planet.id}, ${moonIndex})" class="stellaris-btn stellaris-btn-danger text-xs px-2 py-1">üóëÔ∏è</button>
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';
                }
                
                html += '</div>';
                return html;
            }).join('');
        }

        function renderAsteroidBelts(belts) {
            if (belts.length === 0) {
                return '<p class="text-gray-400 text-sm">No Asteroid Belt.</p>';
            }
            
            return belts.map((belt, index) => {
                return `
                    <div class="bg-gray-800/50 p-3 rounded-lg border border-gray-700 flex justify-between items-center mb-2">
                        <div>
                            <span class="text-yellow-500">‚òÑÔ∏è</span> ${belt.type} (Radius: ${belt.radius})
                        </div>
                        <button onclick="deleteAsteroidBelt(${index})" class="stellaris-btn stellaris-btn-danger text-xs px-2 py-1">üóëÔ∏è</button>
                    </div>
                `;
            }).join('');
        }

        function renderCombinedCelestialBodies(planets, asteroidBelts) {
            // Kombiniere Planeten und Asteroideng√ºrtel mit korrekter Orbit-Berechnung
            const combined = [];
            
            // Berechne kumulative Positionen f√ºr Planeten
            let cumulativeOrbit = 0;
            planets.forEach((planet, index) => {
                cumulativeOrbit += planet.orbitDistance;
                combined.push({
                    type: 'planet',
                    data: planet,
                    index: index,
                    orbit: cumulativeOrbit,  // Kumulative Position
                    displayOrbit: planet.orbitDistance  // Original f√ºr Anzeige
                });
            });
            
            // F√ºge Asteroideng√ºrtel mit absoluter Position hinzu
            asteroidBelts.forEach((belt, index) => {
                combined.push({
                    type: 'asteroid',
                    data: belt,
                    index: index,
                    orbit: belt.radius,  // Absolute Position
                    displayOrbit: belt.radius
                });
            });
            
            // Sortiere nach tats√§chlicher Orbit-Position
            combined.sort((a, b) => a.orbit - b.orbit);
                
                if (combined.length === 0) {
                    return '<p class="text-gray-400 text-sm">No celestial bodies. Click on "Planet" or "Belt" to add.</p>';
                }
                
                return combined.map(item => {
                    if (item.type === 'planet') {
                        const planet = item.data;
                        const index = item.index;
                        const icon = getPlanetIcon(planet.class);
                        const moonCount = planet.moons.length;
                        
                        let html = `
                            <div class="bg-gray-800/50 p-3 rounded-lg border border-gray-700 mb-3">
                                <div class="flex justify-between items-start">
                                    <div class="flex-1">
                                        <div class="flex items-center gap-2 mb-2">
                                            <span class="text-2xl">${icon}</span>
                                            <div>
                                                <div class="font-semibold text-blue-300">${planet.name}</div>
                                                <div class="text-xs text-gray-400">${getClassDisplayName(planet.class)} ‚Ä¢ Size ${planet.size} ‚Ä¢ Orbit +${item.displayOrbit} (Position: ${item.orbit})</div>
                                            </div>
                                        </div>
                                        ${moonCount > 0 ? `<div class="text-xs text-yellow-400 ml-8">üåô ${moonCount} Moon(s)</div>` : ''}
                                    </div>
                                    <div class="flex gap-1">
                                        <button onclick="movePlanetUp(${index})" class="stellaris-btn stellaris-btn-secondary text-xs px-2 py-1" ${index === 0 ? 'disabled' : ''}>‚¨ÜÔ∏è</button>
                                        <button onclick="movePlanetDown(${index})" class="stellaris-btn stellaris-btn-secondary text-xs px-2 py-1">‚¨áÔ∏è</button>
                                        <button onclick="openEditPlanetModal(${planet.id}, ${index})" class="stellaris-btn text-xs px-2 py-1">‚úèÔ∏è</button>
                                        <button onclick="openAddMoonModal(${planet.id})" class="stellaris-btn stellaris-btn-secondary text-xs px-2 py-1">üåô+</button>
                                        <button onclick="deletePlanet(${index})" class="stellaris-btn stellaris-btn-danger text-xs px-2 py-1">üóëÔ∏è</button>
                                    </div>
                                </div>
                                ${planet.moons.length > 0 ? renderMoonsList(planet.moons, planet.id) : ''}
                            </div>
                        `;
                        return html;
                    } else {
                        // Asteroideng√ºrtel
                        const belt = item.data;
                        const index = item.index;
                        return `
                            <div class="bg-gray-800/50 p-3 rounded-lg border border-yellow-600/50 mb-3">
                                <div class="flex justify-between items-center">
                                    <div class="flex items-center gap-2">
                                        <span class="text-yellow-500 text-2xl">‚òÑÔ∏è</span>
                                        <div>
                                            <div class="font-semibold text-yellow-300">Asteroid Belt</div>
                                            <div class="text-xs text-gray-400">${belt.type} ‚Ä¢ Radius: ${item.displayOrbit} (Position: ${item.orbit})</div>
                                        </div>
                                    </div>
                                    <button onclick="deleteAsteroidBelt(${index})" class="stellaris-btn stellaris-btn-danger text-xs px-2 py-1">üóëÔ∏è</button>
                                </div>
                            </div>
                        `;
                    }
                }).join('');
             }

            function renderMoonsList(moons, parentPlanetId) {
                if (moons.length === 0) {
                    return '';
                }
                
                return '<div class="ml-8 mt-2 space-y-2 border-l-2 border-gray-700 pl-4">' + 
                    moons.map((moon, moonIndex) => {
                        const startingIcon = moon.isStartingPlanet ? ' <span class="text-green-400">üè†</span>' : '';
                        return `
                            <div class="bg-gray-900/50 p-2 rounded border border-gray-700 flex items-center justify-between">
                                <div class="flex items-center gap-2">
                                    <span class="text-lg">${getPlanetIcon(moon.class)}</span>
                                    <span class="text-sm">${moon.displayName} (${getClassDisplayName(moon.class)}, Size ${moon.size}, Orbit ${moon.orbitDistance})${startingIcon}</span>
                                </div>
                                <div class="flex gap-1">
                                    <button onclick="editMoon(${parentPlanetId}, ${moonIndex})" class="stellaris-btn stellaris-btn-secondary text-xs px-2 py-1">‚úèÔ∏è</button>
                                    <button onclick="deleteMoon(${parentPlanetId}, ${moonIndex})" class="stellaris-btn stellaris-btn-danger text-xs px-2 py-1">üóëÔ∏è</button>
                                </div>
                            </div>
                        `;
                    }).join('') + 
                '</div>';
            }

        function renderNeighborSystems(neighbors) {
            if (neighbors.length === 0) {
                return '<p class="text-gray-400 text-sm">No neighbor systems.</p>';
            }
            
            return neighbors.map((neighbor, index) => {
                const jumps = `${neighbor.hyperlaneJumps.min}-${neighbor.hyperlaneJumps.max} Hyperlane Jumps`;
                
                // Status-Icon und Info
                let statusIcon = 'üîó';
                let statusColor = 'text-purple-400';
                let displayName = neighbor.initializer;
                
                if (neighbor.linkedSystemIndex !== undefined) {
                    const linkedSystem = allSystems[neighbor.linkedSystemIndex];
                    if (linkedSystem) {
                        statusIcon = '‚úì';
                        statusColor = 'text-green-400';
                        displayName = `${linkedSystem.displayName} ‚Üí ${neighbor.initializer}`;
                    }
                } else if (neighbor.exists === false) {
                    statusIcon = '‚ö†';
                    statusColor = 'text-yellow-400';
                }
                
                return `
                    <div class="bg-gray-800/50 p-3 rounded-lg border border-gray-700 flex justify-between items-center mb-2">
                        <div>
                            <span class="${statusColor}">${statusIcon}</span> ${displayName}
                            <div class="text-xs text-gray-400 mt-1">${jumps}</div>
                        </div>
                        <button onclick="deleteNeighborSystem(${index})" class="stellaris-btn stellaris-btn-danger text-xs px-2 py-1">üóëÔ∏è</button>
                    </div>
                `;
            }).join('');
        }

        function clearEditor() {
            document.getElementById('systemEditorContent').innerHTML = `
                <div class="stellaris-panel text-center py-12">
                    <p class="text-gray-400 text-lg">üëà Select a system from the list or import a file</p>
                </div>
            `;
        }

        // =====================================================
        // PLANET MANAGEMENT
        // =====================================================
        
        function openAddPlanetModal() {
            editingPlanetId = null;
            editingPlanetIndex = null;
            document.getElementById('planetModalTitle').textContent = 'üåç Add Planet';
            
            // Reset form
            document.getElementById('planetName').value = '';
            document.getElementById('planetClass').value = 'pc_continental';
            document.getElementById('planetSize').value = '16';
            document.getElementById('planetOrbit').value = '25';
            
            // NEU: Orbit Angle Preset Setup
            document.getElementById('orbitAngleMode').value = 'preset';
            document.getElementById('planetAnglePreset').value = '90';
            document.getElementById('planetAngleMin').value = '90';
            document.getElementById('planetAngleMax').value = '270';
            toggleOrbitAngleFields();
            
            document.getElementById('planetChangeOrbit').value = '0';
            document.getElementById('planetHasRing').checked = false;
            document.getElementById('planetIsStarting').checked = false;
            
            document.getElementById('planetModal').classList.add('active');
        }

        function openEditPlanetModal(planetId, planetIndex) {
            const planet = allSystems[currentSystemIndex].planets[planetIndex];
            
            editingPlanetId = planetId;
            editingPlanetIndex = planetIndex;
            document.getElementById('planetModalTitle').textContent = '‚úèÔ∏è Edit Planet';
            
            document.getElementById('planetName').value = planet.name;
            document.getElementById('planetClass').value = planet.class;
            document.getElementById('planetSize').value = planet.size;
            document.getElementById('planetOrbit').value = planet.orbitDistance;
            
            // NEU: Orbit Angle Setup basierend auf Planet-Daten
            if (planet.orbitAngleType === 'fixed') {
                document.getElementById('orbitAngleMode').value = 'preset';
                document.getElementById('planetAnglePreset').value = planet.orbitAngle.toString();
            } else {
                document.getElementById('orbitAngleMode').value = 'range';
                document.getElementById('planetAngleMin').value = planet.orbitAngleMin;
                document.getElementById('planetAngleMax').value = planet.orbitAngleMax;
            }
            toggleOrbitAngleFields();
            
            document.getElementById('planetChangeOrbit').value = planet.changeOrbit;
            document.getElementById('planetHasRing').checked = planet.hasRing;
            document.getElementById('planetIsStarting').checked = planet.isStartingPlanet;
            document.getElementById('planetIsGuaranteedHabitable').checked = planet.isGuaranteedHabitable || false;
            
            // Load modifiers
            if (!planet.modifiers) {
                planet.modifiers = [];
            }
            updateSelectedModifiersList();
            
            document.getElementById('planetModal').classList.add('active');
            // Load modifiers  
        }

        function savePlanet() {
            const name = document.getElementById('planetName').value.trim() || `planet_${nextPlanetId}`;
            const planetClass = document.getElementById('planetClass').value;
            const size = parseInt(document.getElementById('planetSize').value);
            const orbit = parseInt(document.getElementById('planetOrbit').value);
            const changeOrbit = parseInt(document.getElementById('planetChangeOrbit').value);
            const hasRing = document.getElementById('planetHasRing').checked;
            const isStarting = document.getElementById('planetIsStarting').checked;
            const isGuaranteedHabitable = document.getElementById('planetIsGuaranteedHabitable').checked;
            
            // NEU: Orbit Angle basierend auf Modus
            const angleMode = document.getElementById('orbitAngleMode').value;
            let orbitAngleType, orbitAngle, orbitAngleMin, orbitAngleMax;
            
            if (angleMode === 'preset') {
                const preset = document.getElementById('planetAnglePreset').value;
                orbitAngleType = 'fixed';
                orbitAngle = parseInt(preset);
                orbitAngleMin = 90;  // Fallback f√ºr Export
                orbitAngleMax = 270;
            } else {
                orbitAngleType = 'range';
                orbitAngle = 0;
                orbitAngleMin = parseInt(document.getElementById('planetAngleMin').value);
                orbitAngleMax = parseInt(document.getElementById('planetAngleMax').value);
            }
            
            const planetData = {
                id: editingPlanetId || nextPlanetId++,
                type: 'planet',
                name: name,
                displayName: name,
                class: planetClass,
                size: size,
                orbitDistance: orbit,
                orbitAngleType: orbitAngleType,
                orbitAngle: orbitAngle,
                orbitAngleMin: orbitAngleMin,
                orbitAngleMax: orbitAngleMax,
                changeOrbit: changeOrbit,
                hasRing: hasRing,
                isStartingPlanet: isStarting,
                isGuaranteedHabitable: isGuaranteedHabitable,
                modifiers: editingPlanetIndex !== null ? allSystems[currentSystemIndex].planets[editingPlanetIndex].modifiers || [] : [],
                moons: [],
                flags: []
            };
            
            if (editingPlanetIndex !== null) {
                // Keep existing moons and modifiers
                const existingPlanet = allSystems[currentSystemIndex].planets[editingPlanetIndex];
                planetData.moons = existingPlanet.moons || [];
                planetData.modifiers = existingPlanet.modifiers || [];
                allSystems[currentSystemIndex].planets[editingPlanetIndex] = planetData;
                showNotification('‚úÖ Planet updated!');
            } else {
                allSystems[currentSystemIndex].planets.push(planetData);
                showNotification('‚úÖ Planet added!');
            }
            
            document.getElementById('planetModal').classList.remove('active');
            loadSystemIntoEditor(allSystems[currentSystemIndex]);
        }

        function deletePlanet(index) {
            if (confirm('Really delete planet?')) {
                allSystems[currentSystemIndex].planets.splice(index, 1);
                showNotification('üóëÔ∏è Planet deleted!');
                loadSystemIntoEditor(allSystems[currentSystemIndex]);
            }
        }

        function movePlanetUp(index) {
            if (index > 0) {
                const planets = allSystems[currentSystemIndex].planets;
                [planets[index], planets[index - 1]] = [planets[index - 1], planets[index]];
                loadSystemIntoEditor(allSystems[currentSystemIndex]);
            }
        }

        function movePlanetDown(index) {
            const planets = allSystems[currentSystemIndex].planets;
            if (index < planets.length - 1) {
                [planets[index], planets[index + 1]] = [planets[index + 1], planets[index]];
                loadSystemIntoEditor(allSystems[currentSystemIndex]);
            }
        }

        // =====================================================
        // MOON MANAGEMENT
        // =====================================================
        
        function openAddMoonModal(parentPlanetId) {
            editingMoonParentId = parentPlanetId;
            editingMoonIndex = null;
            document.getElementById('moonModalTitle').textContent = 'üåô Add Moon';
            
            document.getElementById('moonName').value = '';
            document.getElementById('moonClass').value = 'pc_barren_cold';
            document.getElementById('moonSize').value = '8';
            document.getElementById('moonOrbit').value = '10';
            document.getElementById('moonIsStarting').checked = false;
            document.getElementById('moonIsGuaranteedHabitable').checked = false;
            
            // NEU: Orbit Angle Standardwerte
            document.getElementById('moonOrbitAngleMode').value = 'range';
            document.getElementById('moonAngleMin').value = '90';
            document.getElementById('moonAngleMax').value = '270';
            toggleMoonOrbitAngleFields();
            
            // Reset moon modifiers for new moon
            editingMoonPlanetIndex = allSystems[currentSystemIndex].planets.findIndex(p => p.id === parentPlanetId);
            document.getElementById('selectedMoonModifiersList').innerHTML = '';
            document.getElementById('moonModifierStatusText').textContent = 'No modifiers selected';
            document.getElementById('moonModifierStatusText').className = 'text-gray-400 text-sm mb-3';
            document.getElementById('moonModifierCategory').value = '';
            document.getElementById('moonModifierSelection').innerHTML = '<option value="">-- Select Modifier --</option>';
            document.getElementById('moonModifierSelection').disabled = true;
            document.getElementById('addMoonModifierBtn').disabled = true;
            
            document.getElementById('moonModal').classList.add('active');
        }

        function editMoon(parentPlanetId, moonIndex) {
            const planet = allSystems[currentSystemIndex].planets.find(p => p.id === parentPlanetId);
            const moon = planet.moons[moonIndex];
            
            editingMoonParentId = parentPlanetId;
            editingMoonIndex = moonIndex;
            document.getElementById('moonModalTitle').textContent = '‚úèÔ∏è Edit Moon';
            
            document.getElementById('moonName').value = moon.name;
            document.getElementById('moonClass').value = moon.class;
            document.getElementById('moonSize').value = moon.size;
            document.getElementById('moonOrbit').value = moon.orbitDistance;
            document.getElementById('moonIsStarting').checked = moon.isStartingPlanet || false;
            document.getElementById('moonIsGuaranteedHabitable').checked = false;
            
            // NEU: Orbit Angle Setup f√ºr Monde
            if (moon.orbitAngleType === 'fixed') {
                document.getElementById('moonOrbitAngleMode').value = 'preset';
                document.getElementById('moonAnglePreset').value = moon.orbitAngle.toString();
            } else {
                document.getElementById('moonOrbitAngleMode').value = 'range';
                document.getElementById('moonAngleMin').value = moon.orbitAngleMin;
                document.getElementById('moonAngleMax').value = moon.orbitAngleMax;
            }
            toggleMoonOrbitAngleFields();
            
            // Load moon modifiers
            if (!moon.modifiers) {
                moon.modifiers = [];
            }
            // Store the planet index for getCurrentMoon
            editingMoonPlanetIndex = allSystems[currentSystemIndex].planets.findIndex(p => p.id === parentPlanetId);
            updateSelectedMoonModifiersList();
            
            document.getElementById('moonModal').classList.add('active');
        }

        function saveMoon() {
            const name = document.getElementById('moonName').value.trim() || 'moon';
            const moonClass = document.getElementById('moonClass').value;
            const size = parseInt(document.getElementById('moonSize').value);
            const orbit = parseInt(document.getElementById('moonOrbit').value);
            const isStarting = document.getElementById('moonIsStarting').checked;
            const isGuaranteedHabitable = document.getElementById('moonIsGuaranteedHabitable').checked;
            
            // NEU: Orbit Angle basierend auf Modus
            const angleMode = document.getElementById('moonOrbitAngleMode').value;
            let orbitAngleType, orbitAngle, orbitAngleMin, orbitAngleMax;
            
            if (angleMode === 'preset') {
                const preset = document.getElementById('moonAnglePreset').value;
                orbitAngleType = 'fixed';
                orbitAngle = parseInt(preset);
                orbitAngleMin = 90;
                orbitAngleMax = 270;
            } else {
                orbitAngleType = 'range';
                orbitAngle = 0;
                orbitAngleMin = parseInt(document.getElementById('moonAngleMin').value);
                orbitAngleMax = parseInt(document.getElementById('moonAngleMax').value);
            }
            
            const planet = allSystems[currentSystemIndex].planets.find(p => p.id === editingMoonParentId);
            
            const moonData = {
                id: editingMoonParentId * 1000 + (planet.moons.length + 1),
                type: 'moon',
                name: name,
                displayName: name,
                class: moonClass,
                size: size,
                orbitDistance: orbit,
                orbitAngleType: orbitAngleType,
                orbitAngle: orbitAngle,
                orbitAngleMin: orbitAngleMin,
                orbitAngleMax: orbitAngleMax,
                changeOrbit: 0,
                hasRing: false,
                isStartingPlanet: isStarting,  // GE√ÑNDERT: von false zu isStarting
                isGuaranteedHabitable: isGuaranteedHabitable,
                modifiers: editingMoonIndex !== null ? planet.moons[editingMoonIndex].modifiers || [] : [],
                moons: [],
                flags: []
            };
            
            if (editingMoonIndex !== null) {
                planet.moons[editingMoonIndex] = moonData;
                showNotification('‚úÖ Moon updated!');
            } else {
                planet.moons.push(moonData);
                showNotification('‚úÖ Moon added!');
            }
            
            document.getElementById('moonModal').classList.remove('active');
            loadSystemIntoEditor(allSystems[currentSystemIndex]);
        }

        function deleteMoon(parentPlanetId, moonIndex) {
            if (confirm('Really delete moon?')) {
                const planet = allSystems[currentSystemIndex].planets.find(p => p.id === parentPlanetId);
                planet.moons.splice(moonIndex, 1);
                showNotification('üóëÔ∏è Moon deleted!');
                loadSystemIntoEditor(allSystems[currentSystemIndex]);
            }
        }

        // =====================================================
        // ORBIT ANGLE PRESET FUNCTIONS
        // =====================================================
        
        window.toggleOrbitAngleFields = function() {
            const mode = document.getElementById('orbitAngleMode').value;
            const presetDiv = document.getElementById('orbitAnglePreset');
            const rangeDiv = document.getElementById('orbitAngleRange');
            
            if (mode === 'preset') {
                presetDiv.classList.remove('hidden');
                rangeDiv.classList.add('hidden');
            } else {
                presetDiv.classList.add('hidden');
                rangeDiv.classList.remove('hidden');
            }
        };

        window.toggleMoonOrbitAngleFields = function() {
            const mode = document.getElementById('moonOrbitAngleMode').value;
            const presetDiv = document.getElementById('moonOrbitAnglePreset');
            const rangeDiv = document.getElementById('moonOrbitAngleRange');
            
            if (mode === 'preset') {
                presetDiv.classList.remove('hidden');
                rangeDiv.classList.add('hidden');
            } else {
                presetDiv.classList.add('hidden');
                rangeDiv.classList.remove('hidden');
            }
        };
        
        window.toggleOrbitAngleFields = toggleOrbitAngleFields;

        // =====================================================
        // NEIGHBOR SYSTEM MANAGEMENT
        // =====================================================
        
        function openAddNeighborModal() {
            document.getElementById('neighborDisplayName').value = '';
            document.getElementById('neighborJumpsMin').value = '1';
            document.getElementById('neighborJumpsMax').value = '3';
            document.getElementById('neighborPreviewIdentifier').textContent = '-';
            
            // F√ºlle System-Auswahl
            const select = document.getElementById('neighborSystemSelect');
            select.innerHTML = '<option value="">-- Select from list or enter manually --</option>';
            
            allSystems.forEach((system, index) => {
                if (index !== currentSystemIndex) { // Nicht das aktuelle System anzeigen
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = `${system.displayName} (${system.name})`;
                    select.appendChild(option);
                }
            });
            
            document.getElementById('neighborModal').classList.add('active');
        }

                document.getElementById('neighborSystemSelect').addEventListener('change', (e) => {
                const selectedIndex = e.target.value;
                if (selectedIndex !== '') {
                    const selectedSystem = allSystems[selectedIndex];
                    document.getElementById('neighborDisplayName').value = selectedSystem.displayName;
                    document.getElementById('neighborPreviewIdentifier').textContent = selectedSystem.name;
                } else {
                    document.getElementById('neighborDisplayName').value = '';
                    document.getElementById('neighborPreviewIdentifier').textContent = '-';
                }
            });
            
        function saveNeighborSystem() {
            const displayName = document.getElementById('neighborDisplayName').value.trim();
            const jumpsMin = parseInt(document.getElementById('neighborJumpsMin').value);
            const jumpsMax = parseInt(document.getElementById('neighborJumpsMax').value);
            
            if (!displayName) {
                showNotification('‚ö†Ô∏è Please enter a display name!');
                return;
            }
            
            const identifier = generateNeighborIdentifier(displayName);
            
            const neighborData = {
                id: Date.now() + Math.random(),
                mode: 'reference',
                initializer: identifier,
                hyperlaneJumps: {
                    min: jumpsMin,
                    max: jumpsMax
                }
            };
            
            allSystems[currentSystemIndex].neighborSystems.push(neighborData);
            
            document.getElementById('neighborModal').classList.remove('active');
            showNotification(`‚úÖ Neighbor system "${identifier}" added!`);
            loadSystemIntoEditor(allSystems[currentSystemIndex]);
        }

        function deleteNeighborSystem(index) {
            if (confirm('Really remove neighbor system?')) {
                allSystems[currentSystemIndex].neighborSystems.splice(index, 1);
                showNotification('üóëÔ∏è Neighbor system removed!');
                loadSystemIntoEditor(allSystems[currentSystemIndex]);
            }
        }

        // =====================================================
        // ASTEROID BELT MANAGEMENT
        // =====================================================
        
        function openAddAsteroidBeltModal() {
            document.getElementById('beltType').value = 'rocky_asteroid_belt';
            document.getElementById('beltRadius').value = '90';
            
            document.getElementById('asteroidBeltModal').classList.add('active');
        }

        function saveAsteroidBelt() {
            const type = document.getElementById('beltType').value;
            const radius = parseInt(document.getElementById('beltRadius').value);
            
            const beltData = {
                id: Date.now() + Math.random(),
                type: type,
                radius: radius
            };
            
            allSystems[currentSystemIndex].asteroidBelts.push(beltData);
            
            document.getElementById('asteroidBeltModal').classList.remove('active');
            showNotification('‚úÖ Asteroid belt added!');
            loadSystemIntoEditor(allSystems[currentSystemIndex]);
        }

        function deleteAsteroidBelt(index) {
            if (confirm('Really delete asteroid belt?')) {
                allSystems[currentSystemIndex].asteroidBelts.splice(index, 1);
                showNotification('üóëÔ∏è Asteroid belt deleted!');
                loadSystemIntoEditor(allSystems[currentSystemIndex]);
            }
        }

        // =====================================================
        // SYSTEM MANAGEMENT
        // =====================================================
        
        function editSystemProperties() {
            const system = allSystems[currentSystemIndex];
            
            const newDisplayName = prompt('System display name:', system.displayName);
            if (newDisplayName && newDisplayName.trim()) {
                system.displayName = newDisplayName.trim();
            }
            
            const newClass = prompt('Star class (e.g. sc_g, sc_m, sc_k):', system.class);
            if (newClass && newClass.trim()) {
                system.class = newClass.trim();
            }
            
            const newUsage = prompt('Usage (e.g. custom_empire, misc_system):', system.usage);
            if (newUsage && newUsage.trim()) {
                system.usage = newUsage.trim();
            }
            
            updateSystemList();
            loadSystemIntoEditor(system);
            showNotification('‚úÖ System properties updated!');
        }

        function deleteCurrentSystem() {
            if (currentSystemIndex === null) return;
            
            if (confirm(`Really delete system "${allSystems[currentSystemIndex].displayName}"?`)) {
                allSystems.splice(currentSystemIndex, 1);
                
                if (allSystems.length > 0) {
                    selectSystem(Math.min(currentSystemIndex, allSystems.length - 1));
                } else {
                    currentSystemIndex = null;
                    clearEditor();
                    document.getElementById('importInfo').classList.add('hidden');
                }
                
                updateSystemList();
                showNotification('üóëÔ∏è System deleted!');
            }
        }

        // Make functions globally accessible
        window.deleteCurrentSystem = deleteCurrentSystem;
        window.editSystemProperties = editSystemProperties;
        window.openAddPlanetModal = openAddPlanetModal;
        window.openEditPlanetModal = openEditPlanetModal;
        window.deletePlanet = deletePlanet;
        window.movePlanetUp = movePlanetUp;
        window.movePlanetDown = movePlanetDown;
        window.openAddMoonModal = openAddMoonModal;
        window.editMoon = editMoon;
        window.deleteMoon = deleteMoon;
        window.openAddNeighborModal = openAddNeighborModal;
        window.deleteNeighborSystem = deleteNeighborSystem;
        window.openAddAsteroidBeltModal = openAddAsteroidBeltModal;
        window.deleteAsteroidBelt = deleteAsteroidBelt;

        // =====================================================
        // CODE GENERATION
        // =====================================================
        
        function generateSystemCode(system) {
            let code = `${system.name} = {\n`;
            code += `\tname = "${system.displayName}"\n`;
            code += `\tclass = "${system.class}"\n`;
            
            system.asteroidBelts.forEach(belt => {
                code += `\tasteroid_belt = {\n`;
                code += `\t\ttype = ${belt.type}\n`;
                code += `\t\tradius = ${belt.radius}\n`;
                code += `\t}\n`;
            });
            
            code += `\tusage = ${system.usage}\n`;
            
            if (system.isMain) {
                code += `\tinit_effect = {\n`;
                code += `\t\tevery_neighbor_system = {\n`;
                code += `\t\t\tset_star_flag = empire_cluster\n`;
                code += `\t\t\tevery_neighbor_system = {\n`;
                code += `\t\t\t\tset_star_flag = empire_cluster\n`;
                code += `\t\t\t}\n`;
                code += `\t\t}\n`;
                code += `\t\tgenerate_home_system_resources = yes\n`;
                code += `\t}\n`;
            }
            
            system.planets.forEach(planet => {
                code += generatePlanetCode(planet, 1);
            });
            
            system.neighborSystems.forEach(neighbor => {
                code += `\n\tneighbor_system = {\n`;
                code += `\t\thyperlane_jumps = { min = ${neighbor.hyperlaneJumps.min} max = ${neighbor.hyperlaneJumps.max} }\n`;
                code += `\t\tinitializer = "${neighbor.initializer}"\n`;
                code += `\t}\n`;
            });
            
            code += `}\n`;
            
            return code;
        }

        function generatePlanetCode(planet, indentLevel) {
            const tab = '\t'.repeat(indentLevel);
            let code = `\n${tab}planet = {\n`;
            
            code += `${tab}\tname = "${planet.name}"\n`;
            // Verwende ideal_design_class f√ºr garantierte bewohnbare Planeten
            if (planet.isGuaranteedHabitable) {
                code += `${tab}\tclass = ideal_design_class\n`;
            } else {
                code += `${tab}\tclass = "${planet.class}"\n`;
            }
            code += `${tab}\torbit_distance = ${planet.orbitDistance}\n`;
            
            // Export orbit_angle based on type
            if (planet.orbitAngleType === 'fixed') {
                code += `${tab}\torbit_angle = ${planet.orbitAngle}\n`;
            } else {
                code += `${tab}\torbit_angle = { min = ${planet.orbitAngleMin} max = ${planet.orbitAngleMax} }\n`;
            }
            
            code += `${tab}\tsize = ${planet.size}\n`;
            
            if (planet.changeOrbit > 0) {
                code += `${tab}\tchange_orbit = ${planet.changeOrbit}\n`;
            }
            
            code += `${tab}\thas_ring = ${planet.hasRing ? 'yes' : 'no'}\n`;
            
            // Export modifiers for ALL planets
            if (planet.modifiers && planet.modifiers.length > 0) {
                code += `${tab}\tmodifiers = { ${planet.modifiers.join(' ')} }\n`;
            }
            
            if (planet.isStartingPlanet) {
                code += `${tab}\tstarting_planet = yes\n`;
                code += `${tab}\ttile_blockers = none\n`;
                // Only add "modifiers = none" if no modifiers exist
                if (!planet.modifiers || planet.modifiers.length === 0) {
                    code += `${tab}\tmodifiers = none\n`;
                }
                code += `${tab}\tinit_effect = {\n`;
                code += `${tab}\t\tprevent_anomaly = yes\n`;
                code += `${tab}\t}\n`;
                code += `${tab}\tinit_effect = {\n`;
                code += `${tab}\t\tgenerate_start_buildings_and_blockers = yes\n`;
                code += `${tab}\t}\n`;
            }

            if (planet.isGuaranteedHabitable) {
                code += `${tab}\tmodifiers = none\n`;
                code += `${tab}\tanomaly = none\n`;
                code += `${tab}\tinit_effect = {\n`;
                code += `${tab}\t\tprevent_anomaly = yes\n`;
                code += `${tab}\t\tset_planet_flag = prescripted_ideal\n`;
                code += `${tab}\t}\n`;
            }
    //
    //
    // This change does the following:

    // 1. ‚úÖ **For normal planets with modifiers**: Exports `modifiers = { pm_xyz pm_abc }`
    // 2. ‚úÖ **For normal planets without modifiers**: No modifier line (as is usual in Stellaris)
    // 3. ‚úÖ **For starting planets with modifiers**: Exports the modifiers and NOT `modifiers = none`
    // 4. ‚úÖ **For starting planets without modifiers**: Exports `modifiers = none` (as expected by Stellaris)

    // Now the export should work correctly! Please test it again and check the export preview. The modifiers should now appear as:
    
    //  planet = {
    //      name = "Balder"
    //      class = "pc_molten"
    //      orbit_distance = 25
    //      orbit_angle = { min = 90 max = 270 }
    //      size = 20
    //      has_ring = no
    //      modifiers = { pm_carbon_world }
    //  }
            
            planet.moons.forEach(moon => {
                const moonCode = generatePlanetCode(moon, indentLevel + 1);
                code += moonCode.replace(/\n\s*planet\s*=\s*\{/, '\n' + tab + '\tmoon = {');
            });
            
            code += `${tab}}\n`;
            
            return code;
        }

        function generateLocalizationYML(systems) {
            let yml = 'l_english:\n';
            
            systems.forEach(system => {
                const baseName = system.name.replace(/_system_initializer$/, '');
                const identifier = `${baseName}_system_initializer`;
                
                // NAME entry
                yml += ` ${identifier}_NAME:0 "${system.displayName}"\n`;
                
                // DESC entry - create a default description
                const description = `${system.displayName} Description: A custom star system created with the Stellaris Solar System Editor.`;
                yml += ` ${identifier}_DESC:0 "${description}"\n`;
            });
            
            return yml;
        }

        // =====================================================
        // HELPER FUNCTIONS
        // =====================================================
        
        function getPlanetIcon(planetClass) {
            const icons = {
                'pc_g_star': '‚òÄÔ∏è', 'pc_k_star': 'üåü', 'pc_m_star': 'üî¥',
                'pc_f_star': '‚≠ê', 'pc_a_star': 'üí´', 'pc_b_star': 'üå†',
                'pc_black_hole': '‚ö´', 'pc_neutron_star': 'üí†', 'pc_pulsar': 'üì°',
                'pc_continental': 'üåç', 'pc_ocean': 'üåä', 'pc_desert': 'üèúÔ∏è',
                'pc_tropical': 'üå¥', 'pc_arid': 'üåµ', 'pc_tundra': '‚ùÑÔ∏è',
                'pc_arctic': 'üßä', 'pc_alpine': 'üèîÔ∏è', 'pc_savannah': 'üåæ',
                'pc_gas_giant': 'ü™ê', 'pc_molten': 'üåã', 'pc_barren': 'ü™®',
                'pc_barren_cold': '‚òÑÔ∏è', 'pc_toxic': '‚ò¢Ô∏è', 'pc_frozen': 'üßä',
                'pc_asteroid': '‚òÑÔ∏è', 'pc_ice_asteroid': '‚ùÑÔ∏è', 'pc_rare_crystal_asteroid': 'üíé'
            };
            return icons[planetClass] || 'üåë';
        }

        function getClassDisplayName(planetClass) {
            const names = {
                'pc_g_star': 'G-Star', 'pc_k_star': 'K-Star', 'pc_m_star': 'M-Star',
                'pc_f_star': 'F-Star', 'pc_a_star': 'A-Star', 'pc_b_star': 'B-Star',
                'pc_black_hole': 'Black Hole', 'pc_neutron_star': 'Neutron Star', 
                'pc_pulsar': 'Pulsar',
                'pc_continental': 'Continental', 'pc_ocean': 'Ocean', 'pc_desert': 'Desert',
                'pc_tropical': 'Tropical', 'pc_arid': 'Arid', 'pc_tundra': 'Tundra',
                'pc_arctic': 'Arctic', 'pc_alpine': 'Alpine', 'pc_savannah': 'Savannah',
                'pc_gas_giant': 'Gas Giant', 'pc_molten': 'Molten', 'pc_barren': 'Barren',
                'pc_barren_cold': 'Barren (Cold)', 'pc_toxic': 'Toxic', 'pc_frozen': 'Frozen',
                'pc_asteroid': 'Asteroid', 'pc_ice_asteroid': 'Ice Asteroid', 
                'pc_rare_crystal_asteroid': 'Rare Crystal Asteroid'
            };
            return names[planetClass] || planetClass;
        }

        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
    </script>
</body>
</html>
