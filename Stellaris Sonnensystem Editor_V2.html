<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stellaris Solar System Editor - Enhanced Version</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800;900&family=Exo+2:wght@300;400;500;600&display=swap');
        
        :root {
            --stellaris-blue: #00d4ff;
            --stellaris-gold: #ffd700;
            --stellaris-purple: #9966ff;
            --stellaris-dark: #0a0e1a;
            --stellaris-darker: #050811;
            --stellaris-panel: #1a2332;
            --stellaris-border: #2a3847;
            --stellaris-accent: #00a8cc;
        }

        body {
            font-family: 'Exo 2', 'Inter', sans-serif;
            background: linear-gradient(135deg, var(--stellaris-darker) 0%, var(--stellaris-dark) 50%, #0f1419 100%);
            color: #e2e8f0;
            min-height: 100vh;
            background-attachment: fixed;
        }

        .stellaris-header {
            background: linear-gradient(90deg, var(--stellaris-blue) 0%, var(--stellaris-purple) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-family: 'Orbitron', monospace;
            font-weight: 700;
            text-align: center;
            font-size: 2.5rem;
            margin-bottom: 2rem;
            text-shadow: 0 0 20px rgba(0, 212, 255, 0.3);
        }

        .stellaris-panel {
            background: linear-gradient(145deg, var(--stellaris-panel) 0%, rgba(26, 35, 50, 0.8) 100%);
            border: 1px solid var(--stellaris-border);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            position: relative;
            overflow: hidden;
        }

        .stellaris-panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, var(--stellaris-blue), var(--stellaris-purple), var(--stellaris-gold));
        }

        .stellaris-input {
            background: linear-gradient(145deg, #2a3847 0%, #1e2936 100%);
            border: 1px solid var(--stellaris-border);
            color: #e2e8f0;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            width: 100%;
            font-family: 'Exo 2', sans-serif;
            transition: all 0.3s ease;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .stellaris-input:focus {
            outline: none;
            border-color: var(--stellaris-blue);
            box-shadow: 
                inset 0 2px 4px rgba(0, 0, 0, 0.2),
                0 0 0 3px rgba(0, 212, 255, 0.2);
        }

        /* Dropdown Option Styling f√ºr bessere Lesbarkeit */
        .stellaris-input option {
            background-color: #2a3847;
            color: #e2e8f0;
            padding: 8px 12px;
        }

        .stellaris-input option:hover,
        .stellaris-input option:focus {
            background-color: var(--stellaris-blue);
            color: white;
        }

        .stellaris-input option:checked {
            background-color: var(--stellaris-accent);
            color: white;
        }

        /* Optgroup Styling f√ºr bessere Kategorien-Trennung */
        .stellaris-input optgroup {
            background-color: #1e2936;
            color: #cbd5e0;
            font-weight: bold;
            font-style: normal;
        }

        .stellaris-input optgroup option {
            background-color: #2a3847;
            color: #e2e8f0;
            font-weight: normal;
            padding-left: 16px;
        }

        .stellaris-btn {
            background: linear-gradient(145deg, var(--stellaris-blue) 0%, var(--stellaris-accent) 100%);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            font-family: 'Exo 2', sans-serif;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 4px 15px rgba(0, 212, 255, 0.3);
        }

        .stellaris-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }

        .stellaris-btn:hover::before {
            left: 100%;
        }

        .stellaris-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 212, 255, 0.4);
        }

        .stellaris-btn-secondary {
            background: linear-gradient(145deg, #4a5568 0%, #2d3748 100%);
            box-shadow: 0 4px 15px rgba(74, 85, 104, 0.3);
        }

        .stellaris-btn-danger {
            background: linear-gradient(145deg, #e53e3e 0%, #c53030 100%);
            box-shadow: 0 4px 15px rgba(229, 62, 62, 0.3);
        }

        .celestial-item {
            background: linear-gradient(145deg, rgba(74, 85, 104, 0.6) 0%, rgba(45, 55, 72, 0.8) 100%);
            border: 1px solid var(--stellaris-border);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
            backdrop-filter: blur(5px);
        }

        .celestial-item:hover {
            background: linear-gradient(145deg, rgba(0, 212, 255, 0.1) 0%, rgba(153, 102, 255, 0.1) 100%);
            border-color: var(--stellaris-blue);
            transform: translateX(4px);
        }

        .celestial-item.selected {
            background: linear-gradient(145deg, rgba(0, 212, 255, 0.2) 0%, rgba(153, 102, 255, 0.2) 100%);
            border-color: var(--stellaris-blue);
            box-shadow: 0 0 20px rgba(0, 212, 255, 0.3);
        }

        .celestial-item.new-orbit {
            border-left: 4px solid var(--stellaris-gold);
        }

        .celestial-item.same-orbit {
            border-left: 4px solid rgba(255, 255, 255, 0.3);
        }

        .stellaris-visualizer {
            background: radial-gradient(circle at center, #0a0e1a 0%, #000 70%);
            border: 2px solid var(--stellaris-border);
            border-radius: 12px;
            height: 500px;
            position: relative;
            overflow: hidden;
            box-shadow: inset 0 0 50px rgba(0, 0, 0, 0.8);
        }

        .section-title {
            font-family: 'Orbitron', monospace;
            font-weight: 600;
            font-size: 1.5rem;
            color: var(--stellaris-blue);
            margin-bottom: 1rem;
            text-shadow: 0 0 10px rgba(0, 212, 255, 0.3);
        }

        .label {
            font-weight: 500;
            color: #cbd5e0;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stellaris-export-area {
            background: linear-gradient(145deg, #1a1f2e 0%, #0f1419 100%);
            border: 1px solid var(--stellaris-border);
            border-radius: 8px;
            padding: 1rem;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            line-height: 1.4;
            color: #e2e8f0;
            resize: none;
            min-height: 300px;
        }

        .warning-panel {
            background: linear-gradient(145deg, rgba(255, 193, 7, 0.1) 0%, rgba(255, 152, 0, 0.1) 100%);
            border: 1px solid rgba(255, 193, 7, 0.3);
            border-radius: 8px;
            padding: 1.5rem;
            margin-top: 2rem;
        }

        .orbit-indicator {
            position: absolute;
            border: 1px dashed rgba(0, 212, 255, 0.3);
            border-radius: 50%;
            pointer-events: none;
        }

        .stellaris-star {
            background: radial-gradient(circle, #ffeb3b 0%, #ff9800 100%);
            box-shadow: 
                0 0 30px #ffeb3b,
                0 0 60px rgba(255, 235, 59, 0.5),
                0 0 90px rgba(255, 152, 0, 0.3);
            animation: starGlow 3s ease-in-out infinite alternate;
        }

        @keyframes starGlow {
            0% { box-shadow: 0 0 30px #ffeb3b, 0 0 60px rgba(255, 235, 59, 0.5); }
            100% { box-shadow: 0 0 40px #ffeb3b, 0 0 80px rgba(255, 235, 59, 0.7); }
        }

        .planet, .moon {
            border-radius: 50%;
            position: absolute;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 0.7rem;
            font-weight: 600;
            color: white;
            text-shadow: 0 0 5px rgba(0, 0, 0, 0.8);
            border: 2px solid rgba(255, 255, 255, 0.3);
            box-shadow: 
                0 2px 10px rgba(0, 0, 0, 0.5),
                inset 0 0 10px rgba(255, 255, 255, 0.1);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .planet:hover, .moon:hover {
            transform: scale(1.1);
            box-shadow: 
                0 4px 20px rgba(0, 212, 255, 0.5),
                inset 0 0 15px rgba(255, 255, 255, 0.2);
        }

        .asteroid-belt {
            position: absolute;
            border: 2px dotted rgba(139, 69, 19, 0.6);
            border-radius: 50%;
            pointer-events: none;
        }

        .orbit-number {
            position: absolute;
            color: rgba(0, 212, 255, 0.7);
            font-size: 0.8rem;
            font-weight: bold;
            background: rgba(0, 0, 0, 0.5);
            padding: 2px 6px;
            border-radius: 4px;
        }

        .orbit-distance-info {
            background: rgba(0, 212, 255, 0.1);
            border: 1px solid rgba(0, 212, 255, 0.3);
            border-radius: 4px;
            padding: 0.5rem;
            margin-top: 0.5rem;
            font-size: 0.8rem;
        }

        .neighbor-item {
            background: linear-gradient(145deg, rgba(153, 102, 255, 0.1) 0%, rgba(102, 51, 153, 0.1) 100%);
            border: 1px solid rgba(153, 102, 255, 0.3);
            border-radius: 6px;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .grid {
            display: grid;
            gap: 1.5rem;
        }

        .grid-cols-1 { grid-template-columns: 1fr; }
        .grid-cols-2 { grid-template-columns: repeat(2, 1fr); }
        .grid-cols-3 { grid-template-columns: repeat(3, 1fr); }

        @media (min-width: 768px) {
            .md\:grid-cols-2 { grid-template-columns: repeat(2, 1fr); }
        }

        @media (min-width: 1024px) {
            .lg\:grid-cols-3 { grid-template-columns: repeat(3, 1fr); }
            .lg\:col-span-2 { grid-column: span 2; }
        }

        .hidden { display: none; }
        .ml-6 { margin-left: 1.5rem; }
        .ml-2 { margin-left: 0.5rem; }
        .mt-4 { margin-top: 1rem; }
        .mt-6 { margin-top: 1.5rem; }
        .mb-4 { margin-bottom: 1rem; }
        .mb-8 { margin-bottom: 2rem; }
        .py-8 { padding-top: 2rem; padding-bottom: 2rem; }
        .px-2 { padding-left: 0.5rem; padding-right: 0.5rem; }
        .py-1 { padding-top: 0.25rem; padding-bottom: 0.25rem; }
        .text-sm { font-size: 0.875rem; }
        .max-h-96 { max-height: 24rem; }
        .overflow-y-auto { overflow-y: auto; }
        .cursor-not-allowed { cursor: not-allowed; }
        .container { max-width: 1400px; margin: 0 auto; padding: 2rem; }
    </style>
</head>
<body>
    <div class="container py-8">
        <h1 class="stellaris-header">Stellaris Solar System Editor</h1>
        <div class="text-center mb-6">
            <span class="text-yellow-400 font-semibold">Enhanced Version mit Import/Export, Nachbarsystemen & Mod Support</span>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <!-- System Details Panel -->
            <div class="stellaris-panel md:col-span-3">
                <h2 class="section-title">Systemdetails</h2>
                
                <!-- Import Section -->
                <div class="mb-6 p-4 bg-gradient-to-r from-purple-900/30 to-blue-900/30 rounded-lg border border-purple-500/30">
                    <h3 class="text-lg font-medium mb-3 text-purple-400">üìÇ System Import/Export</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="label">Bestehendes System laden (.txt)</label>
                            <input type="file" id="importFile" class="stellaris-input" accept=".txt" style="padding: 0.5rem;">
                        </div>
                        <div class="flex items-end">
                            <button id="importBtn" class="stellaris-btn stellaris-btn-secondary">System importieren</button>
                            <button id="clearSystemBtn" class="stellaris-btn stellaris-btn-danger ml-2">System leeren</button>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2">
                    <div>
                        <label class="label">Systemname (Interner Bezeichner)</label>
                        <input type="text" id="systemName" class="stellaris-input" placeholder="z.B. akon_system_initializer">
                    </div>
                    <div>
                        <label class="label">Anzeigename des Systems</label>
                        <input type="text" id="systemDisplayName" class="stellaris-input" placeholder="z.B. Akon">
                    </div>
                    <div>
                        <label class="label">Sternenklasse</label>
                        <select id="systemClass" class="stellaris-input">
                            <option value="sc_b">B-Klasse Stern (Hei√üer Riese)</option>
                            <option value="sc_a">A-Klasse Stern (Wei√üer Stern)</option>
                            <option value="sc_f">F-Klasse Stern (Gelblich-wei√üer Stern)</option>
                            <option value="sc_g" selected>G-Klasse Stern (Gelber Zwerg - Sol)</option>
                            <option value="sc_k">K-Klasse Stern (Oranger Zwerg)</option>
                            <option value="sc_m">M-Klasse Stern (Roter Zwerg)</option>
                            <option value="sc_black_hole">Schwarzes Loch</option>
                            <option value="sc_neutron_star">Neutronenstern</option>
                            <option value="sc_pulsar">Pulsar</option>
                            <option value="sc_trinary">Bin√§r/Trin√§r (Zuf√§llig)</option>
                        </select>
                    </div>
                    <div>
                        <label class="label">Verwendung</label>
                        <select id="systemUsage" class="stellaris-input">
                            <option value="empire_init">Imperiumsstart (Zuf√§llig)</option>
                            <option value="custom_empire" selected>Benutzerdefiniertes Imperium (W√§hlbar)</option>
                            <option value="misc_system_init">Verschiedenes System (Zuf√§llig)</option>
                            <option value="">Keine (Nur durch Ereignis)</option>
                        </select>
                    </div>
                </div>
                
                <!-- Neighbor Systems Configuration -->
                <div class="mt-6 p-4 bg-gradient-to-r from-indigo-900/30 to-purple-900/30 rounded-lg border border-indigo-500/30">
                    <h3 class="text-lg font-medium mb-4 text-indigo-400">üåå Nachbarsysteme</h3>
                    <div id="neighborSystemsList" class="space-y-2 mb-4">
                        <p class="text-gray-400 text-sm">Keine Nachbarsysteme definiert</p>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="label">Distanz</label>
                            <input type="number" id="newNeighborDistance" class="stellaris-input" value="100" min="50" max="200">
                        </div>
                        <div>
                            <label class="label">Initialisierung</label>
                            <select id="newNeighborInit" class="stellaris-input">
                                <option value="">Zuf√§llig</option>
                                <option value="sol_system_initializer">Sol-System</option>
                                <option value="deneb_system">Deneb</option>
                                <option value="alpha_centauri_initializer">Alpha Centauri</option>
                                <option value="custom">Benutzerdefiniert</option>
                            </select>
                        </div>
                        <div class="flex items-end">
                            <button id="addNeighborBtn" class="stellaris-btn stellaris-btn-secondary">Nachbar hinzuf√ºgen</button>
                        </div>
                    </div>
                </div>
                
                <!-- Asteroid Belt Configuration -->
                <div class="mt-6 p-4 bg-gray-800 rounded-lg">
                    <h3 class="text-lg font-medium mb-4 text-yellow-400">Asteroideng√ºrtel (Multiple m√∂glich)</h3>
                    <div id="asteroidBeltList" class="space-y-2 mb-4">
                        <p class="text-gray-400 text-sm">Keine Asteroideng√ºrtel definiert</p>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="label">Typ</label>
                            <select id="newAsteroidBeltType" class="stellaris-input">
                                <option value="rocky_asteroid_belt">Rocky Asteroid Belt</option>
                                <option value="icy_asteroid_belt">Icy Asteroid Belt</option>
                                <option value="crystalline_asteroid_belt">Crystalline Asteroid Belt</option>
                            </select>
                        </div>
                        <div>
                            <label class="label">Radius</label>
                            <input type="number" id="newAsteroidBeltRadius" class="stellaris-input" value="575" min="100" max="1000">
                        </div>
                        <div class="flex items-end">
                            <button id="addAsteroidBeltBtn" class="stellaris-btn stellaris-btn-secondary">G√ºrtel hinzuf√ºgen</button>
                        </div>
                    </div>
                </div>

                <div class="mt-6">
                    <button id="addPlanetBtn" class="stellaris-btn">Planet hinzuf√ºgen</button>
                    <button id="moveUpBtn" class="stellaris-btn stellaris-btn-secondary ml-2" disabled>‚Üë Nach oben</button>
                    <button id="moveDownBtn" class="stellaris-btn stellaris-btn-secondary ml-2" disabled>‚Üì Nach unten</button>
                </div>
                
                <!-- Orbit Distance Info -->
                <div class="orbit-distance-info mt-4">
                    <strong>üí° Stellaris Kumulative Orbit-Mechanik:</strong><br>
                    üìê <strong>Kumulative Addition:</strong> orbit_distance wird zur Gesamtdistanz addiert<br>
                    üü° <strong>Planet 1:</strong> orbit_distance = 25 ‚Üí Umlaufbahn bei 25<br>
                    üü° <strong>Planet 2:</strong> orbit_distance = 30 ‚Üí Umlaufbahn bei 25+30 = 55<br>
                    ‚ö™ <strong>Planet 3:</strong> orbit_distance = 0 ‚Üí Gleiche Umlaufbahn bei 55
                </div>
            </div>

            <!-- Visualizer Panel -->
            <div class="stellaris-panel md:col-span-3" style="height: 650px;">
                <h2 class="section-title">System-Visualisierung</h2>
                <div id="visualizer" class="stellaris-visualizer">
                    <!-- Celestial bodies will be rendered here -->
                </div>
                <div class="mt-4">
                    <button id="zoomInBtn" class="stellaris-btn stellaris-btn-secondary text-sm px-2 py-1">Zoom +</button>
                    <button id="zoomOutBtn" class="stellaris-btn stellaris-btn-secondary text-sm px-2 py-1 ml-2">Zoom -</button>
                    <button id="resetViewBtn" class="stellaris-btn stellaris-btn-secondary text-sm px-2 py-1 ml-2">Reset</button>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 mb-8">
            <!-- Planet List -->
            <div class="stellaris-panel">
                <h2 class="section-title">Planeten (Reihenfolge)</h2>
                <div id="planetList" class="max-h-96 overflow-y-auto">
                    <p class="text-gray-400">F√ºgen Sie Planeten hinzu, um mit dem Systembau zu beginnen.</p>
                </div>
            </div>

            <!-- Celestial Body Details Panel -->
            <div class="stellaris-panel lg:col-span-2">
                <h2 class="section-title">Planet-Details</h2>
                <div id="celestialDetails" class="hidden">
                    <div class="grid grid-cols-1 md:grid-cols-2">
                        <div>
                            <label class="label">Typ</label>
                            <input type="text" id="celestialType" class="stellaris-input cursor-not-allowed" readonly>
                        </div>
                        <div>
                            <label class="label">Position in System</label>
                            <input type="text" id="celestialPosition" class="stellaris-input cursor-not-allowed" readonly>
                        </div>
                        <div>
                            <label class="label">Name (Interner Bezeichner)</label>
                            <input type="text" id="celestialName" class="stellaris-input" placeholder="z.B. akon">
                        </div>
                        <div>
                            <label class="label">Anzeigename</label>
                            <input type="text" id="celestialDisplayName" class="stellaris-input" placeholder="z.B. Akon">
                        </div>
                        <div>
                            <label class="label">Planetenklasse</label>
                            <select id="celestialClass" class="stellaris-input">
                                <optgroup label="Sterne">
                                    <option value="pc_b_star">B-Klasse Stern</option>
                                    <option value="pc_a_star">A-Klasse Stern</option>
                                    <option value="pc_f_star">F-Klasse Stern</option>
                                    <option value="pc_g_star">G-Klasse Stern</option>
                                    <option value="pc_k_star">K-Klasse Stern</option>
                                    <option value="pc_m_star">M-Klasse Stern</option>
                                    <option value="pc_black_hole">Schwarzes Loch</option>
                                    <option value="pc_neutron_star">Neutronenstern</option>
                                    <option value="pc_pulsar">Pulsar</option>
                                    <option value="pc_brown_dwarf">Brauner Zwerg</option>
                                </optgroup>
                                <optgroup label="Bewohnbare Welten">
                                    <option value="pc_continental">Kontinental</option>
                                    <option value="pc_ocean">Ozean</option>
                                    <option value="pc_tropical">Tropisch</option>
                                    <option value="pc_arid">Arid</option>
                                    <option value="pc_desert">W√ºste</option>
                                    <option value="pc_savanna">Savanne</option>
                                    <option value="pc_arctic">Arktisch</option>
                                    <option value="pc_tundra">Tundra</option>
                                    <option value="pc_alpine">Alpin</option>
                                    <option value="pc_gaia">Gaia</option>
                                </optgroup>
                                <optgroup label="Unbewohnbare Welten (Vanilla)">
                                    <option value="pc_barren" selected>Karg</option>
                                    <option value="pc_frozen">Gefroren</option>
                                    <option value="pc_molten">Geschmolzen</option>
                                    <option value="pc_toxic">Toxisch</option>
                                    <option value="pc_gas_giant">Gasriese</option>
                                    <option value="pc_nuked">Verstrahlt</option>
                                    <option value="pc_asteroid">Asteroid</option>
                                </optgroup>
                                <optgroup label="Spezielle Welten">
                                    <option value="pc_relic">Relikt-Welt</option>
                                    <option value="pc_habitat">Habitat</option>
                                    <option value="pc_ecumenopolis">√ñkumenopolis</option>
                                    <option value="pc_machine">Maschinenwelt</option>
                                    <option value="pc_hive">Schwarmwelt</option>
                                    <option value="pc_shielded">Abgeschirmt</option>
                                </optgroup>
                                <optgroup label="üåå Gigastructural Engineers">
                                    <option value="pc_birch">Birch World</option>
                                    <option value="pc_alderson">Alderson Disk</option>
                                    <option value="pc_gas_giant_habitable">Habitable Gas Giant</option>
                                    <option value="pc_stellar_systemcraft">Stellar Systemcraft</option>
                                    <option value="pc_nicoll_dyson_beam">Nicoll-Dyson Beam Target</option>
                                    <option value="pc_penrose_sphere_habitable">Penrose Sphere Habitat</option>
                                    <option value="pc_virtual_reality">Virtual Reality World</option>
                                    <option value="pc_pouchkinn_planet">Pouchkinn Planet</option>
                                    <option value="pc_gigastructural_shielded">Gigastructural Shielded World</option>
                                </optgroup>
                                <optgroup label="üåä PD: Wet Worlds (Feuchte Welten)">
                                    <option value="pd_retinal_world">Retinal World</option>
                                    <option value="pd_lake_world">Lake World</option>
                                    <option value="pd_tepid_world">Tepid World</option>
                                    <option value="pd_mushroom_world">Mushroom World</option>
                                    <option value="pd_temperate_world">Temperate World</option>
                                    <option value="pd_sakura_world">Sakura World</option>
                                    <option value="pd_forest_world">Forest World</option>
                                    <option value="pd_megaflora_world">Megaflora World</option>
                                    <option value="pd_petrified_world">Petrified World</option>
                                    <option value="pd_cascadian_world">Cascadian World</option>
                                    <option value="pd_swamp_world">Swamp World</option>
                                    <option value="pd_crag_world">Crag World</option>
                                    <option value="pd_fog_world">Fog World</option>
                                    <option value="pd_kelp_world">Kelp World</option>
                                    <option value="pd_algae_world">Algae World</option>
                                    <option value="pd_reef_world">Reef World</option>
                                    <option value="pd_coral_world">Coral World</option>
                                    <option value="pd_archipelago_world">Archipelago World</option>
                                    <option value="pd_atoll_world">Atoll World</option>
                                    <option value="pd_tepui_world">Tepui World</option>
                                    <option value="pd_mangrove_world">Mangrove World</option>
                                    <option value="pd_cenote_world">Cenote World</option>
                                    <option value="pd_fungal_world">Fungal World</option>
                                    <option value="pd_aerial_world">Aerial World</option>
                                    <option value="pd_lilypad_world">Lilypad World</option>
                                    <option value="pd_geothermal_world">Geothermal World</option>
                                    <option value="pd_biolumen_world">Bioluminescent World</option>
                                </optgroup>
                                <optgroup label="üèúÔ∏è PD: Dry Worlds (Trockene Welten)">
                                    <option value="pd_dune_world">Dune World</option>
                                    <option value="pd_oasis_world">Oasis World</option>
                                    <option value="pd_outback_world">Outback World</option>
                                    <option value="pd_coastal_world">Coastal World</option>
                                    <option value="pd_fungi_world">Fungi World</option>
                                    <option value="pd_salt_world">Salt World</option>
                                    <option value="pd_aquifer_world">Aquifer World</option>
                                    <option value="pd_mesa_world">Mesa World</option>
                                    <option value="pd_fog_desert_world">Fog Desert World</option>
                                    <option value="pd_mediterranean_world">Mediterranean World</option>
                                    <option value="pd_badlands_world">Badlands World</option>
                                    <option value="pd_succulent_world">Succulent World</option>
                                    <option value="pd_striped_world">Striped World</option>
                                    <option value="pd_primal_world">Primal World</option>
                                    <option value="pd_steppe_world">Steppe World</option>
                                    <option value="pd_prairie_world">Prairie World</option>
                                    <option value="pd_veld_world">Veld World</option>
                                    <option value="pd_semi_arid_world">Semi-Arid World</option>
                                    <option value="pd_aspen_world">Aspen World</option>
                                    <option value="pd_sandstone_world">Sandstone World</option>
                                    <option value="pd_supercontinent_world">Supercontinent World</option>
                                    <option value="pd_sinkhole_world">Sinkhole World</option>
                                </optgroup>
                                <optgroup label="‚ùÑÔ∏è PD: Cold Worlds (Kalte Welten)">
                                    <option value="pd_cold_desert_world">Cold Desert World</option>
                                    <option value="pd_glacial_world">Glacial World</option>
                                    <option value="pd_antarctic_world">Antarctic World</option>
                                    <option value="pd_aeolian_world">Aeolian World</option>
                                    <option value="pd_ice_spike_world">Ice Spike World</option>
                                    <option value="pd_crevasse_world">Crevasse World</option>
                                    <option value="pd_ice_dunes_world">Ice Dunes World</option>
                                    <option value="pd_iceberg_world">Iceberg World</option>
                                    <option value="pd_boreal_world">Boreal World</option>
                                    <option value="pd_snow_world">Snow World</option>
                                    <option value="pd_highland_world">Highland World</option>
                                    <option value="pd_dune_forest_world">Dune Forest World</option>
                                    <option value="pd_fjord_world">Fjord World</option>
                                    <option value="pd_blossom_world">Blossom World</option>
                                    <option value="pd_glaciovolcanic_world">Glaciovolcanic World</option>
                                    <option value="pd_lanthanide_world">Lanthanide World</option>
                                    <option value="pd_bog_world">Bog World</option>
                                    <option value="pd_mycelium_world">Mycelium World</option>
                                    <option value="pd_mud_world">Mud World</option>
                                    <option value="pd_basalt_world">Basalt World</option>
                                    <option value="pd_tuya_world">Tuya World</option>
                                    <option value="pd_cryoflora_world">Cryoflora World</option>
                                    <option value="pd_lichen_world">Lichen World</option>
                                </optgroup>
                                <optgroup label="üåø PD: Gaia Worlds">
                                    <option value="pd_wet_gaia_world">Wet Gaia World</option>
                                    <option value="pd_dry_gaia_world">Dry Gaia World</option>
                                    <option value="pd_cold_gaia_world">Cold Gaia World</option>
                                </optgroup>
                                <optgroup label="‚ú® PD: Uncommon Worlds">
                                    <option value="pc_superhabitable">Superhabitable</option>
                                    <option value="pc_tidally_locked">Tidally Locked</option>
                                    <option value="pc_mantle">Mantle World</option>
                                    <option value="pc_karst">Karst World</option>
                                    <option value="pc_crystal">Crystal World</option>
                                    <option value="pc_frozen_desert">Frozen Desert</option>
                                    <option value="pc_ash">Ash World</option>
                                    <option value="pc_marginal">Marginal World</option>
                                    <option value="pc_sandsea">Sand Sea World</option>
                                    <option value="pc_technoorganic">Techno-organic World</option>
                                    <option value="pd_wet_cave_world">Wet Cave World</option>
                                    <option value="pd_dry_cave_world">Dry Cave World</option>
                                    <option value="pd_cold_cave_world">Cold Cave World</option>
                                    <option value="pd_wet_superhabitable_world">Wet Superhabitable</option>
                                    <option value="pd_dry_superhabitable_world">Dry Superhabitable</option>
                                    <option value="pd_cold_superhabitable_world">Cold Superhabitable</option>
                                    <option value="pd_wet_tidally_locked_world">Wet Tidally Locked</option>
                                    <option value="pd_dry_tidally_locked_world">Dry Tidally Locked</option>
                                    <option value="pd_cold_tidally_locked_world">Cold Tidally Locked</option>
                                </optgroup>
                                <optgroup label="ü™® PD: Enhanced Uninhabitable">
                                    <option value="pc_barren_cold">Karg (Kalt)</option>
                                    <option value="pc_hothouse">Treibhaus</option>
                                    <option value="pc_hot_gas_giant">Hei√üer Gasriese</option>
                                    <option value="pc_cold_gas_giant">Kalter Gasriese</option>
                                    <option value="pc_dwarf_gas_giant">Zwerg-Gasriese</option>
                                    <option value="pc_shattered">Zerst√∂rt</option>
                                    <option value="pc_subglacial">Subglazial</option>
                                    <option value="pc_storm">Sturm-Welt</option>
                                </optgroup>
                            </select>
                        </div>
                        <div>
                            <label class="label">Gr√∂√üe (1-50)</label>
                            <input type="number" id="celestialSize" class="stellaris-input" min="1" max="50" value="16">
                        </div>
                        <div>
                            <label class="label">Orbit Distance</label>
                            <input type="number" id="celestialOrbitDistance" class="stellaris-input" min="0" value="0">
                            <small class="text-gray-400 text-xs">0 = Gleiche Umlaufbahn wie vorheriger Planet</small>
                        </div>
                        <div>
                            <label class="label">Orbit Angle (Typ)</label>
                            <select id="orbitAngleType" class="stellaris-input">
                                <option value="fixed">Fester Winkel</option>
                                <option value="range" selected>Winkelbereich</option>
                            </select>
                        </div>
                        <div class="orbit-angle-controls">
                            <div id="fixedAngleControl" class="hidden">
                                <label class="label">Winkel (0-360¬∞)</label>
                                <input type="number" id="celestialOrbitAngle" class="stellaris-input" min="0" max="360" value="0">
                            </div>
                            <div id="rangeAngleControl">
                                <label class="label">Winkelbereich</label>
                                <div class="grid grid-cols-2 gap-2">
                                    <input type="number" id="celestialOrbitAngleMin" class="stellaris-input" min="0" max="360" value="90" placeholder="Min">
                                    <input type="number" id="celestialOrbitAngleMax" class="stellaris-input" min="0" max="360" value="270" placeholder="Max">
                                </div>
                            </div>
                        </div>
                        <div>
                            <label class="label">Change Orbit (f√ºr nachfolgende Planeten)</label>
                            <input type="number" id="celestialChangeOrbit" class="stellaris-input" min="0" value="0">
                            <small class="text-gray-400 text-xs">0 = Keine √Ñnderung</small>
                        </div>
                        <div class="md:col-span-2">
                            <div class="grid grid-cols-2 gap-4">
                                <label class="label">
                                    <input type="checkbox" id="celestialHasRing" class="mr-2">
                                    Hat Ringsystem
                                </label>
                                <label class="label">
                                    <input type="checkbox" id="celestialIsStartingPlanet" class="mr-2">
                                    Startplanet (Empire)
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="mt-6">
                        <button id="addMoonBtn" class="stellaris-btn stellaris-btn-secondary">Mond hinzuf√ºgen</button>
                        <button id="deleteCelestialBtn" class="stellaris-btn stellaris-btn-danger ml-2">L√∂schen</button>
                    </div>
                </div>
                <p id="noCelestialSelected" class="text-gray-400">W√§hlen Sie einen Planeten aus der Liste, um seine Details zu bearbeiten.</p>
            </div>
        </div>

        <!-- Import/Export Section -->
        <div class="stellaris-panel">
            <h2 class="section-title">Import / Export</h2>
            <div class="grid grid-cols-1 md:col-span-2 gap-4">
                <div>
                    <h3 class="text-xl font-medium mb-4 text-green-400">Generierter Stellaris Code (.txt)</h3>
                    <textarea id="exportTxt" class="stellaris-export-area w-full" rows="40" readonly></textarea>
                    <button id="downloadTxtBtn" class="stellaris-btn mt-4 w-full">Als .txt herunterladen</button>
                </div>
                <div>
                    <h3 class="text-xl font-medium mb-4 text-green-400">Generierte Lokalisierung (.yml)</h3>
                    <textarea id="exportYml" class="stellaris-export-area w-full" rows="40" readonly></textarea>
                    <button id="downloadYmlBtn" class="stellaris-btn mt-4 w-full">Als .yml herunterladen</button>
                </div>
            </div>
            <div class="warning-panel">
                <p class="font-semibold text-yellow-300 mb-2">üéØ Features in Enhanced Version mit Mod Support:</p>
                <ul class="list-disc list-inside space-y-1 text-sm">
                    <li><strong>Import-Funktion:</strong> Laden Sie bestehende Stellaris-Systemdateien (.txt) direkt in den Editor</li>
                    <li><strong>Nachbarsysteme:</strong> Definieren Sie verbundene Systeme mit Distanz und Initialisierung</li>
                    <li><strong>Mod-Unterst√ºtzung:</strong> Vollst√§ndige Integration von Gigastructural Engineers & Planetary Diversity</li>
                    <li><strong>Kumulative Orbit-Mechanik:</strong> orbit_distance wird zur Gesamtdistanz addiert</li>
                    <li><strong>Multiple Asteroideng√ºrtel:</strong> Beliebig viele G√ºrtel mit verschiedenen Radien m√∂glich</li>
                    <li><strong>change_orbit:</strong> Verschiebt die aktuelle Umlaufbahn f√ºr nachfolgende Planeten</li>
                    <li><strong>Automatische Fallbacks:</strong> Mod-Planeten funktionieren auch ohne installierte Mods</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        // Enhanced data model with neighbor systems and mod support
        let solarSystem = {
            name: 'my_custom_system',
            displayName: 'Mein Sonnensystem',
            class: 'sc_g',
            usage: 'custom_empire',
            neighborSystems: [], // Array of neighbor systems
            asteroidBelts: [], // Array of multiple asteroid belts
            planets: [] // Sequential array of planets with cumulative orbit distances
        };

        let selectedPlanet = null;
        let nextCelestialId = 1;
        let visualizerScale = 0.3;

        // DOM Elements
        const elements = {
            // Import elements
            importFile: document.getElementById('importFile'),
            importBtn: document.getElementById('importBtn'),
            clearSystemBtn: document.getElementById('clearSystemBtn'),
            
            // Neighbor systems elements
            neighborSystemsList: document.getElementById('neighborSystemsList'),
            newNeighborDistance: document.getElementById('newNeighborDistance'),
            newNeighborInit: document.getElementById('newNeighborInit'),
            addNeighborBtn: document.getElementById('addNeighborBtn'),
            
            // Existing elements
            systemName: document.getElementById('systemName'),
            systemDisplayName: document.getElementById('systemDisplayName'),
            systemClass: document.getElementById('systemClass'),
            systemUsage: document.getElementById('systemUsage'),
            asteroidBeltList: document.getElementById('asteroidBeltList'),
            newAsteroidBeltType: document.getElementById('newAsteroidBeltType'),
            newAsteroidBeltRadius: document.getElementById('newAsteroidBeltRadius'),
            addAsteroidBeltBtn: document.getElementById('addAsteroidBeltBtn'),
            addPlanetBtn: document.getElementById('addPlanetBtn'),
            moveUpBtn: document.getElementById('moveUpBtn'),
            moveDownBtn: document.getElementById('moveDownBtn'),
            planetList: document.getElementById('planetList'),
            celestialDetails: document.getElementById('celestialDetails'),
            noCelestialSelected: document.getElementById('noCelestialSelected'),
            celestialType: document.getElementById('celestialType'),
            celestialPosition: document.getElementById('celestialPosition'),
            celestialName: document.getElementById('celestialName'),
            celestialDisplayName: document.getElementById('celestialDisplayName'),
            celestialClass: document.getElementById('celestialClass'),
            celestialSize: document.getElementById('celestialSize'),
            celestialOrbitDistance: document.getElementById('celestialOrbitDistance'),
            orbitAngleType: document.getElementById('orbitAngleType'),
            celestialOrbitAngle: document.getElementById('celestialOrbitAngle'),
            celestialOrbitAngleMin: document.getElementById('celestialOrbitAngleMin'),
            celestialOrbitAngleMax: document.getElementById('celestialOrbitAngleMax'),
            celestialChangeOrbit: document.getElementById('celestialChangeOrbit'),
            celestialHasRing: document.getElementById('celestialHasRing'),
            celestialIsStartingPlanet: document.getElementById('celestialIsStartingPlanet'),
            addMoonBtn: document.getElementById('addMoonBtn'),
            deleteCelestialBtn: document.getElementById('deleteCelestialBtn'),
            fixedAngleControl: document.getElementById('fixedAngleControl'),
            rangeAngleControl: document.getElementById('rangeAngleControl'),
            visualizer: document.getElementById('visualizer'),
            zoomInBtn: document.getElementById('zoomInBtn'),
            zoomOutBtn: document.getElementById('zoomOutBtn'),
            resetViewBtn: document.getElementById('resetViewBtn'),
            exportTxt: document.getElementById('exportTxt'),
            exportYml: document.getElementById('exportYml'),
            downloadTxtBtn: document.getElementById('downloadTxtBtn'),
            downloadYmlBtn: document.getElementById('downloadYmlBtn')
        };

        // Stellaris System Parser
        class StellarisSystemParser {
            parse(content) {
                try {
                    // Clean content and find system block
                    const lines = content.split('\n').map(line => line.trim());
                    const systemData = {
                        name: '',
                        displayName: '',
                        class: 'sc_g',
                        usage: '',
                        neighborSystems: [],
                        asteroidBelts: [],
                        planets: []
                    };

                    // Find system definition
                    const systemMatch = content.match(/(\w+)\s*=\s*{/);
                    if (systemMatch) {
                        systemData.name = systemMatch[1];
                    }

                    // Parse basic properties
                    const nameMatch = content.match(/name\s*=\s*"([^"]+)"/);
                    if (nameMatch) systemData.displayName = nameMatch[1];

                    const classMatch = content.match(/class\s*=\s*"?([^"\s]+)"?/);
                    if (classMatch) systemData.class = classMatch[1];

                    const usageMatch = content.match(/usage\s*=\s*(\w+)/);
                    if (usageMatch) systemData.usage = usageMatch[1];

                    // Parse neighbor systems
                    const neighborMatches = content.matchAll(/neighbor_system\s*=\s*{([^}]+)}/g);
                    for (const match of neighborMatches) {
                        const neighborBlock = match[1];
                        const neighbor = {
                            distance: 100,
                            initializer: ''
                        };

                        const distanceMatch = neighborBlock.match(/distance\s*=\s*(\d+)/);
                        if (distanceMatch) neighbor.distance = parseInt(distanceMatch[1]);

                        const initMatch = neighborBlock.match(/initializer\s*=\s*"?([^"\s]+)"?/);
                        if (initMatch) neighbor.initializer = initMatch[1];

                        systemData.neighborSystems.push(neighbor);
                    }

                    // Parse asteroid belts
                    const asteroidBeltMatches = content.matchAll(/asteroid_belt\s*=\s*{([^}]+)}/g);
                    for (const match of asteroidBeltMatches) {
                        const beltBlock = match[1];
                        const belt = {
                            type: 'rocky_asteroid_belt',
                            radius: 575
                        };

                        const typeMatch = beltBlock.match(/type\s*=\s*(\w+)/);
                        if (typeMatch) belt.type = typeMatch[1];

                        const radiusMatch = beltBlock.match(/radius\s*=\s*(\d+)/);
                        if (radiusMatch) belt.radius = parseInt(radiusMatch[1]);

                        systemData.asteroidBelts.push(belt);
                    }

                    // Parse planets (simplified for demonstration)
                    const planetBlocks = this.extractPlanetBlocks(content);
                    let planetId = 1;
                    
                    planetBlocks.forEach((block, index) => {
                        if (index === 0) return; // Skip star
                        
                        const planet = this.parsePlanetBlock(block, planetId++);
                        if (planet) {
                            systemData.planets.push(planet);
                        }
                    });

                    return systemData;
                } catch (error) {
                    console.error('Parse error:', error);
                    throw new Error('Fehler beim Parsen der Systemdatei: ' + error.message);
                }
            }

            extractPlanetBlocks(content) {
                const blocks = [];
                let depth = 0;
                let currentBlock = '';
                let inPlanet = false;

                const lines = content.split('\n');
                for (const line of lines) {
                    if (line.includes('planet = {')) {
                        inPlanet = true;
                        depth = 1;
                        currentBlock = line + '\n';
                    } else if (inPlanet) {
                        currentBlock += line + '\n';
                        if (line.includes('{')) depth++;
                        if (line.includes('}')) depth--;
                        
                        if (depth === 0) {
                            blocks.push(currentBlock);
                            inPlanet = false;
                            currentBlock = '';
                        }
                    }
                }

                return blocks;
            }

            parsePlanetBlock(block, id) {
                const planet = {
                    id: id,
                    type: 'planet',
                    name: `planet_${id}`,
                    displayName: `Planet ${id}`,
                    class: 'pc_barren',
                    size: 16,
                    orbitDistance: 0,
                    orbitAngleType: 'range',
                    orbitAngleMin: 90,
                    orbitAngleMax: 270,
                    changeOrbit: 0,
                    hasRing: false,
                    isStartingPlanet: false,
                    moons: []
                };

                // Parse planet properties
                const nameMatch = block.match(/name\s*=\s*"([^"]+)"/);
                if (nameMatch) {
                    planet.name = nameMatch[1];
                    planet.displayName = nameMatch[1].replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                }

                const classMatch = block.match(/class\s*=\s*"?([^"\s]+)"?/);
                if (classMatch) planet.class = classMatch[1];

                const sizeMatch = block.match(/size\s*=\s*(\d+)/);
                if (sizeMatch) planet.size = parseInt(sizeMatch[1]);

                const orbitDistanceMatch = block.match(/orbit_distance\s*=\s*(\d+)/);
                if (orbitDistanceMatch) planet.orbitDistance = parseInt(orbitDistanceMatch[1]);

                const changeOrbitMatch = block.match(/change_orbit\s*=\s*(\d+)/);
                if (changeOrbitMatch) planet.changeOrbit = parseInt(changeOrbitMatch[1]);

                const hasRingMatch = block.match(/has_ring\s*=\s*yes/);
                planet.hasRing = !!hasRingMatch;

                const startingPlanetMatch = block.match(/starting_planet\s*=\s*yes/);
                planet.isStartingPlanet = !!startingPlanetMatch;

                // Parse orbit angle
                const angleRangeMatch = block.match(/orbit_angle\s*=\s*{\s*min\s*=\s*(\d+)\s*max\s*=\s*(\d+)\s*}/);
                if (angleRangeMatch) {
                    planet.orbitAngleType = 'range';
                    planet.orbitAngleMin = parseInt(angleRangeMatch[1]);
                    planet.orbitAngleMax = parseInt(angleRangeMatch[2]);
                } else {
                    const angleMatch = block.match(/orbit_angle\s*=\s*(\d+)/);
                    if (angleMatch) {
                        planet.orbitAngleType = 'fixed';
                        planet.orbitAngle = parseInt(angleMatch[1]);
                    }
                }

                return planet;
            }
        }

        // Import/Export Functions
        function importSystem() {
            const file = elements.importFile.files[0];
            if (!file) {
                showNotification('Bitte w√§hlen Sie eine Datei aus.');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const parser = new StellarisSystemParser();
                    const parsedSystem = parser.parse(e.target.result);
                    
                    // Load parsed data into the editor
                    loadSystemData(parsedSystem);
                    showNotification('System erfolgreich importiert!');
                } catch (error) {
                    showNotification('Fehler beim Import: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        function loadSystemData(systemData) {
            // Clear existing data
            clearSystem();
            
            // Load basic properties
            solarSystem.name = systemData.name;
            solarSystem.displayName = systemData.displayName;
            solarSystem.class = systemData.class;
            solarSystem.usage = systemData.usage;

            elements.systemName.value = solarSystem.name;
            elements.systemDisplayName.value = solarSystem.displayName;
            elements.systemClass.value = solarSystem.class;
            elements.systemUsage.value = solarSystem.usage;

            // Load neighbor systems
            systemData.neighborSystems.forEach(neighbor => {
                solarSystem.neighborSystems.push({
                    id: Date.now() + Math.random(),
                    distance: neighbor.distance,
                    initializer: neighbor.initializer
                });
            });

            // Load asteroid belts
            systemData.asteroidBelts.forEach(belt => {
                solarSystem.asteroidBelts.push({
                    id: Date.now() + Math.random(),
                    type: belt.type,
                    radius: belt.radius
                });
            });

            // Load planets
            systemData.planets.forEach(planet => {
                nextCelestialId = Math.max(nextCelestialId, planet.id + 1);
                solarSystem.planets.push(planet);
            });

            // Update UI
            updateNeighborSystemsList();
            updateAsteroidBeltList();
            updatePlanetList();
            updateOutput();
            renderVisualizer();
        }

        function clearSystem() {
            solarSystem = {
                name: 'my_custom_system',
                displayName: 'Mein Sonnensystem',
                class: 'sc_g',
                usage: 'custom_empire',
                neighborSystems: [],
                asteroidBelts: [],
                planets: []
            };
            
            selectedPlanet = null;
            nextCelestialId = 1;
            
            // Reset UI
            elements.systemName.value = solarSystem.name;
            elements.systemDisplayName.value = solarSystem.displayName;
            elements.systemClass.value = solarSystem.class;
            elements.systemUsage.value = solarSystem.usage;
            
            updateNeighborSystemsList();
            updateAsteroidBeltList();
            updatePlanetList();
            updateOutput();
            renderVisualizer();
            deselectPlanet();
            
            showNotification('System geleert!');
        }

        // Neighbor Systems Management
        function addNeighborSystem() {
            const newNeighbor = {
                id: Date.now(),
                distance: parseInt(elements.newNeighborDistance.value) || 100,
                initializer: elements.newNeighborInit.value
            };
            
            solarSystem.neighborSystems.push(newNeighbor);
            updateNeighborSystemsList();
            updateOutput();
            renderVisualizer();
        }

        function updateNeighborSystemsList() {
            elements.neighborSystemsList.innerHTML = '';
            
            if (solarSystem.neighborSystems.length === 0) {
                elements.neighborSystemsList.innerHTML = '<p class="text-gray-400 text-sm">Keine Nachbarsysteme definiert</p>';
                return;
            }

            solarSystem.neighborSystems.forEach((neighbor, index) => {
                const neighborItem = document.createElement('div');
                neighborItem.className = 'neighbor-item';
                neighborItem.innerHTML = `
                    <span class="text-sm">
                        üåå Distanz: ${neighbor.distance} | System: ${neighbor.initializer || 'Zuf√§llig'}
                    </span>
                    <button class="stellaris-btn stellaris-btn-danger text-xs px-2 py-1" onclick="removeNeighborSystem(${neighbor.id})">
                        L√∂schen
                    </button>
                `;
                elements.neighborSystemsList.appendChild(neighborItem);
            });
        }

        function removeNeighborSystem(neighborId) {
            solarSystem.neighborSystems = solarSystem.neighborSystems.filter(n => n.id !== neighborId);
            updateNeighborSystemsList();
            updateOutput();
            renderVisualizer();
        }

        // Event Listeners
        function initializeEventListeners() {
            // Import/Export listeners
            elements.importBtn.addEventListener('click', importSystem);
            elements.clearSystemBtn.addEventListener('click', clearSystem);
            
            // Neighbor systems listeners
            elements.addNeighborBtn.addEventListener('click', addNeighborSystem);
            
            // Existing listeners
            elements.systemName.addEventListener('input', (e) => {
                const value = e.target.value.replace(/[^a-zA-Z0-9_]/g, '');
                e.target.value = value;
                solarSystem.name = value || 'my_custom_system';
                updateOutput();
            });

            elements.systemDisplayName.addEventListener('input', (e) => {
                solarSystem.displayName = e.target.value || 'Unbenanntes System';
                updateOutput();
            });

            elements.systemClass.addEventListener('change', (e) => {
                solarSystem.class = e.target.value;
                updateOutput();
                renderVisualizer();
            });

            elements.systemUsage.addEventListener('change', (e) => {
                solarSystem.usage = e.target.value;
                updateOutput();
            });

            elements.addAsteroidBeltBtn.addEventListener('click', addAsteroidBelt);

            elements.addPlanetBtn.addEventListener('click', addPlanet);
            elements.moveUpBtn.addEventListener('click', movePlanetUp);
            elements.moveDownBtn.addEventListener('click', movePlanetDown);

            elements.orbitAngleType.addEventListener('change', (e) => {
                const isRange = e.target.value === 'range';
                elements.fixedAngleControl.classList.toggle('hidden', isRange);
                elements.rangeAngleControl.classList.toggle('hidden', !isRange);
                if (selectedPlanet) {
                    selectedPlanet.orbitAngleType = e.target.value;
                    updateOutput();
                }
            });

            // Planet property updates
            elements.celestialName.addEventListener('input', updateSelectedPlanetProperty('name'));
            elements.celestialDisplayName.addEventListener('input', updateSelectedPlanetProperty('displayName'));
            elements.celestialClass.addEventListener('change', updateSelectedPlanetProperty('class'));
            elements.celestialSize.addEventListener('input', (e) => {
                if (selectedPlanet) {
                    selectedPlanet.size = Math.max(1, Math.min(50, parseInt(e.target.value) || 1));
                    e.target.value = selectedPlanet.size;
                    updateAsteroidBeltList();
                    updatePlanetList();
                    updateOutput();
                    renderVisualizer();
                }
            });
            elements.celestialOrbitDistance.addEventListener('input', (e) => {
                if (selectedPlanet) {
                    selectedPlanet.orbitDistance = Math.max(0, parseInt(e.target.value) || 0);
                    e.target.value = selectedPlanet.orbitDistance;
                    updatePlanetList();
                    updateOutput();
                    renderVisualizer();
                }
            });
            elements.celestialOrbitAngle.addEventListener('input', (e) => {
                if (selectedPlanet) {
                    selectedPlanet.orbitAngle = Math.max(0, Math.min(360, parseInt(e.target.value) || 0));
                    e.target.value = selectedPlanet.orbitAngle;
                    updateOutput();
                    renderVisualizer();
                }
            });
            elements.celestialOrbitAngleMin.addEventListener('input', (e) => {
                if (selectedPlanet) {
                    selectedPlanet.orbitAngleMin = Math.max(0, Math.min(360, parseInt(e.target.value) || 0));
                    e.target.value = selectedPlanet.orbitAngleMin;
                    updateOutput();
                    renderVisualizer();
                }
            });
            elements.celestialOrbitAngleMax.addEventListener('input', (e) => {
                if (selectedPlanet) {
                    selectedPlanet.orbitAngleMax = Math.max(0, Math.min(360, parseInt(e.target.value) || 0));
                    e.target.value = selectedPlanet.orbitAngleMax;
                    updateOutput();
                    renderVisualizer();
                }
            });
            elements.celestialChangeOrbit.addEventListener('input', (e) => {
                if (selectedPlanet) {
                    selectedPlanet.changeOrbit = Math.max(0, parseInt(e.target.value) || 0);
                    e.target.value = selectedPlanet.changeOrbit;
                    updateOutput();
                }
            });
            elements.celestialHasRing.addEventListener('change', (e) => {
                if (selectedPlanet) {
                    selectedPlanet.hasRing = e.target.checked;
                    updateOutput();
                }
            });
            elements.celestialIsStartingPlanet.addEventListener('change', (e) => {
                if (selectedPlanet) {
                    selectedPlanet.isStartingPlanet = e.target.checked;
                    updateOutput();
                }
            });

            elements.addMoonBtn.addEventListener('click', addMoonToSelectedPlanet);
            elements.deleteCelestialBtn.addEventListener('click', deleteSelectedPlanet);

            // Visualizer controls
            elements.zoomInBtn.addEventListener('click', () => {
                visualizerScale = Math.min(1.0, visualizerScale * 1.2);
                renderVisualizer();
            });
            elements.zoomOutBtn.addEventListener('click', () => {
                visualizerScale = Math.max(0.1, visualizerScale * 0.8);
                renderVisualizer();
            });
            elements.resetViewBtn.addEventListener('click', () => {
                visualizerScale = 0.3;
                renderVisualizer();
            });

            // Export buttons
            elements.downloadTxtBtn.addEventListener('click', () => 
                downloadFile(elements.exportTxt.value, `${solarSystem.name}.txt`, 'text/plain'));
            elements.downloadYmlBtn.addEventListener('click', () => {
                const bom = '\ufeff';
                downloadFile(bom + elements.exportYml.value, `${solarSystem.name}_l_german.yml`, 'text/plain;charset=utf-8');
            });
        }

        function updateSelectedPlanetProperty(property) {
            return (e) => {
                if (selectedPlanet) {
                    selectedPlanet[property] = e.target.value;
                    updatePlanetList();
                    updateOutput();
                    renderVisualizer();
                }
            };
        }

        // Asteroid Belt Management
        function addAsteroidBelt() {
            const newBelt = {
                id: Date.now(), // Simple unique ID
                type: elements.newAsteroidBeltType.value,
                radius: parseInt(elements.newAsteroidBeltRadius.value) || 575
            };
            
            solarSystem.asteroidBelts.push(newBelt);
            updateAsteroidBeltList();
            updateOutput();
            renderVisualizer();
        }

        function updateAsteroidBeltList() {
            elements.asteroidBeltList.innerHTML = '';
            
            if (solarSystem.asteroidBelts.length === 0) {
                elements.asteroidBeltList.innerHTML = '<p class="text-gray-400 text-sm">Keine Asteroideng√ºrtel definiert</p>';
                return;
            }

            solarSystem.asteroidBelts.forEach((belt, index) => {
                const beltItem = document.createElement('div');
                beltItem.className = 'flex items-center justify-between bg-gray-700 p-2 rounded';
                beltItem.innerHTML = `
                    <span class="text-sm">
                        ‚òÑÔ∏è ${getAsteroidBeltTypeName(belt.type)} (Radius: ${belt.radius})
                    </span>
                    <button class="stellaris-btn stellaris-btn-danger text-xs px-2 py-1" onclick="removeAsteroidBelt(${belt.id})">
                        L√∂schen
                    </button>
                `;
                elements.asteroidBeltList.appendChild(beltItem);
            });
        }

        function removeAsteroidBelt(beltId) {
            solarSystem.asteroidBelts = solarSystem.asteroidBelts.filter(belt => belt.id !== beltId);
            updateAsteroidBeltList();
            updateOutput();
            renderVisualizer();
        }

        function getAsteroidBeltTypeName(type) {
            const names = {
                'rocky_asteroid_belt': 'Felsiger Asteroideng√ºrtel',
                'icy_asteroid_belt': 'Eisiger Asteroideng√ºrtel',
                'crystalline_asteroid_belt': 'Kristalliner Asteroideng√ºrtel'
            };
            return names[type] || type;
        }

        // Cumulative Orbit Calculation
        function calculateCumulativeOrbitDistances() {
            const result = [];
            let currentDistance = 0;
            
            solarSystem.planets.forEach((planet, index) => {
                if (planet.orbitDistance === 0 && index === 0) {
                    // First planet with 0 distance gets default
                    currentDistance = 40;
                } else if (planet.orbitDistance > 0) {
                    // Add to cumulative distance
                    currentDistance += planet.orbitDistance;
                }
                // If orbitDistance === 0 and not first planet, keep currentDistance
                
                result.push({
                    planet: planet,
                    actualDistance: currentDistance,
                    isNewOrbit: planet.orbitDistance > 0 || index === 0
                });
                
                // Apply change_orbit for next planet
                if (planet.changeOrbit > 0) {
                    currentDistance += planet.changeOrbit;
                }
            });
            
            return result;
        }

        function addPlanet() {
            const newPlanet = {
                id: nextCelestialId++,
                type: 'planet',
                name: `planet_${nextCelestialId - 1}`,
                displayName: `Planet ${nextCelestialId - 1}`,
                class: 'pc_barren',
                size: 16,
                orbitDistance: solarSystem.planets.length === 0 ? 40 : 0, // First planet gets distance, others default to 0
                orbitAngleType: 'range',
                orbitAngleMin: 90,
                orbitAngleMax: 270,
                changeOrbit: 0,
                hasRing: false,
                isStartingPlanet: false,
                moons: []
            };

            solarSystem.planets.push(newPlanet);
            updatePlanetList();
            selectPlanet(newPlanet.id);
            updateOutput();
            renderVisualizer();
        }

        function movePlanetUp() {
            if (!selectedPlanet) return;
            
            const index = solarSystem.planets.findIndex(p => p.id === selectedPlanet.id);
            if (index > 0) {
                [solarSystem.planets[index], solarSystem.planets[index - 1]] = 
                [solarSystem.planets[index - 1], solarSystem.planets[index]];
                updatePlanetList();
                updateOutput();
                renderVisualizer();
            }
        }

        function movePlanetDown() {
            if (!selectedPlanet) return;
            
            const index = solarSystem.planets.findIndex(p => p.id === selectedPlanet.id);
            if (index < solarSystem.planets.length - 1) {
                [solarSystem.planets[index], solarSystem.planets[index + 1]] = 
                [solarSystem.planets[index + 1], solarSystem.planets[index]];
                updatePlanetList();
                updateOutput();
                renderVisualizer();
            }
        }

        function addMoonToSelectedPlanet() {
            if (!selectedPlanet || selectedPlanet.type !== 'planet') {
                showNotification('Bitte w√§hlen Sie zuerst einen Planeten aus.');
                return;
            }

            const newMoon = {
                id: nextCelestialId++,
                type: 'moon',
                name: `moon_${nextCelestialId - 1}`,
                displayName: `Mond ${nextCelestialId - 1}`,
                class: 'pc_barren',
                size: 8,
                orbitDistance: 12,
                orbitAngleType: 'range',
                orbitAngleMin: 90,
                orbitAngleMax: 270,
                hasRing: false,
                parentId: selectedPlanet.id
            };

            selectedPlanet.moons.push(newMoon);
            updatePlanetList();
            updateOutput();
            renderVisualizer();
        }

        // UI Updates
        function updatePlanetList() {
            elements.planetList.innerHTML = '';
            
            if (solarSystem.planets.length === 0) {
                elements.planetList.innerHTML = '<p class="text-gray-400">F√ºgen Sie Planeten hinzu, um mit dem Systembau zu beginnen.</p>';
                return;
            }

            const cumulativeOrbits = calculateCumulativeOrbitDistances();

            cumulativeOrbits.forEach((orbitData, index) => {
                const planet = orbitData.planet;
                const actualDistance = orbitData.actualDistance;
                const isNewOrbit = orbitData.isNewOrbit;
                
                const planetItem = createPlanetListItem(planet, index, isNewOrbit, false, actualDistance);
                elements.planetList.appendChild(planetItem);

                if (planet.moons && planet.moons.length > 0) {
                    planet.moons.forEach(moon => {
                        const moonItem = createPlanetListItem(moon, -1, false, true, 0);
                        elements.planetList.appendChild(moonItem);
                    });
                }
            });
        }

        function createPlanetListItem(celestial, index, isNewOrbit = false, isMoon = false, actualDistance = 0) {
            const item = document.createElement('div');
            item.className = `celestial-item ${selectedPlanet && selectedPlanet.id === celestial.id ? 'selected' : ''} ${isNewOrbit ? 'new-orbit' : 'same-orbit'} ${isMoon ? 'ml-6' : ''}`;
            item.dataset.id = celestial.id;
            
            const icon = getPlanetIcon(celestial.class);
            const typeText = isMoon ? 'Mond' : 'Planet';
            
            let orbitInfo = '';
            if (!isMoon) {
                if (isNewOrbit) {
                    orbitInfo = `üü° +${celestial.orbitDistance} ‚Üí Gesamt: ${actualDistance}`;
                } else {
                    orbitInfo = `‚ö™ +0 ‚Üí Gleiche Umlaufbahn (${actualDistance})`;
                }
            }
            
            item.innerHTML = `
                <div class="flex items-center">
                    <span class="text-2xl mr-2">${icon}</span>
                    <div>
                        <div class="font-medium">${isMoon ? '‚Ü≥ ' : `${index + 1}. `}${celestial.displayName}</div>
                        <div class="text-sm text-gray-400">${getClassDisplayName(celestial.class)} ‚Ä¢ Gr√∂√üe ${celestial.size}</div>
                        ${orbitInfo ? `<div class="text-xs text-blue-300">${orbitInfo}</div>` : ''}
                    </div>
                </div>
                <button class="stellaris-btn stellaris-btn-secondary text-sm px-2 py-1" onclick="selectPlanet(${celestial.id})">
                    Ausw√§hlen
                </button>
            `;
            
            item.addEventListener('click', (e) => {
                if (e.target.tagName !== 'BUTTON') {
                    selectPlanet(celestial.id);
                }
            });
            
            return item;
        }

        function selectPlanet(id) {
            selectedPlanet = findPlanetById(id);
            if (selectedPlanet) {
                elements.celestialDetails.classList.remove('hidden');
                elements.noCelestialSelected.classList.add('hidden');

                const planetIndex = solarSystem.planets.findIndex(p => p.id === selectedPlanet.id);
                
                // Populate details panel
                elements.celestialType.value = selectedPlanet.type === 'planet' ? 'Planet' : 'Mond';
                elements.celestialPosition.value = selectedPlanet.type === 'planet' ? 
                    `Position ${planetIndex + 1}` : `Mond von ${findParentPlanet(selectedPlanet).displayName}`;
                elements.celestialName.value = selectedPlanet.name;
                elements.celestialDisplayName.value = selectedPlanet.displayName;
                elements.celestialClass.value = selectedPlanet.class;
                elements.celestialSize.value = selectedPlanet.size;
                elements.celestialOrbitDistance.value = selectedPlanet.orbitDistance;
                elements.orbitAngleType.value = selectedPlanet.orbitAngleType || 'range';
                elements.celestialOrbitAngle.value = selectedPlanet.orbitAngle || 0;
                elements.celestialOrbitAngleMin.value = selectedPlanet.orbitAngleMin || 90;
                elements.celestialOrbitAngleMax.value = selectedPlanet.orbitAngleMax || 270;
                elements.celestialChangeOrbit.value = selectedPlanet.changeOrbit || 0;
                elements.celestialHasRing.checked = selectedPlanet.hasRing || false;
                elements.celestialIsStartingPlanet.checked = selectedPlanet.isStartingPlanet || false;

                // Toggle angle controls
                const isRange = selectedPlanet.orbitAngleType === 'range';
                elements.fixedAngleControl.classList.toggle('hidden', isRange);
                elements.rangeAngleControl.classList.toggle('hidden', !isRange);

                // Enable/disable buttons based on selection
                elements.addMoonBtn.disabled = selectedPlanet.type !== 'planet';
                elements.moveUpBtn.disabled = planetIndex <= 0 || selectedPlanet.type === 'moon';
                elements.moveDownBtn.disabled = planetIndex >= solarSystem.planets.length - 1 || selectedPlanet.type === 'moon';

                updatePlanetList();
            } else {
                deselectPlanet();
            }
        }

        function deselectPlanet() {
            selectedPlanet = null;
            elements.celestialDetails.classList.add('hidden');
            elements.noCelestialSelected.classList.remove('hidden');
            elements.addMoonBtn.disabled = true;
            elements.moveUpBtn.disabled = true;
            elements.moveDownBtn.disabled = true;
            updatePlanetList();
        }

        function findPlanetById(id) {
            for (const planet of solarSystem.planets) {
                if (planet.id === id) return planet;
                if (planet.moons) {
                    for (const moon of planet.moons) {
                        if (moon.id === id) return moon;
                    }
                }
            }
            return null;
        }

        function findParentPlanet(moon) {
            for (const planet of solarSystem.planets) {
                if (planet.moons && planet.moons.some(m => m.id === moon.id)) {
                    return planet;
                }
            }
            return null;
        }

        function deleteSelectedPlanet() {
            if (!selectedPlanet) return;

            if (selectedPlanet.type === 'planet') {
                solarSystem.planets = solarSystem.planets.filter(p => p.id !== selectedPlanet.id);
            } else if (selectedPlanet.type === 'moon') {
                const parentPlanet = findParentPlanet(selectedPlanet);
                if (parentPlanet) {
                    parentPlanet.moons = parentPlanet.moons.filter(m => m.id !== selectedPlanet.id);
                }
            }

            deselectPlanet();
            updatePlanetList();
            updateOutput();
            renderVisualizer();
        }

        // Enhanced Visualization with neighbor systems
        function renderVisualizer() {
            elements.visualizer.innerHTML = '';

            const centerX = elements.visualizer.offsetWidth / 2;
            const centerY = elements.visualizer.offsetHeight / 2;

            // Draw the star
            const starSize = 30 * visualizerScale;
            const starEl = document.createElement('div');
            starEl.className = 'stellaris-star';
            starEl.style.width = `${starSize}px`;
            starEl.style.height = `${starSize}px`;
            starEl.style.left = `${centerX - starSize / 2}px`;
            starEl.style.top = `${centerY - starSize / 2}px`;
            starEl.style.borderRadius = '50%';
            starEl.style.position = 'absolute';
            elements.visualizer.appendChild(starEl);

            // Draw neighbor system indicators
            solarSystem.neighborSystems.forEach((neighbor, index) => {
                const angle = (index * 360 / solarSystem.neighborSystems.length) * Math.PI / 180;
                const distance = 200 * visualizerScale;
                const x = centerX + distance * Math.cos(angle);
                const y = centerY + distance * Math.sin(angle);

                // Draw connection line
                const line = document.createElement('div');
                line.style.position = 'absolute';
                line.style.width = `${distance}px`;
                line.style.height = '1px';
                line.style.background = 'rgba(153, 102, 255, 0.3)';
                line.style.left = `${centerX}px`;
                line.style.top = `${centerY}px`;
                line.style.transformOrigin = '0 0';
                line.style.transform = `rotate(${angle}rad)`;
                elements.visualizer.appendChild(line);

                // Draw neighbor system
                const neighborEl = document.createElement('div');
                neighborEl.style.position = 'absolute';
                neighborEl.style.width = '20px';
                neighborEl.style.height = '20px';
                neighborEl.style.left = `${x - 10}px`;
                neighborEl.style.top = `${y - 10}px`;
                neighborEl.style.background = 'linear-gradient(45deg, #9966ff, #6633cc)';
                neighborEl.style.borderRadius = '50%';
                neighborEl.style.border = '2px solid rgba(153, 102, 255, 0.5)';
                neighborEl.style.boxShadow = '0 0 10px rgba(153, 102, 255, 0.5)';
                neighborEl.title = neighbor.initializer || 'Random System';
                elements.visualizer.appendChild(neighborEl);
            });

            // Draw multiple asteroid belts
            solarSystem.asteroidBelts.forEach(belt => {
                const beltRadius = belt.radius * visualizerScale;
                const beltEl = document.createElement('div');
                beltEl.className = 'asteroid-belt';
                beltEl.style.width = `${beltRadius * 2}px`;
                beltEl.style.height = `${beltRadius * 2}px`;
                beltEl.style.left = `${centerX - beltRadius}px`;
                beltEl.style.top = `${centerY - beltRadius}px`;
                elements.visualizer.appendChild(beltEl);
            });

            // Calculate cumulative orbits and draw planets
            const cumulativeOrbits = calculateCumulativeOrbitDistances();
            const drawnOrbits = new Set();

            cumulativeOrbits.forEach((orbitData, index) => {
                const actualDistance = orbitData.actualDistance;
                const planet = orbitData.planet;
                
                // Draw orbit ring if we haven't drawn it yet
                const orbitRadius = actualDistance * visualizerScale;
                if (orbitRadius > starSize / 2 + 10 && !drawnOrbits.has(actualDistance)) {
                    drawnOrbits.add(actualDistance);
                    const orbitEl = document.createElement('div');
                    orbitEl.className = 'orbit-indicator';
                    orbitEl.style.width = `${orbitRadius * 2}px`;
                    orbitEl.style.height = `${orbitRadius * 2}px`;
                    orbitEl.style.left = `${centerX - orbitRadius}px`;
                    orbitEl.style.top = `${centerY - orbitRadius}px`;
                    elements.visualizer.appendChild(orbitEl);

                    // Add orbit distance label
                    const orbitLabel = document.createElement('div');
                    orbitLabel.className = 'orbit-number';
                    orbitLabel.textContent = actualDistance;
                    orbitLabel.style.left = `${centerX + orbitRadius - 20}px`;
                    orbitLabel.style.top = `${centerY - 10}px`;
                    elements.visualizer.appendChild(orbitLabel);
                }

                // Draw planet
                drawCelestial(planet, centerX, centerY, orbitRadius, index * 45);
            });
        }

        function drawCelestial(celestial, parentX, parentY, distance, baseAngle = 0) {
            let angle = baseAngle;
            if (celestial.orbitAngleType === 'fixed') {
                angle = celestial.orbitAngle || 0;
            } else {
                // For range, use middle of range for visualization
                const min = celestial.orbitAngleMin || 90;
                const max = celestial.orbitAngleMax || 270;
                angle = (min + max) / 2;
            }

            const angleRad = (angle * Math.PI) / 180;
            const x = parentX + distance * Math.cos(angleRad);
            const y = parentY + distance * Math.sin(angleRad);

            // Draw celestial body
            const size = Math.max(8, celestial.size * visualizerScale * 0.8);
            const bodyEl = document.createElement('div');
            bodyEl.className = celestial.type;
            bodyEl.style.width = `${size}px`;
            bodyEl.style.height = `${size}px`;
            bodyEl.style.left = `${x - size / 2}px`;
            bodyEl.style.top = `${y - size / 2}px`;
            bodyEl.style.background = getEnhancedColorForClass(celestial.class);
            bodyEl.style.position = 'absolute';
            bodyEl.style.borderRadius = '50%';
            bodyEl.style.display = 'flex';
            bodyEl.style.justifyContent = 'center';
            bodyEl.style.alignItems = 'center';
            bodyEl.style.fontSize = '0.7rem';
            bodyEl.style.fontWeight = '600';
            bodyEl.style.color = 'white';
            bodyEl.style.textShadow = '0 0 5px rgba(0,0,0,0.8)';
            bodyEl.style.cursor = 'pointer';
            bodyEl.textContent = celestial.displayName.substring(0, 3);
            
            bodyEl.addEventListener('click', () => selectPlanet(celestial.id));
            elements.visualizer.appendChild(bodyEl);

            // Draw ring system if present
            if (celestial.hasRing) {
                const ringEl = document.createElement('div');
                ringEl.style.position = 'absolute';
                ringEl.style.width = `${size * 1.8}px`;
                ringEl.style.height = `${size * 1.8}px`;
                ringEl.style.left = `${x - (size * 1.8) / 2}px`;
                ringEl.style.top = `${y - (size * 1.8) / 2}px`;
                ringEl.style.border = '2px solid rgba(255, 255, 255, 0.4)';
                ringEl.style.borderRadius = '50%';
                ringEl.style.pointerEvents = 'none';
                elements.visualizer.appendChild(ringEl);
            }

            // Draw moons
            if (celestial.moons && celestial.moons.length > 0) {
                celestial.moons.forEach((moon, moonIndex) => {
                    const moonDistance = moon.orbitDistance * visualizerScale;
                    drawCelestial(moon, x, y, moonDistance, moonIndex * 120);
                });
            }
        }

        // Helper function to determine mod requirements and fallback classes
        function getModInfo(planetClass) {
            const gigastructuralPlanets = {
                'pc_birch': { fallback: 'pc_gaia', mod: 'gigastructures' },
                'pc_alderson': { fallback: 'pc_habitat', mod: 'gigastructures' },
                'pc_gas_giant_habitable': { fallback: 'pc_gas_giant', mod: 'gigastructures' },
                'pc_stellar_systemcraft': { fallback: 'pc_habitat', mod: 'gigastructures' },
                'pc_nicoll_dyson_beam': { fallback: 'pc_barren', mod: 'gigastructures' },
                'pc_penrose_sphere_habitable': { fallback: 'pc_habitat', mod: 'gigastructures' },
                'pc_virtual_reality': { fallback: 'pc_machine', mod: 'gigastructures' },
                'pc_pouchkinn_planet': { fallback: 'pc_gaia', mod: 'gigastructures' },
                'pc_gigastructural_shielded': { fallback: 'pc_shielded', mod: 'gigastructures' }
            };

            const planetaryDiversityPlanets = {
                // Bereits aus Vanilla-Listen verschobene PD-Planeten
                'pc_barren_cold': { fallback: 'pc_barren', mod: 'planetary_diversity' },
                'pc_hothouse': { fallback: 'pc_molten', mod: 'planetary_diversity' },
                'pc_hot_gas_giant': { fallback: 'pc_gas_giant', mod: 'planetary_diversity' },
                'pc_cold_gas_giant': { fallback: 'pc_gas_giant', mod: 'planetary_diversity' },
                'pc_dwarf_gas_giant': { fallback: 'pc_gas_giant', mod: 'planetary_diversity' },
                'pc_storm': { fallback: 'pc_gas_giant', mod: 'planetary_diversity' },
                'pc_shattered': { fallback: 'pc_barren', mod: 'planetary_diversity' },
                'pc_subglacial': { fallback: 'pc_frozen', mod: 'planetary_diversity' },
                // Neue PD-Planeten
                'pc_mantle': { fallback: 'pc_molten', mod: 'planetary_diversity' },
                'pc_karst': { fallback: 'pc_continental', mod: 'planetary_diversity' },
                'pc_mushroom': { fallback: 'pc_continental', mod: 'planetary_diversity' },
                'pc_coral': { fallback: 'pc_ocean', mod: 'planetary_diversity' },
                'pc_crystal': { fallback: 'pc_frozen', mod: 'planetary_diversity' },
                'pc_frozen_desert': { fallback: 'pc_arctic', mod: 'planetary_diversity' },
                'pc_retinal': { fallback: 'pc_toxic', mod: 'planetary_diversity' },
                'pc_ash': { fallback: 'pc_barren', mod: 'planetary_diversity' },
                'pc_salt': { fallback: 'pc_desert', mod: 'planetary_diversity' },
                'pc_superhabitable': { fallback: 'pc_gaia', mod: 'planetary_diversity' },
                'pc_tidally_locked': { fallback: 'pc_barren', mod: 'planetary_diversity' },
                'pc_primal': { fallback: 'pc_continental', mod: 'planetary_diversity' },
                'pc_geothermal': { fallback: 'pc_molten', mod: 'planetary_diversity' },
                'pc_marginal': { fallback: 'pc_barren', mod: 'planetary_diversity' },
                'pc_fog': { fallback: 'pc_tundra', mod: 'planetary_diversity' },
                'pc_mud': { fallback: 'pc_continental', mod: 'planetary_diversity' },
                'pc_sandsea': { fallback: 'pc_desert', mod: 'planetary_diversity' },
                'pc_cascadian': { fallback: 'pc_alpine', mod: 'planetary_diversity' },
                'pc_technoorganic': { fallback: 'pc_machine', mod: 'planetary_diversity' }
            };

            if (gigastructuralPlanets[planetClass]) {
                return gigastructuralPlanets[planetClass];
            }
            if (planetaryDiversityPlanets[planetClass]) {
                return planetaryDiversityPlanets[planetClass];
            }
            return null;
        }

        // Enhanced Code Generation with neighbor systems and mod support
        function generateStellarisTxt() {
            let txt = `##### Generated by Stellaris Solar System Editor - Enhanced Version #####\n`;
            txt += `##### With correct orbit_distance = 0 mechanics, neighbor systems & mod support #####\n\n`;
            txt += `${solarSystem.name} = {\n`;
            txt += `\tname = "${solarSystem.displayName}"\n`;
            txt += `\tclass = "${solarSystem.class}"\n`;

            // Multiple asteroid belts
            solarSystem.asteroidBelts.forEach(belt => {
                txt += `\tasteroid_belt = {\n`;
                txt += `\t\ttype = ${belt.type}\n`;
                txt += `\t\tradius = ${belt.radius}\n`;
                txt += `\t}\n`;
            });

            if (solarSystem.usage) {
                txt += `\tusage = ${solarSystem.usage}\n`;
            }

            // Neighbor systems
            solarSystem.neighborSystems.forEach(neighbor => {
                txt += `\tneighbor_system = {\n`;
                txt += `\t\tdistance = ${neighbor.distance}\n`;
                if (neighbor.initializer) {
                    txt += `\t\tinitializer = "${neighbor.initializer}"\n`;
                }
                txt += `\t}\n`;
            });

            txt += `\tinit_effect = {\n`;
            
            // Add empire cluster effects if custom_empire
            if (solarSystem.usage === 'custom_empire') {
                txt += `\t\tevery_neighbor_system = {\n`;
                txt += `\t\t\tset_star_flag = empire_cluster\n`;
                txt += `\t\t\tevery_neighbor_system = {\n`;
                txt += `\t\t\t\tset_star_flag = empire_cluster\n`;
                txt += `\t\t\t}\n`;
                txt += `\t\t}\n`;
                txt += `\t\tgenerate_home_system_resources = yes\n`;
            }
            
            txt += `\t}\n\n`;

            // Generate star as first planet
            txt += `\tplanet = {\n`;
            txt += `\t\tname = "${solarSystem.displayName.toLowerCase().replace(/\s+/g, '_')}"\n`;
            txt += `\t\tclass = "${getStarClassForSystemClass(solarSystem.class)}"\n`;
            txt += `\t\torbit_distance = 0\n`;
            txt += `\t\torbit_angle = 1\n`;
            txt += `\t\tsize = 45\n`;
            txt += `\t\thas_ring = no\n`;
            txt += `\t}\n\n`;

            // Generate planets with CORRECT orbit logic and mod support
            solarSystem.planets.forEach(planet => {
                const modInfo = getModInfo(planet.class);
                const actualClass = modInfo ? modInfo.fallback : planet.class;

                txt += `\tplanet = {\n`;
                txt += `\t\tname = "${planet.name}"\n`;
                txt += `\t\tclass = "${actualClass}"\n`;
                txt += `\t\torbit_distance = ${planet.orbitDistance}\n`;
                
                // Handle orbit angle
                if (planet.orbitAngleType === 'range') {
                    txt += `\t\torbit_angle = { min = ${planet.orbitAngleMin} max = ${planet.orbitAngleMax} }\n`;
                } else {
                    txt += `\t\torbit_angle = ${planet.orbitAngle}\n`;
                }
                
                txt += `\t\tsize = ${planet.size}\n`;
                
                if (planet.changeOrbit > 0) {
                    txt += `\t\tchange_orbit = ${planet.changeOrbit}\n`;
                }
                
                txt += `\t\thas_ring = ${planet.hasRing ? 'yes' : 'no'}\n`;
                
                // Add mod-conditional init_effect for modded planet types
                let hasInitEffect = false;
                if (modInfo) {
                    txt += `\t\tinit_effect = {\n`;
                    hasInitEffect = true;
                    
                    if (modInfo.mod === 'gigastructures') {
                        txt += `\t\t\tif = {\n`;
                        txt += `\t\t\t\tlimit = { has_gigastructures = yes }\n`;
                        txt += `\t\t\t\tchange_pc = ${planet.class}\n`;
                        txt += `\t\t\t}\n`;
                    } else if (modInfo.mod === 'planetary_diversity') {
                        txt += `\t\t\tif = {\n`;
                        txt += `\t\t\t\tlimit = { has_planetary_diversity = yes }\n`;
                        txt += `\t\t\t\tchange_pc = ${planet.class}\n`;
                        txt += `\t\t\t}\n`;
                    }
                }
                
                if (planet.isStartingPlanet) {
                    if (!hasInitEffect) {
                        txt += `\t\tinit_effect = {\n`;
                        hasInitEffect = true;
                    }
                    txt += `\t\t\tprevent_anomaly = yes\n`;
                    txt += `\t\t\tgenerate_start_buildings_and_blockers = yes\n`;
                }
                
                if (hasInitEffect) {
                    txt += `\t\t}\n`;
                }
                
                if (planet.isStartingPlanet && !hasInitEffect) {
                    txt += `\t\tstarting_planet = yes\n`;
                    txt += `\t\ttile_blockers = none\n`;
                    txt += `\t\tmodifiers = none\n`;
                }

                // Generate moons
                if (planet.moons && planet.moons.length > 0) {
                    planet.moons.forEach(moon => {
                        const moonModInfo = getModInfo(moon.class);
                        const moonActualClass = moonModInfo ? moonModInfo.fallback : moon.class;

                        txt += `\t\tmoon = {\n`;
                        txt += `\t\t\tname = "${moon.name}"\n`;
                        txt += `\t\t\tclass = "${moonActualClass}"\n`;
                        txt += `\t\t\torbit_distance = ${moon.orbitDistance}\n`;
                        
                        if (moon.orbitAngleType === 'range') {
                            txt += `\t\t\torbit_angle = { min = ${moon.orbitAngleMin} max = ${moon.orbitAngleMax} }\n`;
                        } else {
                            txt += `\t\t\torbit_angle = ${moon.orbitAngle}\n`;
                        }
                        
                        txt += `\t\t\tsize = ${moon.size}\n`;
                        if (moon.hasRing) {
                            txt += `\t\t\thas_ring = yes\n`;
                        }
                        
                        // Add mod-conditional init_effect for modded moon types
                        if (moonModInfo) {
                            if (moonModInfo.useChangePC) {
                                txt += `\t\t\tinit_effect = {\n`;
                                
                                if (moonModInfo.mod === 'gigastructures') {
                                    txt += `\t\t\t\tif = {\n`;
                                    txt += `\t\t\t\t\tlimit = { has_gigastructures = yes }\n`;
                                    txt += `\t\t\t\t\tchange_pc = ${moon.class}\n`;
                                    txt += `\t\t\t\t}\n`;
                                } else if (moonModInfo.mod === 'planetary_diversity') {
                                    txt += `\t\t\t\tif = {\n`;
                                    txt += `\t\t\t\t\tlimit = { has_planetary_diversity = yes }\n`;
                                    txt += `\t\t\t\t\tchange_pc = ${moon.class}\n`;
                                    txt += `\t\t\t\t}\n`;
                                }
                                
                                txt += `\t\t\t}\n`;
                            } else {
                                // Modifier-based PD moon
                                txt += `\t\t\t# ${moonModInfo.comment} if Planetary Diversity is active\n`;
                            }
                        }
                        
                        txt += `\t\t}\n`;
                    });
                }

                txt += `\t}\n`;
            });

            txt += `}\n`;
            return txt;
        }

        function generateStellarisYml() {
            let yml = `l_german:\n`;
            yml += ` # Generated by Stellaris Solar System Editor - Enhanced Version\n`;
            yml += ` # System: ${solarSystem.displayName}\n\n`;
            yml += ` ${solarSystem.name}_NAME: "${solarSystem.displayName}"\n`;
            yml += ` ${solarSystem.name}_DESC: "Ein ma√ügeschneidertes Sonnensystem mit korrekter Stellaris-Orbit-Mechanik und Mod-Support."\n\n`;

            solarSystem.planets.forEach(planet => {
                yml += ` ${planet.name}_NAME: "${planet.displayName}"\n`;
                if (planet.moons && planet.moons.length > 0) {
                    planet.moons.forEach(moon => {
                        yml += ` ${moon.name}_NAME: "${moon.displayName}"\n`;
                    });
                }
            });

            return yml;
        }

        function getStarClassForSystemClass(systemClass) {
            const mapping = {
                'sc_b': 'pc_b_star',
                'sc_a': 'pc_a_star',
                'sc_f': 'pc_f_star',
                'sc_g': 'pc_g_star',
                'sc_k': 'pc_k_star',
                'sc_m': 'pc_m_star'
            };
            return mapping[systemClass] || 'pc_g_star';
        }

        // Helper functions
        function getPlanetIcon(planetClass) {
            const icons = {
                'pc_b_star': 'üíô', 'pc_a_star': '‚ö™', 'pc_f_star': 'üíõ', 'pc_g_star': '‚òâ', 'pc_k_star': 'üß°', 'pc_m_star': 'üî¥',
                'pc_continental': 'üåç', 'pc_ocean': 'üåä', 'pc_tropical': 'üå¥',
                'pc_arid': 'üèúÔ∏è', 'pc_desert': 'üèúÔ∏è', 'pc_savanna': 'üåæ',
                'pc_arctic': 'üßä', 'pc_tundra': '‚ùÑÔ∏è', 'pc_alpine': 'üèîÔ∏è',
                'pc_gaia': 'üåø', 'pc_barren': 'üåë', 'pc_barren_cold': '‚òÑÔ∏è', 'pc_frozen': '‚òÑÔ∏è',
                'pc_molten': 'üî•', 'pc_toxic': '‚ò¢Ô∏è', 'pc_hothouse': 'üî•',
                'pc_gas_giant': 'ü™ê', 'pc_hot_gas_giant': 'üî•', 'pc_cold_gas_giant': '‚ùÑÔ∏è', 'pc_dwarf_gas_giant': 'üåå',
                'pc_storm': '‚õàÔ∏è', 'pc_nuked': 'üí•', 'pc_shattered': 'üí•',
                'pc_asteroid': '‚òÑÔ∏è', 'pc_relic': 'üèõÔ∏è', 'pc_subglacial': 'üßä',
                'pc_habitat': 'üõ∞Ô∏è', 'pc_ecumenopolis': 'üèôÔ∏è', 'pc_machine': 'ü§ñ',
                'pc_hive': 'üêõ', 'pc_shielded': 'üõ°Ô∏è',
                // Gigastructural Engineers
                'pc_birch': 'üå≥', 'pc_alderson': 'üíø', 'pc_gas_giant_habitable': 'ü™ê', 
                'pc_stellar_systemcraft': 'üöÄ', 'pc_nicoll_dyson_beam': '‚ö°', 'pc_penrose_sphere_habitable': '‚ö´',
                'pc_virtual_reality': 'üíª', 'pc_pouchkinn_planet': 'üåü', 'pc_gigastructural_shielded': 'üõ°Ô∏è',
                // Planetary Diversity
                'pc_mantle': 'üåã', 'pc_karst': 'ü™®', 'pc_mushroom': 'üçÑ', 'pc_coral': 'ü™∏', 'pc_crystal': 'üíé',
                'pc_frozen_desert': 'üèîÔ∏è', 'pc_retinal': 'üëÅÔ∏è', 'pc_ash': 'üåã', 'pc_salt': 'üßÇ', 'pc_superhabitable': 'üå∫',
                'pc_tidally_locked': 'üåó', 'pc_primal': 'ü¶ï', 'pc_geothermal': '‚ô®Ô∏è', 'pc_marginal': 'üå´Ô∏è',
                'pc_fog': 'üå´Ô∏è', 'pc_mud': 'ü§é', 'pc_sandsea': 'üèñÔ∏è', 'pc_cascadian': 'üèûÔ∏è', 'pc_technoorganic': 'üî¨'
            };
            return icons[planetClass] || 'üåå';
        }

        function getClassDisplayName(planetClass) {
            const names = {
                'pc_b_star': 'B-Stern', 'pc_a_star': 'A-Stern', 'pc_f_star': 'F-Stern', 'pc_g_star': 'G-Stern', 'pc_k_star': 'K-Stern', 'pc_m_star': 'M-Stern',
                'pc_continental': 'Kontinental', 'pc_ocean': 'Ozean', 'pc_tropical': 'Tropisch',
                'pc_arid': 'Arid', 'pc_desert': 'W√ºste', 'pc_savanna': 'Savanne',
                'pc_arctic': 'Arktisch', 'pc_tundra': 'Tundra', 'pc_alpine': 'Alpin',
                'pc_gaia': 'Gaia', 'pc_barren': 'Karg', 'pc_barren_cold': 'Karg (Kalt)', 'pc_frozen': 'Gefroren',
                'pc_molten': 'Geschmolzen', 'pc_toxic': 'Toxisch', 'pc_hothouse': 'Treibhaus',
                'pc_gas_giant': 'Gasriese', 'pc_hot_gas_giant': 'Hei√üer Gasriese', 'pc_cold_gas_giant': 'Kalter Gasriese', 'pc_dwarf_gas_giant': 'Zwerg-Gasriese',
                'pc_storm': 'Sturm', 'pc_nuked': 'Verstrahlt', 'pc_shattered': 'Zerst√∂rt',
                'pc_asteroid': 'Asteroid', 'pc_relic': 'Relikt', 'pc_subglacial': 'Subglazial',
                'pc_habitat': 'Habitat', 'pc_ecumenopolis': '√ñkumenopolis', 'pc_machine': 'Maschine',
                'pc_hive': 'Schwarm', 'pc_shielded': 'Abgeschirmt',
                // Gigastructural Engineers
                'pc_birch': 'Birch-Welt', 'pc_alderson': 'Alderson-Scheibe', 'pc_gas_giant_habitable': 'Bewohnbarer Gasriese',
                'pc_stellar_systemcraft': 'Stellares Systemschiff', 'pc_nicoll_dyson_beam': 'Nicoll-Dyson-Strahl-Ziel',
                'pc_penrose_sphere_habitable': 'Penrose-Sph√§re Habitat', 'pc_virtual_reality': 'Virtual Reality Welt',
                'pc_pouchkinn_planet': 'Pouchkinn Planet', 'pc_gigastructural_shielded': 'Gigastruktureller Schild',
                // Planetary Diversity
                'pc_mantle': 'Mantel-Welt', 'pc_karst': 'Karst-Welt', 'pc_mushroom': 'Pilz-Welt', 'pc_coral': 'Korallen-Welt',
                'pc_crystal': 'Kristall-Welt', 'pc_frozen_desert': 'Gefrorene W√ºste', 'pc_retinal': 'Retinal-Welt',
                'pc_ash': 'Asche-Welt', 'pc_salt': 'Salz-Welt', 'pc_superhabitable': 'Superbewohnbar',
                'pc_tidally_locked': 'Gezeitengebunden', 'pc_primal': 'Urwelt', 'pc_geothermal': 'Geothermisch',
                'pc_marginal': 'Randwelt', 'pc_fog': 'Nebel-Welt', 'pc_mud': 'Schlamm-Welt',
                'pc_sandsea': 'Sandmeer-Welt', 'pc_cascadian': 'Kaskaden-Welt', 'pc_technoorganic': 'Techno-Organisch'
            };
            return names[planetClass] || planetClass;
        }

        function getEnhancedColorForClass(className) {
            const colors = {
                // Vanilla Stars
                'pc_b_star': 'linear-gradient(45deg, #4299e1, #3182ce)',
                'pc_a_star': 'linear-gradient(45deg, #f7fafc, #edf2f7)',
                'pc_f_star': 'linear-gradient(45deg, #faf089, #f6e05e)',
                'pc_g_star': 'linear-gradient(45deg, #f6e05e, #ecc94b)',
                'pc_k_star': 'linear-gradient(45deg, #ed8936, #dd6b20)',
                'pc_m_star': 'linear-gradient(45deg, #e53e3e, #c53030)',
                
                // Vanilla Habitable Worlds
                'pc_continental': 'linear-gradient(45deg, #38b2ac, #4299e1)',
                'pc_ocean': 'linear-gradient(45deg, #4299e1, #3182ce)',
                'pc_tropical': 'linear-gradient(45deg, #48bb78, #38a169)',
                'pc_arid': 'linear-gradient(45deg, #f6ad55, #ed8936)',
                'pc_desert': 'linear-gradient(45deg, #ecc94b, #d69e2e)',
                'pc_savanna': 'linear-gradient(45deg, #ed8936, #dd6b20)',
                'pc_arctic': 'linear-gradient(45deg, #a0aec0, #718096)',
                'pc_tundra': 'linear-gradient(45deg, #718096, #4a5568)',
                'pc_alpine': 'linear-gradient(45deg, #cbd5e0, #a0aec0)',
                'pc_gaia': 'linear-gradient(45deg, #68d391, #48bb78)',
                
                // Vanilla Uninhabitable Worlds
                'pc_barren': 'linear-gradient(45deg, #718096, #4a5568)',
                'pc_frozen': 'linear-gradient(45deg, #bee3f8, #90cdf4)',
                'pc_molten': 'linear-gradient(45deg, #e53e3e, #c53030)',
                'pc_toxic': 'linear-gradient(45deg, #805ad5, #6b46c1)',
                'pc_gas_giant': 'linear-gradient(45deg, #9f7aea, #805ad5)',
                'pc_nuked': 'linear-gradient(45deg, #a3bffa, #7c3aed)',
                'pc_asteroid': 'linear-gradient(45deg, #718096, #4a5568)',
                
                // Vanilla Special Worlds
                'pc_relic': 'linear-gradient(45deg, #d69e2e, #b7791f)',
                'pc_habitat': 'linear-gradient(45deg, #a0aec0, #718096)',
                'pc_ecumenopolis': 'linear-gradient(45deg, #fed7d7, #fc8181)',
                'pc_machine': 'linear-gradient(45deg, #4a5568, #2d3748)',
                'pc_hive': 'linear-gradient(45deg, #9f7aea, #805ad5)',
                'pc_shielded': 'linear-gradient(45deg, #e2e8f0, #cbd5e0)',
                
                // Gigastructural Engineers
                'pc_birch': 'linear-gradient(45deg, #276749, #38a169)',
                'pc_alderson': 'linear-gradient(45deg, #4a5568, #2d3748)',
                'pc_gas_giant_habitable': 'linear-gradient(45deg, #48bb78, #805ad5)',
                'pc_stellar_systemcraft': 'linear-gradient(45deg, #e2e8f0, #a0aec0)',
                'pc_nicoll_dyson_beam': 'linear-gradient(45deg, #f6e05e, #e53e3e)',
                'pc_penrose_sphere_habitable': 'linear-gradient(45deg, #2d3748, #1a202c)',
                'pc_virtual_reality': 'linear-gradient(45deg, #667eea, #764ba2)',
                'pc_pouchkinn_planet': 'linear-gradient(45deg, #f093fb, #f5576c)',
                'pc_gigastructural_shielded': 'linear-gradient(45deg, #4fd1c7, #06bfa5)',
                
                // PD Enhanced Uninhabitable
                'pc_barren_cold': 'linear-gradient(45deg, #a0aec0, #718096)',
                'pc_hothouse': 'linear-gradient(45deg, #e53e3e, #ed8936)',
                'pc_hot_gas_giant': 'linear-gradient(45deg, #e53e3e, #9f7aea)',
                'pc_cold_gas_giant': 'linear-gradient(45deg, #bee3f8, #9f7aea)',
                'pc_dwarf_gas_giant': 'linear-gradient(45deg, #805ad5, #553c9a)',
                'pc_shattered': 'linear-gradient(45deg, #4a5568, #2d3748)',
                'pc_subglacial': 'linear-gradient(45deg, #90cdf4, #4299e1)',
                'pc_storm': 'linear-gradient(45deg, #667eea, #5a67d8)',
                
                // PD Direct Planet Classes (Uncommon)
                'pc_superhabitable': 'linear-gradient(45deg, #68d391, #38b2ac)',
                'pc_tidally_locked': 'linear-gradient(45deg, #e53e3e, #c53030)',
                'pc_mantle': 'linear-gradient(45deg, #c53030, #e53e3e)',
                'pc_karst': 'linear-gradient(45deg, #a0aec0, #38b2ac)',
                'pc_crystal': 'linear-gradient(45deg, #9f7aea, #bee3f8)',
                'pc_frozen_desert': 'linear-gradient(45deg, #bee3f8, #ecc94b)',
                'pc_ash': 'linear-gradient(45deg, #4a5568, #718096)',
                'pc_marginal': 'linear-gradient(45deg, #718096, #4a5568)',
                'pc_sandsea': 'linear-gradient(45deg, #ecc94b, #f6ad55)',
                'pc_technoorganic': 'linear-gradient(45deg, #667eea, #4a5568)',
                
                // PD Wet Worlds (Modifier-based)
                'pd_retinal_world': 'linear-gradient(45deg, #fc8181, #e53e3e)',
                'pd_lake_world': 'linear-gradient(45deg, #4299e1, #3182ce)',
                'pd_tepid_world': 'linear-gradient(45deg, #90cdf4, #4299e1)',
                'pd_mushroom_world': 'linear-gradient(45deg, #805ad5, #38a169)',
                'pd_temperate_world': 'linear-gradient(45deg, #48bb78, #38a169)',
                'pd_sakura_world': 'linear-gradient(45deg, #f093fb, #e879f9)',
                'pd_forest_world': 'linear-gradient(45deg, #276749, #38a169)',
                'pd_megaflora_world': 'linear-gradient(45deg, #68d391, #38b2ac)',
                'pd_petrified_world': 'linear-gradient(45deg, #a0aec0, #718096)',
                'pd_cascadian_world': 'linear-gradient(45deg, #4299e1, #48bb78)',
                'pd_swamp_world': 'linear-gradient(45deg, #38a169, #2d5016)',
                'pd_crag_world': 'linear-gradient(45deg, #4a5568, #2d3748)',
                'pd_fog_world': 'linear-gradient(45deg, #cbd5e0, #a0aec0)',
                'pd_kelp_world': 'linear-gradient(45deg, #38a169, #4299e1)',
                'pd_algae_world': 'linear-gradient(45deg, #68d391, #4299e1)',
                'pd_reef_world': 'linear-gradient(45deg, #fc8181, #4299e1)',
                'pd_coral_world': 'linear-gradient(45deg, #fc8181, #4299e1)',
                'pd_archipelago_world': 'linear-gradient(45deg, #4299e1, #38a169)',
                'pd_atoll_world': 'linear-gradient(45deg, #f6e05e, #4299e1)',
                'pd_tepui_world': 'linear-gradient(45deg, #48bb78, #cbd5e0)',
                'pd_mangrove_world': 'linear-gradient(45deg, #38a169, #4299e1)',
                'pd_cenote_world': 'linear-gradient(45deg, #4299e1, #2d3748)',
                'pd_fungal_world': 'linear-gradient(45deg, #805ad5, #38a169)',
                'pd_aerial_world': 'linear-gradient(45deg, #cbd5e0, #48bb78)',
                'pd_lilypad_world': 'linear-gradient(45deg, #68d391, #4299e1)',
                'pd_geothermal_world': 'linear-gradient(45deg, #ed8936, #e53e3e)',
                'pd_biolumen_world': 'linear-gradient(45deg, #4299e1, #9f7aea)',
                
                // PD Dry Worlds (Modifier-based)
                'pd_dune_world': 'linear-gradient(45deg, #ecc94b, #d69e2e)',
                'pd_oasis_world': 'linear-gradient(45deg, #48bb78, #ecc94b)',
                'pd_outback_world': 'linear-gradient(45deg, #ed8936, #c53030)',
                'pd_coastal_world': 'linear-gradient(45deg, #f6ad55, #4299e1)',
                'pd_fungi_world': 'linear-gradient(45deg, #805ad5, #ed8936)',
                'pd_salt_world': 'linear-gradient(45deg, #f7fafc, #edf2f7)',
                'pd_aquifer_world': 'linear-gradient(45deg, #4299e1, #f6ad55)',
                'pd_mesa_world': 'linear-gradient(45deg, #ed8936, #a0aec0)',
                'pd_fog_desert_world': 'linear-gradient(45deg, #cbd5e0, #ecc94b)',
                'pd_mediterranean_world': 'linear-gradient(45deg, #68d391, #f6ad55)',
                'pd_badlands_world': 'linear-gradient(45deg, #c53030, #ecc94b)',
                'pd_succulent_world': 'linear-gradient(45deg, #68d391, #ed8936)',
                'pd_striped_world': 'linear-gradient(45deg, #ecc94b, #a0aec0)',
                'pd_primal_world': 'linear-gradient(45deg, #38a169, #ed8936)',
                'pd_steppe_world': 'linear-gradient(45deg, #ecc94b, #38a169)',
                'pd_prairie_world': 'linear-gradient(45deg, #68d391, #ecc94b)',
                'pd_veld_world': 'linear-gradient(45deg, #ed8936, #68d391)',
                'pd_semi_arid_world': 'linear-gradient(45deg, #f6ad55, #38a169)',
                'pd_aspen_world': 'linear-gradient(45deg, #faf089, #ed8936)',
                'pd_sandstone_world': 'linear-gradient(45deg, #ecc94b, #a0aec0)',
                'pd_supercontinent_world': 'linear-gradient(45deg, #ed8936, #4a5568)',
                'pd_sinkhole_world': 'linear-gradient(45deg, #2d3748, #ecc94b)',
                
                // PD Cold Worlds (Modifier-based)
                'pd_cold_desert_world': 'linear-gradient(45deg, #a0aec0, #ecc94b)',
                'pd_glacial_world': 'linear-gradient(45deg, #bee3f8, #90cdf4)',
                'pd_antarctic_world': 'linear-gradient(45deg, #f7fafc, #bee3f8)',
                'pd_aeolian_world': 'linear-gradient(45deg, #cbd5e0, #90cdf4)',
                'pd_ice_spike_world': 'linear-gradient(45deg, #bee3f8, #cbd5e0)',
                'pd_crevasse_world': 'linear-gradient(45deg, #90cdf4, #a0aec0)',
                'pd_ice_dunes_world': 'linear-gradient(45deg, #bee3f8, #ecc94b)',
                'pd_iceberg_world': 'linear-gradient(45deg, #bee3f8, #4299e1)',
                'pd_boreal_world': 'linear-gradient(45deg, #38a169, #a0aec0)',
                'pd_snow_world': 'linear-gradient(45deg, #f7fafc, #cbd5e0)',
                'pd_highland_world': 'linear-gradient(45deg, #a0aec0, #718096)',
                'pd_dune_forest_world': 'linear-gradient(45deg, #38a169, #cbd5e0)',
                'pd_fjord_world': 'linear-gradient(45deg, #4299e1, #a0aec0)',
                'pd_blossom_world': 'linear-gradient(45deg, #f093fb, #a0aec0)',
                'pd_glaciovolcanic_world': 'linear-gradient(45deg, #e53e3e, #bee3f8)',
                'pd_lanthanide_world': 'linear-gradient(45deg, #9f7aea, #a0aec0)',
                'pd_bog_world': 'linear-gradient(45deg, #38a169, #4a5568)',
                'pd_mycelium_world': 'linear-gradient(45deg, #805ad5, #a0aec0)',
                'pd_mud_world': 'linear-gradient(45deg, #744210, #718096)',
                'pd_basalt_world': 'linear-gradient(45deg, #2d3748, #a0aec0)',
                'pd_tuya_world': 'linear-gradient(45deg, #718096, #bee3f8)',
                'pd_cryoflora_world': 'linear-gradient(45deg, #68d391, #bee3f8)',
                'pd_lichen_world': 'linear-gradient(45deg, #68d391, #a0aec0)',
                
                // PD Gaia Worlds (Modifier-based)
                'pd_wet_gaia_world': 'linear-gradient(45deg, #68d391, #4299e1)',
                'pd_dry_gaia_world': 'linear-gradient(45deg, #68d391, #ecc94b)',
                'pd_cold_gaia_world': 'linear-gradient(45deg, #68d391, #bee3f8)',
                
                // PD Uncommon Worlds (Modifier-based)
                'pd_wet_cave_world': 'linear-gradient(45deg, #2d3748, #4299e1)',
                'pd_dry_cave_world': 'linear-gradient(45deg, #2d3748, #ecc94b)',
                'pd_cold_cave_world': 'linear-gradient(45deg, #2d3748, #bee3f8)',
                'pd_wet_superhabitable_world': 'linear-gradient(45deg, #68d391, #4299e1)',
                'pd_dry_superhabitable_world': 'linear-gradient(45deg, #68d391, #ed8936)',
                'pd_cold_superhabitable_world': 'linear-gradient(45deg, #68d391, #a0aec0)',
                'pd_wet_tidally_locked_world': 'linear-gradient(45deg, #e53e3e, #4299e1)',
                'pd_dry_tidally_locked_world': 'linear-gradient(45deg, #e53e3e, #ecc94b)',
                'pd_cold_tidally_locked_world': 'linear-gradient(45deg, #e53e3e, #bee3f8)'
            };
            return colors[className] || 'linear-gradient(45deg, #e2e8f0, #cbd5e0)';
        }

        function updateOutput() {
            elements.exportTxt.value = generateStellarisTxt();
            elements.exportYml.value = generateStellarisYml();
        }

        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-blue-600 text-white px-4 py-2 rounded shadow-lg z-50';
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showNotification(`Datei "${filename}" wurde erfolgreich heruntergeladen!`);
        }

        // Make functions globally available
        window.selectPlanet = selectPlanet;
        window.removeAsteroidBelt = removeAsteroidBelt;
        window.removeNeighborSystem = removeNeighborSystem;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            initializeEventListeners();
            
            // Load default system
            elements.systemName.value = solarSystem.name;
            elements.systemDisplayName.value = solarSystem.displayName;
            elements.systemClass.value = solarSystem.class;
            elements.systemUsage.value = solarSystem.usage;
            
            updateNeighborSystemsList();
            updateAsteroidBeltList();
            updatePlanetList();
            updateOutput();
            renderVisualizer();
            
            showNotification('üöÄ Enhanced Version mit Import/Export, Nachbarsystemen & Mod Support geladen!');
        });

        window.addEventListener('resize', () => {
            setTimeout(renderVisualizer, 100);
        });
    </script>
</body>
</html>
