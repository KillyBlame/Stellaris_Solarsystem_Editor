<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stellaris Solar System Editor V7 - Modifier System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800;900&family=Exo+2:wght@300;400;500;600&display=swap');
        
        :root {
            --stellaris-blue: #00d4ff;
            --stellaris-gold: #ffd700;
            --stellaris-purple: #9966ff;
            --stellaris-dark: #0a0e1a;
            --stellaris-darker: #050811;
            --stellaris-panel: #1a2332;
            --stellaris-border: #2a3847;
            --stellaris-accent: #00a8cc;
            --stellaris-green: #48bb78;
        }

        body {
            font-family: 'Exo 2', 'Inter', sans-serif;
            background: linear-gradient(135deg, var(--stellaris-darker) 0%, var(--stellaris-dark) 50%, #0f1419 100%);
            color: #e2e8f0;
            min-height: 100vh;
            background-attachment: fixed;
        }

        .stellaris-header {
            background: linear-gradient(90deg, var(--stellaris-blue) 0%, var(--stellaris-purple) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-family: 'Orbitron', monospace;
            font-weight: 700;
            text-align: center;
            font-size: 2.5rem;
            margin-bottom: 2rem;
            text-shadow: 0 0 20px rgba(0, 212, 255, 0.3);
        }

        .stellaris-panel {
            background: linear-gradient(145deg, var(--stellaris-panel) 0%, rgba(26, 35, 50, 0.8) 100%);
            border: 1px solid var(--stellaris-border);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            position: relative;
            overflow: hidden;
        }

        .stellaris-panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, var(--stellaris-blue), var(--stellaris-purple), var(--stellaris-gold));
        }

        .stellaris-input {
            background: linear-gradient(145deg, #2a3847 0%, #1e2936 100%);
            border: 1px solid var(--stellaris-border);
            color: #e2e8f0;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            width: 100%;
            font-family: 'Exo 2', sans-serif;
            transition: all 0.3s ease;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .stellaris-input:focus {
            outline: none;
            border-color: var(--stellaris-blue);
            box-shadow: 
                inset 0 2px 4px rgba(0, 0, 0, 0.2),
                0 0 0 3px rgba(0, 212, 255, 0.2);
        }

        .stellaris-input option {
            background-color: #2a3847;
            color: #e2e8f0;
            padding: 8px 12px;
        }

        .stellaris-input optgroup {
            background-color: #1e2936;
            color: #cbd5e0;
            font-weight: bold;
            font-style: normal;
        }

        .stellaris-btn {
            background: linear-gradient(145deg, var(--stellaris-blue) 0%, var(--stellaris-accent) 100%);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            font-family: 'Exo 2', sans-serif;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 4px 15px rgba(0, 212, 255, 0.3);
        }

        .stellaris-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 212, 255, 0.4);
        }

        .stellaris-btn-secondary {
            background: linear-gradient(145deg, #4a5568 0%, #2d3748 100%);
            box-shadow: 0 4px 15px rgba(74, 85, 104, 0.3);
        }

        .stellaris-btn-danger {
            background: linear-gradient(145deg, #e53e3e 0%, #c53030 100%);
            box-shadow: 0 4px 15px rgba(229, 62, 62, 0.3);
        }

        .stellaris-btn-success {
            background: linear-gradient(145deg, var(--stellaris-green) 0%, #38a169 100%);
            box-shadow: 0 4px 15px rgba(72, 187, 120, 0.3);
        }

        /* CSS für das neue Nachbarsystem-Layout */
        .neighbor-grid-container {
            display: grid;
            /* Linke Spalte fix, rechte Spalte flexibel */
            grid-template-columns: 320px 1fr; 
            gap: 1.5rem;
            min-height: 400px; /* Stellt sicher, dass das Layout nicht zusammenfällt */
        }

        .neighbor-list-column {
            border-right: 1px solid var(--stellaris-border);
            padding-right: 1.5rem;
        }

        .neighbor-list-item {
            background: linear-gradient(145deg, rgba(74, 85, 104, 0.4) 0%, rgba(45, 55, 72, 0.6) 100%);
            border: 1px solid var(--stellaris-border);
            border-radius: 6px;
            padding: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
            border-left: 4px solid transparent; /* Für den "selected" Indikator */
        }

        .neighbor-list-item:hover {
            border-color: var(--stellaris-accent);
        }

        .neighbor-list-item.selected {
            background: linear-gradient(145deg, rgba(0, 212, 255, 0.15) 0%, rgba(153, 102, 255, 0.15) 100%);
            border-left-color: var(--stellaris-blue);
            box-shadow: 0 0 10px rgba(0, 212, 255, 0.2);
        }

        .celestial-item {
            background: linear-gradient(145deg, rgba(74, 85, 104, 0.6) 0%, rgba(45, 55, 72, 0.8) 100%);
            border: 1px solid var(--stellaris-border);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
            backdrop-filter: blur(5px);
        }

        .celestial-item:hover {
            background: linear-gradient(145deg, rgba(0, 212, 255, 0.1) 0%, rgba(153, 102, 255, 0.1) 100%);
            border-color: var(--stellaris-blue);
            transform: translateX(4px);
        }

        .celestial-item.selected {
            background: linear-gradient(145deg, rgba(0, 212, 255, 0.2) 0%, rgba(153, 102, 255, 0.2) 100%);
            border-color: var(--stellaris-blue);
            box-shadow: 0 0 20px rgba(0, 212, 255, 0.3);
        }

        .celestial-item.new-orbit {
            border-left: 4px solid var(--stellaris-gold);
        }

        .celestial-item.same-orbit {
            border-left: 4px solid rgba(255, 255, 255, 0.3);
        }

        .stellaris-visualizer {
            background: radial-gradient(circle at center, #0a0e1a 0%, #000 70%);
            border: 2px solid var(--stellaris-border);
            border-radius: 12px;
            height: 850px;
            position: relative;
            overflow: hidden;
            box-shadow: inset 0 0 50px rgba(0, 0, 0, 0.8);
        }

        .section-title {
            font-family: 'Orbitron', monospace;
            font-weight: 600;
            font-size: 1.5rem;
            color: var(--stellaris-blue);
            margin-bottom: 1rem;
            text-shadow: 0 0 10px rgba(0, 212, 255, 0.3);
        }

        .label {
            font-weight: 500;
            color: #cbd5e0;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stellaris-export-area {
            background: linear-gradient(145deg, #1a1f2e 0%, #0f1419 100%);
            border: 1px solid var(--stellaris-border);
            border-radius: 8px;
            padding: 1rem;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            line-height: 1.4;
            color: #e2e8f0;
            resize: none;
            min-height: 300px;
        }

        .modifier-panel {
            background: linear-gradient(145deg, rgba(72, 187, 120, 0.1) 0%, rgba(56, 161, 105, 0.1) 100%);
            border: 1px solid rgba(72, 187, 120, 0.3);
            border-radius: 8px;
            padding: 1.5rem;
            margin-top: 1rem;
        }

        .modifier-item {
            background: linear-gradient(145deg, rgba(72, 187, 120, 0.1) 0%, rgba(56, 161, 105, 0.1) 100%);
            border: 1px solid rgba(72, 187, 120, 0.3);
            border-radius: 6px;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .orbit-indicator {
            position: absolute;
            border: 1px dashed rgba(0, 212, 255, 0.3);
            border-radius: 50%;
            pointer-events: none;
        }

        .stellaris-star {
            background: radial-gradient(circle, #ffeb3b 0%, #ff9800 100%);
            box-shadow: 
                0 0 30px #ffeb3b,
                0 0 60px rgba(255, 235, 59, 0.5),
                0 0 90px rgba(255, 152, 0, 0.3);
            animation: starGlow 3s ease-in-out infinite alternate;
        }

        @keyframes starGlow {
            0% { box-shadow: 0 0 30px #ffeb3b, 0 0 60px rgba(255, 235, 59, 0.5); }
            100% { box-shadow: 0 0 40px #ffeb3b, 0 0 80px rgba(255, 235, 59, 0.7); }
        }

        .planet, .moon {
            border-radius: 50%;
            position: absolute;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 0.7rem;
            font-weight: 600;
            color: white;
            text-shadow: 0 0 5px rgba(0, 0, 0, 0.8);
            border: 2px solid rgba(255, 255, 255, 0.3);
            box-shadow: 
                0 2px 10px rgba(0, 0, 0, 0.5),
                inset 0 0 10px rgba(255, 255, 255, 0.1);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .planet:hover, .moon:hover {
            transform: scale(1.1);
            box-shadow: 
                0 4px 20px rgba(0, 212, 255, 0.5),
                inset 0 0 15px rgba(255, 255, 255, 0.2);
        }

        .asteroid-belt {
            position: absolute;
            border: 2px dotted rgba(139, 69, 19, 0.6);
            border-radius: 50%;
            pointer-events: none;
        }

        .orbit-number {
            position: absolute;
            color: rgba(0, 212, 255, 0.7);
            font-size: 0.8rem;
            font-weight: bold;
            background: rgba(0, 0, 0, 0.5);
            padding: 2px 6px;
            border-radius: 4px;
        }

        .orbit-distance-info {
            background: rgba(0, 212, 255, 0.1);
            border: 1px solid rgba(0, 212, 255, 0.3);
            border-radius: 4px;
            padding: 0.5rem;
            margin-top: 0.5rem;
            font-size: 0.8rem;
        }

        .grid { display: grid; gap: 1.5rem; }
        .grid-cols-1 { grid-template-columns: 1fr; }
        .grid-cols-2 { grid-template-columns: repeat(2, 1fr); }
        .grid-cols-3 { grid-template-columns: repeat(3, 1fr); }

        @media (min-width: 768px) {
            .md\:grid-cols-2 { grid-template-columns: repeat(2, 1fr); }
            .md\:grid-cols-3 { grid-template-columns: repeat(3, 1fr); }
        }

        @media (min-width: 1024px) {
            .lg\:grid-cols-3 { grid-template-columns: repeat(3, 1fr); }
            .lg\:col-span-2 { grid-column: span 2; }
        }

        .hidden { display: none; }
        .ml-6 { margin-left: 1.5rem; }
        .ml-2 { margin-left: 0.5rem; }
        .mt-4 { margin-top: 1rem; }
        .mt-6 { margin-top: 1.5rem; }
        .mb-4 { margin-bottom: 1rem; }
        .mb-8 { margin-bottom: 2rem; }
        .py-8 { padding-top: 2rem; padding-bottom: 2rem; }
        .px-2 { padding-left: 0.5rem; padding-right: 0.5rem; }
        .py-1 { padding-top: 0.25rem; padding-bottom: 0.25rem; }
        .text-sm { font-size: 0.875rem; }
        .max-h-96 { max-height: 24rem; }
        .overflow-y-auto { overflow-y: auto; }
        .cursor-not-allowed { cursor: not-allowed; }
        .container { max-width: 1400px; margin: 0 auto; padding: 2rem; }
        .variation-card {
            transition: all 0.3s ease;
            position: relative;
        }
        
        .variation-card.enabled .stellaris-panel {
            background: linear-gradient(145deg, rgba(72, 187, 120, 0.15), rgba(56, 161, 105, 0.15));
            border: 2px solid rgba(72, 187, 120, 0.5);
            box-shadow: 0 0 15px rgba(72, 187, 120, 0.3);
        }
        
        .variation-card:not(.enabled) .stellaris-panel {
            opacity: 0.6;
        }
        
        .variation-card code {
            background: rgba(0, 0, 0, 0.4);
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            color: #ffd700;
        }
        
        .flag-item {
            background: linear-gradient(145deg, rgba(0, 212, 255, 0.1), rgba(153, 102, 255, 0.1));
            border: 1px solid rgba(0, 212, 255, 0.3);
            border-radius: 6px;
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s ease;
        }
        
        .flag-item:hover {
            border-color: var(--stellaris-blue);
            box-shadow: 0 0 10px rgba(0, 212, 255, 0.3);
        }
        
        .variation-changes {
            background: rgba(0, 0, 0, 0.2);
            border-left: 3px solid var(--stellaris-blue);
            padding: 0.5rem;
            margin-top: 0.5rem;
            font-size: 0.8rem;
        }
    </style>
</head>
<body>
    <div class="container py-8">
        <h1 class="stellaris-header">Stellaris Solar System Editor V8</h1>
        <div class="text-center mb-6">
            <span class="text-yellow-400 font-semibold">Enhanced Version mit korrektem Modifier-System für Planetary Diversity</span>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <!-- System Details Panel -->
            <div class="stellaris-panel md:col-span-3">
                <h2 class="section-title">Systemdetails</h2>
                
                <!-- Import Section -->
                <div class="mb-6 p-4 bg-gradient-to-r from-purple-900/30 to-blue-900/30 rounded-lg border border-purple-500/30">
                    <h3 class="text-lg font-medium mb-3 text-purple-400">📂 System Import/Export</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="label">Bestehendes System laden (.txt)</label>
                            <input type="file" id="importFile" class="stellaris-input" accept=".txt" style="padding: 0.5rem;">
                        </div>
                        <div class="flex items-end">
                            <button id="importBtn" class="stellaris-btn stellaris-btn-secondary">System importieren</button>
                            <button id="clearSystemBtn" class="stellaris-btn stellaris-btn-danger ml-2">System leeren</button>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2">
                    <div>
                        <label class="label">Systemname (Interner Bezeichner)</label>
                        <input type="text" id="systemName" class="stellaris-input" placeholder="z.B. akon_system_initializer">
                    </div>
                    <div>
                        <label class="label">Anzeigename des Systems</label>
                        <input type="text" id="systemDisplayName" class="stellaris-input" placeholder="z.B. Akon">
                    </div>
                    <div>
                        <label class="label">Sternenklasse</label>
                        <select id="systemClass" class="stellaris-input">
                            <option value="sc_b">B-Klasse Stern (Heißer Riese)</option>
                            <option value="sc_a">A-Klasse Stern (Weißer Stern)</option>
                            <option value="sc_f">F-Klasse Stern (Gelblich-weißer Stern)</option>
                            <option value="sc_g" selected>G-Klasse Stern (Gelber Zwerg - Sol)</option>
                            <option value="sc_k">K-Klasse Stern (Oranger Zwerg)</option>
                            <option value="sc_m">M-Klasse Stern (Roter Zwerg)</option>
                            <option value="sc_black_hole">Schwarzes Loch</option>
                            <option value="sc_neutron_star">Neutronenstern</option>
                            <option value="sc_pulsar">Pulsar</option>
                            <option value="sc_trinary">Binär/Trinär (Zufällig)</option>
                        </select>
                    </div>
                    <div>
                        <label class="label">Verwendung</label>
                        <select id="systemUsage" class="stellaris-input">
                            <option value="empire_init">Imperiumsstart (Zufällig)</option>
                            <option value="custom_empire" selected>Benutzerdefiniertes Imperium (Wählbar)</option>
                            <option value="misc_system_init">Verschiedenes System (Zufällig)</option>
                            <option value="">Keine (Nur durch Ereignis)</option>
                        </select>
                    </div>
                </div>

                <!--System Flags Block-->
                <div class="mt-6 p-4 bg-gradient-to-r from-blue-900/30 to-purple-900/30 rounded-lg border border-blue-500/30">
                    <h3 class="text-lg font-medium mb-4 text-blue-400">🏴 System Flags</h3>
                    
                    <div class="mb-3 p-2 bg-blue-900/20 rounded border border-blue-500/30">
                        <p class="text-blue-200 text-xs">
                            <strong>Flags</strong> werden für Event-Trigger, Origin-Checks und Story-Integration verwendet.<br>
                            Beispiele: <code>empire_home_system</code>, <code>sol_system</code>, <code>special_project</code>
                        </p>
                    </div>
                    
                    <div id="systemFlagsList" class="space-y-2 mb-4 max-h-40 overflow-y-auto">
                        <p class="text-gray-400 text-sm">Keine System-Flags gesetzt</p>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="md:col-span-2">
                            <label class="label">Neues Flag</label>
                            <input type="text" id="newSystemFlag" class="stellaris-input" 
                                   placeholder="z.B. empire_home_system">
                        </div>
                        <div class="flex items-end">
                            <button id="addSystemFlagBtn" class="stellaris-btn stellaris-btn-secondary w-full">
                                Flag hinzufügen
                            </button>
                        </div>
                    </div>
                    
                    <!-- Quick Add Common Flags -->
                    <div class="mt-3">
                        <label class="label text-xs">Häufige Flags:</label>
                        <div class="flex flex-wrap gap-2 mt-1">
                            <button onclick="quickAddSystemFlag('empire_home_system')" 
                                    class="text-xs px-2 py-1 bg-blue-600 rounded hover:bg-blue-700">
                                empire_home_system
                            </button>
                            <button onclick="quickAddSystemFlag('sol_system')" 
                                    class="text-xs px-2 py-1 bg-blue-600 rounded hover:bg-blue-700">
                                sol_system
                            </button>
                            <button onclick="quickAddSystemFlag('suppress_archaeological_sites')" 
                                    class="text-xs px-2 py-1 bg-blue-600 rounded hover:bg-blue-700">
                                suppress_sites
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Visualizer Panel -->
                <div class="stellaris-panel md:col-span-3" style="height: 1000px;">
                    <h2 class="section-title">System-Visualisierung</h2>
                    <div id="visualizer" class="stellaris-visualizer">
                        <!-- Celestial bodies will be rendered here -->
                    </div>
                    <div class="mt-4">
                        <button id="zoomInBtn" class="stellaris-btn stellaris-btn-secondary text-sm px-2 py-1">Zoom +</button>
                        <button id="zoomOutBtn" class="stellaris-btn stellaris-btn-secondary text-sm px-2 py-1 ml-2">Zoom -</button>
                        <button id="resetViewBtn" class="stellaris-btn stellaris-btn-secondary text-sm px-2 py-1 ml-2">Reset</button>
                    </div>
                </div>
            </div>

                <div class="mt-6">
                    <button id="addPlanetBtn" class="stellaris-btn">Planet hinzufügen</button>
                    <button id="moveUpBtn" class="stellaris-btn stellaris-btn-secondary ml-2" disabled>↑ Nach oben</button>
                    <button id="moveDownBtn" class="stellaris-btn stellaris-btn-secondary ml-2" disabled>↓ Nach unten</button>
                </div>

                
                
                <!-- Asteroid Belt Configuration -->
                <div class="mt-6 p-4 bg-gray-800 rounded-lg">
                    <h3 class="text-lg font-medium mb-4 text-yellow-400">Asteroidengürtel (Multiple möglich)</h3>
                    <div id="asteroidBeltList" class="space-y-2 mb-4">
                        <p class="text-gray-400 text-sm">Keine Asteroidengürtel definiert</p>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="label">Typ</label>
                            <select id="newAsteroidBeltType" class="stellaris-input">
                                <option value="rocky_asteroid_belt">Rocky Asteroid Belt</option>
                                <option value="icy_asteroid_belt">Icy Asteroid Belt</option>
                                <option value="crystalline_asteroid_belt">Crystalline Asteroid Belt</option>
                            </select>
                        </div>
                        <div>
                            <label class="label">Radius</label>
                            <input type="number" id="newAsteroidBeltRadius" class="stellaris-input" value="575" min="100" max="1000">
                        </div>
                        <div class="flex items-end">
                            <button id="addAsteroidBeltBtn" class="stellaris-btn stellaris-btn-secondary">Gürtel hinzufügen</button>
                        </div>
                    </div>
                </div>
                
                <!-- Orbit Distance Info -->
                <div class="orbit-distance-info mt-4">
                    <strong>💡 Stellaris Kumulative Orbit-Mechanik:</strong><br>
                    📏 <strong>Kumulative Addition:</strong> orbit_distance wird zur Gesamtdistanz addiert<br>
                    🟡 <strong>Planet 1:</strong> orbit_distance = 25 → Umlaufbahn bei 25<br>
                    🟡 <strong>Planet 2:</strong> orbit_distance = 30 → Umlaufbahn bei 25+30 = 55<br>
                    ⚪ <strong>Planet 3:</strong> orbit_distance = 0 → Gleiche Umlaufbahn bei 55
                </div>
            </div>

            

        <div class="grid grid-cols-1 lg:grid-cols-3 mb-8">
            <!-- Planet List -->
            <div class="stellaris-panel">
                <h2 class="section-title">Planeten (Reihenfolge)</h2>
                <div id="planetList" class="max-h-96 overflow-y-auto">
                    <p class="text-gray-400">Fügen Sie Planeten hinzu, um mit dem Systembau zu beginnen.</p>
                </div>
            </div>

            <!-- Celestial Body Details Panel -->
            <div class="stellaris-panel lg:col-span-2">
                <h2 class="section-title">Planet-Details</h2>
                <div id="celestialDetails" class="hidden">
                    <div class="grid grid-cols-1 md:grid-cols-2">
                        <div>
                            <label class="label">Typ</label>
                            <input type="text" id="celestialType" class="stellaris-input cursor-not-allowed" readonly>
                        </div>
                        <div>
                            <label class="label">Position in System</label>
                            <input type="text" id="celestialPosition" class="stellaris-input cursor-not-allowed" readonly>
                        </div>
                        <div>
                            <label class="label">Name (Interner Bezeichner)</label>
                            <input type="text" id="celestialName" class="stellaris-input" placeholder="z.B. akon">
                        </div>
                        <div>
                            <label class="label">Anzeigename</label>
                            <input type="text" id="celestialDisplayName" class="stellaris-input" placeholder="z.B. Akon">
                        </div>
                        <div>
                            <label class="label">Basis-Planetenklasse</label>
                            <select id="celestialClass" class="stellaris-input">
                                <optgroup label="Sterne">
                                    <option value="pc_b_star">B-Klasse Stern</option>
                                    <option value="pc_a_star">A-Klasse Stern</option>
                                    <option value="pc_f_star">F-Klasse Stern</option>
                                    <option value="pc_g_star">G-Klasse Stern</option>
                                    <option value="pc_k_star">K-Klasse Stern</option>
                                    <option value="pc_m_star">M-Klasse Stern</option>
                                    <option value="pc_black_hole">Schwarzes Loch</option>
                                    <option value="pc_neutron_star">Neutronenstern</option>
                                    <option value="pc_pulsar">Pulsar</option>
                                    <option value="pc_brown_dwarf">Brauner Zwerg</option>
                                </optgroup>
                                <optgroup label="Bewohnbare Welten (Vanilla)">
                                    <option value="pc_continental">Kontinental</option>
                                    <option value="pc_ocean">Ozean</option>
                                    <option value="pc_tropical">Tropisch</option>
                                    <option value="pc_arid">Arid</option>
                                    <option value="pc_desert">Wüste</option>
                                    <option value="pc_savannah">Savanne</option>
                                    <option value="pc_arctic">Arktisch</option>
                                    <option value="pc_tundra">Tundra</option>
                                    <option value="pc_alpine">Alpin</option>
                                    <option value="pc_gaia">Gaia</option>
                                </optgroup>
                                <optgroup label="Unbewohnbare Welten">
                                    <option value="pc_barren" selected>Karg</option>
                                    <option value="pc_barren_cold">Karg (Kalt)</option>
                                    <option value="pc_frozen">Gefroren</option>
                                    <option value="pc_molten">Geschmolzen</option>
                                    <option value="pc_toxic">Toxisch</option>
                                    <option value="pc_gas_giant">Gasriese</option>
                                    <option value="pc_nuked">Verstrahlt</option>
                                    <option value="pc_asteroid">Asteroid</option>
                                </optgroup>
                                <optgroup label="Spezielle Welten">
                                    <option value="pc_relic">Relikt-Welt</option>
                                    <option value="pc_habitat">Habitat</option>
                                    <option value="pc_ecumenopolis">Ökumenopolis</option>
                                    <option value="pc_machine">Maschinenwelt</option>
                                    <option value="pc_hive">Schwarmwelt</option>
                                    <option value="pc_shielded">Abgeschirmt</option>
                                </optgroup>
                                <optgroup label="🌌 Gigastructural Engineers">
                                    <option value="pc_birch">Birch World</option>
                                    <option value="pc_alderson">Alderson Disk</option>
                                    <option value="pc_gas_giant_habitable">Habitable Gas Giant</option>
                                    <option value="pc_stellar_systemcraft">Stellar Systemcraft</option>
                                    <option value="pc_nicoll_dyson_beam">Nicoll-Dyson Beam Target</option>
                                    <option value="pc_penrose_sphere_habitable">Penrose Sphere Habitat</option>
                                    <option value="pc_virtual_reality">Virtual Reality World</option>
                                    <option value="pc_pouchkinn_planet">Pouchkinn Planet</option>
                                    <option value="pc_gigastructural_shielded">Gigastructural Shielded World</option>
                                    <option value="pc_quasi_stellar_obliterator">Quasi-Stellar Obliterator</option>
                                    <option value="pc_neutronium_gigaforge">Neutronium Gigaforge</option>
                                </optgroup>
                                <optgroup label="✨ PD: Uncommon Worlds">
                                    <option value="pc_superhabitable">Superhabitable</option>
                                    <option value="pc_tidally_locked">Tidally Locked</option>
                                    <option value="pc_mantle">Mantle World</option>
                                    <option value="pc_karst">Karst World</option>
                                    <option value="pc_crystal">Crystal World</option>
                                    <option value="pc_frozen_desert">Frozen Desert</option>
                                    <option value="pc_ash">Ash World</option>
                                    <option value="pc_marginal">Marginal World</option>
                                    <option value="pc_sandsea">Sand Sea World</option>
                                    <option value="pc_technoorganic">Techno-organic World</option>
                                    <option value="pd_wet_cave_world">Wet Cave World</option>
                                    <option value="pd_dry_cave_world">Dry Cave World</option>
                                    <option value="pd_cold_cave_world">Cold Cave World</option>
                                    <option value="pd_wet_superhabitable_world">Wet Superhabitable</option>
                                    <option value="pd_dry_superhabitable_world">Dry Superhabitable</option>
                                    <option value="pd_cold_superhabitable_world">Cold Superhabitable</option>
                                    <option value="pd_wet_tidally_locked_world">Wet Tidally Locked</option>
                                    <option value="pd_dry_tidally_locked_world">Dry Tidally Locked</option>
                                    <option value="pd_cold_tidally_locked_world">Cold Tidally Locked</option>
                                </optgroup>
                                <optgroup label="🪨 PD: Enhanced Uninhabitable">
                                    <option value="pc_barren_cold">Karg (Kalt)</option>
                                    <option value="pc_hothouse">Treibhaus</option>
                                    <option value="pc_hot_gas_giant">Heißer Gasriese</option>
                                    <option value="pc_cold_gas_giant">Kalter Gasriese</option>
                                    <option value="pc_dwarf_gas_giant">Zwerg-Gasriese</option>
                                    <option value="pc_shattered">Zerstört</option>
                                    <option value="pc_subglacial">Subglazial</option>
                                    <option value="pc_storm">Sturm-Welt</option>
                                </optgroup>
                        </select>
                        </div>
                        <div>
                            <label class="label">Größe (1-50)</label>
                            <input type="number" id="celestialSize" class="stellaris-input" min="1" max="50" value="16">
                        </div>
                        <div>
                            <label class="label">Orbit Distance</label>
                            <input type="number" id="celestialOrbitDistance" class="stellaris-input" min="0" value="0">
                            <small class="text-gray-400 text-xs">0 = Gleiche Umlaufbahn wie vorheriger Planet</small>
                        </div>
                        <div>
                            <label class="label">Orbit Angle (Typ)</label>
                            <select id="orbitAngleType" class="stellaris-input">
                                <option value="fixed">Fester Winkel</option>
                                <option value="range" selected>Winkelbereich</option>
                            </select>
                        </div>
                        <div class="orbit-angle-controls">
                            <div id="fixedAngleControl" class="hidden">
                                <label class="label">Winkel (0-360°)</label>
                                <input type="number" id="celestialOrbitAngle" class="stellaris-input" min="0" max="360" value="0">
                            </div>
                            <div id="rangeAngleControl">
                                <label class="label">Winkelbereich</label>
                                <div class="grid grid-cols-2 gap-2">
                                    <input type="number" id="celestialOrbitAngleMin" class="stellaris-input" min="0" max="360" value="90" placeholder="Min">
                                    <input type="number" id="celestialOrbitAngleMax" class="stellaris-input" min="0" max="360" value="270" placeholder="Max">
                                </div>
                            </div>
                        </div>
                        <div>
                            <label class="label">Change Orbit (für nachfolgende Planeten)</label>
                            <input type="number" id="celestialChangeOrbit" class="stellaris-input" min="0" value="0">
                            <small class="text-gray-400 text-xs">0 = Keine Änderung</small>
                        </div>
                        <div class="md:col-span-2">
                            <div class="grid grid-cols-2 gap-4">
                                <label class="label">
                                    <input type="checkbox" id="celestialHasRing" class="mr-2">
                                    Hat Ringsystem
                                </label>
                                <label class="label">
                                    <input type="checkbox" id="celestialIsStartingPlanet" class="mr-2">
                                    Startplanet (Empire)
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="mt-4 p-4 bg-gradient-to-r from-purple-900/30 to-blue-900/30 rounded-lg border border-purple-500/30">
                        <h3 class="text-lg font-medium mb-4 text-purple-400">🏴 Planet Flags & Erweitert</h3>
                        
                        <div id="planetFlagsList" class="space-y-2 mb-4 max-h-32 overflow-y-auto">
                            <p class="text-gray-400 text-sm">Keine Planet-Flags gesetzt</p>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <div class="md:col-span-2">
                                <label class="label">Neues Planet Flag</label>
                                <input type="text" id="newPlanetFlag" class="stellaris-input" 
                                       placeholder="z.B. planet_earth">
                            </div>
                            <div class="flex items-end">
                                <button id="addPlanetFlagBtn" class="stellaris-btn stellaris-btn-secondary w-full">
                                    Flag hinzufügen
                                </button>
                            </div>
                        </div>
                        
                        <!-- Advanced Options -->
                        <div class="border-t border-purple-500/30 pt-4">
                            <h4 class="text-sm font-medium mb-3 text-purple-300">Erweiterte Optionen</h4>
                            
                            <div class="space-y-2">
                                <label class="label flex items-center">
                                    <input type="checkbox" id="celestialPreventAnomaly" class="mr-2">
                                    <span>Prevent Anomaly</span>
                                    <span class="ml-2 text-xs text-gray-400">(verhindert zufällige Anomalien)</span>
                                </label>
                                
                                <div>
                                    <label class="label">Entity Override (visuelles Modell)</label>
                                    <select id="celestialEntity" class="stellaris-input">
                                        <option value="">Standard (automatisch)</option>
                                        <optgroup label="Spezielle Earth Entities">
                                            <option value="continental_planet_earth_entity">Earth (Continental)</option>
                                            <option value="barren_planet_mars_entity">Mars (Barren)</option>
                                            <option value="cold_barren_planet_luna_entity">Luna (Barren Cold)</option>
                                        </optgroup>
                                        <optgroup label="Gas Giants">
                                            <option value="gas_giant_jupiter_entity">Jupiter</option>
                                            <option value="gas_giant_05_entity">Saturn Style</option>
                                            <option value="gas_giant_uranus_entity">Uranus</option>
                                            <option value="gas_giant_neptune_entity">Neptune</option>
                                        </optgroup>
                                        <optgroup label="Molten/Toxic">
                                            <option value="molten_planet_mercury_entity">Mercury (Molten)</option>
                                            <option value="toxic_planet_venus_entity">Venus (Toxic)</option>
                                        </optgroup>
                                    </select>
                                    <small class="text-gray-400 text-xs">Überschreibt Standard-Planetenmodell mit spezifischem Entity</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Modifier System -->
                    <div class="modifier-panel">
                        <h3 class="text-lg font-medium mb-4 text-green-400">🌿 Intelligentes Planet-Modifier System</h3>
                        <div class="mb-3 p-2 bg-blue-900/20 rounded border border-blue-500/30">
                            <p class="text-blue-200 text-xs">
                                <strong>Planetary Diversity:</strong> Zeigt nur kompatible Modifier für gewählte Basis-Planetenklasse<br>
                                <strong>Andere:</strong> Standard-Modifier funktionieren mit allen Klassen
                            </p>
                        </div>
                        <div id="modifierList" class="space-y-2 mb-4">
                            <p class="text-gray-400 text-sm">Keine Modifier ausgewählt</p>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="label">Modifier Kategorie</label>
                                <select id="modifierCategory" class="stellaris-input">
                                    <option value="">-- Kategorie wählen --</option>
                                    <option value="planetary_diversity">Planetary Diversity</option>
                                    <option value="environmental">Umwelt-Modifier</option>
                                    <option value="resource">Ressourcen-Modifier</option>
                                    <option value="special">Spezial-Modifier</option>
                                </select>
                            </div>
                            <div>
                                <label class="label">Modifier</label>
                                <select id="modifierType" class="stellaris-input" disabled>
                                    <option value="">-- Erst Kategorie wählen --</option>
                                </select>
                            </div>
                            <div class="flex items-end">
                                <button id="addModifierBtn" class="stellaris-btn stellaris-btn-success" disabled>Modifier hinzufügen</button>
                            </div>
                        </div>
                    </div>

                    <div class="mt-6">
                        <button id="addMoonBtn" class="stellaris-btn stellaris-btn-secondary">Mond hinzufügen</button>
                        <button id="deleteCelestialBtn" class="stellaris-btn stellaris-btn-danger ml-2">Löschen</button>
                    </div>
                </div>
                <p id="noCelestialSelected" class="text-gray-400">Wählen Sie einen Planeten aus der Liste, um seine Details zu bearbeiten.</p>
            </div>

            <!-- Neighbor Systems Configuration -->
                <div class="md:col-span-3 mt-8">
                    <h3 class="text-lg font-medium mb-4 text-indigo-400">🌌 Nachbarsysteme</h3>

                    <!-- Neighbor Systems List -->
                    <div id="neighborSystemsList" class="space-y-2 mb-4 max-h-64 overflow-y-auto">
                        <p class="text-gray-400 text-sm">Keine Nachbarsysteme definiert</p>
                    </div>

                    <!-- Add Neighbor System -->
                    <div class="lg:col-span-2 space-y-6">
                        <h4 class="text-sm font-medium mb-3 text-blue-300">Neues Nachbarsystem hinzufügen</h4>
                        
                        <!-- Modus-Auswahl -->
                        <div class="mb-4">
                            <label class="label">Modus</label>
                            <select id="neighborMode" class="stellaris-input" onchange="toggleNeighborCustomFields()">
                                <option value="reference">Referenz zu existierendem System</option>
                                <option value="custom">Benutzerdefiniert (neues System)</option>
                            </select>
                        </div>
                        
                        <!-- ✅ KORRIGIERT: Hyperlane Jumps statt Distance -->
                        <div class="mb-4">
                            <label class="label">Hyperlane Entfernung (Jumps)</label>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="text-xs text-gray-400">Min</label>
                                    <input type="number" id="neighborHyperlaneMin" class="stellaris-input" value="1" min="1" max="10">
                                </div>
                                <div>
                                    <label class="text-xs text-gray-400">Max</label>
                                    <input type="number" id="neighborHyperlaneMax" class="stellaris-input" value="3" min="1" max="10">
                                </div>
                            </div>
                            <p class="text-xs text-gray-400 mt-1">
                                💡 Tipp: 1-3 Jumps = Nahes Nachbarsystem, 4-6 = Weiter entfernt
                            </p>
                        </div>
                        
                        <!-- Trigger (Optional) -->
                        <div class="mb-4">
                            <label class="label">Trigger (Optional)</label>
                            <input type="text" id="neighborTrigger" class="stellaris-input" 
                                   placeholder="z.B. num_guaranteed_colonies >= 1">
                            <p class="text-xs text-gray-400 mt-1">
                                💡 Leer lassen für immer aktives Nachbarsystem
                            </p>
                        </div>
                        
                        <!-- Referenz-Modus Felder -->
                        <div id="referenceNeighborFields">
                            <div class="mb-4">
                                <label class="label">System-Referenz</label>
                                <input type="text" id="newNeighborReference" class="stellaris-input" 
                                       placeholder="z.B. sol_neighbor_t1, neighbor_t1_first_colony">
                                <p class="text-xs text-gray-400 mt-1">
                                    💡 Vanilla-Systeme: sol_neighbor_t1, neighbor_t1_first_colony, neighbor_t2
                                </p>
                            </div>
                        </div>
                        
                        <!-- Custom-Modus Felder -->
                        <div id="customNeighborFields" class="hidden">
                            <h4 class="text-sm font-medium mb-3 text-purple-300 border-t border-purple-500/30 pt-4">
                                Benutzerdefiniertes Nachbarsystem
                            </h4>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label class="label">Systemname</label>
                                    <input type="text" id="customNeighborName" class="stellaris-input" 
                                           placeholder="z.B. Alpha Proxima">
                                </div>
                                <div>
                                    <label class="label">Sternenklasse</label>
                                    <select id="customNeighborStarClass" class="stellaris-input">
                                        <option value="sc_b">B-Klasse (Heißer Riese)</option>
                                        <option value="sc_a">A-Klasse (Weißer Stern)</option>
                                        <option value="sc_f">F-Klasse (Gelblich-weiß)</option>
                                        <option value="sc_g" selected>G-Klasse (Gelber Zwerg)</option>
                                        <option value="sc_k">K-Klasse (Oranger Zwerg)</option>
                                        <option value="sc_m">M-Klasse (Roter Zwerg)</option>
                                        <option value="sc_black_hole">Schwarzes Loch</option>
                                        <option value="sc_neutron_star">Neutronenstern</option>
                                        <option value="sc_pulsar">Pulsar</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- ✅ NEU: Asteroidengürtel -->
                            <div class="mb-4 p-3 bg-gray-800/50 rounded border border-yellow-500/30">
                                <div class="flex justify-between items-center mb-2">
                                    <label class="label mb-0">Asteroidengürtel</label>
                                    <button onclick="addNeighborAsteroidBelt()" 
                                            class="stellaris-btn stellaris-btn-secondary text-xs px-2 py-1">
                                        + Gürtel hinzufügen
                                    </button>
                                </div>
                                <div id="customNeighborAsteroidsList" class="space-y-1 mt-2">
                                    <p class="text-gray-400 text-xs">Keine Gürtel definiert</p>
                                </div>
                            </div>
                            
                            <!-- ✅ ERWEITERT: Planeten mit Mond-Support -->
                            <div class="p-3 bg-gray-800/50 rounded border border-green-500/30">
                                <div class="flex justify-between items-center mb-2">
                                    <label class="label mb-0">Planeten im Nachbarsystem</label>
                                    <div class="flex gap-2">
                                        <button onclick="addNeighborPlanetDraft('single')" 
                                                class="stellaris-btn stellaris-btn-secondary text-xs px-2 py-1">
                                            + Planet
                                        </button>
                                        <button onclick="addNeighborPlanetDraft('asteroid_group')" 
                                                class="stellaris-btn stellaris-btn-secondary text-xs px-2 py-1">
                                            + Asteroiden
                                        </button>
                                    </div>
                                </div>
                                <div id="customNeighborPlanetsList" class="space-y-2 mt-2 max-h-64 overflow-y-auto">
                                    <p class="text-gray-400 text-xs">Keine Planeten definiert</p>
                                </div>
                            </div>
                        </div>
                        
                        <button id="addNeighborBtn" class="stellaris-btn stellaris-btn-secondary w-full mt-4">
                            Nachbarsystem hinzufügen
                        </button>
                    </div>
                </div>
        </div>

        <div class="stellaris-panel md:col-span-3 mt-8">
            <h2 class="section-title">🌍 System-Variationen (Origin Support)</h2>
            
            <div class="mb-6 p-4 bg-gradient-to-r from-green-900/30 to-blue-900/30 rounded-lg border border-green-500/30">
                <div class="flex items-start gap-3">
                    <span class="text-3xl">💡</span>
                    <div>
                        <p class="text-green-200 font-semibold mb-2">Was sind System-Variationen?</p>
                        <p class="text-green-200 text-sm">
                            Viele Stellaris Origins verwenden <strong>modifizierte Versionen</strong> desselben Sonnensystems. 
                            Zum Beispiel hat das Sol-System 7 verschiedene Varianten für Origins wie "Commonwealth", "Lost Colony", 
                            "Knights of the Toxic God", etc.<br><br>
                            Aktiviere die gewünschten Varianten unten - beim Export werden automatisch alle aktivierten Versionen 
                            als separate System-Initializers generiert!
                        </p>
                    </div>
                </div>
            </div>
            
            <!-- Variation Cards Grid -->
            <div id="variationsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
                <!-- Wird dynamisch mit JavaScript gefüllt -->
            </div>
            
            <!-- Status Footer -->
            <div class="mt-6 p-4 bg-gradient-to-r from-blue-900/30 to-purple-900/30 rounded-lg border border-blue-500/30">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-blue-200 font-semibold">Export Status</p>
                        <p class="text-blue-300 text-sm mt-1">
                            <span id="variationCount">1</span> System-Initializer(s) werden beim Export generiert
                        </p>
                    </div>
                    <button id="previewVariationsBtn" class="stellaris-btn stellaris-btn-secondary">
                        Vorschau aller Varianten
                    </button>
                </div>
            </div>
        </div>

        <!-- Export Section -->
        <div class="stellaris-panel">
            <h2 class="section-title">Export</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <h3 class="text-xl font-medium mb-4 text-green-400">Generierter Stellaris Code (.txt)</h3>
                    <textarea id="exportTxt" class="stellaris-export-area w-full" rows="40" readonly></textarea>
                    <button id="downloadTxtBtn" class="stellaris-btn mt-4 w-full">Als .txt herunterladen</button>
                </div>
                <div>
                    <h3 class="text-xl font-medium mb-4 text-green-400">Generierte Lokalisierung (.yml)</h3>
                    <textarea id="exportYml" class="stellaris-export-area w-full" rows="40" readonly></textarea>
                    <button id="downloadYmlBtn" class="stellaris-btn mt-4 w-full">Als .yml herunterladen</button>
                </div>
            </div>
            <div class="mt-6 p-4 bg-gradient-to-r from-green-900/30 to-blue-900/30 rounded-lg border border-green-500/30">
                <p class="font-semibold text-green-300 mb-2">🎯 V7 Features - System-Variationen & Erweiterte Kompatibilität:</p>
                <ul class="list-disc list-inside space-y-1 text-sm">
                    <li><strong>🌍 System-Variationen:</strong> Automatische Origin-Varianten mit einem Klick</li>
                    <li><strong>🏴 Flags System:</strong> System- und Planet-Flags für Event-Integration</li>
                    <li><strong>🚫 Prevent Anomaly:</strong> Verhindere zufällige Anomalien auf Planeten</li>
                    <li><strong>🎨 Entity Override:</strong> Benutzerdefinierte Planeten-Visualisierungen</li>
                    <li><strong>📦 Multi-Variant Export:</strong> Alle Varianten in einer Datei oder separat</li>
                    <li><strong>✅ Vanilla-Kompatibilität:</strong> 100% kompatibel mit allen Stellaris Origins</li>
                    <li><strong>🔄 V6 Features:</strong> Alle bisherigen Features vollständig erhalten</li>
                </ul>
                <div class="mt-4 p-3 bg-blue-900/20 rounded border border-blue-500/30">
                    <p class="text-blue-200 text-sm">
                        <strong>💡 Neu in V7:</strong> Erstelle komplexe Origin-Systeme wie "Knights of the Toxic God" 
                        oder "Fear of the Dark" mit automatischen Planet-Modifikationen und Flags!
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        /*
        ╔══════════════════════════════════════════════════════════════════════╗
        ║     STELLARIS SOLAR SYSTEM EDITOR V8 - CODE STRUKTUR                ║
        ╠══════════════════════════════════════════════════════════════════════╣
        ║                                                                      ║
        ║  INHALTSVERZEICHNIS (Suche mit Strg+F nach [SECTION-XX])           ║
        ║                                                                      ║
        ║  [SECTION-01] Datenmodelle & Konfiguration                          ║
        ║  [SECTION-02] Modifier & Planetenklassen Datenbank                  ║
        ║  [SECTION-03] System-Variationen (Origins)                          ║
        ║  [SECTION-04] DOM Element Referenzen                                ║
        ║  [SECTION-05] Modifier System Funktionen                            ║
        ║  [SECTION-06] Flag Management (System & Planeten)                   ║
        ║  [SECTION-07] System-Variationen Funktionen                         ║
        ║  [SECTION-08] Planet Management Funktionen                          ║
        ║  [SECTION-09] Nachbarsystem Management                              ║
        ║  [SECTION-10] Asteroidengürtel Management                           ║
        ║  [SECTION-11] Import/Export Funktionen                              ║
        ║  [SECTION-12] Code-Generierung (Stellaris .txt)                     ║
        ║  [SECTION-13] UI Update Funktionen                                  ║
        ║  [SECTION-14] Visualisierung (Canvas)                               ║
        ║  [SECTION-15] Helper Funktionen (Icons, Farben, etc.)               ║
        ║  [SECTION-16] Event Listener Initialisierung                        ║
        ║  [SECTION-17] Globale Funktionen & Initialization                   ║
        ║                                                                      ║
        ╚══════════════════════════════════════════════════════════════════════╝
        */

        // ============================================================
        // [SECTION-01] DATENMODELLE & KONFIGURATION
        // ============================================================
        // HIER: Hauptdatenstruktur des Sonnensystems
        // ÄNDERN: Wenn du neue Eigenschaften zum System hinzufügen willst
        
        let solarSystem = {
            name: 'my_custom_system',
            displayName: 'Mein Sonnensystem',
            class: 'sc_g',
            usage: 'custom_empire',
            neighborSystems: [], // Array of neighbor systems
            asteroidBelts: [], // Array of multiple asteroid belts
            planets: [], // Sequential array of planets
            flags: [],
            usageOdds: null,
            maxInstances: null
        };

        let selectedPlanet = null;
        let nextCelestialId = 1;
        let visualizerScale = 0.3;

        // ============================================================
        // [SECTION-02] MODIFIER & PLANETENKLASSEN DATENBANK
        // ============================================================
        // HIER: Alle verfügbaren Modifiers für Planeten
        // ÄNDERN: Um neue Planetary Diversity Modifier hinzuzufügen
        // TIPP: Füge neue Modifier nach dem gleichen Muster hinzu

        // V7 ADDITION - System Variations Database

        // Intelligent Planet-Class-Based Modifier Database
        const MODIFIERS = {
            planetary_diversity: {
                name: "Planetary Diversity",
                modifiers: {
                    // Continental-based modifiers
                    pc_continental: {
                        "pd_retinal_world_effect": { name: "Retinal World", description: "Augen-ähnliche Strukturen" },
                        "pd_lake_world_effect": { name: "Lake World", description: "Viele Seen und Wasserkörper" },
                        "pd_tepid_world_effect": { name: "Tepid World", description: "Lauwarmes Klima" },
                        "pd_mushroom_world_effect": { name: "Mushroom World", description: "Dominiert von Pilzen" },
                        "pd_temperate_world_effect": { name: "Temperate World", description: "Gemäßigtes Klima" },
                        "pd_sakura_world_effect": { name: "Sakura World", description: "Kirschblüten-Landschaften" },
                        "pd_moss_world_effect": { name: "Moss World", description: "Moos-bedeckt" },
                        "pd_marsh_world_effect": { name: "Marsh World", description: "Sumpfgebiete" },
                        "pd_forest_world_effect": { name: "Forest World", description: "Dichte Wälder" },
                        "pd_megaflora_world_effect": { name: "Megaflora World", description: "Riesenpflanzen" },
                        "pd_petrified_world_effect": { name: "Petrified World", description: "Versteinerte Landschaften" }
                    },
                    // Ocean-based modifiers
                    pc_ocean: {
                        "pd_cascadian_world_effect": { name: "Cascadian World", description: "Wasserfälle und Kaskaden" },
                        "pd_swamp_world_effect": { name: "Swamp World", description: "Sumpfige Gebiete" },
                        "pd_crag_world_effect": { name: "Crag World", description: "Schroffe Küsten" },
                        "pd_fog_world_effect": { name: "Fog World", description: "Permanenter Nebel" },
                        "pd_kelp_world_effect": { name: "Kelp World", description: "Ausgedehnte Algenwälder" },
                        "pd_algae_world_effect": { name: "Algae World", description: "Algen-dominiert" },
                        "pd_columnar_world_effect": { name: "Columnar World", description: "Säulenförmige Strukturen" },
                        "pd_tidepool_world_effect": { name: "Tidepool World", description: "Gezeitentümpel" },
                        "pd_reef_world_effect": { name: "Reef World", description: "Korallenriff-Strukturen" },
                        "pd_archipelago_world_effect": { name: "Archipelago World", description: "Inselgruppen" }
                    },
                    // Tropical-based modifiers
                    pc_tropical: {
                        "pd_atoll_world_effect": { name: "Atoll World", description: "Ringförmige Inseln" },
                        "pd_tepui_world_effect": { name: "Tepui World", description: "Tafelberge im Dschungel" },
                        "pd_mangrove_world_effect": { name: "Mangrove World", description: "Mangrovenwälder" },
                        "pd_cenote_world_effect": { name: "Cenote World", description: "Unterirdische Seen" },
                        "pd_fungal_world_effect": { name: "Fungal World", description: "Pilz-Ökosysteme" },
                        "pd_aerial_world_effect": { name: "Aerial World", description: "Luftige Baumkronen" },
                        "pd_lilypad_world_effect": { name: "Lilypad World", description: "Riesige Seerosen" },
                        "pd_obsidian_world_effect": { name: "Obsidian World", description: "Vulkanisches Glas" },
                        "pd_geothermal_world_effect": { name: "Geothermal World", description: "Heiße Quellen" },
                        "pd_biolumen_world_effect": { name: "Bioluminescent World", description: "Leuchtende Organismen" }
                    },
                    // Desert-based modifiers
                    pc_desert: {
                        "pd_dune_world_effect": { name: "Dune World", description: "Wanderdünen" },
                        "pd_oasis_world_effect": { name: "Oasis World", description: "Oasen in Wüsten" },
                        "pd_outback_world_effect": { name: "Outback World", description: "Trockenes Buschland" },
                        "pd_coastal_world_effect": { name: "Coastal World", description: "Wüstenküsten" },
                        "pd_fungi_world_effect": { name: "Fungi World", description: "Wüstenpilze" },
                        "pd_ironsand_world_effect": { name: "Ironsand World", description: "Eisenhaltiger Sand" },
                        "pd_cactus_world_effect": { name: "Cactus World", description: "Riesenkakteen" },
                        "pd_salt_world_effect": { name: "Salt World", description: "Salzwüsten" },
                        "pd_aquifer_world_effect": { name: "Aquifer World", description: "Unterirdisches Wasser" }
                    },
                    // Arid-based modifiers
                    pc_arid: {
                        "pd_mesa_world_effect": { name: "Mesa World", description: "Tafelberge und Plateaus" },
                        "pd_fog_desert_world_effect": { name: "Fog Desert World", description: "Nebelwüste" },
                        "pd_mediterranean_world_effect": { name: "Mediterranean World", description: "Mediterranes Klima" },
                        "pd_badlands_world_effect": { name: "Badlands World", description: "Zerklüftete Landschaften" },
                        "pd_succulent_world_effect": { name: "Succulent World", description: "Sukkulenten-dominiert" },
                        "pd_striped_world_effect": { name: "Striped World", description: "Gestreifte Landschaften" },
                        "pd_amethyst_world_effect": { name: "Amethyst World", description: "Amethyst-Formationen" },
                        "pd_coral_world_effect": { name: "Coral World", description: "Fossile Korallenriffe" },
                        "pd_primal_world_effect": { name: "Primal World", description: "Urzeitliche Landschaften" }
                    },
                    // Savannah-based modifiers
                    pc_savannah: {
                        "pd_steppe_world_effect": { name: "Steppe World", description: "Weite Graslandschaften" },
                        "pd_prairie_world_effect": { name: "Prairie World", description: "Prärie-Ökosystem" },
                        "pd_veld_world_effect": { name: "Veld World", description: "Afrikanische Savanne" },
                        "pd_semi_arid_world_effect": { name: "Semi-Arid World", description: "Halbtrockenes Klima" },
                        "pd_aspen_world_effect": { name: "Aspen World", description: "Zitterpappel-Wälder" },
                        "pd_sandstone_world_effect": { name: "Sandstone World", description: "Sandstein-Formationen" },
                        "pd_turquoise_world_effect": { name: "Turquoise World", description: "Türkisfarbene Landschaften" },
                        "pd_calcite_world_effect": { name: "Calcite World", description: "Kalzit-Kristalle" },
                        "pd_monsoon_world_effect": { name: "Monsoon World", description: "Monsun-Klima" },
                        "pd_supercontinent_world_effect": { name: "Supercontinent World", description: "Riesiger Kontinent" },
                        "pd_sinkhole_world_effect": { name: "Sinkhole World", description: "Dolinen und Senklöcher" }
                    },
                    // Arctic-based modifiers
                    pc_arctic: {
                        "pd_cold_desert_world_effect": { name: "Cold Desert World", description: "Kalte Wüste" },
                        "pd_glacial_world_effect": { name: "Glacial World", description: "Gletscher-bedeckt" },
                        "pd_antarctic_world_effect": { name: "Antarctic World", description: "Antarktische Bedingungen" },
                        "pd_aeolian_world_effect": { name: "Aeolian World", description: "Windgeformte Landschaften" },
                        "pd_ice_spike_world_effect": { name: "Ice Spike World", description: "Eisstachel-Formationen" },
                        "pd_crevasse_world_effect": { name: "Crevasse World", description: "Gletscherspalten" },
                        "pd_ice_dunes_world_effect": { name: "Ice Dunes World", description: "Eisdünen" },
                        "pd_ferrospring_world_effect": { name: "Ferrospring World", description: "Eisenhaltige Quellen" },
                        "pd_storm_world_effect": { name: "Storm World", description: "Permanente Stürme" },
                        "pd_iceberg_world_effect": { name: "Iceberg World", description: "Schwimmende Eisberge" }
                    },
                    // Alpine-based modifiers
                    pc_alpine: {
                        "pd_boreal_world_effect": { name: "Boreal World", description: "Nordische Wälder" },
                        "pd_snow_world_effect": { name: "Snow World", description: "Schnee-bedeckt" },
                        "pd_highland_world_effect": { name: "Highland World", description: "Hochlandschaften" },
                        "pd_dune_forest_world_effect": { name: "Dune Forest World", description: "Waldige Dünen" },
                        "pd_fjord_world_effect": { name: "Fjord World", description: "Tiefe Fjorde" },
                        "pd_blossom_world_effect": { name: "Blossom World", description: "Blütenpracht" },
                        "pd_taiga_world_effect": { name: "Taiga World", description: "Nadelwald-Taiga" },
                        "pd_craton_world_effect": { name: "Craton World", description: "Alte Kontinentalplatten" },
                        "pd_glaciovolcanic_world_effect": { name: "Glaciovolcanic World", description: "Eis und Vulkane" },
                        "pd_lanthanide_world_effect": { name: "Lanthanide World", description: "Seltene Erden" }
                    },
                    // Tundra-based modifiers
                    pc_tundra: {
                        "pd_bog_world_effect": { name: "Bog World", description: "Torfmoore" },
                        "pd_mycelium_world_effect": { name: "Mycelium World", description: "Pilzmyzel-Netzwerke" },
                        "pd_mud_world_effect": { name: "Mud World", description: "Schlammige Landschaften" },
                        "pd_basalt_world_effect": { name: "Basalt World", description: "Basalt-Formationen" },
                        "pd_tuya_world_effect": { name: "Tuya World", description: "Tafelberge aus Eis" },
                        "pd_cryovolcano_world_effect": { name: "Cryovolcano World", description: "Eisvulkane" },
                        "pd_treeline_world_effect": { name: "Treeline World", description: "Baumgrenze-Ökosysteme" },
                        "pd_cryoflora_world_effect": { name: "Cryoflora World", description: "Kälte-angepasste Pflanzen" },
                        "pd_lichen_world_effect": { name: "Lichen World", description: "Flechten-dominiert" }
                    }
                }
            },
            environmental: {
                name: "Umwelt-Modifier",
                modifiers: {
                    "pm_tidal_locked": { name: "Gezeitengebunden", description: "Immer dieselbe Seite zur Sonne" },
                    "pm_asteroid_impacts": { name: "Asteroideneinschläge", description: "Regelmäßige Einschläge" },
                    "pm_unstable_weather": { name: "Instabiles Wetter", description: "Extreme Wetterschwankungen" },
                    "pm_strong_magnetic_field": { name: "Starkes Magnetfeld", description: "Schutz vor Strahlung" },
                    "pm_weak_magnetic_field": { name: "Schwaches Magnetfeld", description: "Erhöhte Strahlung" },
                    "pm_low_gravity": { name: "Niedrige Schwerkraft", description: "Geringe Gravitationskraft" },
                    "pm_high_gravity": { name: "Hohe Schwerkraft", description: "Starke Gravitationskraft" }
                }
            },
            resource: {
                name: "Ressourcen-Modifier",
                modifiers: {
                    "pm_mineral_rich": { name: "Mineralienreich", description: "+2 Mineralien aus Bergbau-Jobs" },
                    "pm_mineral_poor": { name: "Mineralienarm", description: "-1 Mineralien aus Bergbau-Jobs" },
                    "pm_energy_rich": { name: "Energiereich", description: "+2 Energie aus Techniker-Jobs" },
                    "pm_energy_poor": { name: "Energiearm", description: "-1 Energie aus Techniker-Jobs" },
                    "pm_food_rich": { name: "Nahrungsreich", description: "+2 Nahrung aus Farmer-Jobs" },
                    "pm_food_poor": { name: "Nahrungsarm", description: "-1 Nahrung aus Farmer-Jobs" }
                }
            },
            special: {
                name: "Spezial-Modifier",
                modifiers: {
                    "pm_natural_beauty": { name: "Natürliche Schönheit", description: "+5% Glück" },
                    "pm_dangerous_wildlife": { name: "Gefährliche Tierwelt", description: "+25% Armeeaufbaugeschwindigkeit" },
                    "pm_lush": { name: "Üppig", description: "+20% Bevölkerungswachstum" },
                    "pm_bleak": { name: "Trostlos", description: "-10% Glück" },
                    "pm_irradiated": { name: "Verstrahlt", description: "-10% Gesundheit" },
                    "pm_titanic_life": { name: "Titanisches Leben", description: "+4 Gesellschaftsforschung aus Forscher-Jobs" },
                    "pm_storm_wracked": { name: "Sturmgeplagt", description: "-20% Produktivität" }
                }
            }
        };

        // Helper function to determine mod requirements and fallback classes
        function getModInfo(planetClass) {
            const gigastructuralPlanets = {
                'pc_birch': { fallback: 'pc_gaia', mod: 'gigastructures' },
                'pc_alderson': { fallback: 'pc_habitat', mod: 'gigastructures' },
                'pc_gas_giant_habitable': { fallback: 'pc_gas_giant', mod: 'gigastructures' },
                'pc_stellar_systemcraft': { fallback: 'pc_habitat', mod: 'gigastructures' },
                'pc_nicoll_dyson_beam': { fallback: 'pc_barren', mod: 'gigastructures' },
                'pc_penrose_sphere_habitable': { fallback: 'pc_habitat', mod: 'gigastructures' },
                'pc_virtual_reality': { fallback: 'pc_machine', mod: 'gigastructures' },
                'pc_pouchkinn_planet': { fallback: 'pc_gaia', mod: 'gigastructures' },
                'pc_gigastructural_shielded': { fallback: 'pc_shielded', mod: 'gigastructures' },
                'pc_quasi_stellar_obliterator': { fallback: 'pc_habitat', mod: 'gigastructures' },
                'pc_neutronium_gigaforge': { fallback: 'pc_habitat', mod: 'gigastructures' }
            };

            const planetaryDiversityPlanets = {
                // PD Enhanced Uninhabitable
                'pc_barren_cold': { fallback: 'pc_barren', mod: 'planetary_diversity' },
                'pc_hothouse': { fallback: 'pc_molten', mod: 'planetary_diversity' },
                'pc_hot_gas_giant': { fallback: 'pc_gas_giant', mod: 'planetary_diversity' },
                'pc_cold_gas_giant': { fallback: 'pc_gas_giant', mod: 'planetary_diversity' },
                'pc_dwarf_gas_giant': { fallback: 'pc_gas_giant', mod: 'planetary_diversity' },
                'pc_storm': { fallback: 'pc_gas_giant', mod: 'planetary_diversity' },
                'pc_shattered': { fallback: 'pc_barren', mod: 'planetary_diversity' },
                'pc_subglacial': { fallback: 'pc_frozen', mod: 'planetary_diversity' },
                
                // PD Uncommon Worlds
                'pc_mantle': { fallback: 'pc_molten', mod: 'planetary_diversity' },
                'pc_karst': { fallback: 'pc_continental', mod: 'planetary_diversity' },
                'pc_crystal': { fallback: 'pc_frozen', mod: 'planetary_diversity' },
                'pc_frozen_desert': { fallback: 'pc_arctic', mod: 'planetary_diversity' },
                'pc_ash': { fallback: 'pc_barren', mod: 'planetary_diversity' },
                'pc_marginal': { fallback: 'pc_barren', mod: 'planetary_diversity' },
                'pc_sandsea': { fallback: 'pc_desert', mod: 'planetary_diversity' },
                'pc_superhabitable': { fallback: 'pc_gaia', mod: 'planetary_diversity' },
                'pc_tidally_locked': { fallback: 'pc_barren', mod: 'planetary_diversity' },
                'pc_technoorganic': { fallback: 'pc_machine', mod: 'planetary_diversity' },

                // PD Gaia Worlds
                'pd_wet_gaia_world': { fallback: 'pc_gaia', mod: 'planetary_diversity' },
                'pd_dry_gaia_world': { fallback: 'pc_gaia', mod: 'planetary_diversity' },
                'pd_cold_gaia_world': { fallback: 'pc_gaia', mod: 'planetary_diversity' },
                
                // PD Cave/Superhabitable/Tidally Locked variants
                'pd_wet_cave_world': { fallback: 'pc_continental', mod: 'planetary_diversity' },
                'pd_dry_cave_world': { fallback: 'pc_desert', mod: 'planetary_diversity' },
                'pd_cold_cave_world': { fallback: 'pc_arctic', mod: 'planetary_diversity' },
                'pd_wet_superhabitable_world': { fallback: 'pc_gaia', mod: 'planetary_diversity' },
                'pd_dry_superhabitable_world': { fallback: 'pc_gaia', mod: 'planetary_diversity' },
                'pd_cold_superhabitable_world': { fallback: 'pc_gaia', mod: 'planetary_diversity' },
                'pd_wet_tidally_locked_world': { fallback: 'pc_continental', mod: 'planetary_diversity' },
                'pd_dry_tidally_locked_world': { fallback: 'pc_desert', mod: 'planetary_diversity' },
                'pd_cold_tidally_locked_world': { fallback: 'pc_arctic', mod: 'planetary_diversity' }
            };

            if (gigastructuralPlanets[planetClass]) {
                return gigastructuralPlanets[planetClass];
            }
            if (planetaryDiversityPlanets[planetClass]) {
                return planetaryDiversityPlanets[planetClass];
            }
            return null;
        }

        // ============================================================
        // [SECTION-03] SYSTEM-VARIATIONEN (ORIGINS)
        // ============================================================
        // HIER: Definition aller Origin-Varianten (Sol Commonwealth, etc.)
        // ÄNDERN: Um neue Origins hinzuzufügen (z.B. Shattered Ring)
        // TIPP: Kopiere eine bestehende Variante und passe sie an

        const systemVariations = {
            standard: {
                id: 'standard',
                enabled: true,
                locked: true,
                suffix: '',
                displayName: 'Standard (Custom Empire)',
                description: 'Standard-Variante für wählbare Custom Empires',
                icon: '⭐',
                modifications: {
                    system: {
                        usage: 'custom_empire',
                        flags: ['empire_home_system', 'sol_system', 'sol']
                    }
                }
            },
            
            commonwealth: {
                id: 'commonwealth',
                enabled: false,
                suffix: '_commonwealth',
                systemNameOverride: 'com_sol_system',
                displayName: 'Commonwealth of Man',
                description: 'Spawnt als NPC-System wenn Commonwealth gespielt wird',
                icon: '🏛️',
                modifications: {
                    system: {
                        usage: 'misc_system_init',
                        flags: ['sol_system', 'com_sol', 'sol', 'empire_home_system'],
                        usageOdds: {
                            base: 0,
                            condition: 'has_country_flag = human_2',
                            add: 99999
                        }
                    }
                }
            },
            
            lost_colony: {
                id: 'lost_colony',
                enabled: false,
                suffix: '_lost_colony',
                systemNameOverride: 'lost_colony_sol_system',
                displayName: 'Lost Colony Origin',
                description: 'Sol als Parent-System für Lost Colony Origins',
                icon: '🚀',
                modifications: {
                    system: {
                        usage: 'misc_system_init',
                        flags: ['sol_system', 'lost_colony_sol', 'sol', 'empire_home_system']
                    }
                }
            },
            
            toxic_knights: {
                id: 'toxic_knights',
                enabled: false,
                suffix: '_toxic_knights',
                systemNameOverride: 'toxic_knights_sol_start',
                displayName: 'Knights of the Toxic God',
                description: 'Luna Habitat + Toxic Venus Terraforming',
                icon: '☠️',
                modifications: {
                    system: {
                        usage: 'origin',
                        flags: ['empire_home_system', 'sol_system', 'sol']
                    },
                    planets: {
                        venus: {
                            addFlags: ['toxic_terraforming_candidate']
                        },
                        earth: {
                            addFlags: ['planet_earth', 'toxic_knights_homeworld']
                        }
                    }
                }
            },
            
            fear_dark: {
                id: 'fear_dark',
                enabled: false,
                suffix: '_fear_dark',
                systemNameOverride: 'sol_system_fear_of_the_dark_system',
                displayName: 'Fear of the Dark',
                description: 'Divider (Broken Venus) + Desert Mars Haven',
                icon: '💀',
                modifications: {
                    system: {
                        usage: 'origin',
                        flags: ['empire_home_system', 'sol_system', 'sol']
                    },
                    planets: {
                        mars: {
                            changeClass: 'pc_desert',
                            addFlags: ['haven_flag', 'planet_mars']
                        },
                        earth: {
                            changeSize: 16
                        }
                    }
                }
            },
            
            nuked: {
                id: 'nuked',
                enabled: false,
                suffix: '_nuked',
                systemNameOverride: 'special_init_04',
                displayName: 'Nuclear Wasteland',
                description: 'Post-Nuclear War Earth - spawnt zufällig',
                icon: '☢️',
                modifications: {
                    system: {
                        usage: 'misc_system_init',
                        flags: ['nuked_sol', 'sol']
                    },
                    planets: {
                        earth: {
                            changeClass: 'pc_nuked',
                            addFlags: ['nuked_earth']
                        }
                    }
                }
            },
            
            mindwarden: {
                id: 'mindwarden',
                enabled: false,
                suffix: '_mindwarden',
                systemNameOverride: 'mindwarden_sol_system_init',
                displayName: 'Exiled (Mindwarden)',
                description: 'Mars as Shrouded World',
                icon: '🌀',
                modifications: {
                    system: {
                        usage: 'origin',
                        flags: ['empire_home_system', 'sol_system', 'sol', 'mindwarden_system']
                    },
                    planets: {
                        mars: {
                            changeClass: 'pc_shrouded'
                        }
                    }
                }
            }
        };

        // ============================================================
        // [SECTION-04] DOM ELEMENT REFERENZEN
        // ============================================================
        // HIER: Alle HTML-Element-Verknüpfungen
        // ÄNDERN: Wenn du neue Input-Felder im HTML hinzufügst
        // WICHTIG: ID im HTML muss mit getElementById übereinstimmen

        // DOM Elements
        const elements = {
            // Import elements
            importFile: document.getElementById('importFile'),
            importBtn: document.getElementById('importBtn'),
            clearSystemBtn: document.getElementById('clearSystemBtn'),

            // Neighbor systems elements
            neighborSystemsList: document.getElementById('neighborSystemsList'),
            // ✅ KORRIGIERT: Neue Felder für hyperlane_jumps
            neighborHyperlaneMin: document.getElementById('neighborHyperlaneMin'),
            neighborHyperlaneMax: document.getElementById('neighborHyperlaneMax'),
            addNeighborBtn: document.getElementById('addNeighborBtn'),
            neighborTrigger: document.getElementById('neighborTrigger'),
            neighborMode: document.getElementById('neighborMode'),
            newNeighborReference: document.getElementById('newNeighborReference'),

            // Asteroid belt elements - HINZUFÜGEN
            asteroidBeltList: document.getElementById('asteroidBeltList'),
            newAsteroidBeltType: document.getElementById('newAsteroidBeltType'),
            newAsteroidBeltRadius: document.getElementById('newAsteroidBeltRadius'),
            addAsteroidBeltBtn: document.getElementById('addAsteroidBeltBtn'),
            
            // System elements
            systemName: document.getElementById('systemName'),
            systemDisplayName: document.getElementById('systemDisplayName'),
            systemClass: document.getElementById('systemClass'),
            systemUsage: document.getElementById('systemUsage'),
            
            // Planet management
            addPlanetBtn: document.getElementById('addPlanetBtn'),
            moveUpBtn: document.getElementById('moveUpBtn'),
            moveDownBtn: document.getElementById('moveDownBtn'),
            planetList: document.getElementById('planetList'),
            
            // Planet details
            celestialDetails: document.getElementById('celestialDetails'),
            noCelestialSelected: document.getElementById('noCelestialSelected'),
            celestialType: document.getElementById('celestialType'),
            celestialPosition: document.getElementById('celestialPosition'),
            celestialName: document.getElementById('celestialName'),
            celestialDisplayName: document.getElementById('celestialDisplayName'),
            celestialClass: document.getElementById('celestialClass'),
            celestialSize: document.getElementById('celestialSize'),
            celestialOrbitDistance: document.getElementById('celestialOrbitDistance'),
            orbitAngleType: document.getElementById('orbitAngleType'),
            celestialOrbitAngle: document.getElementById('celestialOrbitAngle'),
            celestialOrbitAngleMin: document.getElementById('celestialOrbitAngleMin'),
            celestialOrbitAngleMax: document.getElementById('celestialOrbitAngleMax'),
            celestialChangeOrbit: document.getElementById('celestialChangeOrbit'),
            celestialHasRing: document.getElementById('celestialHasRing'),
            celestialIsStartingPlanet: document.getElementById('celestialIsStartingPlanet'),
            addMoonBtn: document.getElementById('addMoonBtn'),
            deleteCelestialBtn: document.getElementById('deleteCelestialBtn'),
            fixedAngleControl: document.getElementById('fixedAngleControl'),
            rangeAngleControl: document.getElementById('rangeAngleControl'),
            
            // Modifier system
            modifierList: document.getElementById('modifierList'),
            modifierCategory: document.getElementById('modifierCategory'),
            modifierType: document.getElementById('modifierType'),
            addModifierBtn: document.getElementById('addModifierBtn'),
            
            // Visualizer
            visualizer: document.getElementById('visualizer'),
            zoomInBtn: document.getElementById('zoomInBtn'),
            zoomOutBtn: document.getElementById('zoomOutBtn'),
            resetViewBtn: document.getElementById('resetViewBtn'),
            
            // Export
            exportTxt: document.getElementById('exportTxt'),
            exportYml: document.getElementById('exportYml'),
            downloadTxtBtn: document.getElementById('downloadTxtBtn'),
            downloadYmlBtn: document.getElementById('downloadYmlBtn')
        };

        // ============================================================
        // [SECTION-05] MODIFIER SYSTEM FUNKTIONEN
        // ============================================================
        // HIER: Logik für Planet-Modifier (Planetary Diversity, etc.)
        // ÄNDERN: Um Modifier-Verhalten anzupassen
        // WICHTIG: Achte auf Kompatibilität mit Planetenklassen

        // Modifier System Functions
        function initializeModifierSystem() {
            elements.modifierCategory.addEventListener('change', updateModifierTypes);
            elements.modifierType.addEventListener('change', enableAddModifierButton);
            elements.addModifierBtn.addEventListener('click', addModifierToPlanet);
        }

        function updateModifierTypes() {
            const category = elements.modifierCategory.value;
            const modifierSelect = elements.modifierType;
            
            // Clear existing options
            modifierSelect.innerHTML = '<option value="">-- Modifier wählen --</option>';
            
            if (category && MODIFIERS[category]) {
                modifierSelect.disabled = false;
                
                if (category === 'planetary_diversity') {
                    // For PD, only show modifiers compatible with selected planet class
                    const selectedClass = selectedPlanet ? selectedPlanet.class : null;
                    
                    if (selectedClass && MODIFIERS[category].modifiers[selectedClass]) {
                        Object.entries(MODIFIERS[category].modifiers[selectedClass]).forEach(([key, modifier]) => {
                            const option = document.createElement('option');
                            option.value = key;
                            option.textContent = modifier.name;
                            option.title = modifier.description;
                            modifierSelect.appendChild(option);
                        });
                    } else if (selectedClass) {
                        // Show message if no PD modifiers available for this class
                        const option = document.createElement('option');
                        option.value = '';
                        option.textContent = `Keine PD-Modifier für ${getClassDisplayName(selectedClass)} verfügbar`;
                        option.disabled = true;
                        modifierSelect.appendChild(option);
                    } else {
                        const option = document.createElement('option');
                        option.value = '';
                        option.textContent = 'Erst Planeten auswählen';
                        option.disabled = true;
                        modifierSelect.appendChild(option);
                    }
                } else {
                    // For other categories, show all modifiers
                    Object.entries(MODIFIERS[category].modifiers).forEach(([key, modifier]) => {
                        const option = document.createElement('option');
                        option.value = key;
                        option.textContent = modifier.name;
                        option.title = modifier.description;
                        modifierSelect.appendChild(option);
                    });
                }
            } else {
                modifierSelect.disabled = true;
            }
            
            elements.addModifierBtn.disabled = true;
        }

        function enableAddModifierButton() {
            elements.addModifierBtn.disabled = !elements.modifierType.value;
        }

        function addModifierToPlanet() {
            if (!selectedPlanet || !elements.modifierType.value) return;

            const modifierKey = elements.modifierType.value;
            const category = elements.modifierCategory.value;
            
            let modifierInfo;
            if (category === 'planetary_diversity' && selectedPlanet.class) {
                modifierInfo = MODIFIERS[category].modifiers[selectedPlanet.class][modifierKey];
            } else {
                modifierInfo = MODIFIERS[category].modifiers[modifierKey];
            }

            if (!modifierInfo) {
                showNotification('Fehler: Modifier-Information nicht gefunden!');
                return;
            }

            // Check if modifier already exists
            if (!selectedPlanet.modifiers) {
                selectedPlanet.modifiers = [];
            }

            if (selectedPlanet.modifiers.some(m => m.key === modifierKey)) {
                showNotification('Dieser Modifier ist bereits hinzugefügt!');
                return;
            }

            selectedPlanet.modifiers.push({
                key: modifierKey,
                name: modifierInfo.name,
                description: modifierInfo.description,
                category: category,
                baseClass: category === 'planetary_diversity' ? selectedPlanet.class : null
            });

            updateModifierList();
            updatePlanetList();
            updateOutput();
            renderVisualizer();
            
            // Reset selection
            elements.modifierCategory.value = '';
            elements.modifierType.innerHTML = '<option value="">-- Erst Kategorie wählen --</option>';
            elements.modifierType.disabled = true;
            elements.addModifierBtn.disabled = true;
            
            showNotification(`Modifier "${modifierInfo.name}" hinzugefügt!`);
        }

        function updateModifierList() {
            if (!selectedPlanet || !selectedPlanet.modifiers || selectedPlanet.modifiers.length === 0) {
                elements.modifierList.innerHTML = '<p class="text-gray-400 text-sm">Keine Modifier ausgewählt</p>';
                return;
            }

            elements.modifierList.innerHTML = '';
            selectedPlanet.modifiers.forEach((modifier, index) => {
                const modifierItem = document.createElement('div');
                modifierItem.className = 'modifier-item';
                modifierItem.innerHTML = `
                    <div>
                        <span class="font-medium text-green-300">${modifier.name}</span>
                        <p class="text-xs text-gray-400">${modifier.description}</p>
                    </div>
                    <button class="stellaris-btn stellaris-btn-danger text-xs px-2 py-1" onclick="removeModifier(${index})">
                        Entfernen
                    </button>
                `;
                elements.modifierList.appendChild(modifierItem);
            });
        }

        function removeModifier(index) {
            if (selectedPlanet && selectedPlanet.modifiers) {
                selectedPlanet.modifiers.splice(index, 1);
                updateModifierList();
                updateOutput();
            }
        }

        // ============================================================
        // [SECTION-06] FLAG MANAGEMENT (SYSTEM & PLANETEN)
        // ============================================================
        // HIER: Funktionen zum Hinzufügen/Entfernen von Flags
        // ÄNDERN: Wenn du Flag-Validierung hinzufügen willst
        // BEISPIEL: Verhindere bestimmte Flag-Kombinationen

        // ============================================
        // V7 ADDITION - Flag Management Functions
        // ============================================

        function addSystemFlag() {
            const flagInput = document.getElementById('newSystemFlag');
            const flag = flagInput.value.trim().replace(/\s+/g, '_');
            
            if (flag && !solarSystem.flags.includes(flag)) {
                solarSystem.flags.push(flag);
                updateSystemFlagsList();
                updateOutput();
                flagInput.value = '';
                showNotification(`System-Flag "${flag}" hinzugefügt`);
            }
        }

        function quickAddSystemFlag(flag) {
            if (!solarSystem.flags.includes(flag)) {
                solarSystem.flags.push(flag);
                updateSystemFlagsList();
                updateOutput();
                showNotification(`System-Flag "${flag}" hinzugefügt`);
            }
        }

        function removeSystemFlag(index) {
            const flag = solarSystem.flags[index];
            solarSystem.flags.splice(index, 1);
            updateSystemFlagsList();
            updateOutput();
            showNotification(`System-Flag "${flag}" entfernt`);
        }

        function updateSystemFlagsList() {
            const list = document.getElementById('systemFlagsList');
            
            if (!solarSystem.flags || solarSystem.flags.length === 0) {
                list.innerHTML = '<p class="text-gray-400 text-sm">Keine System-Flags gesetzt</p>';
                return;
            }
            
            list.innerHTML = '';
            solarSystem.flags.forEach((flag, index) => {
                const item = document.createElement('div');
                item.className = 'flag-item';
                item.innerHTML = `
                    <div class="flex items-center gap-2">
                        <span class="text-xl">🏴</span>
                        <code class="text-sm">${flag}</code>
                    </div>
                    <button class="stellaris-btn stellaris-btn-danger text-xs px-2 py-1" 
                            onclick="removeSystemFlag(${index})">
                        ✕
                    </button>
                `;
                list.appendChild(item);
            });
        }

        function addPlanetFlag() {
            if (!selectedPlanet) return;
            
            const flagInput = document.getElementById('newPlanetFlag');
            const flag = flagInput.value.trim().replace(/\s+/g, '_');
            
            if (flag) {
                if (!selectedPlanet.flags) selectedPlanet.flags = [];
                
                if (!selectedPlanet.flags.includes(flag)) {
                    selectedPlanet.flags.push(flag);
                    updatePlanetFlagsList();
                    updatePlanetList();
                    updateOutput();
                    flagInput.value = '';
                    showNotification(`Planet-Flag "${flag}" hinzugefügt`);
                }
            }
        }

        function removePlanetFlag(index) {
            if (selectedPlanet && selectedPlanet.flags) {
                const flag = selectedPlanet.flags[index];
                selectedPlanet.flags.splice(index, 1);
                updatePlanetFlagsList();
                updatePlanetList();
                updateOutput();
                showNotification(`Planet-Flag "${flag}" entfernt`);
            }
        }

        function updatePlanetFlagsList() {
            const list = document.getElementById('planetFlagsList');
            
            if (!selectedPlanet || !selectedPlanet.flags || selectedPlanet.flags.length === 0) {
                list.innerHTML = '<p class="text-gray-400 text-sm">Keine Planet-Flags gesetzt</p>';
                return;
            }
            
            list.innerHTML = '';
            selectedPlanet.flags.forEach((flag, index) => {
                const item = document.createElement('div');
                item.className = 'flag-item';
                item.innerHTML = `
                    <div class="flex items-center gap-2">
                        <span class="text-xl">🏴</span>
                        <code class="text-sm">${flag}</code>
                    </div>
                    <button class="stellaris-btn stellaris-btn-danger text-xs px-2 py-1" 
                            onclick="removePlanetFlag(${index})">
                        ✕
                    </button>
                `;
                list.appendChild(item);
            });
        }

        // ============================================================
        // [SECTION-07] SYSTEM-VARIATIONEN FUNKTIONEN
        // ============================================================
        // HIER: Rendering und Verwaltung von Origin-Varianten
        // ÄNDERN: Um das Aussehen der Variations-Cards zu ändern
        // TIPP: Suche nach "variation-card" im CSS

        // ============================================
        // V7 ADDITION - Variation System Functions
        // ============================================

        function renderVariationsList() {
            const container = document.getElementById('variationsList');
            if (!container) return;
            
            container.innerHTML = '';
            
            Object.entries(systemVariations).forEach(([key, variation]) => {
                const card = document.createElement('div');
                card.className = `variation-card ${variation.enabled ? 'enabled' : ''}`;
                
                const isLocked = variation.locked || false;
                const disabled = isLocked ? 'disabled' : '';
                const checkedAttr = variation.enabled ? 'checked' : '';
                
                card.innerHTML = `
                    <div class="stellaris-panel p-4">
                        <div class="flex items-start justify-between mb-3">
                            <label class="flex items-center cursor-pointer ${isLocked ? 'cursor-not-allowed' : ''}">
                                <input type="checkbox" 
                                       ${disabled}
                                       ${checkedAttr}
                                       onchange="toggleVariation('${key}')"
                                       class="mr-3 w-5 h-5">
                                <div>
                                    <div class="flex items-center gap-2">
                                        <span class="text-2xl">${variation.icon}</span>
                                        <span class="font-semibold text-lg">${variation.displayName}</span>
                                    </div>
                                    ${isLocked ? '<span class="text-xs text-yellow-400">⭐ Immer aktiv</span>' : ''}
                                </div>
                            </label>
                        </div>
                        
                        ${variation.systemNameOverride ? `
                            <div class="text-xs text-gray-400 mb-2 font-mono bg-black/20 px-2 py-1 rounded">
                                → ${variation.systemNameOverride}
                            </div>
                        ` : ''}
                        
                        <p class="text-sm text-gray-300 mb-3">${variation.description}</p>
                        
                        ${renderVariationChanges(variation)}
                    </div>
                `;
                
                container.appendChild(card);
            });
            
            updateVariationCount();
        }

        function renderVariationChanges(variation) {
            const mods = variation.modifications;
            if (!mods) return '';
            
            let html = '<div class="variation-changes">';
            
            if (mods.system) {
                html += '<div class="mb-2"><strong class="text-blue-300">System:</strong></div>';
                
                if (mods.system.usage) {
                    html += `<div class="ml-2 text-xs">📋 usage: <code>${mods.system.usage}</code></div>`;
                }
                
                if (mods.system.flags && mods.system.flags.length > 0) {
                    const displayFlags = mods.system.flags.slice(0, 2);
                    const moreCount = mods.system.flags.length - 2;
                    html += `<div class="ml-2 text-xs">🏴 flags: <code>${displayFlags.join(', ')}</code>`;
                    if (moreCount > 0) html += ` <span class="text-gray-500">+${moreCount} mehr</span>`;
                    html += '</div>';
                }
                
                if (mods.system.usageOdds) {
                    html += `<div class="ml-2 text-xs">🎲 Conditional spawn</div>`;
                }
            }
            
            if (mods.planets) {
                const planetCount = Object.keys(mods.planets).length;
                html += `<div class="mt-2 mb-2"><strong class="text-purple-300">Planeten (${planetCount} geändert):</strong></div>`;
                
                Object.entries(mods.planets).forEach(([planetName, changes]) => {
                    const planetDisplay = planetName.charAt(0).toUpperCase() + planetName.slice(1);
                    html += `<div class="ml-2 text-xs mb-1">`;
                    html += `<span class="text-yellow-400">•</span> <strong>${planetDisplay}:</strong> `;
                    
                    const changesList = [];
                    if (changes.changeClass) changesList.push(`Klasse → ${changes.changeClass}`);
                    if (changes.changeSize) changesList.push(`Size → ${changes.changeSize}`);
                    if (changes.addFlags) changesList.push(`+${changes.addFlags.length} flags`);
                    
                    html += changesList.join(', ');
                    html += '</div>';
                });
            }
            
            html += '</div>';
            return html;
        }

        function toggleVariation(key) {
            const variation = systemVariations[key];
            if (variation.locked) return;
            
            variation.enabled = !variation.enabled;
            renderVariationsList();
            updateOutput();
            
            const status = variation.enabled ? 'aktiviert' : 'deaktiviert';
            showNotification(`Variante "${variation.displayName}" ${status}`);
        }

        function updateVariationCount() {
            const count = Object.values(systemVariations).filter(v => v.enabled).length;
            const countElement = document.getElementById('variationCount');
            if (countElement) {
                countElement.textContent = count;
            }
        }

        // ============================================================
        // [SECTION-08] PLANET MANAGEMENT FUNKTIONEN
        // ============================================================
        // HIER: Hinzufügen, Auswählen, Löschen von Planeten
        // ÄNDERN: Um Standard-Planetenwerte anzupassen
        // TIPP: Siehe addPlanet() für neue Planet-Defaults

        // Planet Management Functions
        function addPlanet() {
            const newPlanet = {
                id: nextCelestialId++,
                type: 'planet',
                name: `planet_${nextCelestialId - 1}`,
                displayName: `Planet ${nextCelestialId - 1}`,
                class: 'pc_continental',
                size: 16,
                orbitDistance: solarSystem.planets.length === 0 ? 40 : 0,
                orbitAngleType: 'range',
                orbitAngleMin: 90,
                orbitAngleMax: 270,
                changeOrbit: 0,
                hasRing: false,
                isStartingPlanet: false,
                modifiers: [],
                moons: [],
                flags: [],
                preventAnomaly: false,
                entityOverride: null
            };

            solarSystem.planets.push(newPlanet);
            updatePlanetList();
            selectPlanet(newPlanet.id);
            updateOutput();
            renderVisualizer();
        }

        function selectPlanet(id) {
            selectedPlanet = findPlanetById(id);
            if (selectedPlanet) {
                elements.celestialDetails.classList.remove('hidden');
                elements.noCelestialSelected.classList.add('hidden');

                const planetIndex = solarSystem.planets.findIndex(p => p.id === selectedPlanet.id);
                
                // Populate details panel
                elements.celestialType.value = selectedPlanet.type === 'planet' ? 'Planet' : 'Mond';
                elements.celestialPosition.value = selectedPlanet.type === 'planet' ? 
                    `Position ${planetIndex + 1}` : `Mond von ${findParentPlanet(selectedPlanet).displayName}`;
                elements.celestialName.value = selectedPlanet.name;
                elements.celestialDisplayName.value = selectedPlanet.displayName;
                elements.celestialClass.value = selectedPlanet.class;
                elements.celestialSize.value = selectedPlanet.size;
                elements.celestialOrbitDistance.value = selectedPlanet.orbitDistance;
                elements.orbitAngleType.value = selectedPlanet.orbitAngleType || 'range';
                elements.celestialOrbitAngle.value = selectedPlanet.orbitAngle || 0;
                elements.celestialOrbitAngleMin.value = selectedPlanet.orbitAngleMin || 90;
                elements.celestialOrbitAngleMax.value = selectedPlanet.orbitAngleMax || 270;
                elements.celestialChangeOrbit.value = selectedPlanet.changeOrbit || 0;
                elements.celestialHasRing.checked = selectedPlanet.hasRing || false;
                elements.celestialIsStartingPlanet.checked = selectedPlanet.isStartingPlanet || false;

                // V7 ADDITION - Update new fields
                if (elements.celestialPreventAnomaly) {
                    elements.celestialPreventAnomaly.checked = selectedPlanet.preventAnomaly || false;
                }
                if (elements.celestialEntity) {
                    elements.celestialEntity.value = selectedPlanet.entityOverride || '';
                }

                // Toggle angle controls
                const isRange = selectedPlanet.orbitAngleType === 'range';
                elements.fixedAngleControl.classList.toggle('hidden', isRange);
                elements.rangeAngleControl.classList.toggle('hidden', !isRange);

                // Update modifier list and reset modifier selection
                updateModifierList();
                elements.modifierCategory.value = '';
                elements.modifierType.innerHTML = '<option value="">-- Erst Kategorie wählen --</option>';
                elements.modifierType.disabled = true;
                elements.addModifierBtn.disabled = true;

                // Enable/disable buttons
                elements.addMoonBtn.disabled = selectedPlanet.type !== 'planet';
                elements.moveUpBtn.disabled = planetIndex <= 0 || selectedPlanet.type === 'moon';
                elements.moveDownBtn.disabled = planetIndex >= solarSystem.planets.length - 1 || selectedPlanet.type === 'moon';

                updatePlanetList();
            } else {
                deselectPlanet();
            }
        }

        function deselectPlanet() {
            selectedPlanet = null;
            elements.celestialDetails.classList.add('hidden');
            elements.noCelestialSelected.classList.remove('hidden');
            elements.addMoonBtn.disabled = true;
            elements.moveUpBtn.disabled = true;
            elements.moveDownBtn.disabled = true;
            updatePlanetList();
        }

        function findPlanetById(id) {
            for (const planet of solarSystem.planets) {
                if (planet.id === id) return planet;
                if (planet.moons) {
                    for (const moon of planet.moons) {
                        if (moon.id === id) return moon;
                    }
                }
            }
            return null;
        }

        function findParentPlanet(moon) {
            for (const planet of solarSystem.planets) {
                if (planet.moons && planet.moons.some(m => m.id === moon.id)) {
                    return planet;
                }
            }
            return null;
        }

        // ============================================================
        // [SECTION-09] NACHBARSYSTEM MANAGEMENT
        // ============================================================
        // HIER: Alle Funktionen für Nachbarsysteme
        // ÄNDERN: Um neue Nachbarsystem-Features hinzuzufügen
        // WICHTIG: Unterscheide zwischen 'reference' und 'custom' Modus
        // 
        // UNTERFUNKTIONEN:
        // - addNeighborSystem()           → Nachbarsystem hinzufügen
        // - updateNeighborSystemsList()   → Liste aktualisieren
        // - editNeighborSystem()          → Bestehende bearbeiten
        // - removeNeighborSystem()        → Löschen
        // - toggleNeighborCustomFields()  → UI zwischen Modi umschalten
        // - clearNeighborInputs()         → Formular zurücksetzen

        // Import/Export Functions
        function importSystem() {
            const file = elements.importFile.files[0];
            if (!file) {
                showNotification('Bitte wählen Sie eine Datei aus.');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const parser = new StellarisSystemParser();
                    const parsedSystem = parser.parse(e.target.result);
                    
                    // Load parsed data into the editor
                    loadSystemData(parsedSystem);
                    showNotification('System erfolgreich importiert!');
                } catch (error) {
                    showNotification('Fehler beim Import: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        function loadSystemData(systemData) {
            // Clear existing data
            clearSystem();
            
            // Load basic properties
            solarSystem.name = systemData.name;
            solarSystem.displayName = systemData.displayName;
            solarSystem.class = systemData.class;
            solarSystem.usage = systemData.usage;

            elements.systemName.value = solarSystem.name;
            elements.systemDisplayName.value = solarSystem.displayName;
            elements.systemClass.value = solarSystem.class;
            elements.systemUsage.value = solarSystem.usage;

            // Load neighbor systems
            systemData.neighborSystems.forEach(neighbor => {
                solarSystem.neighborSystems.push({
                    id: Date.now() + Math.random(),
                    distance: neighbor.distance,
                    initializer: neighbor.initializer
                });
            });

            // Load asteroid belts
            systemData.asteroidBelts.forEach(belt => {
                solarSystem.asteroidBelts.push({
                    id: Date.now() + Math.random(),
                    type: belt.type,
                    radius: belt.radius
                });
            });

            // Load planets
            systemData.planets.forEach(planet => {
                nextCelestialId = Math.max(nextCelestialId, planet.id + 1);
                solarSystem.planets.push(planet);
            });

            // Update UI
            updateNeighborSystemsList();
            updateAsteroidBeltList();
            updatePlanetList();
            updateOutput();
            renderVisualizer();
        }

        function clearSystem() {
            solarSystem = {
                name: 'my_custom_system',
                displayName: 'Mein Sonnensystem',
                class: 'sc_g',
                usage: 'custom_empire',
                neighborSystems: [],
                asteroidBelts: [],
                planets: []
            };
            
            selectedPlanet = null;
            nextCelestialId = 1;
            
            // Reset UI
            elements.systemName.value = solarSystem.name;
            elements.systemDisplayName.value = solarSystem.displayName;
            elements.systemClass.value = solarSystem.class;
            elements.systemUsage.value = solarSystem.usage;
            
            updateNeighborSystemsList();
            updateAsteroidBeltList();
            updatePlanetList();
            updateOutput();
            renderVisualizer();
            deselectPlanet();
            
            showNotification('System geleert!');
        }


        // ============================================================
        // [SECTION-09] NACHBARSYSTEM MANAGEMENT
        // ============================================================
        // (Siehe Marker oben für Details)

        /**
         * ✅ KORRIGIERT: Nachbarsystem hinzufügen mit korrekter Datenstruktur
         */
        function addNeighborSystem() {
            const mode = document.getElementById('neighborMode').value;
            
            let newNeighbor = {
                id: Date.now(),
                mode: mode,
                // ✅ KORRIGIERT: hyperlaneJumps statt distance
                hyperlaneJumps: { 
                    min: parseInt(document.getElementById('neighborHyperlaneMin')?.value || 1),
                    max: parseInt(document.getElementById('neighborHyperlaneMax')?.value || 3)
                },
                trigger: document.getElementById('neighborTrigger')?.value.trim() || null
            };
            
            if (mode === 'reference') {
                // Referenz-Modus
                const reference = document.getElementById('newNeighborReference').value.trim();
                if (!reference) {
                    showNotification('⚠️ Bitte geben Sie eine System-Referenz ein!');
                    return;
                }
                newNeighbor.initializer = reference;
            } else {
                // Custom-Modus
                const customName = document.getElementById('customNeighborName').value.trim();
                const customStarClass = document.getElementById('customNeighborStarClass').value;
                
                if (!customName) {
                    showNotification('⚠️ Bitte geben Sie einen Systemnamen ein!');
                    return;
                }
                
                newNeighbor.name = customName;
                newNeighbor.starClass = customStarClass;
                
                // ✅ NEU: Asteroidengürtel sammeln
                newNeighbor.asteroidBelts = [];
                document.querySelectorAll('#customNeighborAsteroidsList .neighbor-belt-item').forEach(belt => {
                    newNeighbor.asteroidBelts.push({
                        type: belt.querySelector('[data-field="type"]').value,
                        radius: parseInt(belt.querySelector('[data-field="radius"]').value)
                    });
                });
                
                // ✅ ERWEITERT: Planeten mit Monden sammeln
                newNeighbor.planets = [];
                document.querySelectorAll('#customNeighborPlanetsList .neighbor-planet-item').forEach(planet => {
                    const planetType = planet.dataset.type;
                    
                    if (planetType === 'asteroid_group') {
                        newNeighbor.planets.push({
                            type: 'asteroid_group',
                            class: planet.querySelector('[data-field="class"]').value,
                            countMin: parseInt(planet.querySelector('[data-field="countMin"]').value),
                            countMax: parseInt(planet.querySelector('[data-field="countMax"]').value)
                        });
                    } else {
                        const planetData = {
                            type: 'single',
                            name: planet.querySelector('[data-field="name"]').value,
                            class: planet.querySelector('[data-field="class"]').value,
                            size: parseInt(planet.querySelector('[data-field="size"]').value),
                            hasRing: false,
                            moons: []
                        };
                        
                        // Monde sammeln
                        planet.querySelectorAll('.moon-item').forEach(moon => {
                            planetData.moons.push({
                                name: moon.querySelector('[data-field="name"]').value,
                                class: moon.querySelector('[data-field="class"]').value,
                                size: parseInt(moon.querySelector('[data-field="size"]').value),
                                orbitDistance: 5
                            });
                        });
                        
                        newNeighbor.planets.push(planetData);
                    }
                });
            }
            
            solarSystem.neighborSystems.push(newNeighbor);
            updateNeighborSystemsList();
            clearNeighborInputs();
            updateOutput();
            renderVisualizer();
            showNotification(`✅ Nachbarsystem "${newNeighbor.name || newNeighbor.initializer}" hinzugefügt!`);
        }

        function clearNeighborInputs() {
            // ✅ KORRIGIERT: Richtige Felder zurücksetzen
            const hyperlaneMin = document.getElementById('neighborHyperlaneMin');
            const hyperlaneMax = document.getElementById('neighborHyperlaneMax');
            const triggerInput = document.getElementById('neighborTrigger');
            const referenceInput = document.getElementById('newNeighborReference');
            const customNameInput = document.getElementById('customNeighborName');
            const customStarClass = document.getElementById('customNeighborStarClass');
            
            if (hyperlaneMin) hyperlaneMin.value = 1;
            if (hyperlaneMax) hyperlaneMax.value = 3;
            if (triggerInput) triggerInput.value = '';
            if (referenceInput) referenceInput.value = '';
            if (customNameInput) customNameInput.value = '';
            if (customStarClass) customStarClass.value = 'sc_g';
            
            // Clear custom asteroid belts
            const asteroidsList = document.getElementById('customNeighborAsteroidsList');
            if (asteroidsList) {
                asteroidsList.innerHTML = '<p class="text-gray-400 text-xs">Keine Gürtel definiert</p>';
            }
            
            // Clear custom planet list
            const planetsList = document.getElementById('customNeighborPlanetsList');
            if (planetsList) {
                planetsList.innerHTML = '<p class="text-gray-400 text-xs">Keine Planeten definiert</p>';
            }
        }

        /**
         * ✅ NEU: Toggle zwischen Reference und Custom Modus
         */
        function toggleNeighborCustomFields() {
            const mode = document.getElementById('neighborMode').value;
            const referenceFields = document.getElementById('referenceNeighborFields');
            const customFields = document.getElementById('customNeighborFields');
            
            if (mode === 'reference') {
                referenceFields.classList.remove('hidden');
                customFields.classList.add('hidden');
            } else {
                referenceFields.classList.add('hidden');
                customFields.classList.remove('hidden');
            }
        }

        /**
         * ✅ NEU: Asteroidengürtel zu Draft-Nachbarsystem hinzufügen
         */
        function addNeighborAsteroidBelt() {
            const beltList = document.getElementById('customNeighborAsteroidsList');
            const existingBelts = beltList.querySelectorAll('.neighbor-belt-item').length;
            
            if (existingBelts === 0) {
                beltList.innerHTML = '';
            }
            
            const beltItem = document.createElement('div');
            beltItem.className = 'neighbor-belt-item bg-gray-700/50 p-2 rounded flex justify-between items-center';
            
            beltItem.innerHTML = `
                <div class="flex gap-2 flex-1">
                    <select class="stellaris-input text-xs py-1 flex-1" data-field="type">
                        <option value="rocky_asteroid_belt">Rocky Asteroid Belt</option>
                        <option value="icy_asteroid_belt">Icy Asteroid Belt</option>
                        <option value="crystal_asteroid_belt">Crystal Asteroid Belt</option>
                    </select>
                    <input type="number" placeholder="Radius" value="${90 + existingBelts * 60}" min="30" max="300"
                           class="stellaris-input text-xs py-1 w-24" data-field="radius">
                </div>
                <button onclick="removeNeighborBeltDraft(this)" 
                        class="stellaris-btn stellaris-btn-danger text-xs px-2 py-1 ml-2">
                    ✕
                </button>
            `;
            
            beltList.appendChild(beltItem);
        }

        function removeNeighborBeltDraft(button) {
            const beltList = document.getElementById('customNeighborAsteroidsList');
            button.closest('.neighbor-belt-item').remove();
            
            if (beltList.querySelectorAll('.neighbor-belt-item').length === 0) {
                beltList.innerHTML = '<p class="text-gray-400 text-xs">Keine Gürtel definiert</p>';
            }
        }

        /**
         * ✅ NEU: Planet zu Draft-Nachbarsystem hinzufügen
         */
        function addNeighborPlanetDraft(type = 'single') {
            const planetList = document.getElementById('customNeighborPlanetsList');
            const existingPlanets = planetList.querySelectorAll('.neighbor-planet-item').length;
            
            if (existingPlanets === 0) {
                planetList.innerHTML = '';
            }
            
            const planetItem = document.createElement('div');
            planetItem.className = 'neighbor-planet-item bg-gray-700/50 p-3 rounded border border-gray-600';
            planetItem.dataset.type = type;
            
            if (type === 'asteroid_group') {
                // Asteroiden-Gruppe
                planetItem.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-sm font-medium text-yellow-400">☄️ Asteroiden-Gruppe</span>
                        <button onclick="removeNeighborPlanetDraft(this)" 
                                class="stellaris-btn stellaris-btn-danger text-xs px-2 py-1">
                            ✕
                        </button>
                    </div>
                    <div class="grid grid-cols-3 gap-2">
                        <select class="stellaris-input text-xs py-1" data-field="class">
                            <option value="pc_asteroid">Rocky Asteroid</option>
                            <option value="pc_ice_asteroid">Eis-Asteroid</option>
                        </select>
                        <input type="number" placeholder="Min" value="2" min="1" max="10"
                               class="stellaris-input text-xs py-1" data-field="countMin">
                        <input type="number" placeholder="Max" value="4" min="1" max="10"
                               class="stellaris-input text-xs py-1" data-field="countMax">
                    </div>
                `;
            } else {
                // Einzelner Planet
                planetItem.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-sm font-medium text-blue-400">🌍 Planet</span>
                        <button onclick="removeNeighborPlanetDraft(this)" 
                                class="stellaris-btn stellaris-btn-danger text-xs px-2 py-1">
                            ✕
                        </button>
                    </div>
                    <div class="grid grid-cols-3 gap-2 mb-2">
                        <input type="text" placeholder="Name (optional)" value="planet_${existingPlanets + 1}"
                               class="stellaris-input text-xs py-1" data-field="name">
                        <select class="stellaris-input text-xs py-1" data-field="class">
                            <optgroup label="Bewohnbar">
                                <option value="pc_continental">Kontinental</option>
                                <option value="pc_ocean">Ozean</option>
                                <option value="pc_tropical">Tropisch</option>
                                <option value="pc_arid">Arid</option>
                                <option value="pc_desert">Wüste</option>
                                <option value="pc_savannah">Savanne</option>
                                <option value="pc_arctic">Arktisch</option>
                                <option value="pc_tundra">Tundra</option>
                                <option value="pc_alpine">Alpin</option>
                                <option value="pc_gaia">Gaia</option>
                            </optgroup>
                            <optgroup label="Unbewohnbar">
                                <option value="pc_barren">Karg</option>
                                <option value="pc_barren_cold">Karg (Kalt)</option>
                                <option value="pc_frozen">Gefroren</option>
                                <option value="pc_molten">Geschmolzen</option>
                                <option value="pc_toxic">Toxisch</option>
                            </optgroup>
                            <optgroup label="Gas-Riesen">
                                <option value="pc_gas_giant">Gasriese</option>
                                <option value="pc_hot_gas_giant">Heißer Gasriese</option>
                                <option value="pc_cold_gas_giant">Kalter Gasriese</option>
                            </optgroup>
                            <optgroup label="Asteroiden">
                                <option value="pc_asteroid">Rocky Asteroid</option>
                                <option value="pc_ice_asteroid">Eis-Asteroid</option>
                            </optgroup>
                        </select>
                        <input type="number" placeholder="Größe" value="16" min="1" max="50"
                               class="stellaris-input text-xs py-1" data-field="size">
                    </div>
                    
                    <!-- Monde-Bereich -->
                    <div class="mt-2 p-2 bg-gray-800/50 rounded border-l-2 border-purple-500/50">
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-xs text-gray-400">🌙 Monde</span>
                            <button onclick="addMoonToDraftPlanet(this)" 
                                    class="stellaris-btn stellaris-btn-secondary text-xs px-2 py-1">
                                + Mond
                            </button>
                        </div>
                        <div class="moon-list space-y-1 mt-1">
                            <!-- Monde werden hier eingefügt -->
                        </div>
                    </div>
                `;
            }
            
            planetList.appendChild(planetItem);
        }

        /**
         * ✅ NEU: Mond zu Draft-Planet hinzufügen
         */
        function addMoonToDraftPlanet(button) {
            const planetItem = button.closest('.neighbor-planet-item');
            const moonList = planetItem.querySelector('.moon-list');
            const existingMoons = moonList.querySelectorAll('.moon-item').length;
            
            const moonItem = document.createElement('div');
            moonItem.className = 'moon-item bg-gray-700/30 p-1 rounded flex gap-1 items-center';
            
            moonItem.innerHTML = `
                <span class="text-xs text-gray-400">🌙</span>
                <input type="text" placeholder="Name (optional)" value="moon_${existingMoons + 1}"
                       class="stellaris-input text-xs py-1 flex-1" data-field="name">
                <select class="stellaris-input text-xs py-1" data-field="class">
                    <option value="pc_barren_cold">Karg (Kalt)</option>
                    <option value="pc_frozen">Gefroren</option>
                    <option value="pc_barren">Karg</option>
                    <option value="pc_molten">Geschmolzen</option>
                    <option value="pc_asteroid">Asteroid</option>
                    <option value="pc_ice_asteroid">Eis-Asteroid</option>
                </select>
                <input type="number" placeholder="Größe" value="${8 - existingMoons}" min="1" max="15"
                       class="stellaris-input text-xs py-1 w-16" data-field="size">
                <button onclick="removeMoonFromDraft(this)" 
                        class="stellaris-btn stellaris-btn-danger text-xs px-1 py-1">
                    ✕
                </button>
            `;
            
            moonList.appendChild(moonItem);
        }

        function removeMoonFromDraft(button) {
            button.closest('.moon-item').remove();
        }

        function removeNeighborPlanetDraft(button) {
            const planetList = document.getElementById('customNeighborPlanetsList');
            button.closest('.neighbor-planet-item').remove();
            
            if (planetList.querySelectorAll('.neighbor-planet-item').length === 0) {
                planetList.innerHTML = '<p class="text-gray-400 text-xs">Keine Planeten definiert</p>';
            }
        }

        function addPlanetToNeighbor(neighborId) {
            const neighbor = solarSystem.neighborSystems.find(n => n.id === neighborId);
            if (!neighbor || neighbor.mode !== 'custom') return;
            
            const newPlanet = {
                id: Date.now(),
                name: `planet_${neighbor.planets.length + 1}`,
                class: 'pc_continental',
                size: 16,
                orbitDistance: neighbor.planets.length === 0 ? 40 : 25
            };
            
            neighbor.planets.push(newPlanet);
            updateNeighborSystemsList();
            updateOutput();
            showNotification('✅ Planet zum Nachbarsystem hinzugefügt!');
        }

        function addPlanetToCustomNeighborDraft() {
            // This is for the draft neighbor being created
            const planetList = document.getElementById('customNeighborPlanetsList');
            const existingPlanets = planetList.querySelectorAll('.neighbor-planet-item').length;
            
            const planetItem = document.createElement('div');
            planetItem.className = 'neighbor-planet-item bg-gray-700/50 p-2 rounded flex justify-between items-center';
            planetItem.dataset.index = existingPlanets;
            
            planetItem.innerHTML = `
                <div class="grid grid-cols-3 gap-2 flex-1">
                    <input type="text" placeholder="Planet Name" value="planet_${existingPlanets + 1}"
                        class="stellaris-input text-xs py-1" data-field="name">
                    <select class="stellaris-input text-xs py-1" data-field="class">
                        <option value="pc_continental">Kontinental</option>
                        <option value="pc_ocean">Ozean</option>
                        <option value="pc_desert">Wüste</option>
                        <option value="pc_arctic">Arktisch</option>
                        <option value="pc_tropical">Tropisch</option>
                        <option value="pc_arid">Arid</option>
                        <option value="pc_tundra">Tundra</option>
                        <option value="pc_barren">Karg</option>
                        <option value="pc_gas_giant">Gasriese</option>
                    </select>
                    <input type="number" placeholder="Größe" value="16" min="1" max="50"
                        class="stellaris-input text-xs py-1" data-field="size">
                </div>
                <button onclick="removeNeighborPlanetDraft(this)" 
                        class="stellaris-btn stellaris-btn-danger text-xs px-2 py-1 ml-2">
                    ✕
                </button>
            `;
            
            if (existingPlanets === 0) {
                planetList.innerHTML = '';
            }
            planetList.appendChild(planetItem);
        }

        function removeNeighborPlanetDraft(button) {
            button.closest('.neighbor-planet-item').remove();
            
            const planetList = document.getElementById('customNeighborPlanetsList');
            if (planetList.querySelectorAll('.neighbor-planet-item').length === 0) {
                planetList.innerHTML = '<p class="text-gray-400 text-xs">Keine Planeten definiert</p>';
            }
        }

        function collectCustomNeighborPlanets() {
            const planetItems = document.querySelectorAll('#customNeighborPlanetsList .neighbor-planet-item');
            const planets = [];
            
            planetItems.forEach(item => {
                const name = item.querySelector('[data-field="name"]').value.trim();
                const planetClass = item.querySelector('[data-field="class"]').value;
                const size = parseInt(item.querySelector('[data-field="size"]').value) || 16;
                
                if (name) {
                    planets.push({
                        id: Date.now() + Math.random(),
                        name: name,
                        class: planetClass,
                        size: size,
                        orbitDistance: planets.length === 0 ? 40 : 25
                    });
                }
            });
            
            return planets;
        }

        function removePlanetFromNeighbor(neighborId, planetId) {
            const neighbor = solarSystem.neighborSystems.find(n => n.id === neighborId);
            if (!neighbor) return;
            
            neighbor.planets = neighbor.planets.filter(p => p.id !== planetId);
            updateNeighborSystemsList();
            updateOutput();
            showNotification('Planet aus Nachbarsystem entfernt!');
        }

        function editNeighborSystem(neighborId) {
            const neighbor = solarSystem.neighborSystems.find(n => n.id === neighborId);
            if (!neighbor) return;
            
            // Scroll to neighbor section and populate fields
            const neighborSection = document.querySelector('.mt-6.p-4.bg-gradient-to-r.from-indigo-900\\/30');
            neighborSection.scrollIntoView({ behavior: 'smooth' });
            
            document.getElementById('neighborMode').value = neighbor.mode;
            document.getElementById('newNeighborDistance').value = neighbor.distance;
            
            if (neighbor.mode === 'reference') {
                document.getElementById('newNeighborReference').value = neighbor.initializer || '';
            } else {
                document.getElementById('customNeighborName').value = neighbor.name || '';
                document.getElementById('customNeighborStarClass').value = neighbor.starClass || 'sc_g';
                
                // Populate planets
                const planetList = document.getElementById('customNeighborPlanetsList');
                planetList.innerHTML = '';
                
                if (neighbor.planets && neighbor.planets.length > 0) {
                    neighbor.planets.forEach(planet => {
                        const planetItem = document.createElement('div');
                        planetItem.className = 'neighbor-planet-item bg-gray-700/50 p-2 rounded flex justify-between items-center';
                        
                        planetItem.innerHTML = `
                            <div class="grid grid-cols-3 gap-2 flex-1">
                                <input type="text" value="${planet.name}" class="stellaris-input text-xs py-1" data-field="name">
                                <select class="stellaris-input text-xs py-1" data-field="class">
                                    <option value="pc_continental" ${planet.class === 'pc_continental' ? 'selected' : ''}>Kontinental</option>
                                    <option value="pc_ocean" ${planet.class === 'pc_ocean' ? 'selected' : ''}>Ozean</option>
                                    <option value="pc_desert" ${planet.class === 'pc_desert' ? 'selected' : ''}>Wüste</option>
                                    <option value="pc_arctic" ${planet.class === 'pc_arctic' ? 'selected' : ''}>Arktisch</option>
                                    <option value="pc_tropical" ${planet.class === 'pc_tropical' ? 'selected' : ''}>Tropisch</option>
                                </select>
                                <input type="number" value="${planet.size}" min="1" max="50" class="stellaris-input text-xs py-1" data-field="size">
                            </div>
                            <button onclick="removeNeighborPlanetDraft(this)" class="stellaris-btn stellaris-btn-danger text-xs px-2 py-1 ml-2">✕</button>
                        `;
                        
                        planetList.appendChild(planetItem);
                    });
                } else {
                    planetList.innerHTML = '<p class="text-gray-400 text-xs">Keine Planeten definiert</p>';
                }
            }
            
            toggleNeighborCustomFields();
            
            // Remove original and user will re-add
            removeNeighborSystem(neighborId);
            showNotification('Nachbarsystem zur Bearbeitung geladen. Bitte speichern Sie die Änderungen.');
        }

        function updateNeighborSystemsList() {
            elements.neighborSystemsList.innerHTML = '';
            
            if (solarSystem.neighborSystems.length === 0) {
                elements.neighborSystemsList.innerHTML = '<p class="text-gray-400 text-sm">Keine Nachbarsysteme definiert</p>';
                return;
            }

            solarSystem.neighborSystems.forEach((neighbor) => {
                const neighborItem = document.createElement('div');
                neighborItem.className = 'bg-gray-700/50 p-3 rounded border border-indigo-500/30';
                
                let content = '';
                
                // ✅ KORRIGIERT: Hyperlane Jumps anzeigen
                const jumpsDisplay = neighbor.hyperlaneJumps 
                    ? `${neighbor.hyperlaneJumps.min}-${neighbor.hyperlaneJumps.max} Jumps`
                    : '1-3 Jumps';
                
                if (neighbor.mode === 'reference') {
                    content = `
                        <div class="flex justify-between items-start">
                            <div>
                                <div class="font-medium text-indigo-300">🔎 ${neighbor.initializer}</div>
                                <div class="text-xs text-gray-400 mt-1">Hyperlane: ${jumpsDisplay} • Modus: Referenz</div>
                                ${neighbor.trigger ? `<div class="text-xs text-blue-300 mt-1">Trigger: ${neighbor.trigger}</div>` : ''}
                            </div>
                            <div class="flex gap-2">
                                <button onclick="editNeighborSystem(${neighbor.id})" 
                                        class="stellaris-btn stellaris-btn-secondary text-xs px-2 py-1">
                                    Bearbeiten
                                </button>
                                <button onclick="removeNeighborSystem(${neighbor.id})" 
                                        class="stellaris-btn stellaris-btn-danger text-xs px-2 py-1">
                                    Löschen
                                </button>
                            </div>
                        </div>
                    `;
                } else {
                    const planetCount = neighbor.planets ? neighbor.planets.length : 0;
                    const asteroidCount = neighbor.asteroidBelts ? neighbor.asteroidBelts.length : 0;
                    const starIcon = getStarIcon(neighbor.starClass);
                    
                    content = `
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <div class="font-medium text-purple-300">${starIcon} ${neighbor.name}</div>
                                <div class="text-xs text-gray-400 mt-1">
                                    Hyperlane: ${jumpsDisplay} • Klasse: ${neighbor.starClass} • 
                                    ${planetCount} Planet${planetCount !== 1 ? 'en' : ''}
                                    ${asteroidCount > 0 ? ` • ${asteroidCount} Gürtel` : ''}
                                </div>
                                ${neighbor.trigger ? `<div class="text-xs text-blue-300 mt-1">Trigger: ${neighbor.trigger}</div>` : ''}
                            </div>
                            <div class="flex gap-2">
                                <button onclick="editNeighborSystem(${neighbor.id})" 
                                        class="stellaris-btn stellaris-btn-secondary text-xs px-2 py-1">
                                    Bearbeiten
                                </button>
                                <button onclick="removeNeighborSystem(${neighbor.id})" 
                                        class="stellaris-btn stellaris-btn-danger text-xs px-2 py-1">
                                    Löschen
                                </button>
                            </div>
                        </div>
                    `;
                    
                    if (neighbor.planets && neighbor.planets.length > 0) {
                        content += '<div class="mt-2 pl-4 border-l-2 border-purple-500/30 space-y-1">';
                        neighbor.planets.forEach(planet => {
                            const planetIcon = getPlanetIcon(planet.class);
                            content += `
                                <div class="text-xs flex justify-between items-center bg-gray-800/50 p-1 rounded">
                                    <span>${planetIcon} ${planet.name} • ${getClassDisplayName(planet.class)} • Größe ${planet.size}</span>
                                    <button onclick="removePlanetFromNeighbor(${neighbor.id}, ${planet.id})" 
                                            class="text-red-400 hover:text-red-300 text-xs px-1">
                                        ✕
                                    </button>
                                </div>
                            `;
                        });
                        content += '</div>';
                    }
                }
                
                neighborItem.innerHTML = content;
                elements.neighborSystemsList.appendChild(neighborItem);
            });
        }

        function getStarIcon(starClass) {
            const icons = {
                'sc_b': '💙', 'sc_a': '⚪', 'sc_f': '💛',
                'sc_g': '☉', 'sc_k': '🧡', 'sc_m': '🔴',
                'sc_black_hole': '⚫', 'sc_neutron_star': '⚫'
            };
            return icons[starClass] || '⭐';
        }

        function toggleNeighborCustomFields() {
            const mode = document.getElementById('neighborMode').value;
            const customFields = document.getElementById('customNeighborFields');
            const referenceField = document.getElementById('neighborReferenceField');
            
            if (mode === 'custom') {
                customFields.classList.remove('hidden');
                referenceField.classList.add('hidden');
            } else {
                customFields.classList.add('hidden');
                referenceField.classList.remove('hidden');
            }
        }

        function removeNeighborSystem(neighborId) {
            solarSystem.neighborSystems = solarSystem.neighborSystems.filter(n => n.id !== neighborId);
            updateNeighborSystemsList();
            updateOutput();
            renderVisualizer();
        }

        // ============================================================
        // [SECTION-10] ASTEROIDENGÜRTEL MANAGEMENT
        // ============================================================
        // HIER: Funktionen für Asteroidengürtel im Hauptsystem
        // ÄNDERN: Um neue Asteroidengürtel-Typen hinzuzufügen
        // TIPP: Siehe auch generateCustomNeighborDefinition() für
        //       Asteroidengürtel in Nachbarsystemen

        // Asteroid Belt Management
        function addAsteroidBelt() {
            const newBelt = {
                id: Date.now(),
                type: elements.newAsteroidBeltType.value,
                radius: parseInt(elements.newAsteroidBeltRadius.value) || 575
            };
            
            solarSystem.asteroidBelts.push(newBelt);
            updateAsteroidBeltList();
            updateOutput();
            renderVisualizer();
        }

        function updateAsteroidBeltList() {
            elements.asteroidBeltList.innerHTML = '';
            
            if (solarSystem.asteroidBelts.length === 0) {
                elements.asteroidBeltList.innerHTML = '<p class="text-gray-400 text-sm">Keine Asteroidengürtel definiert</p>';
                return;
            }

            solarSystem.asteroidBelts.forEach((belt, index) => {
                const beltItem = document.createElement('div');
                beltItem.className = 'flex items-center justify-between bg-gray-700 p-2 rounded';
                beltItem.innerHTML = `
                    <span class="text-sm">
                        ☄️ ${getAsteroidBeltTypeName(belt.type)} (Radius: ${belt.radius})
                    </span>
                    <button class="stellaris-btn stellaris-btn-danger text-xs px-2 py-1" onclick="removeAsteroidBelt(${belt.id})">
                        Löschen
                    </button>
                `;
                elements.asteroidBeltList.appendChild(beltItem);
            });
        }

        function removeAsteroidBelt(beltId) {
            solarSystem.asteroidBelts = solarSystem.asteroidBelts.filter(belt => belt.id !== beltId);
            updateAsteroidBeltList();
            updateOutput();
            renderVisualizer();
        }

        function getAsteroidBeltTypeName(type) {
            const names = {
                'rocky_asteroid_belt': 'Felsiger Asteroidengürtel',
                'icy_asteroid_belt': 'Eisiger Asteroidengürtel',
                'crystalline_asteroid_belt': 'Kristalliner Asteroidengürtel'
            };
            return names[type] || type;
        }

        // ============================================================
        // [SECTION-12] CODE-GENERIERUNG (STELLARIS .TXT)
        // ============================================================
        // HIER: Generierung des Stellaris-kompatiblen Codes
        // ÄNDERN: Um neue Stellaris-Features zu unterstützen
        // WICHTIG: Achte auf korrekte Einrückung (Tabs!)
        // 
        // HAUPTFUNKTIONEN:
        // - generateStellarisTxt()           → Hauptfunktion für Export
        // - generateSingleVariant()          → Einzelne Variante generieren
        // - generateAllVariants()            → Mehrere Varianten kombinieren
        // - applyVariationModifications()    → Origin-Änderungen anwenden
        // - generateCustomNeighborDefinition() → Nachbarsystem-Code
        // - generateStellarisYml()           → Lokalisierung (.yml)

        // Code Generation with proper modifier system
        function generateStellarisTxt() {
            // Check if multiple variations are enabled
            const enabledVariations = Object.values(systemVariations).filter(v => v.enabled);
            
            if (enabledVariations.length > 1) {
                return generateAllVariants();
            }
            
            // Single variant generation
            return generateSingleVariant(enabledVariations[0] || systemVariations.standard);
        }

        function generateSingleVariant(variation) {
            const variantSystem = applyVariationModifications(
                JSON.parse(JSON.stringify(solarSystem)), 
                variation
            );
            
            let txt = `##### Generated by Stellaris Solar System Editor V7 #####\n`;
            txt += `##### Variant: ${variation.displayName} #####\n\n`;
            
            const systemName = variation.systemNameOverride || solarSystem.name;
            txt += `${systemName} = {\n`;
            txt += `\tname = "${variantSystem.displayName}"\n`;
            txt += `\tclass = "${variantSystem.class}"\n`;

            // Multiple asteroid belts
            variantSystem.asteroidBelts.forEach(belt => {
                txt += `\tasteroid_belt = {\n`;
                txt += `\t\ttype = ${belt.type}\n`;
                txt += `\t\tradius = ${belt.radius}\n`;
                txt += `\t}\n`;
            });

            // V7 ADDITION - FLAGS
            if (variantSystem.flags && variantSystem.flags.length > 0) {
                txt += `\n\tflags = { ${variantSystem.flags.join(' ')} }\n`;
            }

            if (variantSystem.usage) {
                txt += `\n\tusage = ${variantSystem.usage}\n`;
            }

            // V7 ADDITION - USAGE ODDS
            if (variantSystem.usageOdds) {
                txt += `\n\tusage_odds = {\n`;
                txt += `\t\tbase = ${variantSystem.usageOdds.base}\n`;
                txt += `\t\tmodifier = {\n`;
                txt += `\t\t\t${variantSystem.usageOdds.condition}\n`;
                txt += `\t\t\tadd = ${variantSystem.usageOdds.add}\n`;
                txt += `\t\t}\n`;
                txt += `\t}\n`;
            }

            // V7 ADDITION - MAX INSTANCES
            if (variantSystem.maxInstances) {
                txt += `\n\tmax_instances = ${variantSystem.maxInstances}\n`;
            }

            // ============================================
            // ✅ CORRECTED: Neighbor Systems Generation
            // ============================================
            if (variantSystem.neighborSystems && variantSystem.neighborSystems.length > 0) {
                variantSystem.neighborSystems.forEach(neighbor => {
                    txt += `\tneighbor_system = {\n`;
                    
                    // ✅ KORRIGIERT: hyperlane_jumps statt distance
                    const jumps = neighbor.hyperlaneJumps || { min: 1, max: 3 };
                    txt += `\t\thyperlane_jumps = { min = ${jumps.min} max = ${jumps.max} }\n`;
                    
                    // Trigger (optional)
                    if (neighbor.trigger) {
                        txt += `\t\ttrigger = { ${neighbor.trigger} }\n`;
                    }
                    
                    // ✅ KORRIGIERT: initializer ist immer ein STRING, niemals ein Objekt
                    if (neighbor.mode === 'reference') {
                        // Modus A: Referenz zu existierendem System
                        txt += `\t\tinitializer = "${neighbor.initializer}"\n`;
                    } else if (neighbor.mode === 'custom') {
                        // Modus B: Referenz zu eigenem Custom-System
                        const customSystemName = neighbor.name.toLowerCase().replace(/\s+/g, '_') + '_neighbor';
                        txt += `\t\tinitializer = "${customSystemName}"\n`;
                    }

                    // Generate star
                    txt += `\t\t\tplanet = {\n`;
                    txt += `\t\t\t\tname = "${neighbor.name.toLowerCase().replace(/\s+/g, '_')}_star"\n`;
                    txt += `\t\t\t\tclass = "${getStarClassForSystemClass(neighbor.starClass)}"\n`;
                    txt += `\t\t\t\torbit_distance = 0\n`;
                    txt += `\t\t\t\torbit_angle = 1\n`;
                    txt += `\t\t\t\tsize = 40\n`;
                    txt += `\t\t\t\thas_ring = no\n`;
                    txt += `\t\t\t}\n`;
                   
                    // Generate planets
                    if (neighbor.planets && neighbor.planets.length > 0) {
                        neighbor.planets.forEach(planet => {
                            txt += `\t\t\tplanet = {\n`;
                            txt += `\t\t\t\tname = "${planet.name}"\n`;
                            txt += `\t\t\t\tclass = "${planet.class}"\n`;
                            txt += `\t\t\t\torbit_distance = ${planet.orbitDistance}\n`;
                            txt += `\t\t\t\torbit_angle = { min = 90 max = 270 }\n`;
                            txt += `\t\t\t\tsize = ${planet.size}\n`;
                            txt += `\t\t\t\thas_ring = no\n`;
                            txt += `\t\t\t}\n`;
                        });
                    }
                    
                    txt += `\t}\n`;
                });
            }
        
            txt += `}\n\n`;
            
            // ✅ NEU: Separate Nachbarsystem-Definitionen
            if (solarSystem.neighborSystems && solarSystem.neighborSystems.length > 0) {
                solarSystem.neighborSystems.forEach(neighbor => {
                    if (neighbor.mode === 'custom') {
                        txt += generateCustomNeighborDefinition(neighbor);
                        txt += '\n';
                    }
                });
            }

            txt += `\tinit_effect = {\n`;

            /**
            * ✅ NEU: Generiert separate Nachbarsystem-Definition
            */
            function generateCustomNeighborDefinition(neighbor) {
                const systemId = neighbor.name.toLowerCase().replace(/\s+/g, '_') + '_neighbor';
                
                let txt = `# Custom Neighbor System: ${neighbor.name}\n`;
                txt += `${systemId} = {\n`;
                txt += `\tname = "${neighbor.name}"\n`;
                txt += `\tclass = "${neighbor.starClass}"\n\n`;
                
                // Init Effect für Nachbarsysteme
                txt += `\tinit_effect = {\n`;
                txt += `\t\tevery_neighbor_system = { set_star_flag = empire_cluster }\n`;
                txt += `\t}\n\n`;
                
                // Stern
                txt += `\tplanet = {\n`;
                txt += `\t\tname = "${systemId}_star"\n`;
                txt += `\t\tclass = "${getStarClassForSystemClass(neighbor.starClass)}"\n`;
                txt += `\t\torbit_distance = 0\n`;
                txt += `\t\torbit_angle = 1\n`;
                txt += `\t\tsize = 30\n`;
                txt += `\t\thas_ring = no\n`;
                txt += `\t}\n\n`;
                
                // Asteroidengürtel
                if (neighbor.asteroidBelts && neighbor.asteroidBelts.length > 0) {
                    neighbor.asteroidBelts.forEach(belt => {
                        txt += `\tasteroid_belt = {\n`;
                        txt += `\t\ttype = ${belt.type}\n`;
                        txt += `\t\tradius = ${belt.radius}\n`;
                        txt += `\t}\n`;
                    });
                    txt += '\n';
                }
                
                // Planeten
                if (neighbor.planets && neighbor.planets.length > 0) {
                    txt += `\tchange_orbit = 45\n\n`;
                    
                    neighbor.planets.forEach((planet, index) => {
                        if (planet.type === 'asteroid_group') {
                            // Asteroiden-Gruppe
                            txt += `\tplanet = {\n`;
                            txt += `\t\tcount = { min = ${planet.countMin || 2} max = ${planet.countMax || 4} }\n`;
                            txt += `\t\tclass = ${planet.class}\n`;
                            txt += `\t\torbit_distance = ${index === 0 ? 0 : 20}\n`;
                            txt += `\t\torbit_angle = { min = 90 max = 270 }\n`;
                            txt += `\t}\n\n`;
                        } else {
                            // Regulärer Planet
                            txt += `\tplanet = {\n`;
                            if (planet.name) {
                                txt += `\t\tname = "${planet.name}"\n`;
                            }
                            txt += `\t\tclass = "${planet.class}"\n`;
                            txt += `\t\torbit_distance = ${planet.orbitDistance || (index === 0 ? 40 : 25)}\n`;
                            txt += `\t\torbit_angle = { min = 90 max = 270 }\n`;
                            txt += `\t\tsize = ${planet.size || 16}\n`;
                            txt += `\t\thas_ring = ${planet.hasRing ? 'yes' : 'no'}\n`;
                            
                            // Monde
                            if (planet.moons && planet.moons.length > 0) {
                                txt += `\n\t\tchange_orbit = 5\n\n`;
                                
                                planet.moons.forEach(moon => {
                                    txt += `\t\tmoon = {\n`;
                                    if (moon.name) {
                                        txt += `\t\t\tname = "${moon.name}"\n`;
                                    }
                                    txt += `\t\t\tclass = "${moon.class}"\n`;
                                    txt += `\t\t\tsize = ${moon.size || 8}\n`;
                                    txt += `\t\t\torbit_distance = ${moon.orbitDistance || 5}\n`;
                                    txt += `\t\t\torbit_angle = { min = 90 max = 270 }\n`;
                                    txt += `\t\t\thas_ring = no\n`;
                                    txt += `\t\t}\n\n`;
                                });
                            }
                            
                            txt += `\t}\n\n`;
                        }
                    });
                }
                
                txt += `}\n`;
                return txt;
            }
            
            /**
            * Konvertiert System-Klasse zu Stern-Klasse
            */
            function getStarClassForSystemClass(systemClass) {
                const mapping = {
                    'sc_b': 'pc_b_star',
                    'sc_a': 'pc_a_star',
                    'sc_f': 'pc_f_star',
                    'sc_g': 'pc_g_star',
                    'sc_k': 'pc_k_star',
                    'sc_m': 'pc_m_star',
                    'sc_black_hole': 'pc_black_hole',
                    'sc_neutron_star': 'pc_neutron_star',
                    'sc_pulsar': 'pc_pulsar'
                };
                return mapping[systemClass] || 'pc_g_star';
            }
            
            // Add empire cluster effects if custom_empire
            if (solarSystem.usage === 'custom_empire') {
                txt += `\t\tevery_neighbor_system = {\n`;
                txt += `\t\t\tset_star_flag = empire_cluster\n`;
                txt += `\t\t\tevery_neighbor_system = {\n`;
                txt += `\t\t\t\tset_star_flag = empire_cluster\n`;
                txt += `\t\t\t}\n`;
                txt += `\t\t}\n`;
                txt += `\t\tgenerate_home_system_resources = yes\n`;
            }
            
            txt += `\t}\n\n`;

            // Generate star as first planet
            txt += `\tplanet = {\n`;
            txt += `\t\tname = "${solarSystem.displayName.toLowerCase().replace(/\s+/g, '_')}"\n`;
            txt += `\t\tclass = "${getStarClassForSystemClass(solarSystem.class)}"\n`;
            txt += `\t\torbit_distance = 0\n`;
            txt += `\t\torbit_angle = 1\n`;
            txt += `\t\tsize = 45\n`;
            txt += `\t\thas_ring = no\n`;
            txt += `\t}\n\n`;

            // Generate planets with proper modifier system
            solarSystem.planets.forEach(planet => {
                txt += `\tplanet = {\n`;
                txt += `\t\tname = "${planet.name}"\n`;
                txt += `\t\tclass = "${planet.class}"\n`;
                txt += `\t\torbit_distance = ${planet.orbitDistance}\n`;
                
                // Handle orbit angle
                if (planet.orbitAngleType === 'range') {
                    txt += `\t\torbit_angle = { min = ${planet.orbitAngleMin} max = ${planet.orbitAngleMax} }\n`;
                } else {
                    txt += `\t\torbit_angle = ${planet.orbitAngle}\n`;
                }
                
                txt += `\t\tsize = ${planet.size}\n`;
                
                if (planet.changeOrbit > 0) {
                    txt += `\t\tchange_orbit = ${planet.changeOrbit}\n`;
                }
                
                txt += `\t\thas_ring = ${planet.hasRing ? 'yes' : 'no'}\n`;
                
                // V7 ADDITION - PLANET FLAGS
                if (planet.flags && planet.flags.length > 0) {
                    txt += `\t\tflags = { ${planet.flags.join(' ')} }\n`;
                }
                
                // V7 ADDITION - ENTITY OVERRIDE
                if (planet.entityOverride) {
                    txt += `\t\tentity = "${planet.entityOverride}"\n`;
                }
                
                // Generate modifiers
                let hasInitEffect = false;
                let initEffectContent = '';
                
                if (planet.modifiers && planet.modifiers.length > 0) {
                    hasInitEffect = true;
                    
                    // Group modifiers by category for better organization
                    const pdModifiers = planet.modifiers.filter(m => m.category === 'planetary_diversity');
                    const otherModifiers = planet.modifiers.filter(m => m.category !== 'planetary_diversity');
                    
                    // Add PD modifiers with conditional check
                    if (pdModifiers.length > 0) {
                        initEffectContent += `\t\t\tif = {\n`;
                        initEffectContent += `\t\t\t\tlimit = { has_planetary_diversity = yes }\n`;
                        pdModifiers.forEach(modifier => {
                            initEffectContent += `\t\t\t\t${modifier.key} = yes\n`;
                        });
                        initEffectContent += `\t\t\t}\n`;
                    }
                    
                    // Add other modifiers directly
                    otherModifiers.forEach(modifier => {
                        if (modifier.category === 'environmental' || modifier.category === 'resource' || modifier.category === 'special') {
                            initEffectContent += `\t\t\tadd_modifier = { modifier = ${modifier.key} }\n`;
                        }
                    });
                }
                
                // V7 ADDITION - PREVENT ANOMALY
                if (planet.preventAnomaly) {
                    hasInitEffect = true;
                    initEffectContent += `\t\t\tprevent_anomaly = yes\n`;
                }
                
                if (planet.isStartingPlanet) {
                    hasInitEffect = true;
                    if (!planet.preventAnomaly) { // Don't duplicate if already added
                        initEffectContent += `\t\t\tprevent_anomaly = yes\n`;
                    }
                    initEffectContent += `\t\t\tgenerate_start_buildings_and_blockers = yes\n`;
                }
                
                if (hasInitEffect) {
                    txt += `\t\tmodifiers = none\n`;
                    txt += `\t\tinit_effect = {\n`;
                    txt += initEffectContent;
                    txt += `\t\t}\n`;
                } else if (planet.isStartingPlanet) {
                    txt += `\t\tstarting_planet = yes\n`;
                    txt += `\t\ttile_blockers = none\n`;
                    txt += `\t\tmodifiers = none\n`;
                }

                // Generate moons
                if (planet.moons && planet.moons.length > 0) {
                    planet.moons.forEach(moon => {
                        txt += `\t\tmoon = {\n`;
                        txt += `\t\t\tname = "${moon.name}"\n`;
                        txt += `\t\t\tclass = "${moon.class}"\n`;
                        txt += `\t\t\torbit_distance = ${moon.orbitDistance}\n`;
                        
                        if (moon.orbitAngleType === 'range') {
                            txt += `\t\t\torbit_angle = { min = ${moon.orbitAngleMin} max = ${moon.orbitAngleMax} }\n`;
                        } else {
                            txt += `\t\t\torbit_angle = ${moon.orbitAngle}\n`;
                        }
                        
                        txt += `\t\t\tsize = ${moon.size}\n`;
                        if (moon.hasRing) {
                            txt += `\t\t\thas_ring = yes\n`;
                        }
                        
                        txt += `\t\t}\n`;
                    });
                }

                txt += `\t}\n`;
            });

            txt += `}\n`;
            return txt;
        }

        // V7 ADDITION - Multi-Variant Generation
        function generateAllVariants() {
            let combinedTxt = `##### Generated by Stellaris Solar System Editor V7 #####\n`;
            combinedTxt += `##### Multiple Variants Export #####\n`;
            combinedTxt += `##### Total Variants: ${Object.values(systemVariations).filter(v => v.enabled).length} #####\n\n`;
            
            const enabledVariations = Object.entries(systemVariations).filter(([key, v]) => v.enabled);
            
            enabledVariations.forEach(([key, variation], index) => {
                if (index > 0) {
                    combinedTxt += `\n\n##########################################################\n`;
                }
                combinedTxt += `### Variant ${index + 1}: ${variation.displayName} ###\n`;
                combinedTxt += `### System: ${variation.systemNameOverride || solarSystem.name} ###\n`;
                combinedTxt += `##########################################################\n\n`;
                
                combinedTxt += generateSingleVariant(variation);
            });
            
            return combinedTxt;
        }

        function applyVariationModifications(system, variation) {
            const mods = variation.modifications;
            if (!mods) return system;
            
            // Apply system-level modifications
            if (mods.system) {
                if (mods.system.usage) system.usage = mods.system.usage;
                if (mods.system.flags) system.flags = [...mods.system.flags];
                if (mods.system.usageOdds) system.usageOdds = mods.system.usageOdds;
                if (mods.system.maxInstances) system.maxInstances = mods.system.maxInstances;
            }
            
            // Apply planet-level modifications
            if (mods.planets) {
                system.planets.forEach(planet => {
                    // Match planet by normalized name (remove spaces, lowercase)
                    const planetKey = planet.name.toLowerCase().replace(/[^a-z0-9]/g, '');
                    
                    // Check all possible planet name variations
                    const planetMods = mods.planets[planetKey] || 
                                      mods.planets[planet.name.toLowerCase()] ||
                                      mods.planets[planet.displayName.toLowerCase()];
                    
                    if (planetMods) {
                        if (planetMods.changeClass) planet.class = planetMods.changeClass;
                        if (planetMods.changeSize) planet.size = planetMods.changeSize;
                        
                        if (planetMods.addFlags) {
                            planet.flags = [...(planet.flags || []), ...planetMods.addFlags];
                        }
                        
                        if (planetMods.removeFlags) {
                            planetMods.removeFlags.forEach(flag => {
                                planet.flags = (planet.flags || []).filter(f => f !== flag);
                            });
                        }
                        
                        if (planetMods.addModifiers) {
                            planet.modifiers = [...(planet.modifiers || []), ...planetMods.addModifiers];
                        }
                    }
                });
            }
            
            return system;
        }

        function generateStellarisYml() {
            let yml = `l_german:\n`;
            yml += ` # Generated by Stellaris Solar System Editor V6\n`;
            yml += ` # System: ${solarSystem.displayName}\n`;
            yml += ` # With proper modifier system\n\n`;
            yml += ` ${solarSystem.name}_NAME: "${solarSystem.displayName}"\n`;
            yml += ` ${solarSystem.name}_DESC: "Ein maßgeschneidertes Sonnensystem mit korrektem Modifier-System."\n\n`;

            solarSystem.planets.forEach(planet => {
                yml += ` ${planet.name}_NAME: "${planet.displayName}"\n`;
                if (planet.moons && planet.moons.length > 0) {
                    planet.moons.forEach(moon => {
                        yml += ` ${moon.name}_NAME: "${moon.displayName}"\n`;
                    });
                }
            });

            return yml;
        }

        // ============================================================
        // [SECTION-13] UI UPDATE FUNKTIONEN
        // ============================================================
        // HIER: Aktualisierung der Benutzeroberfläche
        // ÄNDERN: Um neue UI-Elemente zu aktualisieren
        // TIPP: Diese Funktionen werden nach jeder Änderung aufgerufen

        // Cumulative Orbit Calculation (unchanged from V5)
        function calculateCumulativeOrbitDistances() {
            const result = [];
            let currentDistance = 0;
            
            solarSystem.planets.forEach((planet, index) => {
                if (planet.orbitDistance === 0 && index === 0) {
                    // First planet with 0 distance gets default
                    currentDistance = 40;
                } else if (planet.orbitDistance > 0) {
                    // Add to cumulative distance
                    currentDistance += planet.orbitDistance;
                }
                // If orbitDistance === 0 and not first planet, keep currentDistance
                
                result.push({
                    planet: planet,
                    actualDistance: currentDistance,
                    isNewOrbit: planet.orbitDistance > 0 || index === 0
                });
                
                // Apply change_orbit for next planet
                if (planet.changeOrbit > 0) {
                    currentDistance += planet.changeOrbit;
                }
            });
            
            return result;
        }

        // UI Update Functions
        function updatePlanetList() {
            elements.planetList.innerHTML = '';
            
            if (solarSystem.planets.length === 0) {
                elements.planetList.innerHTML = '<p class="text-gray-400">Fügen Sie Planeten hinzu, um mit dem Systembau zu beginnen.</p>';
                return;
            }

            const cumulativeOrbits = calculateCumulativeOrbitDistances();

            cumulativeOrbits.forEach((orbitData, index) => {
                const planet = orbitData.planet;
                const actualDistance = orbitData.actualDistance;
                const isNewOrbit = orbitData.isNewOrbit;
                
                const planetItem = createPlanetListItem(planet, index, isNewOrbit, false, actualDistance);
                elements.planetList.appendChild(planetItem);

                if (planet.moons && planet.moons.length > 0) {
                    planet.moons.forEach(moon => {
                        const moonItem = createPlanetListItem(moon, -1, false, true, 0);
                        elements.planetList.appendChild(moonItem);
                    });
                }
            });
        }

        function createPlanetListItem(celestial, index, isNewOrbit = false, isMoon = false, actualDistance = 0) {
            const item = document.createElement('div');
            item.className = `celestial-item ${selectedPlanet && selectedPlanet.id === celestial.id ? 'selected' : ''} ${isNewOrbit ? 'new-orbit' : 'same-orbit'} ${isMoon ? 'ml-6' : ''}`;
            item.dataset.id = celestial.id;
            
            const icon = getPlanetIcon(celestial.class);
            const typeText = isMoon ? 'Mond' : 'Planet';
            
            let orbitInfo = '';
            if (!isMoon) {
                if (isNewOrbit) {
                    orbitInfo = `🟡 +${celestial.orbitDistance} → Gesamt: ${actualDistance}`;
                } else {
                    orbitInfo = `⚪ +0 → Gleiche Umlaufbahn (${actualDistance})`;
                }
            }
            
            // Show modifier count
            let modifierInfo = '';
            if (celestial.modifiers && celestial.modifiers.length > 0) {
                modifierInfo = `<div class="text-xs text-green-300">🌿 ${celestial.modifiers.length} Modifier</div>`;
            }
            
            item.innerHTML = `
                <div class="flex items-center">
                    <span class="text-2xl mr-2">${icon}</span>
                    <div>
                        <div class="font-medium">${isMoon ? '↳ ' : `${index + 1}. `}${celestial.displayName}</div>
                        <div class="text-sm text-gray-400">${getClassDisplayName(celestial.class)} • Größe ${celestial.size}</div>
                        ${orbitInfo ? `<div class="text-xs text-blue-300">${orbitInfo}</div>` : ''}
                        ${modifierInfo}
                    </div>
                </div>
                <button class="stellaris-btn stellaris-btn-secondary text-sm px-2 py-1" onclick="selectPlanet(${celestial.id})">
                    Auswählen
                </button>
            `;
            
            item.addEventListener('click', (e) => {
                if (e.target.tagName !== 'BUTTON') {
                    selectPlanet(celestial.id);
                }
            });
            
            return item;
        }

        // ============================================================
        // [SECTION-14] VISUALISIERUNG (CANVAS)
        // ============================================================
        // HIER: Rendering des Solar Systems im Canvas
        // ÄNDERN: Um visuelle Darstellung anzupassen
        // TIPP: 
        // - visualizerScale für Zoom-Stufe
        // - getColorForClass() für Planetenfarben
        // - drawCelestial() für einzelne Objekte

        // Visualization (unchanged from V5)
        function renderVisualizer() {
            elements.visualizer.innerHTML = '';

            const centerX = elements.visualizer.offsetWidth / 2;
            const centerY = elements.visualizer.offsetHeight / 2;

            // Draw the star
            const starSize = 30 * visualizerScale;
            const starEl = document.createElement('div');
            starEl.className = 'stellaris-star';
            starEl.style.width = `${starSize}px`;
            starEl.style.height = `${starSize}px`;
            starEl.style.left = `${centerX - starSize / 2}px`;
            starEl.style.top = `${centerY - starSize / 2}px`;
            starEl.style.borderRadius = '50%';
            starEl.style.position = 'absolute';
            elements.visualizer.appendChild(starEl);

            // Draw neighbor system indicators - HINZUFÜGEN
            solarSystem.neighborSystems.forEach((neighbor, index) => {
                const angle = (index * 360 / solarSystem.neighborSystems.length) * Math.PI / 180;
                const distance = 200 * visualizerScale;
                const x = centerX + distance * Math.cos(angle);
                const y = centerY + distance * Math.sin(angle);

                // Draw connection line
                const line = document.createElement('div');
                line.style.position = 'absolute';
                line.style.width = `${distance}px`;
                line.style.height = '1px';
                line.style.background = 'rgba(153, 102, 255, 0.3)';
                line.style.left = `${centerX}px`;
                line.style.top = `${centerY}px`;
                line.style.transformOrigin = '0 0';
                line.style.transform = `rotate(${angle}rad)`;
                elements.visualizer.appendChild(line);

                // Draw neighbor system
                const neighborEl = document.createElement('div');
                neighborEl.style.position = 'absolute';
                neighborEl.style.width = '20px';
                neighborEl.style.height = '20px';
                neighborEl.style.left = `${x - 10}px`;
                neighborEl.style.top = `${y - 10}px`;
                neighborEl.style.background = 'linear-gradient(45deg, #9966ff, #6633cc)';
                neighborEl.style.borderRadius = '50%';
                neighborEl.style.border = '2px solid rgba(153, 102, 255, 0.5)';
                neighborEl.style.boxShadow = '0 0 10px rgba(153, 102, 255, 0.5)';
                neighborEl.title = neighbor.initializer || 'Random System';
                elements.visualizer.appendChild(neighborEl);
            });

            // Draw multiple asteroid belts - HINZUFÜGEN
            solarSystem.asteroidBelts.forEach(belt => {
                const beltRadius = belt.radius * visualizerScale;
                const beltEl = document.createElement('div');
                beltEl.className = 'asteroid-belt';
                beltEl.style.width = `${beltRadius * 2}px`;
                beltEl.style.height = `${beltRadius * 2}px`;
                beltEl.style.left = `${centerX - beltRadius}px`;
                beltEl.style.top = `${centerY - beltRadius}px`;
                elements.visualizer.appendChild(beltEl);
            });

            // Calculate cumulative orbits and draw planets
            const cumulativeOrbits = calculateCumulativeOrbitDistances();
            const drawnOrbits = new Set();

            cumulativeOrbits.forEach((orbitData, index) => {
                const actualDistance = orbitData.actualDistance;
                const planet = orbitData.planet;
                
                // Draw orbit ring if we haven't drawn it yet
                const orbitRadius = actualDistance * visualizerScale;
                if (orbitRadius > starSize / 2 + 10 && !drawnOrbits.has(actualDistance)) {
                    drawnOrbits.add(actualDistance);
                    const orbitEl = document.createElement('div');
                    orbitEl.className = 'orbit-indicator';
                    orbitEl.style.width = `${orbitRadius * 2}px`;
                    orbitEl.style.height = `${orbitRadius * 2}px`;
                    orbitEl.style.left = `${centerX - orbitRadius}px`;
                    orbitEl.style.top = `${centerY - orbitRadius}px`;
                    elements.visualizer.appendChild(orbitEl);
                }

                // Draw planet
                drawCelestial(planet, centerX, centerY, orbitRadius, index * 45);
            });
        }

        function drawCelestial(celestial, parentX, parentY, distance, baseAngle = 0) {
            let angle = baseAngle;
            if (celestial.orbitAngleType === 'fixed') {
                angle = celestial.orbitAngle || 0;
            } else {
                // For range, use middle of range for visualization
                const min = celestial.orbitAngleMin || 90;
                const max = celestial.orbitAngleMax || 270;
                angle = (min + max) / 2;
            }

            const angleRad = (angle * Math.PI) / 180;
            const x = parentX + distance * Math.cos(angleRad);
            const y = parentY + distance * Math.sin(angleRad);

            // Draw celestial body
            const size = Math.max(8, celestial.size * visualizerScale * 0.8);
            const bodyEl = document.createElement('div');
            bodyEl.className = celestial.type;
            bodyEl.style.width = `${size}px`;
            bodyEl.style.height = `${size}px`;
            bodyEl.style.left = `${x - size / 2}px`;
            bodyEl.style.top = `${y - size / 2}px`;
            bodyEl.style.background = getColorForClass(celestial.class);
            bodyEl.style.position = 'absolute';
            bodyEl.style.borderRadius = '50%';
            bodyEl.style.display = 'flex';
            bodyEl.style.justifyContent = 'center';
            bodyEl.style.alignItems = 'center';
            bodyEl.style.fontSize = '0.7rem';
            bodyEl.style.fontWeight = '600';
            bodyEl.style.color = 'white';
            bodyEl.style.textShadow = '0 0 5px rgba(0,0,0,0.8)';
            bodyEl.style.cursor = 'pointer';
            bodyEl.textContent = celestial.displayName.substring(0, 3);
            
            // Add modifier indicator
            if (celestial.modifiers && celestial.modifiers.length > 0) {
                bodyEl.style.border = '3px solid #48bb78';
                bodyEl.style.boxShadow = '0 0 10px rgba(72, 187, 120, 0.5)';
            }
            
            bodyEl.addEventListener('click', () => selectPlanet(celestial.id));
            elements.visualizer.appendChild(bodyEl);

            // Draw ring system if present
            if (celestial.hasRing) {
                const ringEl = document.createElement('div');
                ringEl.style.position = 'absolute';
                ringEl.style.width = `${size * 1.8}px`;
                ringEl.style.height = `${size * 1.8}px`;
                ringEl.style.left = `${x - (size * 1.8) / 2}px`;
                ringEl.style.top = `${y - (size * 1.8) / 2}px`;
                ringEl.style.border = '2px solid rgba(255, 255, 255, 0.4)';
                ringEl.style.borderRadius = '50%';
                ringEl.style.pointerEvents = 'none';
                elements.visualizer.appendChild(ringEl);
            }

            // Draw moons
            if (celestial.moons && celestial.moons.length > 0) {
                celestial.moons.forEach((moon, moonIndex) => {
                    const moonDistance = moon.orbitDistance * visualizerScale;
                    drawCelestial(moon, x, y, moonDistance, moonIndex * 120);
                });
            }
        }

        // ============================================================
        // [SECTION-15] HELPER FUNKTIONEN (ICONS, FARBEN, ETC.)
        // ============================================================
        // HIER: Hilfsfunktionen für Icons, Farben, Namen
        // ÄNDERN: 
        // - getPlanetIcon(): Um neue Planet-Icons hinzuzufügen
        // - getClassDisplayName(): Für deutsche Übersetzungen
        // - getColorForClass(): Für Planetenfarben im Visualizer
        // - getStarIcon(): Für Stern-Icons in Nachbarsystemen
        // 
        // TIPP: Emojis können direkt eingefügt werden: 🌍 🔴 ⭐

        // Helper Functions
        function getPlanetIcon(planetClass) {
            const icons = {
                // Stars
                'pc_b_star': '💙', 'pc_a_star': '⚪', 'pc_f_star': '💛', 'pc_g_star': '☉', 'pc_k_star': '🧡', 'pc_m_star': '🔴',
                'pc_black_hole': '⚫', 'pc_neutron_star': '⚫', 'pc_pulsar': '🌟', 'pc_brown_dwarf': '🟤',
                
                // Habitable Worlds
                'pc_continental': '🌍', 'pc_ocean': '🌊', 'pc_tropical': '🌴',
                'pc_arid': '🏜️', 'pc_desert': '🏜️', 'pc_savannah': '🌾',
                'pc_arctic': '🧊', 'pc_tundra': '❄️', 'pc_alpine': '🏔️',
                'pc_gaia': '🌿',
                
                // Uninhabitable Worlds
                'pc_barren': '🌑', 'pc_barren_cold': '☄️', 'pc_frozen': '☄️',
                'pc_molten': '🔥', 'pc_toxic': '☢️', 'pc_hothouse': '🔥',
                'pc_gas_giant': '🪐', 'pc_hot_gas_giant': '🔥', 'pc_cold_gas_giant': '❄️', 'pc_dwarf_gas_giant': '🌌',
                'pc_storm': '⛈️', 'pc_nuked': '💥', 'pc_shattered': '💥',
                'pc_asteroid': '☄️', 'pc_subglacial': '🧊',
                
                // Special Worlds
                'pc_relic': '🛛️', 'pc_habitat': '🛰️', 'pc_ecumenopolis': '🏙️',
                'pc_machine': '🤖', 'pc_hive': '🪲', 'pc_shielded': '🛡️',
                
                // Gigastructural Engineers
                'pc_birch': '🌳', 'pc_alderson': '💿', 'pc_gas_giant_habitable': '🪐', 
                'pc_stellar_systemcraft': '🚀', 'pc_nicoll_dyson_beam': '⚡', 'pc_penrose_sphere_habitable': '⚫',
                'pc_virtual_reality': '💻', 'pc_pouchkinn_planet': '🌟', 'pc_gigastructural_shielded': '🛡️',
                'pc_quasi_stellar_obliterator': '⭐', 'pc_neutronium_gigaforge': '⚒️',
                
                // Planetary Diversity - Gaia & Special
                'pd_wet_gaia_world': '🌿', 'pd_dry_gaia_world': '🌿', 'pd_cold_gaia_world': '🌿',
                'pd_wet_cave_world': '🕳️', 'pd_dry_cave_world': '🕳️', 'pd_cold_cave_world': '🕳️',
                'pd_wet_superhabitable_world': '🌺', 'pd_dry_superhabitable_world': '🌺', 'pd_cold_superhabitable_world': '🌺',
                'pd_wet_tidally_locked_world': '🌗', 'pd_dry_tidally_locked_world': '🌗', 'pd_cold_tidally_locked_world': '🌗',
                
                // Planetary Diversity - Uncommon
                'pc_superhabitable': '🌺', 'pc_tidally_locked': '🌗', 'pc_mantle': '🌋', 'pc_karst': '🪨',
                'pc_crystal': '💎', 'pc_frozen_desert': '🏔️', 'pc_ash': '🌋', 'pc_marginal': '🌫️',
                'pc_sandsea': '🏖️', 'pc_technoorganic': '🔬'
            };
            return icons[planetClass] || '🌌';
        }

        function getClassDisplayName(planetClass) {
            const names = {
                // Stars
                'pc_b_star': 'B-Stern', 'pc_a_star': 'A-Stern', 'pc_f_star': 'F-Stern',
                'pc_g_star': 'G-Stern', 'pc_k_star': 'K-Stern', 'pc_m_star': 'M-Stern',
                'pc_black_hole': 'Schwarzes Loch', 'pc_neutron_star': 'Neutronenstern',
                'pc_pulsar': 'Pulsar', 'pc_brown_dwarf': 'Brauner Zwerg',
                
                // Habitable Worlds
                'pc_continental': 'Kontinental', 'pc_ocean': 'Ozean', 'pc_tropical': 'Tropisch',
                'pc_arid': 'Arid', 'pc_desert': 'Wüste', 'pc_savannah': 'Savanne',
                'pc_arctic': 'Arktisch', 'pc_tundra': 'Tundra', 'pc_alpine': 'Alpin',
                'pc_gaia': 'Gaia',
                
                // Uninhabitable Worlds
                'pc_barren': 'Karg', 'pc_barren_cold': 'Karg (Kalt)', 'pc_frozen': 'Gefroren',
                'pc_molten': 'Geschmolzen', 'pc_toxic': 'Toxisch', 'pc_hothouse': 'Treibhaus',
                'pc_gas_giant': 'Gasriese', 'pc_hot_gas_giant': 'Heißer Gasriese',
                'pc_cold_gas_giant': 'Kalter Gasriese', 'pc_dwarf_gas_giant': 'Zwerg-Gasriese',
                'pc_storm': 'Sturm', 'pc_nuked': 'Verstrahlt', 'pc_shattered': 'Zerstört',
                'pc_asteroid': 'Asteroid', 'pc_subglacial': 'Subglazial',
                
                // Special Worlds
                'pc_relic': 'Relikt', 'pc_habitat': 'Habitat', 'pc_ecumenopolis': 'Ökumenopolis',
                'pc_machine': 'Maschine', 'pc_hive': 'Schwarm', 'pc_shielded': 'Abgeschirmt',
                
                // Gigastructural Engineers
                'pc_birch': 'Birch-Welt', 'pc_alderson': 'Alderson-Scheibe',
                'pc_gas_giant_habitable': 'Bewohnbarer Gasriese', 'pc_stellar_systemcraft': 'Stellares Systemschiff',
                'pc_nicoll_dyson_beam': 'Nicoll-Dyson-Strahl-Ziel', 'pc_penrose_sphere_habitable': 'Penrose-Sphäre Habitat',
                'pc_virtual_reality': 'Virtual Reality Welt', 'pc_pouchkinn_planet': 'Pouchkinn Planet',
                'pc_gigastructural_shielded': 'Gigastruktureller Schild', 'pc_quasi_stellar_obliterator': 'Quasi-Stellar Obliterator',
                'pc_neutronium_gigaforge': 'Neutronium Gigaforge',
                
                // Planetary Diversity (shortened for space, add more as needed)
                'pd_retinal_world': 'Retinal-Welt', 'pd_lake_world': 'Seen-Welt', 'pd_mushroom_world': 'Pilz-Welt',
                'pd_dune_world': 'Dünen-Welt', 'pd_glacial_world': 'Gletscher-Welt',
                'pc_superhabitable': 'Superbewohnbar', 'pc_tidally_locked': 'Gezeitengebunden',
                'pc_mantle': 'Mantel-Welt', 'pc_crystal': 'Kristall-Welt'
            };
            return names[planetClass] || planetClass;
        }

        function getColorForClass(className) {
            const colors = {
                // Habitable Worlds
                // Stars
                'pc_b_star': 'linear-gradient(45deg, #4299e1, #3182ce)',
                'pc_a_star': 'linear-gradient(45deg, #f7fafc, #edf2f7)',
                'pc_f_star': 'linear-gradient(45deg, #faf089, #f6e05e)',
                'pc_g_star': 'linear-gradient(45deg, #f6e05e, #ecc94b)',
                'pc_k_star': 'linear-gradient(45deg, #ed8936, #dd6b20)',
                'pc_m_star': 'linear-gradient(45deg, #e53e3e, #c53030)',
                
                // Habitable Worlds
                'pc_continental': 'linear-gradient(45deg, #38b2ac, #4299e1)',
                'pc_ocean': 'linear-gradient(45deg, #4299e1, #3182ce)',
                'pc_tropical': 'linear-gradient(45deg, #48bb78, #38a169)',
                'pc_arid': 'linear-gradient(45deg, #f6ad55, #ed8936)',
                'pc_desert': 'linear-gradient(45deg, #ecc94b, #d69e2e)',
                'pc_savannah': 'linear-gradient(45deg, #ed8936, #dd6b20)',
                'pc_arctic': 'linear-gradient(45deg, #a0aec0, #718096)',
                'pc_tundra': 'linear-gradient(45deg, #718096, #4a5568)',
                'pc_alpine': 'linear-gradient(45deg, #cbd5e0, #a0aec0)',
                'pc_gaia': 'linear-gradient(45deg, #68d391, #48bb78)',
                
                // Uninhabitable Worlds
                'pc_barren': 'linear-gradient(45deg, #718096, #4a5568)',
                'pc_barren_cold': 'linear-gradient(45deg, #a0aec0, #718096)',
                'pc_frozen': 'linear-gradient(45deg, #bee3f8, #90cdf4)',
                'pc_molten': 'linear-gradient(45deg, #e53e3e, #c53030)',
                'pc_toxic': 'linear-gradient(45deg, #805ad5, #6b46c1)',
                'pc_gas_giant': 'linear-gradient(45deg, #9f7aea, #805ad5)',
                'pc_nuked': 'linear-gradient(45deg, #a3bffa, #7c3aed)',
                'pc_asteroid': 'linear-gradient(45deg, #718096, #4a5568)',
                
                // Special Worlds
                'pc_relic': 'linear-gradient(45deg, #d69e2e, #b7791f)',
                'pc_habitat': 'linear-gradient(45deg, #a0aec0, #718096)',
                'pc_ecumenopolis': 'linear-gradient(45deg, #fed7d7, #fc8181)',
                'pc_machine': 'linear-gradient(45deg, #4a5568, #2d3748)',
                'pc_hive': 'linear-gradient(45deg, #9f7aea, #805ad5)',
                'pc_shielded': 'linear-gradient(45deg, #e2e8f0, #cbd5e0)',
                
                // Gigastructural Engineers
                'pc_birch': 'linear-gradient(45deg, #276749, #38a169)',
                'pc_alderson': 'linear-gradient(45deg, #4a5568, #2d3748)',
                'pc_gas_giant_habitable': 'linear-gradient(45deg, #48bb78, #805ad5)',
                'pc_stellar_systemcraft': 'linear-gradient(45deg, #e2e8f0, #a0aec0)',
                'pc_nicoll_dyson_beam': 'linear-gradient(45deg, #f6e05e, #e53e3e)',
                'pc_penrose_sphere_habitable': 'linear-gradient(45deg, #2d3748, #1a202c)',
                'pc_virtual_reality': 'linear-gradient(45deg, #667eea, #764ba2)',
                'pc_pouchkinn_planet': 'linear-gradient(45deg, #f093fb, #f5576c)',
                'pc_gigastructural_shielded': 'linear-gradient(45deg, #4fd1c7, #06bfa5)',
                
                // Add more Planetary Diversity colors as needed
                'pd_retinal_world': 'linear-gradient(45deg, #fc8181, #e53e3e)',
                'pd_lake_world': 'linear-gradient(45deg, #4299e1, #3182ce)',
                'pd_mushroom_world': 'linear-gradient(45deg, #805ad5, #38a169)',
                'pd_dune_world': 'linear-gradient(45deg, #ecc94b, #d69e2e)',
                'pd_glacial_world': 'linear-gradient(45deg, #bee3f8, #90cdf4)',
                'pc_superhabitable': 'linear-gradient(45deg, #68d391, #38b2ac)',
                'pc_crystal': 'linear-gradient(45deg, #9f7aea, #bee3f8)'
            };
            return colors[className] || 'linear-gradient(45deg, #e2e8f0, #cbd5e0)';
        }

        function getStarClassForSystemClass(systemClass) {
            const mapping = {
                'sc_b': 'pc_b_star',
                'sc_a': 'pc_a_star',
                'sc_f': 'pc_f_star',
                'sc_g': 'pc_g_star',
                'sc_k': 'pc_k_star',
                'sc_m': 'pc_m_star'
            };
            return mapping[systemClass] || 'pc_g_star';
        }

        // ============================================================
        // [SECTION-16] EVENT LISTENER INITIALISIERUNG
        // ============================================================
        // HIER: Alle Event-Handler für Buttons, Inputs, etc.
        // ÄNDERN: Um neue Buttons/Felder zu verknüpfen
        // WICHTIG: 
        // - Prüfe mit if() ob Element existiert vor addEventListener
        // - Verwende () => {} für anonyme Funktionen
        // - Nutze updateOutput() nach jeder Änderung
        // 
        // STRUKTUR:
        // 1. System-Properties (Name, Klasse, Usage)
        // 2. Nachbarsystem-Controls
        // 3. Asteroidengürtel-Controls
        // 4. Planeten-Controls
        // 5. Planet-Eigenschaften
        // 6. Modifier-System
        // 7. Visualizer-Controls
        // 8. Export-Buttons
        // 9. V7-Features (Flags, Variationen)

        // Event handlers and property updates
        function updateSelectedPlanetProperty(property) {
            return (e) => {
                if (selectedPlanet) {
                    selectedPlanet[property] = e.target.value;
                    updatePlanetList();
                    updateOutput();
                    renderVisualizer();
                }
            };
        }

        function updateOutput() {
            elements.exportTxt.value = generateStellarisTxt();
            elements.exportYml.value = generateStellarisYml();
        }

        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-blue-600 text-white px-4 py-2 rounded shadow-lg z-50';
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showNotification(`Datei "${filename}" wurde erfolgreich heruntergeladen!`);
        }

        // ============================================================
        // [SECTION-16] EVENT LISTENER INITIALISIERUNG
        // ============================================================
        // (Siehe Marker oben für Details)

        // Event Listeners
        function initializeEventListeners() {
            // System properties
            elements.systemName.addEventListener('input', (e) => {
                const value = e.target.value.replace(/[^a-zA-Z0-9_]/g, '');
                e.target.value = value;
                solarSystem.name = value || 'my_custom_system';
                updateOutput();
            });

            elements.systemDisplayName.addEventListener('input', (e) => {
                solarSystem.displayName = e.target.value || 'Unbenanntes System';
                updateOutput();
            });

            elements.systemClass.addEventListener('change', (e) => {
                solarSystem.class = e.target.value;
                updateOutput();
                renderVisualizer();
            });

            elements.systemUsage.addEventListener('change', (e) => {
                solarSystem.usage = e.target.value;
                updateOutput();
            });

            // ============================================
            // Neighbor Systems Event Listeners - KORRIGIERT
            // ============================================
            if (elements.addNeighborBtn) {
                elements.addNeighborBtn.addEventListener('click', addNeighborSystem);
            }

            const neighborModeSelect = document.getElementById('neighborMode');
            if (neighborModeSelect) {
                neighborModeSelect.addEventListener('change', toggleNeighborCustomFields);
            }
            
            // Asteroid belt listeners - HINZUFÜGEN
            elements.addAsteroidBeltBtn.addEventListener('click', addAsteroidBelt);

            // Planet management - KORRIGIERT
            if (elements.addPlanetBtn) {
                elements.addPlanetBtn.addEventListener('click', addPlanet);
            }

            elements.orbitAngleType.addEventListener('change', (e) => {
                const isRange = e.target.value === 'range';
                elements.fixedAngleControl.classList.toggle('hidden', isRange);
                elements.rangeAngleControl.classList.toggle('hidden', !isRange);
                if (selectedPlanet) {
                    selectedPlanet.orbitAngleType = e.target.value;
                    updateOutput();
                }
            });

            // Planet property updates
            elements.celestialName.addEventListener('input', updateSelectedPlanetProperty('name'));
            elements.celestialDisplayName.addEventListener('input', updateSelectedPlanetProperty('displayName'));
            elements.celestialClass.addEventListener('change', (e) => {
                if (selectedPlanet) {
                    selectedPlanet.class = e.target.value;
                    updatePlanetList();
                    updateOutput();
                    renderVisualizer();
                    
                    // Reset modifier selection when class changes as available modifiers change
                    elements.modifierCategory.value = '';
                    elements.modifierType.innerHTML = '<option value="">-- Erst Kategorie wählen --</option>';
                    elements.modifierType.disabled = true;
                    elements.addModifierBtn.disabled = true;
                }
            });
            
            elements.celestialSize.addEventListener('input', (e) => {
                if (selectedPlanet) {
                    selectedPlanet.size = Math.max(1, Math.min(50, parseInt(e.target.value) || 1));
                    e.target.value = selectedPlanet.size;
                    updatePlanetList();
                    updateOutput();
                    renderVisualizer();
                }
            });
            
            elements.celestialOrbitDistance.addEventListener('input', (e) => {
                if (selectedPlanet) {
                    selectedPlanet.orbitDistance = Math.max(0, parseInt(e.target.value) || 0);
                    e.target.value = selectedPlanet.orbitDistance;
                    updatePlanetList();
                    updateOutput();
                    renderVisualizer();
                }
            });

            elements.celestialHasRing.addEventListener('change', (e) => {
                if (selectedPlanet) {
                    selectedPlanet.hasRing = e.target.checked;
                    updateOutput();
                    renderVisualizer();
                }
            });
            
            elements.celestialIsStartingPlanet.addEventListener('change', (e) => {
                if (selectedPlanet) {
                    selectedPlanet.isStartingPlanet = e.target.checked;
                    updateOutput();
                }
            });

            elements.deleteCelestialBtn.addEventListener('click', () => {
                if (!selectedPlanet) return;

                if (selectedPlanet.type === 'planet') {
                    solarSystem.planets = solarSystem.planets.filter(p => p.id !== selectedPlanet.id);
                }

                deselectPlanet();
                updatePlanetList();
                updateOutput();
                renderVisualizer();
            });

            // Visualizer controls
            elements.zoomInBtn.addEventListener('click', () => {
                visualizerScale = Math.min(5.0, visualizerScale * 1.2);
                renderVisualizer();
            });
            elements.zoomOutBtn.addEventListener('click', () => {
                visualizerScale = Math.max(0.1, visualizerScale * 0.8);
                renderVisualizer();
            });
            elements.resetViewBtn.addEventListener('click', () => {
                visualizerScale = 0.3;
                renderVisualizer();
            });

            // Export buttons
            elements.downloadTxtBtn.addEventListener('click', () => {
                const enabledCount = Object.values(systemVariations).filter(v => v.enabled).length;
                const output = elements.exportTxt.value;
                
                if (enabledCount > 1) {
                    const filename = `${solarSystem.name}_${enabledCount}_variants.txt`;
                    downloadFile(output, filename, 'text/plain');
                    showNotification(`${enabledCount} Varianten exportiert!`);
                } else {
                    downloadFile(output, `${solarSystem.name}.txt`, 'text/plain');
                }
            });
            
            elements.downloadYmlBtn.addEventListener('click', () => {
                const bom = '\ufeff';
                downloadFile(bom + elements.exportYml.value, `${solarSystem.name}_l_german.yml`, 'text/plain;charset=utf-8');
            });
            
            // ============================================
            // V7 ADDITIONS - New Event Listeners
            // ============================================
            
            // System Flags
            const addSystemFlagBtn = document.getElementById('addSystemFlagBtn');
            if (addSystemFlagBtn) {
                addSystemFlagBtn.addEventListener('click', addSystemFlag);
            }
            
            const newSystemFlagInput = document.getElementById('newSystemFlag');
            if (newSystemFlagInput) {
                newSystemFlagInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') addSystemFlag();
                });
            }
            
            // Planet Flags
            const addPlanetFlagBtn = document.getElementById('addPlanetFlagBtn');
            if (addPlanetFlagBtn) {
                addPlanetFlagBtn.addEventListener('click', addPlanetFlag);
            }
            
            const newPlanetFlagInput = document.getElementById('newPlanetFlag');
            if (newPlanetFlagInput) {
                newPlanetFlagInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') addPlanetFlag();
                });
            }
            
            // Prevent Anomaly
            const preventAnomalyCheckbox = document.getElementById('celestialPreventAnomaly');
            if (preventAnomalyCheckbox) {
                preventAnomalyCheckbox.addEventListener('change', (e) => {
                    if (selectedPlanet) {
                        selectedPlanet.preventAnomaly = e.target.checked;
                        updateOutput();
                    }
                });
            }
            
            // Entity Override
            const entitySelect = document.getElementById('celestialEntity');
            if (entitySelect) {
                entitySelect.addEventListener('change', (e) => {
                    if (selectedPlanet) {
                        selectedPlanet.entityOverride = e.target.value || null;
                        updateOutput();
                        renderVisualizer();
                    }
                });
            }
            
            // Preview Variations Button
            const previewVariationsBtn = document.getElementById('previewVariationsBtn');
            if (previewVariationsBtn) {
                previewVariationsBtn.addEventListener('click', () => {
                    const enabledVariations = Object.values(systemVariations).filter(v => v.enabled);
                    const names = enabledVariations.map(v => `• ${v.displayName}`).join('\n');
                    alert(`Aktivierte Varianten (${enabledVariations.length}):\n\n${names}\n\nBeim Export werden alle Varianten in einer kombinierten Datei generiert.`);
                });
            }
        }

        // ============================================================
        // [SECTION-17] GLOBALE FUNKTIONEN & INITIALIZATION
        // ============================================================
        // HIER: Funktionen für window-Objekt und DOMContentLoaded
        // WICHTIG: Alle onclick-Handler im HTML brauchen window.*
        // ÄNDERN: Neue onclick-Handler hier hinzufügen
        // 
        // INITIALISIERUNG:
        // 1. Event Listener registrieren
        // 2. Modifier System initialisieren
        // 3. UI-Listen aktualisieren
        // 4. Variationen rendern
        // 5. Output generieren

        // Make functions globally available
        window.selectPlanet = selectPlanet;
        window.removeModifier = removeModifier;
        window.removeAsteroidBelt = removeAsteroidBelt;
        window.removeNeighborSystem = removeNeighborSystem;
        window.editNeighborSystem = editNeighborSystem;
        window.addPlanetToNeighbor = addPlanetToNeighbor;
        window.removePlanetFromNeighbor = removePlanetFromNeighbor;
        window.removeNeighborPlanetDraft = removeNeighborPlanetDraft;
        window.collectCustomNeighborPlanets = collectCustomNeighborPlanets;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            initializeEventListeners();
            initializeModifierSystem();
            updateNeighborSystemsList();
            updateAsteroidBeltList();
            
            // V7 ADDITION - Initialize Variations and Flags
            renderVariationsList();
            updateSystemFlagsList();
            
            // Load default system
            elements.systemName.value = solarSystem.name;
            elements.systemDisplayName.value = solarSystem.displayName;
            elements.systemClass.value = solarSystem.class;
            elements.systemUsage.value = solarSystem.usage;
            
            updatePlanetList();
            updateOutput();
            renderVisualizer();
            
            showNotification('🚀 V7 - System-Variationen & Erweiterte Kompatibilität geladen!');
        });

        window.addEventListener('resize', () => {
            setTimeout(renderVisualizer, 100);
        });
        
        // ============================================================
        // [SECTION-17] GLOBALE FUNKTIONEN & INITIALIZATION
        // ============================================================
        // (Siehe Marker oben)
        
        // ============================================
        // V7 ADDITION - Global Functions for onclick handlers
        // ============================================
        window.removeSystemFlag = removeSystemFlag;
        window.removePlanetFlag = removePlanetFlag;
        window.toggleVariation = toggleVariation;
        window.quickAddSystemFlag = quickAddSystemFlag;

        /*
        ╔══════════════════════════════════════════════════════════════════════╗
        ║              HÄUFIGE ÄNDERUNGEN - QUICK REFERENCE                   ║
        ╚══════════════════════════════════════════════════════════════════════╝
        
        ┌─────────────────────────────────────────────────────────────────────┐
        │ 1️⃣  NEUEN PLANETARY DIVERSITY MODIFIER HINZUFÜGEN                    │
        ├─────────────────────────────────────────────────────────────────────┤
        │ WO:      [SECTION-02] → MODIFIERS → planetary_diversity             │
        │ SUCHE:   "pc_continental:" (oder andere Planetenklasse)             │
        │ AKTION:  Füge neuen Modifier nach diesem Muster hinzu:              │
        │                                                                      │
        │   "pd_dein_neuer_modifier": {                                       │
        │       name: "Dein Modifier Name",                                   │
        │       description: "Beschreibung was er macht"                      │
        │   }                                                                  │
        └─────────────────────────────────────────────────────────────────────┘
        
        ┌─────────────────────────────────────────────────────────────────────┐
        │ 2️⃣  NEUE PLANETENKLASSE HINZUFÜGEN                                   │
        ├─────────────────────────────────────────────────────────────────────┤
        │ 1. HTML → <select id="celestialClass"> → Neue <option> hinzufügen  │
        │ 2. [SECTION-15] → getPlanetIcon() → Icon hinzufügen                │
        │ 3. [SECTION-15] → getClassDisplayName() → Namen hinzufügen         │
        │ 4. [SECTION-15] → getColorForClass() → Farbe hinzufügen            │
        └─────────────────────────────────────────────────────────────────────┘
        
        ┌─────────────────────────────────────────────────────────────────────┐
        │ 3️⃣  NEUE ORIGIN-VARIANTE HINZUFÜGEN                                  │
        ├─────────────────────────────────────────────────────────────────────┤
        │ WO:      [SECTION-03] → systemVariations                            │
        │ AKTION:  Kopiere eine bestehende Variante (z.B. commonwealth)      │
        │          und ändere:                                                 │
        │   - id: eindeutiger Bezeichner                                      │
        │   - suffix: wird an Systemnamen angehängt                           │
        │   - displayName: Anzeigename für User                               │
        │   - icon: Emoji für die Card                                        │
        │   - modifications: Welche Änderungen am System                      │
        └─────────────────────────────────────────────────────────────────────┘
        
        ┌─────────────────────────────────────────────────────────────────────┐
        │ 4️⃣  STANDARD-PLANET-WERTE ÄNDERN                                     │
        ├─────────────────────────────────────────────────────────────────────┤
        │ WO:      [SECTION-08] → addPlanet()                                 │
        │ SUCHE:   "const newPlanet = {"                                      │
        │ ÄNDERE:  - class: Standard-Planetenklasse                           │
        │          - size: Standard-Größe                                     │
        │          - orbitDistance: Anfangsabstand                            │
        └─────────────────────────────────────────────────────────────────────┘
        
        ┌─────────────────────────────────────────────────────────────────────┐
        │ 5️⃣  STELLARIS CODE-OUTPUT ANPASSEN                                   │
        ├─────────────────────────────────────────────────────────────────────┤
        │ WO:      [SECTION-12] → generateSingleVariant()                     │
        │ TIPP:    Suche nach bestimmten Stellaris-Befehlen (z.B. "flags =") │
        │ WICHTIG: Achte auf korrekte Tab-Einrückung (\t)                    │
        └─────────────────────────────────────────────────────────────────────┘
        
        ┌─────────────────────────────────────────────────────────────────────┐
        │ 6️⃣  NEUE BUTTON/INPUT HINZUFÜGEN                                     │
        ├─────────────────────────────────────────────────────────────────────┤
        │ 1. HTML → Neues Element mit eindeutiger id="" erstellen            │
        │ 2. [SECTION-04] → elements → getElementById hinzufügen              │
        │ 3. [SECTION-16] → initializeEventListeners() → Event hinzufügen    │
        │ 4. Bei onclick im HTML: Funktion in window.* verfügbar machen      │
        │    (siehe [SECTION-17] → window.deineFunktion = ...)               │
        └─────────────────────────────────────────────────────────────────────┘
        
        ┌─────────────────────────────────────────────────────────────────────┐
        │ 7️⃣  VISUALIZER ANPASSEN (FARBEN, GRÖSSEN)                            │
        ├─────────────────────────────────────────────────────────────────────┤
        │ WO:      [SECTION-14] → renderVisualizer() & drawCelestial()       │
        │ ÄNDERN:                                                              │
        │   - Planetengröße: Suche "size * visualizerScale"                  │
        │   - Orbit-Ringe: Suche ".orbit-indicator"                           │
        │   - Zoom-Stufe: Ändere "visualizerScale = 0.3" am Anfang          │
        │   - Stern-Größe: Suche "const starSize = 30"                       │
        └─────────────────────────────────────────────────────────────────────┘
        
        ┌─────────────────────────────────────────────────────────────────────┐
        │ 8️⃣  DEBUGGING-TIPPS                                                  │
        ├─────────────────────────────────────────────────────────────────────┤
        │ • Browser-Konsole öffnen: F12 → Console Tab                        │
        │ • Fehler bei Button-Klick: Prüfe ob Funktion in window.* ist      │
        │ • Daten nicht gespeichert: Prüfe updateOutput() Aufrufe           │
        │ • UI aktualisiert nicht: Prüfe update...() Funktionsaufrufe       │
        │ • Export falsch: console.log(solarSystem) vor Export ausführen    │
        └─────────────────────────────────────────────────────────────────────┘
        
        ┌─────────────────────────────────────────────────────────────────────┐
        │ 9️⃣  SUCHTIPPS FÜR STRG+F                                             │
        ├─────────────────────────────────────────────────────────────────────┤
        │ • [SECTION-XX]    → Springe zu Hauptbereichen                      │
        │ • function add    → Finde alle add..() Funktionen                  │
        │ • function update → Finde alle update..() Funktionen               │
        │ • addEventListener → Finde alle Event-Registrierungen              │
        │ • window.         → Finde alle globalen Funktionen                 │
        │ • txt +=          → Finde Code-Generierung                         │
        │ • getElementById  → Finde HTML-Element-Verknüpfungen              │
        └─────────────────────────────────────────────────────────────────────┘
        
        ╔══════════════════════════════════════════════════════════════════════╗
        ║  Bei Fragen: Suche nach dem relevanten [SECTION-XX] Marker oder    ║
        ║  durchsuche die Kommentare mit "HIER:", "ÄNDERN:", "WICHTIG:"      ║
        ╚══════════════════════════════════════════════════════════════════════╝
        */
    </script>
</body>
</html>
