<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stellaris Solar System Editor - Korrekte Orbit-Mechanik</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800;900&family=Exo+2:wght@300;400;500;600&display=swap');
        
        :root {
            --stellaris-blue: #00d4ff;
            --stellaris-gold: #ffd700;
            --stellaris-purple: #9966ff;
            --stellaris-dark: #0a0e1a;
            --stellaris-darker: #050811;
            --stellaris-panel: #1a2332;
            --stellaris-border: #2a3847;
            --stellaris-accent: #00a8cc;
        }

        body {
            font-family: 'Exo 2', 'Inter', sans-serif;
            background: linear-gradient(135deg, var(--stellaris-darker) 0%, var(--stellaris-dark) 50%, #0f1419 100%);
            color: #e2e8f0;
            min-height: 100vh;
            background-attachment: fixed;
        }

        .stellaris-header {
            background: linear-gradient(90deg, var(--stellaris-blue) 0%, var(--stellaris-purple) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-family: 'Orbitron', monospace;
            font-weight: 700;
            text-align: center;
            font-size: 2.5rem;
            margin-bottom: 2rem;
            text-shadow: 0 0 20px rgba(0, 212, 255, 0.3);
        }

        .stellaris-panel {
            background: linear-gradient(145deg, var(--stellaris-panel) 0%, rgba(26, 35, 50, 0.8) 100%);
            border: 1px solid var(--stellaris-border);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            position: relative;
            overflow: hidden;
        }

        .stellaris-panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, var(--stellaris-blue), var(--stellaris-purple), var(--stellaris-gold));
        }

        .stellaris-input {
            background: linear-gradient(145deg, #2a3847 0%, #1e2936 100%);
            border: 1px solid var(--stellaris-border);
            color: #0068f3;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            width: 100%;
            font-family: 'Exo 2', sans-serif;
            transition: all 0.3s ease;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .stellaris-input:focus {
            outline: none;
            border-color: var(--stellaris-blue);
            box-shadow: 
                inset 0 2px 4px rgba(0, 0, 0, 0.2),
                0 0 0 3px rgba(0, 212, 255, 0.2);
        }

        .stellaris-btn {
            background: linear-gradient(145deg, var(--stellaris-blue) 0%, var(--stellaris-accent) 100%);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            font-family: 'Exo 2', sans-serif;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 4px 15px rgba(0, 212, 255, 0.3);
        }

        .stellaris-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }

        .stellaris-btn:hover::before {
            left: 100%;
        }

        .stellaris-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 212, 255, 0.4);
        }

        .stellaris-btn-secondary {
            background: linear-gradient(145deg, #4a5568 0%, #2d3748 100%);
            box-shadow: 0 4px 15px rgba(74, 85, 104, 0.3);
        }

        .stellaris-btn-danger {
            background: linear-gradient(145deg, #e53e3e 0%, #c53030 100%);
            box-shadow: 0 4px 15px rgba(229, 62, 62, 0.3);
        }

        .celestial-item {
            background: linear-gradient(145deg, rgba(74, 85, 104, 0.6) 0%, rgba(45, 55, 72, 0.8) 100%);
            border: 1px solid var(--stellaris-border);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
            backdrop-filter: blur(5px);
        }

        .celestial-item:hover {
            background: linear-gradient(145deg, rgba(0, 212, 255, 0.1) 0%, rgba(153, 102, 255, 0.1) 100%);
            border-color: var(--stellaris-blue);
            transform: translateX(4px);
        }

        .celestial-item.selected {
            background: linear-gradient(145deg, rgba(0, 212, 255, 0.2) 0%, rgba(153, 102, 255, 0.2) 100%);
            border-color: var(--stellaris-blue);
            box-shadow: 0 0 20px rgba(0, 212, 255, 0.3);
        }

        .celestial-item.new-orbit {
            border-left: 4px solid var(--stellaris-gold);
        }

        .celestial-item.same-orbit {
            border-left: 4px solid rgba(255, 255, 255, 0.3);
        }

        .stellaris-visualizer {
            background: radial-gradient(circle at center, #0a0e1a 0%, #000 70%);
            border: 2px solid var(--stellaris-border);
            border-radius: 12px;
            height: 500px;
            position: relative;
            overflow: hidden;
            box-shadow: inset 0 0 50px rgba(0, 0, 0, 0.8);
        }

        .section-title {
            font-family: 'Orbitron', monospace;
            font-weight: 600;
            font-size: 1.5rem;
            color: var(--stellaris-blue);
            margin-bottom: 1rem;
            text-shadow: 0 0 10px rgba(0, 212, 255, 0.3);
        }

        .label {
            font-weight: 500;
            color: #cbd5e0;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stellaris-export-area {
            background: linear-gradient(145deg, #1a1f2e 0%, #0f1419 100%);
            border: 1px solid var(--stellaris-border);
            border-radius: 8px;
            padding: 1rem;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            line-height: 1.4;
            color: #e2e8f0;
            resize: none;
            min-height: 200px;
            min-width: 400px;
        }

        .warning-panel {
            background: linear-gradient(145deg, rgba(255, 193, 7, 0.1) 0%, rgba(255, 152, 0, 0.1) 100%);
            border: 1px solid rgba(255, 193, 7, 0.3);
            border-radius: 8px;
            padding: 1.5rem;
            margin-top: 2rem;
        }

        .orbit-indicator {
            position: absolute;
            border: 1px dashed rgba(0, 212, 255, 0.3);
            border-radius: 50%;
            pointer-events: none;
        }

        .stellaris-star {
            background: radial-gradient(circle, #ffeb3b 0%, #ff9800 100%);
            box-shadow: 
                0 0 30px #ffeb3b,
                0 0 60px rgba(255, 235, 59, 0.5),
                0 0 90px rgba(255, 152, 0, 0.3);
            animation: starGlow 3s ease-in-out infinite alternate;
        }

        @keyframes starGlow {
            0% { box-shadow: 0 0 30px #ffeb3b, 0 0 60px rgba(255, 235, 59, 0.5); }
            100% { box-shadow: 0 0 40px #ffeb3b, 0 0 80px rgba(255, 235, 59, 0.7); }
        }

        .planet, .moon {
            border-radius: 50%;
            position: absolute;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 0.7rem;
            font-weight: 600;
            color: white;
            text-shadow: 0 0 5px rgba(0, 0, 0, 0.8);
            border: 2px solid rgba(255, 255, 255, 0.3);
            box-shadow: 
                0 2px 10px rgba(0, 0, 0, 0.5),
                inset 0 0 10px rgba(255, 255, 255, 0.1);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .planet:hover, .moon:hover {
            transform: scale(1.1);
            box-shadow: 
                0 4px 20px rgba(0, 212, 255, 0.5),
                inset 0 0 15px rgba(255, 255, 255, 0.2);
        }

        .asteroid-belt {
            position: absolute;
            border: 2px dotted rgba(139, 69, 19, 0.6);
            border-radius: 50%;
            pointer-events: none;
        }

        .orbit-number {
            position: absolute;
            color: rgba(0, 212, 255, 0.7);
            font-size: 0.8rem;
            font-weight: bold;
            background: rgba(0, 0, 0, 0.5);
            padding: 2px 6px;
            border-radius: 4px;
        }

        .orbit-distance-info {
            background: rgba(0, 212, 255, 0.1);
            border: 1px solid rgba(0, 212, 255, 0.3);
            border-radius: 4px;
            padding: 0.5rem;
            margin-top: 0.5rem;
            font-size: 0.8rem;
        }

        .grid {
            display: grid;
            gap: 1.5rem;
        }

        .grid-cols-1 { grid-template-columns: 1fr; }
        .grid-cols-2 { grid-template-columns: repeat(2, 1fr); }
        .grid-cols-3 { grid-template-columns: repeat(3, 1fr); }

        @media (min-width: 768px) {
            .md\:grid-cols-2 { grid-template-columns: repeat(2, 1fr); }
        }

        @media (min-width: 1024px) {
            .lg\:grid-cols-3 { grid-template-columns: repeat(3, 1fr); }
            .lg\:col-span-2 { grid-column: span 2; }
        }

        .hidden { display: none; }
        .ml-6 { margin-left: 1.5rem; }
        .ml-2 { margin-left: 0.5rem; }
        .mt-4 { margin-top: 1rem; }
        .mt-6 { margin-top: 1.5rem; }
        .mb-4 { margin-bottom: 1rem; }
        .mb-8 { margin-bottom: 2rem; }
        .py-8 { padding-top: 2rem; padding-bottom: 2rem; }
        .px-2 { padding-left: 0.5rem; padding-right: 0.5rem; }
        .py-1 { padding-top: 0.25rem; padding-bottom: 0.25rem; }
        .text-sm { font-size: 0.875rem; }
        .max-h-96 { max-height: 24rem; }
        .overflow-y-auto { overflow-y: auto; }
        .cursor-not-allowed { cursor: not-allowed; }
        .container { max-width: 1400px; margin: 0 auto; padding: 2rem; }
    </style>
</head>
<body>
    <div class="container py-8">
        <h1 class="stellaris-header">Stellaris Solar System Editor</h1>
        <div class="text-center mb-6">
            <span class="text-yellow-400 font-semibold">Mit korrekter Stellaris-Orbit-Mechanik (orbit_distance = 0 System)</span>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 mb-8">
            <!-- System Details Panel -->
            <div class="stellaris-panel lg:col-span-2">
                <h2 class="section-title">Systemdetails</h2>
                <div class="grid grid-cols-1 md:grid-cols-2">
                    <div>
                        <label class="label">Systemname (Interner Bezeichner)</label>
                        <input type="text" id="systemName" class="stellaris-input" placeholder="z.B. akon_system_initializer">
                    </div>
                    <div>
                        <label class="label">Anzeigename des Systems</label>
                        <input type="text" id="systemDisplayName" class="stellaris-input" placeholder="z.B. Akon">
                    </div>
                    <div>
                        <label class="label">Sternenklasse</label>
                        <select id="systemClass" class="stellaris-input">
                            <option value="sc_b">B-Klasse Stern (Heißer Riese)</option>
                            <option value="sc_a">A-Klasse Stern (Weißer Stern)</option>
                            <option value="sc_f">F-Klasse Stern (Gelblich-weißer Stern)</option>
                            <option value="sc_g" selected>G-Klasse Stern (Gelber Zwerg - Sol)</option>
                            <option value="sc_k">K-Klasse Stern (Oranger Zwerg)</option>
                            <option value="sc_m">M-Klasse Stern (Roter Zwerg)</option>
                            <option value="sc_black_hole">Schwarzes Loch</option>
                            <option value="sc_neutron_star">Neutronenstern</option>
                            <option value="sc_pulsar">Pulsar</option>
                            <option value="sc_trinary">Binär/Trinär (Zufällig)</option>
                        </select>
                    </div>
                    <div>
                        <label class="label">Verwendung</label>
                        <select id="systemUsage" class="stellaris-input">
                            <option value="empire_init">Imperiumsstart (Zufällig)</option>
                            <option value="custom_empire" selected>Benutzerdefiniertes Imperium (Wählbar)</option>
                            <option value="misc_system_init">Verschiedenes System (Zufällig)</option>
                            <option value="">Keine (Nur durch Ereignis)</option>
                        </select>
                    </div>
                </div>
                
                <!-- Asteroid Belt Configuration -->
                <div class="mt-6 p-4 bg-gray-800 rounded-lg">
                    <h3 class="text-lg font-medium mb-4 text-yellow-400">Asteroidengürtel (Multiple möglich)</h3>
                    <div id="asteroidBeltList" class="space-y-2 mb-4">
                        <p class="text-gray-400 text-sm">Keine Asteroidengürtel definiert</p>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="label">Typ</label>
                            <select id="newAsteroidBeltType" class="stellaris-input">
                                <option value="rocky_asteroid_belt">Rocky Asteroid Belt</option>
                                <option value="icy_asteroid_belt">Icy Asteroid Belt</option>
                                <option value="crystalline_asteroid_belt">Crystalline Asteroid Belt</option>
                            </select>
                        </div>
                        <div>
                            <label class="label">Radius</label>
                            <input type="number" id="newAsteroidBeltRadius" class="stellaris-input" value="575" min="100" max="1000">
                        </div>
                        <div class="flex items-end">
                            <button id="addAsteroidBeltBtn" class="stellaris-btn stellaris-btn-secondary">Gürtel hinzufügen</button>
                        </div>
                    </div>
                </div>

                <div class="mt-6">
                    <button id="addPlanetBtn" class="stellaris-btn">Planet hinzufügen</button>
                    <button id="moveUpBtn" class="stellaris-btn stellaris-btn-secondary ml-2" disabled>↑ Nach oben</button>
                    <button id="moveDownBtn" class="stellaris-btn stellaris-btn-secondary ml-2" disabled>↓ Nach unten</button>
                </div>
                
                <!-- Orbit Distance Info -->
                <div class="orbit-distance-info mt-4">
                    <strong>💡 Stellaris Kumulative Orbit-Mechanik:</strong><br>
                    📐 <strong>Kumulative Addition:</strong> orbit_distance wird zur Gesamtdistanz addiert<br>
                    🟡 <strong>Planet 1:</strong> orbit_distance = 25 → Umlaufbahn bei 25<br>
                    🟡 <strong>Planet 2:</strong> orbit_distance = 30 → Umlaufbahn bei 25+30 = 55<br>
                    ⚪ <strong>Planet 3:</strong> orbit_distance = 0 → Gleiche Umlaufbahn bei 55
                </div>
            </div>

            <!-- Visualizer Panel -->
            <div class="stellaris-panel">
                <h2 class="section-title">System-Visualisierung</h2>
                <div id="visualizer" class="stellaris-visualizer">
                    <!-- Celestial bodies will be rendered here -->
                </div>
                <div class="mt-4">
                    <button id="zoomInBtn" class="stellaris-btn stellaris-btn-secondary text-sm px-2 py-1">Zoom +</button>
                    <button id="zoomOutBtn" class="stellaris-btn stellaris-btn-secondary text-sm px-2 py-1 ml-2">Zoom -</button>
                    <button id="resetViewBtn" class="stellaris-btn stellaris-btn-secondary text-sm px-2 py-1 ml-2">Reset</button>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 mb-8">
            <!-- Planet List -->
            <div class="stellaris-panel">
                <h2 class="section-title">Planeten (Reihenfolge)</h2>
                <div id="planetList" class="max-h-96 overflow-y-auto">
                    <p class="text-gray-400">Fügen Sie Planeten hinzu, um mit dem Systembau zu beginnen.</p>
                </div>
            </div>

            <!-- Celestial Body Details Panel -->
            <div class="stellaris-panel lg:col-span-2">
                <h2 class="section-title">Planet-Details</h2>
                <div id="celestialDetails" class="hidden">
                    <div class="grid grid-cols-1 md:grid-cols-2">
                        <div>
                            <label class="label">Typ</label>
                            <input type="text" id="celestialType" class="stellaris-input cursor-not-allowed" readonly>
                        </div>
                        <div>
                            <label class="label">Position in System</label>
                            <input type="text" id="celestialPosition" class="stellaris-input cursor-not-allowed" readonly>
                        </div>
                        <div>
                            <label class="label">Name (Interner Bezeichner)</label>
                            <input type="text" id="celestialName" class="stellaris-input" placeholder="z.B. akon">
                        </div>
                        <div>
                            <label class="label">Anzeigename</label>
                            <input type="text" id="celestialDisplayName" class="stellaris-input" placeholder="z.B. Akon">
                        </div>
                        <div>
                            <label class="label">Planetenklasse</label>
                            <select id="celestialClass" class="stellaris-input">
                                <optgroup label="Sterne">
                                    <option value="pc_b_star">B-Klasse Stern</option>
                                    <option value="pc_a_star">A-Klasse Stern</option>
                                    <option value="pc_f_star">F-Klasse Stern</option>
                                    <option value="pc_g_star">G-Klasse Stern</option>
                                    <option value="pc_k_star">K-Klasse Stern</option>
                                    <option value="pc_m_star">M-Klasse Stern</option>
                                </optgroup>
                                <optgroup label="Bewohnbare Welten">
                                    <option value="pc_continental">Kontinental</option>
                                    <option value="pc_ocean">Ozean</option>
                                    <option value="pc_tropical">Tropisch</option>
                                    <option value="pc_arid">Arid</option>
                                    <option value="pc_desert">Wüste</option>
                                    <option value="pc_savanna">Savanne</option>
                                    <option value="pc_arctic">Arktisch</option>
                                    <option value="pc_tundra">Tundra</option>
                                    <option value="pc_alpine">Alpin</option>
                                    <option value="pc_gaia">Gaia</option>
                                </optgroup>
                                <optgroup label="Unbewohnbare Welten">
                                    <option value="pc_barren" selected>Karg</option>
                                    <option value="pc_barren_cold">Karg (Kalt)</option>
                                    <option value="pc_frozen">Gefroren</option>
                                    <option value="pc_molten">Geschmolzen</option>
                                    <option value="pc_toxic">Toxisch</option>
                                    <option value="pc_hothouse">Treibhaus</option>
                                    <option value="pc_gas_giant">Gasriese</option>
                                    <option value="pc_hot_gas_giant">Heißer Gasriese</option>
                                    <option value="pc_cold_gas_giant">Kalter Gasriese</option>
                                    <option value="pc_dwarf_gas_giant">Zwerg-Gasriese</option>
                                    <option value="pc_storm">Sturm</option>
                                    <option value="pc_nuked">Verstrahlt</option>
                                    <option value="pc_shattered">Zerstört</option>
                                    <option value="pc_asteroid">Asteroid</option>
                                    <option value="pc_subglacial">Subglazial</option>
                                </optgroup>
                                <optgroup label="Spezielle Welten">
                                    <option value="pc_relic">Relikt-Welt</option>
                                    <option value="pc_habitat">Habitat</option>
                                    <option value="pc_ecumenopolis">Ökumenopolis</option>
                                    <option value="pc_machine">Maschinenwelt</option>
                                    <option value="pc_hive">Schwarmwelt</option>
                                    <option value="pc_shielded">Abgeschirmt</option>
                                </optgroup>
                            </select>
                        </div>
                        <div>
                            <label class="label">Größe (1-50)</label>
                            <input type="number" id="celestialSize" class="stellaris-input" min="1" max="50" value="16">
                        </div>
                        <div>
                            <label class="label">Orbit Distance</label>
                            <input type="number" id="celestialOrbitDistance" class="stellaris-input" min="0" value="0">
                            <small class="text-gray-400 text-xs">0 = Gleiche Umlaufbahn wie vorheriger Planet</small>
                        </div>
                        <div>
                            <label class="label">Orbit Angle (Typ)</label>
                            <select id="orbitAngleType" class="stellaris-input">
                                <option value="fixed">Fester Winkel</option>
                                <option value="range" selected>Winkelbereich</option>
                            </select>
                        </div>
                        <div class="orbit-angle-controls">
                            <div id="fixedAngleControl" class="hidden">
                                <label class="label">Winkel (0-360°)</label>
                                <input type="number" id="celestialOrbitAngle" class="stellaris-input" min="0" max="360" value="0">
                            </div>
                            <div id="rangeAngleControl">
                                <label class="label">Winkelbereich</label>
                                <div class="grid grid-cols-2 gap-2">
                                    <input type="number" id="celestialOrbitAngleMin" class="stellaris-input" min="0" max="360" value="90" placeholder="Min">
                                    <input type="number" id="celestialOrbitAngleMax" class="stellaris-input" min="0" max="360" value="270" placeholder="Max">
                                </div>
                            </div>
                        </div>
                        <div>
                            <label class="label">Change Orbit (für nachfolgende Planeten)</label>
                            <input type="number" id="celestialChangeOrbit" class="stellaris-input" min="0" value="0">
                            <small class="text-gray-400 text-xs">0 = Keine Änderung</small>
                        </div>
                        <div class="md:col-span-2">
                            <div class="grid grid-cols-2 gap-4">
                                <label class="label">
                                    <input type="checkbox" id="celestialHasRing" class="mr-2">
                                    Hat Ringsystem
                                </label>
                                <label class="label">
                                    <input type="checkbox" id="celestialIsStartingPlanet" class="mr-2">
                                    Startplanet (Empire)
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="mt-6">
                        <button id="addMoonBtn" class="stellaris-btn stellaris-btn-secondary">Mond hinzufügen</button>
                        <button id="deleteCelestialBtn" class="stellaris-btn stellaris-btn-danger ml-2">Löschen</button>
                    </div>
                </div>
                <p id="noCelestialSelected" class="text-gray-400">Wählen Sie einen Planeten aus der Liste, um seine Details zu bearbeiten.</p>
            </div>
        </div>

        <!-- Import/Export Section -->
        <div class="stellaris-panel">
            <h2 class="section-title">Import / Export</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 mt-8">
                <div>
                    <h3 class="text-xl font-medium mb-4 text-green-400">Generierter Stellaris Code (.txt)</h3>
                    <textarea id="exportTxt" class="stellaris-export-area" rows="20" readonly></textarea>
                    <button id="downloadTxtBtn" class="stellaris-btn mt-4">Als .txt herunterladen</button>
                </div>
                <div>
                    <h3 class="text-xl font-medium mb-4 text-green-400">Generierte Lokalisierung (.yml)</h3>
                    <textarea id="exportYml" class="stellaris-export-area" rows="20" readonly></textarea>
                    <button id="downloadYmlBtn" class="stellaris-btn mt-4">Als .yml herunterladen</button>
                </div>
            </div>
            <div class="warning-panel">
                <p class="font-semibold text-yellow-300 mb-2">🎯 Kumulative Stellaris Orbit-Mechanik implementiert:</p>
                <ul class="list-disc list-inside space-y-1 text-sm">
                    <li><strong>Kumulative Addition:</strong> orbit_distance wird zur Gesamtdistanz addiert (Planet 1: 25, Planet 2: +30 = 55)</li>
                    <li><strong>orbit_distance = 0:</strong> Bedeutet "gleiche Umlaufbahn wie aktuell" (kein Distanz-Zuwachs)</li>
                    <li><strong>Multiple Asteroidengürtel:</strong> Beliebig viele Gürtel mit verschiedenen Radien möglich</li>
                    <li><strong>change_orbit:</strong> Verschiebt die aktuelle Umlaufbahn für nachfolgende Planeten</li>
                    <li><strong>Korrekte Visualisierung:</strong> Zeigt echte Stellaris-Distanzen (z.B. 25 → 55 → 55 → 75)</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        // Corrected data model for cumulative orbit calculation
        let solarSystem = {
            name: 'my_custom_system',
            displayName: 'Mein Sonnensystem',
            class: 'sc_g',
            usage: 'custom_empire',
            asteroidBelts: [], // Array of multiple asteroid belts
            planets: [] // Sequential array of planets with cumulative orbit distances
        };

        let selectedPlanet = null;
        let nextCelestialId = 1;
        let visualizerScale = 0.3;

        // DOM Elements
        const elements = {
            systemName: document.getElementById('systemName'),
            systemDisplayName: document.getElementById('systemDisplayName'),
            systemClass: document.getElementById('systemClass'),
            systemUsage: document.getElementById('systemUsage'),
            asteroidBeltList: document.getElementById('asteroidBeltList'),
            newAsteroidBeltType: document.getElementById('newAsteroidBeltType'),
            newAsteroidBeltRadius: document.getElementById('newAsteroidBeltRadius'),
            addAsteroidBeltBtn: document.getElementById('addAsteroidBeltBtn'),
            addPlanetBtn: document.getElementById('addPlanetBtn'),
            moveUpBtn: document.getElementById('moveUpBtn'),
            moveDownBtn: document.getElementById('moveDownBtn'),
            planetList: document.getElementById('planetList'),
            celestialDetails: document.getElementById('celestialDetails'),
            noCelestialSelected: document.getElementById('noCelestialSelected'),
            celestialType: document.getElementById('celestialType'),
            celestialPosition: document.getElementById('celestialPosition'),
            celestialName: document.getElementById('celestialName'),
            celestialDisplayName: document.getElementById('celestialDisplayName'),
            celestialClass: document.getElementById('celestialClass'),
            celestialSize: document.getElementById('celestialSize'),
            celestialOrbitDistance: document.getElementById('celestialOrbitDistance'),
            orbitAngleType: document.getElementById('orbitAngleType'),
            celestialOrbitAngle: document.getElementById('celestialOrbitAngle'),
            celestialOrbitAngleMin: document.getElementById('celestialOrbitAngleMin'),
            celestialOrbitAngleMax: document.getElementById('celestialOrbitAngleMax'),
            celestialChangeOrbit: document.getElementById('celestialChangeOrbit'),
            celestialHasRing: document.getElementById('celestialHasRing'),
            celestialIsStartingPlanet: document.getElementById('celestialIsStartingPlanet'),
            addMoonBtn: document.getElementById('addMoonBtn'),
            deleteCelestialBtn: document.getElementById('deleteCelestialBtn'),
            fixedAngleControl: document.getElementById('fixedAngleControl'),
            rangeAngleControl: document.getElementById('rangeAngleControl'),
            visualizer: document.getElementById('visualizer'),
            zoomInBtn: document.getElementById('zoomInBtn'),
            zoomOutBtn: document.getElementById('zoomOutBtn'),
            resetViewBtn: document.getElementById('resetViewBtn'),
            exportTxt: document.getElementById('exportTxt'),
            exportYml: document.getElementById('exportYml'),
            downloadTxtBtn: document.getElementById('downloadTxtBtn'),
            downloadYmlBtn: document.getElementById('downloadYmlBtn')
        };

        // Event Listeners
        function initializeEventListeners() {
            elements.systemName.addEventListener('input', (e) => {
                const value = e.target.value.replace(/[^a-zA-Z0-9_]/g, '');
                e.target.value = value;
                solarSystem.name = value || 'my_custom_system';
                updateOutput();
            });

            elements.systemDisplayName.addEventListener('input', (e) => {
                solarSystem.displayName = e.target.value || 'Unbenanntes System';
                updateOutput();
            });

            elements.systemClass.addEventListener('change', (e) => {
                solarSystem.class = e.target.value;
                updateOutput();
                renderVisualizer();
            });

            elements.systemUsage.addEventListener('change', (e) => {
                solarSystem.usage = e.target.value;
                updateOutput();
            });

            elements.addAsteroidBeltBtn.addEventListener('click', addAsteroidBelt);

            elements.addPlanetBtn.addEventListener('click', addPlanet);
            elements.moveUpBtn.addEventListener('click', movePlanetUp);
            elements.moveDownBtn.addEventListener('click', movePlanetDown);

            elements.orbitAngleType.addEventListener('change', (e) => {
                const isRange = e.target.value === 'range';
                elements.fixedAngleControl.classList.toggle('hidden', isRange);
                elements.rangeAngleControl.classList.toggle('hidden', !isRange);
                if (selectedPlanet) {
                    selectedPlanet.orbitAngleType = e.target.value;
                    updateOutput();
                }
            });

            // Planet property updates
            elements.celestialName.addEventListener('input', updateSelectedPlanetProperty('name'));
            elements.celestialDisplayName.addEventListener('input', updateSelectedPlanetProperty('displayName'));
            elements.celestialClass.addEventListener('change', updateSelectedPlanetProperty('class'));
            elements.celestialSize.addEventListener('input', (e) => {
                if (selectedPlanet) {
                    selectedPlanet.size = Math.max(1, Math.min(50, parseInt(e.target.value) || 1));
                    e.target.value = selectedPlanet.size;
                    updateAsteroidBeltList();
            updatePlanetList();
                    updateOutput();
                    renderVisualizer();
                }
            });
            elements.celestialOrbitDistance.addEventListener('input', (e) => {
                if (selectedPlanet) {
                    selectedPlanet.orbitDistance = Math.max(0, parseInt(e.target.value) || 0);
                    e.target.value = selectedPlanet.orbitDistance;
                    updatePlanetList();
                    updateOutput();
                    renderVisualizer();
                }
            });
            elements.celestialOrbitAngle.addEventListener('input', (e) => {
                if (selectedPlanet) {
                    selectedPlanet.orbitAngle = Math.max(0, Math.min(360, parseInt(e.target.value) || 0));
                    e.target.value = selectedPlanet.orbitAngle;
                    updateOutput();
                    renderVisualizer();
                }
            });
            elements.celestialOrbitAngleMin.addEventListener('input', (e) => {
                if (selectedPlanet) {
                    selectedPlanet.orbitAngleMin = Math.max(0, Math.min(360, parseInt(e.target.value) || 0));
                    e.target.value = selectedPlanet.orbitAngleMin;
                    updateOutput();
                    renderVisualizer();
                }
            });
            elements.celestialOrbitAngleMax.addEventListener('input', (e) => {
                if (selectedPlanet) {
                    selectedPlanet.orbitAngleMax = Math.max(0, Math.min(360, parseInt(e.target.value) || 0));
                    e.target.value = selectedPlanet.orbitAngleMax;
                    updateOutput();
                    renderVisualizer();
                }
            });
            elements.celestialChangeOrbit.addEventListener('input', (e) => {
                if (selectedPlanet) {
                    selectedPlanet.changeOrbit = Math.max(0, parseInt(e.target.value) || 0);
                    e.target.value = selectedPlanet.changeOrbit;
                    updateOutput();
                }
            });
            elements.celestialHasRing.addEventListener('change', (e) => {
                if (selectedPlanet) {
                    selectedPlanet.hasRing = e.target.checked;
                    updateOutput();
                }
            });
            elements.celestialIsStartingPlanet.addEventListener('change', (e) => {
                if (selectedPlanet) {
                    selectedPlanet.isStartingPlanet = e.target.checked;
                    updateOutput();
                }
            });

            elements.addMoonBtn.addEventListener('click', addMoonToSelectedPlanet);
            elements.deleteCelestialBtn.addEventListener('click', deleteSelectedPlanet);

            // Visualizer controls
            elements.zoomInBtn.addEventListener('click', () => {
                visualizerScale = Math.min(1.0, visualizerScale * 1.2);
                renderVisualizer();
            });
            elements.zoomOutBtn.addEventListener('click', () => {
                visualizerScale = Math.max(0.1, visualizerScale * 0.8);
                renderVisualizer();
            });
            elements.resetViewBtn.addEventListener('click', () => {
                visualizerScale = 0.3;
                renderVisualizer();
            });

            // Export buttons
            elements.downloadTxtBtn.addEventListener('click', () => 
                downloadFile(elements.exportTxt.value, `${solarSystem.name}.txt`, 'text/plain'));
            elements.downloadYmlBtn.addEventListener('click', () => {
                const bom = '\ufeff';
                downloadFile(bom + elements.exportYml.value, `${solarSystem.name}_l_german.yml`, 'text/plain;charset=utf-8');
            });
        }

        function updateSelectedPlanetProperty(property) {
            return (e) => {
                if (selectedPlanet) {
                    selectedPlanet[property] = e.target.value;
                    updatePlanetList();
                    updateOutput();
                    renderVisualizer();
                }
            };
        }

        // Asteroid Belt Management
        function addAsteroidBelt() {
            const newBelt = {
                id: Date.now(), // Simple unique ID
                type: elements.newAsteroidBeltType.value,
                radius: parseInt(elements.newAsteroidBeltRadius.value) || 575
            };
            
            solarSystem.asteroidBelts.push(newBelt);
            updateAsteroidBeltList();
            updateOutput();
            renderVisualizer();
        }

        function updateAsteroidBeltList() {
            elements.asteroidBeltList.innerHTML = '';
            
            if (solarSystem.asteroidBelts.length === 0) {
                elements.asteroidBeltList.innerHTML = '<p class="text-gray-400 text-sm">Keine Asteroidengürtel definiert</p>';
                return;
            }

            solarSystem.asteroidBelts.forEach((belt, index) => {
                const beltItem = document.createElement('div');
                beltItem.className = 'flex items-center justify-between bg-gray-700 p-2 rounded';
                beltItem.innerHTML = `
                    <span class="text-sm">
                        ☄️ ${getAsteroidBeltTypeName(belt.type)} (Radius: ${belt.radius})
                    </span>
                    <button class="stellaris-btn stellaris-btn-danger text-xs px-2 py-1" onclick="removeAsteroidBelt(${belt.id})">
                        Löschen
                    </button>
                `;
                elements.asteroidBeltList.appendChild(beltItem);
            });
        }

        function removeAsteroidBelt(beltId) {
            solarSystem.asteroidBelts = solarSystem.asteroidBelts.filter(belt => belt.id !== beltId);
            updateAsteroidBeltList();
            updateOutput();
            renderVisualizer();
        }

        function getAsteroidBeltTypeName(type) {
            const names = {
                'rocky_asteroid_belt': 'Felsiger Asteroidengürtel',
                'icy_asteroid_belt': 'Eisiger Asteroidengürtel',
                'crystalline_asteroid_belt': 'Kristalliner Asteroidengürtel'
            };
            return names[type] || type;
        }

        // Cumulative Orbit Calculation
        function calculateCumulativeOrbitDistances() {
            const result = [];
            let currentDistance = 0;
            
            solarSystem.planets.forEach((planet, index) => {
                if (planet.orbitDistance === 0 && index === 0) {
                    // First planet with 0 distance gets default
                    currentDistance = 40;
                } else if (planet.orbitDistance > 0) {
                    // Add to cumulative distance
                    currentDistance += planet.orbitDistance;
                }
                // If orbitDistance === 0 and not first planet, keep currentDistance
                
                result.push({
                    planet: planet,
                    actualDistance: currentDistance,
                    isNewOrbit: planet.orbitDistance > 0 || index === 0
                });
                
                // Apply change_orbit for next planet
                if (planet.changeOrbit > 0) {
                    currentDistance += planet.changeOrbit;
                }
            });
            
            return result;
        }
        function addPlanet() {
            const newPlanet = {
                id: nextCelestialId++,
                type: 'planet',
                name: `planet_${nextCelestialId - 1}`,
                displayName: `Planet ${nextCelestialId - 1}`,
                class: 'pc_barren',
                size: 16,
                orbitDistance: solarSystem.planets.length === 0 ? 40 : 0, // First planet gets distance, others default to 0
                orbitAngleType: 'range',
                orbitAngleMin: 90,
                orbitAngleMax: 270,
                changeOrbit: 0,
                hasRing: false,
                isStartingPlanet: false,
                moons: []
            };

            solarSystem.planets.push(newPlanet);
            updatePlanetList();
            selectPlanet(newPlanet.id);
            updateOutput();
            renderVisualizer();
        }

        function movePlanetUp() {
            if (!selectedPlanet) return;
            
            const index = solarSystem.planets.findIndex(p => p.id === selectedPlanet.id);
            if (index > 0) {
                [solarSystem.planets[index], solarSystem.planets[index - 1]] = 
                [solarSystem.planets[index - 1], solarSystem.planets[index]];
                updatePlanetList();
                updateOutput();
                renderVisualizer();
            }
        }

        function movePlanetDown() {
            if (!selectedPlanet) return;
            
            const index = solarSystem.planets.findIndex(p => p.id === selectedPlanet.id);
            if (index < solarSystem.planets.length - 1) {
                [solarSystem.planets[index], solarSystem.planets[index + 1]] = 
                [solarSystem.planets[index + 1], solarSystem.planets[index]];
                updatePlanetList();
                updateOutput();
                renderVisualizer();
            }
        }

        function addMoonToSelectedPlanet() {
            if (!selectedPlanet || selectedPlanet.type !== 'planet') {
                showNotification('Bitte wählen Sie zuerst einen Planeten aus.');
                return;
            }

            const newMoon = {
                id: nextCelestialId++,
                type: 'moon',
                name: `moon_${nextCelestialId - 1}`,
                displayName: `Mond ${nextCelestialId - 1}`,
                class: 'pc_barren',
                size: 8,
                orbitDistance: 12,
                orbitAngleType: 'range',
                orbitAngleMin: 90,
                orbitAngleMax: 270,
                hasRing: false,
                parentId: selectedPlanet.id
            };

            selectedPlanet.moons.push(newMoon);
            updatePlanetList();
            updateOutput();
            renderVisualizer();
        }

        // UI Updates
        function updatePlanetList() {
            elements.planetList.innerHTML = '';
            
            if (solarSystem.planets.length === 0) {
                elements.planetList.innerHTML = '<p class="text-gray-400">Fügen Sie Planeten hinzu, um mit dem Systembau zu beginnen.</p>';
                return;
            }

            const cumulativeOrbits = calculateCumulativeOrbitDistances();

            cumulativeOrbits.forEach((orbitData, index) => {
                const planet = orbitData.planet;
                const actualDistance = orbitData.actualDistance;
                const isNewOrbit = orbitData.isNewOrbit;
                
                const planetItem = createPlanetListItem(planet, index, isNewOrbit, false, actualDistance);
                elements.planetList.appendChild(planetItem);

                if (planet.moons && planet.moons.length > 0) {
                    planet.moons.forEach(moon => {
                        const moonItem = createPlanetListItem(moon, -1, false, true, 0);
                        elements.planetList.appendChild(moonItem);
                    });
                }
            });
        }

        function createPlanetListItem(celestial, index, isNewOrbit = false, isMoon = false, actualDistance = 0) {
            const item = document.createElement('div');
            item.className = `celestial-item ${selectedPlanet && selectedPlanet.id === celestial.id ? 'selected' : ''} ${isNewOrbit ? 'new-orbit' : 'same-orbit'} ${isMoon ? 'ml-6' : ''}`;
            item.dataset.id = celestial.id;
            
            const icon = getPlanetIcon(celestial.class);
            const typeText = isMoon ? 'Mond' : 'Planet';
            
            let orbitInfo = '';
            if (!isMoon) {
                if (isNewOrbit) {
                    orbitInfo = `🟡 +${celestial.orbitDistance} → Gesamt: ${actualDistance}`;
                } else {
                    orbitInfo = `⚪ +0 → Gleiche Umlaufbahn (${actualDistance})`;
                }
            }
            
            item.innerHTML = `
                <div class="flex items-center">
                    <span class="text-2xl mr-2">${icon}</span>
                    <div>
                        <div class="font-medium">${isMoon ? '↳ ' : `${index + 1}. `}${celestial.displayName}</div>
                        <div class="text-sm text-gray-400">${getClassDisplayName(celestial.class)} • Größe ${celestial.size}</div>
                        ${orbitInfo ? `<div class="text-xs text-blue-300">${orbitInfo}</div>` : ''}
                    </div>
                </div>
                <button class="stellaris-btn stellaris-btn-secondary text-sm px-2 py-1" onclick="selectPlanet(${celestial.id})">
                    Auswählen
                </button>
            `;
            
            item.addEventListener('click', (e) => {
                if (e.target.tagName !== 'BUTTON') {
                    selectPlanet(celestial.id);
                }
            });
            
            return item;
        }

        function selectPlanet(id) {
            selectedPlanet = findPlanetById(id);
            if (selectedPlanet) {
                elements.celestialDetails.classList.remove('hidden');
                elements.noCelestialSelected.classList.add('hidden');

                const planetIndex = solarSystem.planets.findIndex(p => p.id === selectedPlanet.id);
                
                // Populate details panel
                elements.celestialType.value = selectedPlanet.type === 'planet' ? 'Planet' : 'Mond';
                elements.celestialPosition.value = selectedPlanet.type === 'planet' ? 
                    `Position ${planetIndex + 1}` : `Mond von ${findParentPlanet(selectedPlanet).displayName}`;
                elements.celestialName.value = selectedPlanet.name;
                elements.celestialDisplayName.value = selectedPlanet.displayName;
                elements.celestialClass.value = selectedPlanet.class;
                elements.celestialSize.value = selectedPlanet.size;
                elements.celestialOrbitDistance.value = selectedPlanet.orbitDistance;
                elements.orbitAngleType.value = selectedPlanet.orbitAngleType || 'range';
                elements.celestialOrbitAngle.value = selectedPlanet.orbitAngle || 0;
                elements.celestialOrbitAngleMin.value = selectedPlanet.orbitAngleMin || 90;
                elements.celestialOrbitAngleMax.value = selectedPlanet.orbitAngleMax || 270;
                elements.celestialChangeOrbit.value = selectedPlanet.changeOrbit || 0;
                elements.celestialHasRing.checked = selectedPlanet.hasRing || false;
                elements.celestialIsStartingPlanet.checked = selectedPlanet.isStartingPlanet || false;

                // Toggle angle controls
                const isRange = selectedPlanet.orbitAngleType === 'range';
                elements.fixedAngleControl.classList.toggle('hidden', isRange);
                elements.rangeAngleControl.classList.toggle('hidden', !isRange);

                // Enable/disable buttons based on selection
                elements.addMoonBtn.disabled = selectedPlanet.type !== 'planet';
                elements.moveUpBtn.disabled = planetIndex <= 0 || selectedPlanet.type === 'moon';
                elements.moveDownBtn.disabled = planetIndex >= solarSystem.planets.length - 1 || selectedPlanet.type === 'moon';

                updatePlanetList();
            } else {
                deselectPlanet();
            }
        }

        function deselectPlanet() {
            selectedPlanet = null;
            elements.celestialDetails.classList.add('hidden');
            elements.noCelestialSelected.classList.remove('hidden');
            elements.addMoonBtn.disabled = true;
            elements.moveUpBtn.disabled = true;
            elements.moveDownBtn.disabled = true;
            updatePlanetList();
        }

        function findPlanetById(id) {
            for (const planet of solarSystem.planets) {
                if (planet.id === id) return planet;
                if (planet.moons) {
                    for (const moon of planet.moons) {
                        if (moon.id === id) return moon;
                    }
                }
            }
            return null;
        }

        function findParentPlanet(moon) {
            for (const planet of solarSystem.planets) {
                if (planet.moons && planet.moons.some(m => m.id === moon.id)) {
                    return planet;
                }
            }
            return null;
        }

        function deleteSelectedPlanet() {
            if (!selectedPlanet) return;

            if (selectedPlanet.type === 'planet') {
                solarSystem.planets = solarSystem.planets.filter(p => p.id !== selectedPlanet.id);
            } else if (selectedPlanet.type === 'moon') {
                const parentPlanet = findParentPlanet(selectedPlanet);
                if (parentPlanet) {
                    parentPlanet.moons = parentPlanet.moons.filter(m => m.id !== selectedPlanet.id);
                }
            }

            deselectPlanet();
            updatePlanetList();
            updateOutput();
            renderVisualizer();
        }

        // Visualization with correct cumulative orbit calculation
        function renderVisualizer() {
            elements.visualizer.innerHTML = '';

            const centerX = elements.visualizer.offsetWidth / 2;
            const centerY = elements.visualizer.offsetHeight / 2;

            // Draw the star
            const starSize = 30 * visualizerScale;
            const starEl = document.createElement('div');
            starEl.className = 'stellaris-star';
            starEl.style.width = `${starSize}px`;
            starEl.style.height = `${starSize}px`;
            starEl.style.left = `${centerX - starSize / 2}px`;
            starEl.style.top = `${centerY - starSize / 2}px`;
            starEl.style.borderRadius = '50%';
            starEl.style.position = 'absolute';
            elements.visualizer.appendChild(starEl);

            // Draw multiple asteroid belts
            solarSystem.asteroidBelts.forEach(belt => {
                const beltRadius = belt.radius * visualizerScale;
                const beltEl = document.createElement('div');
                beltEl.className = 'asteroid-belt';
                beltEl.style.width = `${beltRadius * 2}px`;
                beltEl.style.height = `${beltRadius * 2}px`;
                beltEl.style.left = `${centerX - beltRadius}px`;
                beltEl.style.top = `${centerY - beltRadius}px`;
                elements.visualizer.appendChild(beltEl);
            });

            // Calculate cumulative orbits and draw planets
            const cumulativeOrbits = calculateCumulativeOrbitDistances();
            const drawnOrbits = new Set();

            cumulativeOrbits.forEach((orbitData, index) => {
                const actualDistance = orbitData.actualDistance;
                const planet = orbitData.planet;
                
                // Draw orbit ring if we haven't drawn it yet
                const orbitRadius = actualDistance * visualizerScale;
                if (orbitRadius > starSize / 2 + 10 && !drawnOrbits.has(actualDistance)) {
                    drawnOrbits.add(actualDistance);
                    const orbitEl = document.createElement('div');
                    orbitEl.className = 'orbit-indicator';
                    orbitEl.style.width = `${orbitRadius * 2}px`;
                    orbitEl.style.height = `${orbitRadius * 2}px`;
                    orbitEl.style.left = `${centerX - orbitRadius}px`;
                    orbitEl.style.top = `${centerY - orbitRadius}px`;
                    elements.visualizer.appendChild(orbitEl);

                    // Add orbit distance label
                    const orbitLabel = document.createElement('div');
                    orbitLabel.className = 'orbit-number';
                    orbitLabel.textContent = actualDistance;
                    orbitLabel.style.left = `${centerX + orbitRadius - 20}px`;
                    orbitLabel.style.top = `${centerY - 10}px`;
                    elements.visualizer.appendChild(orbitLabel);
                }

                // Draw planet
                drawCelestial(planet, centerX, centerY, orbitRadius, index * 45);
            });
        }

        function drawCelestial(celestial, parentX, parentY, distance, baseAngle = 0) {
            let angle = baseAngle;
            if (celestial.orbitAngleType === 'fixed') {
                angle = celestial.orbitAngle || 0;
            } else {
                // For range, use middle of range for visualization
                const min = celestial.orbitAngleMin || 90;
                const max = celestial.orbitAngleMax || 270;
                angle = (min + max) / 2;
            }

            const angleRad = (angle * Math.PI) / 180;
            const x = parentX + distance * Math.cos(angleRad);
            const y = parentY + distance * Math.sin(angleRad);

            // Draw celestial body
            const size = Math.max(8, celestial.size * visualizerScale * 0.8);
            const bodyEl = document.createElement('div');
            bodyEl.className = celestial.type;
            bodyEl.style.width = `${size}px`;
            bodyEl.style.height = `${size}px`;
            bodyEl.style.left = `${x - size / 2}px`;
            bodyEl.style.top = `${y - size / 2}px`;
            bodyEl.style.background = getEnhancedColorForClass(celestial.class);
            bodyEl.style.position = 'absolute';
            bodyEl.style.borderRadius = '50%';
            bodyEl.style.display = 'flex';
            bodyEl.style.justifyContent = 'center';
            bodyEl.style.alignItems = 'center';
            bodyEl.style.fontSize = '0.7rem';
            bodyEl.style.fontWeight = '600';
            bodyEl.style.color = 'white';
            bodyEl.style.textShadow = '0 0 5px rgba(0,0,0,0.8)';
            bodyEl.style.cursor = 'pointer';
            bodyEl.textContent = celestial.displayName.substring(0, 3);
            
            bodyEl.addEventListener('click', () => selectPlanet(celestial.id));
            elements.visualizer.appendChild(bodyEl);

            // Draw ring system if present
            if (celestial.hasRing) {
                const ringEl = document.createElement('div');
                ringEl.style.position = 'absolute';
                ringEl.style.width = `${size * 1.8}px`;
                ringEl.style.height = `${size * 1.8}px`;
                ringEl.style.left = `${x - (size * 1.8) / 2}px`;
                ringEl.style.top = `${y - (size * 1.8) / 2}px`;
                ringEl.style.border = '2px solid rgba(255, 255, 255, 0.4)';
                ringEl.style.borderRadius = '50%';
                ringEl.style.pointerEvents = 'none';
                elements.visualizer.appendChild(ringEl);
            }

            // Draw moons
            if (celestial.moons && celestial.moons.length > 0) {
                celestial.moons.forEach((moon, moonIndex) => {
                    const moonDistance = moon.orbitDistance * visualizerScale;
                    drawCelestial(moon, x, y, moonDistance, moonIndex * 120);
                });
            }
        }

        // Code Generation with CORRECT Stellaris format
        function generateStellarisTxt() {
            let txt = `##### Generated by Stellaris Solar System Editor #####\n`;
            txt += `##### With correct orbit_distance = 0 mechanics    #####\n\n`;
            txt += `${solarSystem.name} = {\n`;
            txt += `\tname = "${solarSystem.displayName}"\n`;
            txt += `\tclass = "${solarSystem.class}"\n`;

            // Multiple asteroid belts
            solarSystem.asteroidBelts.forEach(belt => {
                txt += `\tasteroid_belt = {\n`;
                txt += `\t\ttype = ${belt.type}\n`;
                txt += `\t\tradius = ${belt.radius}\n`;
                txt += `\t}\n`;
            });

            if (solarSystem.usage) {
                txt += `\tusage = ${solarSystem.usage}\n`;
            }

            txt += `\tinit_effect = {\n`;
            
            // Add empire cluster effects if custom_empire
            if (solarSystem.usage === 'custom_empire') {
                txt += `\t\tevery_neighbor_system = {\n`;
                txt += `\t\t\tset_star_flag = empire_cluster\n`;
                txt += `\t\t\tevery_neighbor_system = {\n`;
                txt += `\t\t\t\tset_star_flag = empire_cluster\n`;
                txt += `\t\t\t}\n`;
                txt += `\t\t}\n`;
                txt += `\t\tgenerate_home_system_resources = yes\n`;
            }
            
            txt += `\t}\n\n`;

            // Generate star as first planet
            txt += `\tplanet = {\n`;
            txt += `\t\tname = "${solarSystem.displayName.toLowerCase().replace(/\s+/g, '_')}"\n`;
            txt += `\t\tclass = "${getStarClassForSystemClass(solarSystem.class)}"\n`;
            txt += `\t\torbit_distance = 0\n`;
            txt += `\t\torbit_angle = 1\n`;
            txt += `\t\tsize = 45\n`;
            txt += `\t\thas_ring = no\n`;
            txt += `\t}\n\n`;

            // Generate planets with CORRECT orbit logic
            solarSystem.planets.forEach(planet => {
                txt += `\tplanet = {\n`;
                txt += `\t\tname = "${planet.name}"\n`;
                txt += `\t\tclass = "${planet.class}"\n`;
                txt += `\t\torbit_distance = ${planet.orbitDistance}\n`; // This is the key fix!
                
                // Handle orbit angle
                if (planet.orbitAngleType === 'range') {
                    txt += `\t\torbit_angle = { min = ${planet.orbitAngleMin} max = ${planet.orbitAngleMax} }\n`;
                } else {
                    txt += `\t\torbit_angle = ${planet.orbitAngle}\n`;
                }
                
                txt += `\t\tsize = ${planet.size}\n`;
                
                if (planet.changeOrbit > 0) {
                    txt += `\t\tchange_orbit = ${planet.changeOrbit}\n`;
                }
                
                txt += `\t\thas_ring = ${planet.hasRing ? 'yes' : 'no'}\n`;
                
                if (planet.isStartingPlanet) {
                    txt += `\t\tstarting_planet = yes\n`;
                    txt += `\t\ttile_blockers = none\n`;
                    txt += `\t\tmodifiers = none\n`;
                    txt += `\t\tinit_effect = {\n`;
                    txt += `\t\t\tprevent_anomaly = yes\n`;
                    txt += `\t\t}\n\n`;
                    txt += `\t\tinit_effect = {\n`;
                    txt += `\t\t\tgenerate_start_buildings_and_blockers = yes\n`;
                    txt += `\t\t}\n`;
                }

                // Generate moons
                if (planet.moons && planet.moons.length > 0) {
                    planet.moons.forEach(moon => {
                        txt += `\t\tmoon = {\n`;
                        txt += `\t\t\tname = "${moon.name}"\n`;
                        txt += `\t\t\tclass = "${moon.class}"\n`;
                        txt += `\t\t\torbit_distance = ${moon.orbitDistance}\n`;
                        
                        if (moon.orbitAngleType === 'range') {
                            txt += `\t\t\torbit_angle = { min = ${moon.orbitAngleMin} max = ${moon.orbitAngleMax} }\n`;
                        } else {
                            txt += `\t\t\torbit_angle = ${moon.orbitAngle}\n`;
                        }
                        
                        txt += `\t\t\tsize = ${moon.size}\n`;
                        if (moon.hasRing) {
                            txt += `\t\t\thas_ring = yes\n`;
                        }
                        txt += `\t\t}\n`;
                    });
                }

                txt += `\t}\n`;
            });

            txt += `}\n`;
            return txt;
        }

        function generateStellarisYml() {
            let yml = `l_german:\n`;
            yml += ` # Generated by Stellaris Solar System Editor\n`;
            yml += ` # System: ${solarSystem.displayName}\n\n`;
            yml += ` ${solarSystem.name}_NAME: "${solarSystem.displayName}"\n`;
            yml += ` ${solarSystem.name}_DESC: "Ein maßgeschneidertes Sonnensystem mit korrekter Stellaris-Orbit-Mechanik."\n\n`;

            solarSystem.planets.forEach(planet => {
                yml += ` ${planet.name}_NAME: "${planet.displayName}"\n`;
                if (planet.moons && planet.moons.length > 0) {
                    planet.moons.forEach(moon => {
                        yml += ` ${moon.name}_NAME: "${moon.displayName}"\n`;
                    });
                }
            });

            return yml;
        }

        function getStarClassForSystemClass(systemClass) {
            const mapping = {
                'sc_b': 'pc_b_star',
                'sc_a': 'pc_a_star',
                'sc_f': 'pc_f_star',
                'sc_g': 'pc_g_star',
                'sc_k': 'pc_k_star',
                'sc_m': 'pc_m_star'
            };
            return mapping[systemClass] || 'pc_g_star';
        }

        // Helper functions
        function getPlanetIcon(planetClass) {
            const icons = {
                'pc_b_star': '💙', 'pc_a_star': '⚪', 'pc_f_star': '💛', 'pc_g_star': '☉', 'pc_k_star': '🧡', 'pc_m_star': '🔴',
                'pc_continental': '🌍', 'pc_ocean': '🌊', 'pc_tropical': '🌴',
                'pc_arid': '🏜️', 'pc_desert': '🏜️', 'pc_savanna': '🌾',
                'pc_arctic': '🧊', 'pc_tundra': '❄️', 'pc_alpine': '🏔️',
                'pc_gaia': '🌿', 'pc_barren': '🌑', 'pc_barren_cold': '☄️', 'pc_frozen': '☄️',
                'pc_molten': '🔥', 'pc_toxic': '☢️', 'pc_hothouse': '🔥',
                'pc_gas_giant': '🪐', 'pc_hot_gas_giant': '🔥', 'pc_cold_gas_giant': '❄️', 'pc_dwarf_gas_giant': '🌐',
                'pc_storm': '⛈️', 'pc_nuked': '💥', 'pc_shattered': '💥',
                'pc_asteroid': '☄️', 'pc_relic': '🏛️', 'pc_subglacial': '🧊',
                'pc_habitat': '🛰️', 'pc_ecumenopolis': '🏙️', 'pc_machine': '🤖',
                'pc_hive': '🐛', 'pc_shielded': '🛡️'
            };
            return icons[planetClass] || '🌌';
        }

        function getClassDisplayName(planetClass) {
            const names = {
                'pc_b_star': 'B-Stern', 'pc_a_star': 'A-Stern', 'pc_f_star': 'F-Stern', 'pc_g_star': 'G-Stern', 'pc_k_star': 'K-Stern', 'pc_m_star': 'M-Stern',
                'pc_continental': 'Kontinental', 'pc_ocean': 'Ozean', 'pc_tropical': 'Tropisch',
                'pc_arid': 'Arid', 'pc_desert': 'Wüste', 'pc_savanna': 'Savanne',
                'pc_arctic': 'Arktisch', 'pc_tundra': 'Tundra', 'pc_alpine': 'Alpin',
                'pc_gaia': 'Gaia', 'pc_barren': 'Karg', 'pc_barren_cold': 'Karg (Kalt)', 'pc_frozen': 'Gefroren',
                'pc_molten': 'Geschmolzen', 'pc_toxic': 'Toxisch', 'pc_hothouse': 'Treibhaus',
                'pc_gas_giant': 'Gasriese', 'pc_hot_gas_giant': 'Heißer Gasriese', 'pc_cold_gas_giant': 'Kalter Gasriese', 'pc_dwarf_gas_giant': 'Zwerg-Gasriese',
                'pc_storm': 'Sturm', 'pc_nuked': 'Verstrahlt', 'pc_shattered': 'Zerstört',
                'pc_asteroid': 'Asteroid', 'pc_relic': 'Relikt', 'pc_subglacial': 'Subglazial',
                'pc_habitat': 'Habitat', 'pc_ecumenopolis': 'Ökumenopolis', 'pc_machine': 'Maschine',
                'pc_hive': 'Schwarm', 'pc_shielded': 'Abgeschirmt'
            };
            return names[planetClass] || planetClass;
        }

        function getEnhancedColorForClass(className) {
            const colors = {
                'pc_b_star': 'linear-gradient(45deg, #4299e1, #3182ce)',
                'pc_a_star': 'linear-gradient(45deg, #f7fafc, #edf2f7)',
                'pc_f_star': 'linear-gradient(45deg, #faf089, #f6e05e)',
                'pc_g_star': 'linear-gradient(45deg, #f6e05e, #ecc94b)',
                'pc_k_star': 'linear-gradient(45deg, #ed8936, #dd6b20)',
                'pc_m_star': 'linear-gradient(45deg, #e53e3e, #c53030)',
                'pc_continental': 'linear-gradient(45deg, #38b2ac, #4299e1)',
                'pc_ocean': 'linear-gradient(45deg, #4299e1, #3182ce)',
                'pc_tropical': 'linear-gradient(45deg, #48bb78, #38a169)',
                'pc_arid': 'linear-gradient(45deg, #f6ad55, #ed8936)',
                'pc_desert': 'linear-gradient(45deg, #ecc94b, #d69e2e)',
                'pc_savanna': 'linear-gradient(45deg, #ed8936, #dd6b20)',
                'pc_arctic': 'linear-gradient(45deg, #a0aec0, #718096)',
                'pc_tundra': 'linear-gradient(45deg, #718096, #4a5568)',
                'pc_alpine': 'linear-gradient(45deg, #cbd5e0, #a0aec0)',
                'pc_gaia': 'linear-gradient(45deg, #68d391, #48bb78)',
                'pc_barren': 'linear-gradient(45deg, #718096, #4a5568)',
                'pc_barren_cold': 'linear-gradient(45deg, #a0aec0, #718096)',
                'pc_frozen': 'linear-gradient(45deg, #bee3f8, #90cdf4)',
                'pc_molten': 'linear-gradient(45deg, #e53e3e, #c53030)',
                'pc_toxic': 'linear-gradient(45deg, #805ad5, #6b46c1)',
                'pc_hothouse': 'linear-gradient(45deg, #e53e3e, #ed8936)',
                'pc_gas_giant': 'linear-gradient(45deg, #9f7aea, #805ad5)',
                'pc_hot_gas_giant': 'linear-gradient(45deg, #e53e3e, #9f7aea)',
                'pc_cold_gas_giant': 'linear-gradient(45deg, #bee3f8, #9f7aea)',
                'pc_dwarf_gas_giant': 'linear-gradient(45deg, #805ad5, #553c9a)',
                'pc_storm': 'linear-gradient(45deg, #667eea, #5a67d8)',
                'pc_nuked': 'linear-gradient(45deg, #a3bffa, #7c3aed)',
                'pc_shattered': 'linear-gradient(45deg, #4a5568, #2d3748)',
                'pc_asteroid': 'linear-gradient(45deg, #718096, #4a5568)',
                'pc_relic': 'linear-gradient(45deg, #d69e2e, #b7791f)',
                'pc_subglacial': 'linear-gradient(45deg, #90cdf4, #4299e1)',
                'pc_habitat': 'linear-gradient(45deg, #a0aec0, #718096)',
                'pc_ecumenopolis': 'linear-gradient(45deg, #fed7d7, #fc8181)',
                'pc_machine': 'linear-gradient(45deg, #4a5568, #2d3748)',
                'pc_hive': 'linear-gradient(45deg, #9f7aea, #805ad5)',
                'pc_shielded': 'linear-gradient(45deg, #e2e8f0, #cbd5e0)'
            };
            return colors[className] || 'linear-gradient(45deg, #e2e8f0, #cbd5e0)';
        }

        function updateOutput() {
            elements.exportTxt.value = generateStellarisTxt();
            elements.exportYml.value = generateStellarisYml();
        }

        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-blue-600 text-white px-4 py-2 rounded shadow-lg z-50';
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showNotification(`Datei "${filename}" wurde erfolgreich heruntergeladen!`);
        }

        // Make functions globally available
        window.selectPlanet = selectPlanet;
        window.removeAsteroidBelt = removeAsteroidBelt;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            initializeEventListeners();
            
            // Load default system
            elements.systemName.value = solarSystem.name;
            elements.systemDisplayName.value = solarSystem.displayName;
            elements.systemClass.value = solarSystem.class;
            elements.systemUsage.value = solarSystem.usage;
            
            updatePlanetList();
            updateOutput();
            renderVisualizer();
            
            showNotification('🎯 Kumulative Stellaris-Orbit-Mechanik und Multiple Asteroidengürtel implementiert!');
        });

        window.addEventListener('resize', () => {
            setTimeout(renderVisualizer, 100);
        });
    </script>
</body>
</html>